<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cement Production Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Product color coding */
        .product-opc { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-left: 4px solid #3b82f6; }
        .product-il11 { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid #f59e0b; }
        .product-il8 { background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); border-left: 4px solid #ec4899; }
        .product-ppc { background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border-left: 4px solid #6366f1; }
        
        .product-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-opc { background: #3b82f6; color: white; }
        .badge-il11 { background: #f59e0b; color: white; }
        .badge-il8 { background: #ec4899; color: white; }
        .badge-ppc { background: #6366f1; color: white; }
        
        .product-card {
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .product-card.selected {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .recipe-ingredient {
            display: grid;
            grid-template-columns: 200px 1fr 100px;
            gap: 12px;
            align-items: center;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .ingredient-slider {
            width: 100%;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .calendar-day {
            min-height: 80px;
            border: 1px solid #e5e7eb;
            padding: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .calendar-day:hover {
            background: #f3f4f6;
            border-color: #3b82f6;
        }
        
        .calendar-day.selected {
            background: #dbeafe;
            border-color: #3b82f6;
            border-width: 2px;
        }
        
        .calendar-day.maintenance {
            background: repeating-linear-gradient(45deg, #fef2f2, #fef2f2 10px, #fee2e2 10px, #fee2e2 20px);
        }
        
        .calendar-day.shutdown {
            background: #f3f4f6;
        }
        
        /* Process Flow Styles */
        .toolbar-item {
            cursor: grab;
            transition: all 0.2s;
        }
        
        .toolbar-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .equipment-node {
            cursor: move;
            transition: all 0.2s;
        }
        
        .equipment-node:hover {
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.3));
        }
        
        .equipment-node.selected {
            filter: drop-shadow(0 0 12px #3b82f6);
        }
        
        .connection-line {
            stroke: #9ca3af;
            stroke-width: 3;
            fill: none;
            cursor: pointer;
        }
        
        .connection-line:hover {
            stroke: #3b82f6;
            stroke-width: 4;
        }
        
        .port {
            cursor: crosshair;
            transition: all 0.2s;
        }
        
        .port:hover {
            r: 8;
            fill: #3b82f6;
        }
        
        .hidden {
            display: none;
        }
        
        /* Sticky scrollbar container - always visible at top */
        .scrollbar-container {
            position: sticky;
            top: 60px; /* Below the sticky date header */
            z-index: 15;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            overflow-x: scroll;
            overflow-y: hidden;
            height: 20px;
        }
        
        .scrollbar-container::-webkit-scrollbar {
            height: 12px;
        }
        
        .scrollbar-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        .scrollbar-container::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 6px;
        }
        
        .scrollbar-container::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        
        /* Force scrollbar to always show */
        .scrollbar-content {
            height: 1px;
        }
    
        
        /* Flow Designer v2 - Selection & Zoom */
        .connection-line {
            stroke: #9ca3af;
            stroke-width: 3;
            fill: none;
            cursor: pointer;
            transition: stroke-width 0.2s;
        }
        
        .connection-line:hover {
            stroke: #3b82f6;
            stroke-width: 5;
        }
        
        .equipment-node {
            cursor: move;
        }
        
        .equipment-node.selected rect {
            filter: drop-shadow(0px 4px 12px rgba(59, 130, 246, 0.6));
        }
        
        .port {
            cursor: pointer;
            transition: r 0.2s;
        }
        
        .port:hover {
            r: 8;
        }
        
        #flowCanvas {
            cursor: crosshair;
        }
        </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <!-- Product Recipe Modal -->
    <div id="recipeModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-3xl border border-gray-200 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-900" id="recipeModalTitle">Edit Product Recipe</h3>
                <button onclick="closeRecipeModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="recipeModalContent"></div>
            <div class="flex justify-end space-x-2 mt-6">
                <button onclick="closeRecipeModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded">Cancel</button>
                <button onclick="saveRecipe()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Save Recipe</button>
            </div>
        </div>
    </div>

    <!-- Production Day Modal -->
    <div id="dayModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl border border-gray-200 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-900" id="dayModalTitle">Edit Production Day</h3>
                <button onclick="closeDayModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="dayModalContent"></div>
            <div class="flex justify-end space-x-2 mt-6">
                <button onclick="closeDayModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded">Cancel</button>
                <button onclick="saveDayPlan()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        console.log('=== CEMENT PLANNER STARTING ===');
        
        // ============================================
        // GLOBAL STATE
        // ============================================
        
        console.log('Initializing APP_STATE...');
        
        // ============================================
        // CEMEX FLORIDA REGION - LOCATIONS
        // ============================================
        const CEMEX_LOCATIONS = {
            'MIA': { code: 'MIA', name: 'Miami Plant',           type: 'plant',    icon: 'üè≠', color: '#1d4ed8', bg: '#eff6ff' },
            'BRS': { code: 'BRS', name: 'Brooksville Plant',     type: 'plant',    icon: 'üè≠', color: '#15803d', bg: '#f0fdf4' },
            'PEV': { code: 'PEV', name: 'Port Everglades',       type: 'terminal', icon: 'üö¢', color: '#0e7490', bg: '#ecfeff' },
            'WPB': { code: 'WPB', name: 'West Palm Beach',       type: 'terminal', icon: 'üö¢', color: '#0369a1', bg: '#f0f9ff' },
            'ORL': { code: 'ORL', name: 'Orlando Terminal',      type: 'terminal', icon: 'üöÇ', color: '#7c3aed', bg: '#f5f3ff' },
            'SUB': { code: 'SUB', name: 'Sutton Terminal',       type: 'terminal', icon: 'üöÇ', color: '#b45309', bg: '#fffbeb' },
            'JAX': { code: 'JAX', name: 'Jacksonville Terminal', type: 'terminal', icon: 'üöÇ', color: '#9f1239', bg: '#fff1f2' }
        };

        const APP_STATE = {
            currentTab: 'products',
            currentDate: new Date(),
            currentLocation: localStorage.getItem('cemex_current_location') || 'MIA',
            
            // Product Definitions
            products: {
                opc: {
                    id: 'opc',
                    name: 'OPC (Ordinary Portland Cement)',
                    recipe: {
                        clinker: 95,
                        gypsum: 5,
                        limestone: 0,
                        fly_ash: 0,
                        slag: 0,
                        pozzolana: 0,
                        additives: 0
                    },
                    color: '#3b82f6'
                },
                il11: {
                    id: 'il11',
                    name: 'IL(11) - Portland Limestone Cement',
                    recipe: {
                        clinker: 84,
                        gypsum: 5,
                        limestone: 11,
                        fly_ash: 0,
                        slag: 0,
                        pozzolana: 0,
                        additives: 0
                    },
                    color: '#f59e0b'
                }
            },
            
            // Equipment in process flow
            flowDesigner: {
                equipment: [],
                connections: [],
                nextId: 1,
                selectedEquipment: null,
                connecting: null,
                zoom: 1,
                panX: 0,
                panY: 0,
                selection: { active: false, startX: 0, startY: 0, endX: 0, endY: 0 },
                selectedIds: []
            },
            
            // Production Plan (by date, by equipment)
            productionPlan: {
                // Format: 'YYYY-MM-DD': { equipment_id: { status: 'production|maintenance|shutdown', product: 'opc', target_tpd: 2000 } }
            },
            
            // Campaigns (by equipment)
            campaigns: {
                // Format: { equipment_id: [ { id, start, duration, status, product, tpd, reason } ] }
                // Example: 'kiln_1': [ { id: 'c1', start: 0, duration: 15, status: 'active', tpd: 2000 } ]
            },
            
            // Demand Plan (by product, by date)
            demandPlan: {
                // Format: { product_id: { 'YYYY-MM-DD': { value: 1500, type: 'actual|forecast' } } }
            },
            
            // Inventory tracking (by silo, by product, by date)
            inventory: {
                // Format: { silo_id: { product_id: { 'YYYY-MM-DD': beginning_inventory_tons } } }
            },
            
            // Current view year/month for production plan
            planView: {
                year: 2025,
                month: 2 // February
            }
        };

        // Equipment type definitions for Process Flow
        const EQUIPMENT_TYPES = {
            raw_material: {
                name: 'Raw Material',
                color: '#84cc16',
                icon: 'ü™®',
                width: 100,
                height: 100,
                outputs: ['raw_material'],
                inputs: [],
                defaultParams: { supply_rate: 3000, cost_per_ton: 30, material_name: 'Limestone' }
            },
            fuel: {
                name: 'Fuel',
                color: '#18181b',
                icon: '‚ö´',
                width: 100,
                height: 100,
                outputs: ['fuel'],
                inputs: [],
                defaultParams: { supply_rate: 500, gcal_per_ton: 6000, cost_per_ton: 80, fuel_name: 'Coal' }
            },
            additive: {
                name: 'Additive',
                color: '#f5f5f4',
                icon: 'üíé',
                width: 100,
                height: 100,
                outputs: ['additive'],
                inputs: [],
                defaultParams: { supply_rate: 300, cost_per_ton: 40, additive_name: 'Gypsum' }
            },
            raw_mill: {
                name: 'Raw Mill',
                color: '#dc2626',
                icon: '‚öôÔ∏è',
                width: 100,
                height: 100,
                inputs: ['raw_material'],
                outputs: ['raw_meal'],
                defaultParams: { nominal_tph: 120, hours: 22, utilization: 0.85, efficiency: 0.95 }
            },
            kiln: {
                name: 'Kiln',
                color: '#ea580c',
                icon: 'üî•',
                width: 100,
                height: 100,
                inputs: ['raw_meal', 'fuel'],
                outputs: ['clinker'],
                defaultParams: { 
                    tpd: 2000,
                    gcal_per_tm_ck: 750,
                    rm_to_clinker_factor: 1.55
                }
            },
            silo: {
                name: 'Silo',
                color: '#6b7280',
                icon: 'üè∫',
                width: 100,
                height: 120,
                inputs: ['raw_material', 'fuel', 'clinker', 'cement', 'raw_meal', 'additive'],
                outputs: ['raw_material', 'fuel', 'clinker', 'cement', 'raw_meal', 'additive'],
                defaultParams: { 
                    min_volume: 2000,
                    max_volume: 15000,
                    material_type: 'Clinker' 
                }
            },
            finish_mill: {
                name: 'Finish Mill',
                color: '#3b82f6',
                icon: 'üîß',
                width: 120,
                height: 100,
                inputs: ['clinker', 'additive'],
                outputs: ['cement'],
                defaultParams: { 
                    products: {} // Will store product_id: { enabled: true, tpd: 1800 }
                }
            },
            packing: {
                name: 'Packing System',
                color: '#eab308',
                icon: 'üì¶',
                width: 120,
                height: 100,
                inputs: ['cement'],
                outputs: ['packed'],
                defaultParams: { 
                    product: '',
                    pallets_per_hour: 100,
                    hours_operation: 18
                }
            },
            loadout: {
                name: 'Loadout',
                color: '#8b5cf6',
                icon: 'üöö',
                width: 100,
                height: 100,
                inputs: ['cement', 'packed'],
                outputs: [],
                defaultParams: { 
                    loads_per_hour: 4,  // 4 loads/hour √ó 25 tons = 100 TPH
                    hours_operation: 16  // Default 16 hours/day
                }
            }
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function formatNumber(num) {
            return Math.round(num).toLocaleString();
        }

        function adjustColor(color, amount) {
            const num = parseInt(color.replace('#', ''), 16);
            const r = Math.max(0, Math.min(255, (num >> 16) + amount));
            const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
            const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
            return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
        }

        function getDateString(date) {
            return date.toISOString().split('T')[0];
        }

        function parseDate(dateStr) {
            return new Date(dateStr + 'T12:00:00'); // Noon to avoid timezone issues
        }

        // ============================================
        // MAIN RENDER
        // ============================================
        
        function renderApp() {
            const app = document.getElementById('app');
            
            let content = '';
            content += renderHeader();
            content += renderNavTabs();
            
            switch (APP_STATE.currentTab) {
                case 'products':
                    content += renderProductsTab();
                    break;
                case 'flow':
                    content += renderFlowDesignerTab();
                    break;
                case 'demand':
                    content += renderDemandPlanningTab();
                    break;
                case 'plan':
                    content += renderProductionPlanTab();
                    break;
                case 'monitor':
                    content += renderMonitorTab();
                    break;
            }
            
            app.innerHTML = content;
            
            // Initialize tab-specific functionality
            if (APP_STATE.currentTab === 'flow') {
                initializeFlowDesigner();
            }
            
            if (APP_STATE.currentTab === 'plan') {
                initializeProductionPlanScrollSync();
            }
        }
        
        function initializeProductionPlanScrollSync() {
            const topScrollbar = document.getElementById('topScrollbar');
            const tableContainer = document.getElementById('tableScrollContainer');
            const topScrollbarContent = document.getElementById('topScrollbarContent');
            
            if (!topScrollbar || !tableContainer || !topScrollbarContent) return;
            
            // Set scrollbar content width to match table width
            const table = tableContainer.querySelector('table');
            if (table) {
                topScrollbarContent.style.width = table.scrollWidth + 'px';
            }
            
            // Sync top scrollbar with table scroll
            topScrollbar.addEventListener('scroll', function() {
                tableContainer.scrollLeft = topScrollbar.scrollLeft;
            });
            
            // Sync table scroll with top scrollbar
            tableContainer.addEventListener('scroll', function() {
                topScrollbar.scrollLeft = tableContainer.scrollLeft;
            });
        }

        // ============================================
        // HEADER
        // ============================================
        
        function renderHeader() {
            const loc = CEMEX_LOCATIONS[APP_STATE.currentLocation] || CEMEX_LOCATIONS['MIA'];
            const isPlant = loc.type === 'plant';
            return `
                <div class="border-b border-gray-200 shadow-sm" style="background:white;">
                    <!-- TOP BAR: Location identifier & switcher -->
                    <div class="px-6 py-2 flex items-center justify-between" style="background:${loc.color}; color:white;">
                        <div class="flex items-center space-x-2 text-sm font-medium">
                            <span class="font-bold text-white text-base tracking-wide">CEMEX</span>
                            <span class="opacity-60">‚Ä∫</span>
                            <span class="opacity-90">Florida Region</span>
                            <span class="opacity-60">‚Ä∫</span>
                            <span class="font-bold">${loc.icon} ${loc.name}</span>
                            <span class="ml-2 px-2 py-0.5 rounded text-xs font-bold" style="background:rgba(255,255,255,0.25)">${loc.code}</span>
                            <span class="px-2 py-0.5 rounded text-xs" style="background:rgba(255,255,255,0.15)">${isPlant ? 'üè≠ Plant' : 'üì¶ Terminal'}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs opacity-75">Switch:</span>
                            ${Object.values(CEMEX_LOCATIONS).map(l => `
                                <button onclick="switchLocation('${l.code}')"
                                        title="${l.name}"
                                        class="px-2 py-0.5 rounded text-xs font-bold transition-all ${l.code === APP_STATE.currentLocation
                                            ? 'bg-white text-gray-800 shadow'
                                            : 'text-white opacity-60 hover:opacity-100'
                                        }">
                                    ${l.icon} ${l.code}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    <!-- BOTTOM BAR: App title + date -->
                    <div class="px-6 py-3 flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="p-2 rounded-lg text-white" style="background:${loc.color}">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                            </div>
                            <div>
                                <h1 class="text-lg font-bold text-gray-900">Production Planning System</h1>
                                <p class="text-xs text-gray-400">Configure ‚Üí Design ‚Üí Plan ‚Üí Monitor</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="text-right">
                                <div class="text-xs text-gray-400">Today</div>
                                <div class="text-sm font-bold text-gray-900">${APP_STATE.currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>
                            </div>
                            <button onclick="exportAllData()" class="text-white px-3 py-1.5 rounded-lg text-sm" style="background:${loc.color}">
                                üì• Export
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function switchLocation(code) {
            if (!CEMEX_LOCATIONS[code]) return;
            if (code === APP_STATE.currentLocation) return;

            // Save current location data first
            saveToLocalStorage();

            // Switch location
            APP_STATE.currentLocation = code;
            localStorage.setItem('cemex_current_location', code);

            // Reset state for new location (keep UI state)
            APP_STATE.products = {};
            APP_STATE.flowDesigner = { equipment: [], connections: [], nextId: 1 };
            APP_STATE.productionPlan = { campaigns: {} };
            APP_STATE.demandPlan = {};
            APP_STATE.inventory = {};
            APP_STATE.currentTab = 'products';

            // Load new location's data
            loadFromLocalStorage();
            renderApp();
        }

        // ============================================
        // NAVIGATION
        // ============================================
        
        function renderNavTabs() {
            const tabs = [
                { id: 'products', label: '1. Products & Recipes', icon: 'üìã' },
                { id: 'flow', label: '2. Process Flow', icon: 'üè≠' },
                { id: 'demand', label: '3. Demand Planning', icon: 'üìà' },
                { id: 'plan', label: '4. Production Plan', icon: 'üìÖ' },
                { id: 'monitor', label: '5. Monitor & Inventory', icon: 'üìä' }
            ];
            
            return `
                <div class="bg-white border-b border-gray-200">
                    <div class="px-6">
                        <nav class="flex space-x-2">
                            ${tabs.map(tab => `
                                <button 
                                    onclick="switchTab('${tab.id}')"
                                    class="border-b-2 ${APP_STATE.currentTab === tab.id ? 'border-blue-600 text-blue-600 bg-blue-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'} py-3 px-4 font-semibold text-sm transition-colors rounded-t"
                                >
                                    <span class="mr-2">${tab.icon}</span>${tab.label}
                                </button>
                            `).join('')}
                        </nav>
                    </div>
                </div>
            `;
        }

        function switchTab(tabId) {
            APP_STATE.currentTab = tabId;
            renderApp();
        }

        // ============================================
        // GLOBAL RAW MATERIALS LIST
        // ============================================
        
        if (!window.AVAILABLE_RAW_MATERIALS) {
            window.AVAILABLE_RAW_MATERIALS = [
                'Clinker',
                'Gypsum',
                'Limestone',
                'Fly Ash',
                'Slag',
                'Pozzolana',
                'Silica Fume',
                'Rice Husk Ash',
                'Metakaolin'
            ];
        }

        // ============================================
        // TAB 1: PRODUCTS & RECIPES
        // ============================================
        
        function renderProductsTab() {
            const products = Object.values(APP_STATE.products);

            // Group products by family
            const groups = {
                'ck_raw': { label: 'ü™® CK Raw Materials', subtitle: 'Kiln feed materials for clinker production', color: '#78716c', bg: '#f5f5f4', border: '#a8a29e', products: [] },
                'cem_raw': { label: 'üî• CEM Raw Materials', subtitle: 'Clinker & additives for cement grinding', color: '#b45309', bg: '#fffbeb', border: '#fcd34d', products: [] },
                'fuel': { label: '‚õΩ Fuels', subtitle: 'Energy inputs for kiln operation', color: '#dc2626', bg: '#fef2f2', border: '#fca5a5', products: [] },
                'portland_cement': { label: 'üèóÔ∏è Portland Cement', subtitle: 'OPC and standard portland types', color: '#1d4ed8', bg: '#eff6ff', border: '#93c5fd', products: [] },
                'blended_cement': { label: 'üîÑ Blended Cement', subtitle: 'IL, PLC, PCC and blended types', color: '#059669', bg: '#f0fdf4', border: '#6ee7b7', products: [] },
                'specialty_cement': { label: '‚≠ê Specialty Cement', subtitle: 'White, oil well, SR and special types', color: '#7c3aed', bg: '#f5f3ff', border: '#c4b5fd', products: [] }
            };

            products.forEach(p => {
                const fam = p.family || 'portland_cement';
                if (groups[fam]) groups[fam].products.push(p);
                else groups['portland_cement'].products.push(p);
            });

            const groupHTML = Object.entries(groups).map(([key, group]) => `
                <div class="mb-6">
                    <!-- Section Header -->
                    <div class="flex items-center justify-between mb-2 pb-2 border-b-2" style="border-color: ${group.border}">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-bold" style="color: ${group.color}">${group.label}</span>
                            <span class="text-xs text-gray-400">${group.subtitle}</span>
                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full text-white" style="background:${group.color}">${group.products.length}</span>
                        </div>
                        <button onclick="addNewProductOfFamily('${key}')" 
                                class="text-xs px-2 py-1 rounded border font-semibold hover:opacity-80 flex items-center space-x-1"
                                style="color:${group.color}; border-color:${group.color}; background:${group.bg}">
                            <span>+</span><span>Add</span>
                        </button>
                    </div>
                    <!-- Products Grid -->
                    ${group.products.length === 0 ? `
                        <div class="text-xs text-gray-400 italic py-2 pl-2">No ${group.label.split(' ').slice(1).join(' ')} defined yet. Click + Add to create one.</div>
                    ` : `
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-2">
                            ${group.products.map(p => renderProductCard(p, group)).join('')}
                        </div>
                    `}
                </div>
            `).join('');

            return `
                <div class="p-4">
                    <div class="mb-4 flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Products & Recipes</h2>
                            <p class="text-gray-500 text-xs mt-0.5">Define materials and cement types grouped by category</p>
                        </div>
                        <button onclick="addNewProduct()" class="bg-green-600 text-white px-3 py-1.5 rounded-lg hover:bg-green-700 flex items-center space-x-1 text-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            <span>Add Product</span>
                        </button>
                    </div>
                    ${groupHTML}
                </div>
            `;
        }

        function renderProductCard(product, group) {
            const recipeItems = Object.entries(product.recipe || {});
            const totalPercentage = recipeItems.reduce((sum, [mat, pct]) => sum + pct, 0);
            const isValid = recipeItems.length === 0 || Math.abs(totalPercentage - 100) < 0.1;
            const family = product.family || 'portland_cement';
            const isBaseInput = family === 'ck_raw' || family === 'fuel';
            const borderColor = group ? group.border : '#e5e7eb';
            const bgColor = group ? group.bg : '#ffffff';

            return `
                <div class="rounded-lg border p-2 text-xs" style="background:${bgColor}; border-color:${borderColor}; border-width:1.5px;">
                    <!-- Header: name + delete -->
                    <div class="flex items-center justify-between mb-1.5">
                        <span class="font-bold text-gray-800 truncate flex-1 text-xs" title="${product.name}">${product.name}</span>
                        <div class="flex items-center space-x-1 flex-shrink-0">
                            <select onchange="updateProductFamily('${product.id}', this.value)"
                                    class="text-xs border-0 bg-transparent cursor-pointer p-0 pr-1"
                                    title="Change category"
                                    style="font-size:10px; max-width:20px; opacity:0.5">
                                <option value="ck_raw" ${family === 'ck_raw' ? 'selected' : ''}>ü™®</option>
                                <option value="cem_raw" ${family === 'cem_raw' ? 'selected' : ''}>üî•</option>
                                <option value="fuel" ${family === 'fuel' ? 'selected' : ''}>‚õΩ</option>
                                <option value="portland_cement" ${family === 'portland_cement' ? 'selected' : ''}>üèóÔ∏è</option>
                                <option value="blended_cement" ${family === 'blended_cement' ? 'selected' : ''}>üîÑ</option>
                                <option value="specialty_cement" ${family === 'specialty_cement' ? 'selected' : ''}>‚≠ê</option>
                            </select>
                            <button onclick="deleteProduct('${product.id}')" class="text-red-400 hover:text-red-600 p-0.5 rounded">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    ${isBaseInput ? `
                        <div class="text-gray-400 italic text-center py-1" style="font-size:10px">Base input ‚Äî no recipe</div>
                    ` : `
                        <!-- Recipe rows -->
                        <div class="space-y-1 mb-1.5">
                            ${recipeItems.map(([material, percentage]) => `
                                <div class="flex items-center space-x-1">
                                    <select onchange="updateMaterialName('${product.id}', '${material}', this.value)"
                                            class="border border-gray-200 rounded px-1 py-0.5 flex-1 min-w-0 bg-white" style="font-size:10px">
                                        ${getFilteredMaterialsForFamily(family).map(mat =>
                                            `<option value="${mat}" ${mat === material ? 'selected' : ''}>${mat}</option>`
                                        ).join('')}
                                        <option value="__add_new__">+ Add New...</option>
                                    </select>
                                    <input type="number"
                                           value="${percentage}"
                                           min="0" max="100" step="0.1"
                                           onchange="updateMaterialPercentage('${product.id}', '${material}', this.value)"
                                           class="border border-gray-200 rounded px-1 py-0.5 bg-white text-right"
                                           style="width:40px; font-size:10px">
                                    <span class="text-gray-400" style="font-size:10px">%</span>
                                    <button onclick="removeMaterial('${product.id}', '${material}')"
                                            class="text-red-400 hover:text-red-600 flex-shrink-0">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                            `).join('')}
                        </div>

                        <button onclick="addMaterialToProduct('${product.id}')"
                                class="w-full bg-white hover:bg-gray-100 text-gray-500 rounded border border-dashed border-gray-300 py-0.5 mb-1.5"
                                style="font-size:10px">
                            + Add
                        </button>

                        <!-- Total -->
                        <div class="flex items-center justify-between pt-1 border-t border-gray-200">
                            <span class="text-gray-500" style="font-size:10px">Total:</span>
                            <span class="font-bold ${isValid ? 'text-green-600' : 'text-red-600'}" style="font-size:10px">
                                ${recipeItems.length === 0 ? '‚Äî' : totalPercentage.toFixed(1) + '%'}
                                ${isValid ? '‚úì' : '‚úó'}
                            </span>
                        </div>
                    `}
                </div>
            `;
        }

        function addNewProduct() {
            const productName = prompt('Enter product name (e.g., OPC, PPC, IL-11):');
            if (!productName) return;
            
            const productId = productName.toLowerCase().replace(/[^a-z0-9]/g, '_');
            
            if (APP_STATE.products[productId]) {
                alert('Product with this name already exists!');
                return;
            }
            
            APP_STATE.products[productId] = {
                id: productId,
                name: productName,
                family: 'portland_cement', // Default family
                recipe: {},
                color: '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')
            };
            
            saveToLocalStorage();
            renderApp();
        }
        
        function updateProductFamily(productId, newFamily) {
            const product = APP_STATE.products[productId];
            if (!product) return;
            
            product.family = newFamily;
            
            // Clear recipe when changing family (optional - prevents invalid combinations)
            // product.recipe = {};
            
            saveToLocalStorage();
            renderApp();
        }
        
        function getFilteredMaterialsForFamily(family) {
            const allProducts = Object.values(APP_STATE.products);
            switch(family) {
                case 'ck_raw':
                case 'fuel':
                    return [];
                case 'cem_raw':
                    return allProducts.filter(p => p.family === 'ck_raw').map(p => p.name);
                case 'portland_cement':
                case 'blended_cement':
                case 'specialty_cement':
                    return allProducts.filter(p => p.family === 'cem_raw').map(p => p.name);
                default:
                    return allProducts.map(p => p.name);
            }
        }

        function addNewProductOfFamily(family) {
            const familyLabels = {
                'ck_raw': 'CK Raw Material (e.g., Limestone, Clay)',
                'cem_raw': 'CEM Raw Material (e.g., Clinker Gray, Gypsum)',
                'fuel': 'Fuel (e.g., Coal, Pet Coke)',
                'portland_cement': 'Portland Cement (e.g., OPC Type I)',
                'blended_cement': 'Blended Cement (e.g., IL-11, PLC)',
                'specialty_cement': 'Specialty Cement (e.g., White Cement, SR)'
            };
            const productName = prompt('Enter ' + (familyLabels[family] || 'product') + ' name:');
            if (!productName) return;
            const productId = productName.toLowerCase().replace(/[^a-z0-9]/g, '_') + '_' + Date.now();
            APP_STATE.products[productId] = {
                id: productId,
                name: productName,
                family: family,
                recipe: {},
                color: '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')
            };
            saveToLocalStorage();
            renderApp();
        }

        function deleteProduct(productId) {
            if (!confirm(`Delete product "${APP_STATE.products[productId].name}"?`)) return;
            
            delete APP_STATE.products[productId];
            saveToLocalStorage();
            renderApp();
        }

        function addMaterialToProduct(productId) {
            const product = APP_STATE.products[productId];
            if (!product) return;
            
            if (!product.recipe) product.recipe = {};
            
            // Find first available material not in recipe
            const usedMaterials = Object.keys(product.recipe);
            let availableMaterial = window.AVAILABLE_RAW_MATERIALS.find(mat => !usedMaterials.includes(mat));
            
            if (!availableMaterial) {
                // If all materials are used, add "New Material"
                availableMaterial = 'New Material';
            }
            
            product.recipe[availableMaterial] = 0;
            
            saveToLocalStorage();
            renderApp();
        }

        function removeMaterial(productId, material) {
            const product = APP_STATE.products[productId];
            if (!product) return;
            
            delete product.recipe[material];
            saveToLocalStorage();
            renderApp();
        }

        function updateMaterialName(productId, oldMaterial, newMaterial) {
            if (newMaterial === '__add_new__') {
                const customMaterial = prompt('Enter new material name:');
                if (!customMaterial) return;
                
                if (!window.AVAILABLE_RAW_MATERIALS.includes(customMaterial)) {
                    window.AVAILABLE_RAW_MATERIALS.push(customMaterial);
                }
                newMaterial = customMaterial;
            }
            
            const product = APP_STATE.products[productId];
            if (!product) return;
            
            const percentage = product.recipe[oldMaterial];
            delete product.recipe[oldMaterial];
            product.recipe[newMaterial] = percentage;
            
            saveToLocalStorage();
            renderApp();
        }

        function updateMaterialPercentage(productId, material, newPercentage) {
            const product = APP_STATE.products[productId];
            if (!product) return;
            
            product.recipe[material] = parseFloat(newPercentage) || 0;
            saveToLocalStorage();
            renderApp();
        }

        function closeRecipeModal() {
            document.getElementById('recipeModal').classList.remove('active');
        }

        // ============================================
        // TAB 2: PROCESS FLOW DESIGNER (Simplified - same as before)
        // ============================================
        
        function renderFlowDesignerTab() {
            return `
                <div class="bg-gray-800 border-b border-gray-700 p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-white font-semibold text-lg">Process Flow Designer</h2>
                            <p class="text-gray-400 text-sm">Design your plant layout and equipment connections</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="btnFlowClear" class="bg-gray-700 text-gray-200 px-3 py-2 rounded text-sm hover:bg-gray-600">
                                üóëÔ∏è Clear
                            </button>
                            <button id="btnFlowLoad" class="bg-gray-700 text-gray-200 px-3 py-2 rounded text-sm hover:bg-gray-600">
                                üìÇ Load
                            </button>
                            <button id="btnFlowSave" class="bg-gray-700 text-gray-200 px-3 py-2 rounded text-sm hover:bg-gray-600">
                                üíæ Export
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex" style="height: calc(100vh - 280px);">
                    <!-- Left Toolbar -->
                    <div id="flowToolbar" class="w-64 bg-gray-800 border-r border-gray-700 p-4 overflow-y-auto">
                        <h3 class="text-white font-semibold mb-2 text-sm">Equipment Library</h3>
                        <p class="text-gray-400 text-xs mb-4">Drag onto canvas ‚Üí</p>
                        <div id="equipmentLibrary"></div>
                    </div>

                    <!-- Main Canvas -->
                    <div id="flowCanvasContainer" class="flex-1 relative bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900">
                        <svg id="flowCanvas" class="absolute inset-0 w-full h-full">
                            <defs>
                                <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                                    <path d="M 40 0 L 0 0 0 40" fill="none" stroke="white" stroke-width="0.5" opacity="0.1"/>
                                </pattern>
                                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                    <polygon points="0 0, 10 3, 0 6" fill="#60a5fa" />
                                </marker>
                            </defs>
                            <rect width="100%" height="100%" fill="url(#grid)" />
                            <g id="connectionsLayer"></g>
                            <g id="equipmentLayer"></g>
                        </svg>

                        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-blue-900 bg-opacity-90 text-white px-6 py-3 rounded-lg border border-blue-500">
                            <div class="flex items-center space-x-4 text-sm">
                                <div>üñ±Ô∏è <span class="font-semibold">Drag</span> from left</div>
                                <div>üîó <span class="font-semibold">Click ports</span> to connect</div>
                                <div>üìù <span class="font-semibold">Double-click</span> to edit</div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel -->
                    <div id="flowRightPanel" class="w-80 bg-gray-800 border-l border-gray-700 p-4 overflow-y-auto">
                        <h3 class="text-white font-semibold mb-4">Inspector</h3>
                        <div id="flowInspector" class="text-gray-400 text-sm">
                            Select equipment to view details
                        </div>
                    </div>
                </div>
            `;
        }

        function initializeFlowDesigner() {
            // Load saved flow
            loadFlowFromLocalStorage();
            
            renderFlowEquipmentLibrary();
            setupFlowDesignerEvents();
            renderFlowCanvas();
        }

        function renderFlowEquipmentLibrary() {
            const library = document.getElementById('equipmentLibrary');
            if (!library) return;
            
            library.innerHTML = '';

            const categories = {
                'Sources': ['raw_material', 'additive', 'fuel'],
                'Processing': ['raw_mill', 'kiln', 'finish_mill', 'packing'],
                'Storage': ['silo'],
                'Dispatch': ['loadout']
            };

            Object.entries(categories).forEach(([category, types]) => {
                const header = document.createElement('div');
                header.className = 'text-xs font-semibold text-gray-400 mb-2 uppercase mt-4';
                header.textContent = category;
                library.appendChild(header);

                types.forEach(type => {
                    const def = EQUIPMENT_TYPES[type];
                    if (!def) return;

                    const el = document.createElement('div');
                    el.className = 'toolbar-item bg-gray-700 rounded-lg p-3 mb-2';
                    el.style.background = `linear-gradient(135deg, ${def.color}, ${adjustColor(def.color, -20)})`;
                    el.style.cursor = 'grab';
                    el.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <div class="text-2xl">${def.icon}</div>
                            <div class="flex-1">
                                <div class="text-white font-semibold text-sm">${def.name}</div>
                            </div>
                        </div>
                    `;
                    el.draggable = true;
                    el.dataset.type = type;
                    
                    el.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('equipmentType', type);
                        el.style.opacity = '0.5';
                    });
                    
                    el.addEventListener('dragend', () => {
                        el.style.opacity = '1';
                    });
                    
                    library.appendChild(el);
                });
            });
        }

        // This contains the updated Flow Designer functions
// Will be inserted into the HTML file

function setupFlowDesignerEvents() {
    const container = document.getElementById('flowCanvasContainer');
    const canvas = document.getElementById('flowCanvas');
    
    if (!container || !canvas) return;

    let isDraggingCanvas = false;
    let isSelecting = false;
    let dragStartX = 0, dragStartY = 0;

    // Mouse wheel zoom
    canvas.addEventListener('wheel', (e) => {
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
        const newZoom = Math.max(0.25, Math.min(2, APP_STATE.flowDesigner.zoom * zoomFactor));
        
        // Zoom towards mouse position
        const zoomChange = newZoom / APP_STATE.flowDesigner.zoom;
        APP_STATE.flowDesigner.panX = mouseX - (mouseX - APP_STATE.flowDesigner.panX) * zoomChange;
        APP_STATE.flowDesigner.panY = mouseY - (mouseY - APP_STATE.flowDesigner.panY) * zoomChange;
        APP_STATE.flowDesigner.zoom = newZoom;
        
        renderFlowCanvas();
    });

    // Selection rectangle & panning
    canvas.addEventListener('mousedown', (e) => {
        if (e.target === canvas || e.target.id === 'equipmentLayer' || e.target.id === 'connectionsLayer') {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left - APP_STATE.flowDesigner.panX) / APP_STATE.flowDesigner.zoom;
            const y = (e.clientY - rect.top - APP_STATE.flowDesigner.panY) / APP_STATE.flowDesigner.zoom;
            
            // Check if clicking on empty space
            const clickedEq = APP_STATE.flowDesigner.equipment.find(eq => {
                const def = EQUIPMENT_TYPES[eq.type];
                return x >= eq.x && x <= eq.x + def.width && y >= eq.y && y <= eq.y + def.height;
            });
            
            if (!clickedEq) {
                // Start selection rectangle
                isSelecting = true;
                APP_STATE.flowDesigner.selection = {
                    active: true,
                    startX: x,
                    startY: y,
                    endX: x,
                    endY: y
                };
                APP_STATE.flowDesigner.selectedIds = []; // Clear selection
            }
        }
    });

    canvas.addEventListener('mousemove', (e) => {
        if (isSelecting) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left - APP_STATE.flowDesigner.panX) / APP_STATE.flowDesigner.zoom;
            const y = (e.clientY - rect.top - APP_STATE.flowDesigner.panY) / APP_STATE.flowDesigner.zoom;
            
            APP_STATE.flowDesigner.selection.endX = x;
            APP_STATE.flowDesigner.selection.endY = y;
            
            // Update selected items
            const minX = Math.min(APP_STATE.flowDesigner.selection.startX, x);
            const maxX = Math.max(APP_STATE.flowDesigner.selection.startX, x);
            const minY = Math.min(APP_STATE.flowDesigner.selection.startY, y);
            const maxY = Math.max(APP_STATE.flowDesigner.selection.startY, y);
            
            APP_STATE.flowDesigner.selectedIds = APP_STATE.flowDesigner.equipment
                .filter(eq => {
                    const def = EQUIPMENT_TYPES[eq.type];
                    return eq.x + def.width > minX && eq.x < maxX && 
                           eq.y + def.height > minY && eq.y < maxY;
                })
                .map(eq => eq.id);
            
            renderFlowCanvas();
        }
    });

    canvas.addEventListener('mouseup', () => {
        if (isSelecting) {
            isSelecting = false;
            APP_STATE.flowDesigner.selection.active = false;
            renderFlowCanvas();
        }
    });

    // Drag & drop from library
    container.addEventListener('dragover', (e) => e.preventDefault());
    container.addEventListener('drop', (e) => {
        e.preventDefault();
        const type = e.dataTransfer.getData('equipmentType');
        if (type) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left - APP_STATE.flowDesigner.panX) / APP_STATE.flowDesigner.zoom;
            const y = (e.clientY - rect.top - APP_STATE.flowDesigner.panY) / APP_STATE.flowDesigner.zoom;
            addFlowEquipment(type, x, y);
        }
    });

    // Buttons
    const btnFlowClear = document.getElementById('btnFlowClear');
    if (btnFlowClear) {
        btnFlowClear.addEventListener('click', () => {
            if (confirm('Clear all equipment?')) {
                APP_STATE.flowDesigner.equipment = [];
                APP_STATE.flowDesigner.connections = [];
                APP_STATE.flowDesigner.selectedEquipment = null;
                APP_STATE.flowDesigner.selectedIds = [];
                renderFlowCanvas();
                saveFlowToLocalStorage();
            }
        });
    }

    const btnFlowSave = document.getElementById('btnFlowSave');
    if (btnFlowSave) btnFlowSave.addEventListener('click', exportFlowToFile);

    const btnFlowLoad = document.getElementById('btnFlowLoad');
    if (btnFlowLoad) btnFlowLoad.addEventListener('click', importFlowFromFile);
}

function renderFlowCanvas() {
    renderFlowConnections();
    renderFlowEquipment();
    renderSelectionRect();
}

function renderSelectionRect() {
    const layer = document.getElementById('equipmentLayer');
    if (!layer) return;
    
    // Remove old selection rect if exists
    const oldRect = document.getElementById('selectionRect');
    if (oldRect) oldRect.remove();
    
    if (!APP_STATE.flowDesigner.selection.active) return;
    
    const sel = APP_STATE.flowDesigner.selection;
    const x = Math.min(sel.startX, sel.endX);
    const y = Math.min(sel.startY, sel.endY);
    const width = Math.abs(sel.endX - sel.startX);
    const height = Math.abs(sel.endY - sel.startY);
    
    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    rect.setAttribute('id', 'selectionRect');
    rect.setAttribute('x', x);
    rect.setAttribute('y', y);
    rect.setAttribute('width', width);
    rect.setAttribute('height', height);
    rect.setAttribute('fill', 'none');
    rect.setAttribute('stroke', '#3b82f6');
    rect.setAttribute('stroke-width', 2 / APP_STATE.flowDesigner.zoom);
    rect.setAttribute('stroke-dasharray', `${10 / APP_STATE.flowDesigner.zoom}`);
    rect.setAttribute('pointer-events', 'none');
    
    layer.appendChild(rect);
}

function renderFlowConnections() {
    const layer = document.getElementById('connectionsLayer');
    if (!layer) return;
    
    layer.innerHTML = '';

    APP_STATE.flowDesigner.connections.forEach(conn => {
        const fromEq = APP_STATE.flowDesigner.equipment.find(e => e.id === conn.from);
        const toEq = APP_STATE.flowDesigner.equipment.find(e => e.id === conn.to);

        if (!fromEq || !toEq) return;

        const fromDef = EQUIPMENT_TYPES[fromEq.type];
        const toDef = EQUIPMENT_TYPES[toEq.type];

        // Auto-smart routing: pick best sides
        const fromCenter = { x: fromEq.x + fromDef.width / 2, y: fromEq.y + fromDef.height / 2 };
        const toCenter = { x: toEq.x + toDef.width / 2, y: toEq.y + toDef.height / 2 };
        
        let fromX, fromY, toX, toY;
        
        // Determine best exit/entry points
        const dx = toCenter.x - fromCenter.x;
        const dy = toCenter.y - fromCenter.y;
        
        // From side selection
        if (Math.abs(dx) > Math.abs(dy)) {
            // Horizontal preference
            if (dx > 0) {
                fromX = fromEq.x + fromDef.width;
                fromY = fromEq.y + fromDef.height / 2;
            } else {
                fromX = fromEq.x;
                fromY = fromEq.y + fromDef.height / 2;
            }
        } else {
            // Vertical preference
            if (dy > 0) {
                fromX = fromEq.x + fromDef.width / 2;
                fromY = fromEq.y + fromDef.height;
            } else {
                fromX = fromEq.x + fromDef.width / 2;
                fromY = fromEq.y;
            }
        }
        
        // To side selection (opposite logic)
        if (Math.abs(dx) > Math.abs(dy)) {
            if (dx > 0) {
                toX = toEq.x;
                toY = toEq.y + toDef.height / 2;
            } else {
                toX = toEq.x + toDef.width;
                toY = toEq.y + toDef.height / 2;
            }
        } else {
            if (dy > 0) {
                toX = toEq.x + toDef.width / 2;
                toY = toEq.y;
            } else {
                toX = toEq.x + toDef.width / 2;
                toY = toEq.y + toDef.height;
            }
        }

        // Create beautiful Bezier curves
        const dx = toX - fromX;
        const dy = toY - fromY;
        
        // Control points create the curve
        let controlX1, controlY1, controlX2, controlY2;
        
        if (Math.abs(dx) > Math.abs(dy)) {
            // Horizontal connection - create vertical curve
            const curveAmount = Math.abs(dy) > 20 ? dy * 0.5 : 50; // Minimum 50px curve
            controlX1 = fromX + dx * 0.4;
            controlY1 = fromY + curveAmount;
            controlX2 = fromX + dx * 0.6;
            controlY2 = toY - curveAmount;
        } else {
            // Vertical connection - create horizontal curve
            const curveAmount = Math.abs(dx) > 20 ? dx * 0.5 : 50; // Minimum 50px curve
            controlX1 = fromX + curveAmount;
            controlY1 = fromY + dy * 0.4;
            controlX2 = toX - curveAmount;
            controlY2 = fromY + dy * 0.6;
        }
        
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        const d = `M ${fromX} ${fromY} C ${controlX1} ${controlY1}, ${controlX2} ${controlY2}, ${toX} ${toY}`;
        path.setAttribute('d', d);
        path.setAttribute('stroke', '#60a5fa');
        path.setAttribute('stroke-width', '4');
        path.setAttribute('fill', 'none');
        path.setAttribute('class', 'connection-line');
        path.setAttribute('marker-end', 'url(#arrowhead)');
        path.setAttribute('opacity', '0.8');
        path.style.cursor = 'pointer';
        path.addEventListener('click', () => {
            if (confirm('Delete connection?')) {
                APP_STATE.flowDesigner.connections = APP_STATE.flowDesigner.connections.filter(c => c.id !== conn.id);
                renderFlowCanvas();
                saveFlowToLocalStorage();
            }
        });

        layer.appendChild(path);
    });
}

function renderFlowEquipment() {
    const layer = document.getElementById('equipmentLayer');
    if (!layer) return;
    
    // Clear but keep selection rect
    const selRect = document.getElementById('selectionRect');
    layer.innerHTML = '';
    if (selRect) layer.appendChild(selRect);

    APP_STATE.flowDesigner.equipment.forEach(eq => {
        const def = EQUIPMENT_TYPES[eq.type];
        const isSelected = APP_STATE.flowDesigner.selectedIds.includes(eq.id);
        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        g.setAttribute('class', `equipment-node ${isSelected ? 'selected' : ''}`);

        // Box with selection highlight
        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', eq.x);
        rect.setAttribute('y', eq.y);
        rect.setAttribute('width', def.width);
        rect.setAttribute('height', def.height);
        rect.setAttribute('rx', 10);
        rect.setAttribute('fill', def.color);
        rect.setAttribute('stroke', isSelected ? '#3b82f6' : 'white');
        rect.setAttribute('stroke-width', isSelected ? 4 : 2);
        if (isSelected) {
            rect.setAttribute('filter', 'drop-shadow(0px 4px 8px rgba(59, 130, 246, 0.5))');
        }
        g.appendChild(rect);

        // Icon
        const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        icon.setAttribute('x', eq.x + def.width / 2);
        icon.setAttribute('y', eq.y + 40);
        icon.setAttribute('text-anchor', 'middle');
        icon.setAttribute('font-size', '32');
        icon.textContent = def.icon;
        g.appendChild(icon);

        // Name
        const name = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        name.setAttribute('x', eq.x + def.width / 2);
        name.setAttribute('y', eq.y + def.height - 20);
        name.setAttribute('text-anchor', 'middle');
        name.setAttribute('fill', 'white');
        name.setAttribute('font-size', '11');
        name.setAttribute('font-weight', 'bold');
        
        let displayName = eq.name;
        if (eq.type === 'raw_material' && eq.params.material_name) {
            displayName = eq.params.material_name;
        } else if (eq.type === 'fuel' && eq.params.fuel_name) {
            displayName = eq.params.fuel_name;
        } else if (eq.type === 'additive' && eq.params.additive_name) {
            displayName = eq.params.additive_name;
        } else if (eq.type === 'kiln' && eq.params.clinker_type) {
            const clinkerTypes = {
                'gray': 'Gray', 'white': 'White', 'oil_well': 'Oil Well',
                'sulphate_resistant': 'SR', 'low_heat': 'Low Heat'
            };
            const typeLabel = clinkerTypes[eq.params.clinker_type] || '';
            displayName = typeLabel ? `${eq.name} (${typeLabel})` : eq.name;
        }
        
        name.textContent = displayName;
        g.appendChild(name);

        // Status indicator
        const status = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        status.setAttribute('cx', eq.x + def.width - 10);
        status.setAttribute('cy', eq.y + 10);
        status.setAttribute('r', 4);
        status.setAttribute('fill', '#10b981');
        g.appendChild(status);

        // Ports
        if (def.outputs.length > 0) {
            const port = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            port.setAttribute('cx', eq.x + def.width);
            port.setAttribute('cy', eq.y + def.height / 2);
            port.setAttribute('r', 6);
            port.setAttribute('fill', '#3b82f6');
            port.setAttribute('class', 'port');
            port.addEventListener('click', (e) => {
                e.stopPropagation();
                startFlowConnection(eq.id);
            });
            g.appendChild(port);
        }

        if (def.inputs.length > 0) {
            const port = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            port.setAttribute('cx', eq.x);
            port.setAttribute('cy', eq.y + def.height / 2);
            port.setAttribute('r', 6);
            port.setAttribute('fill', '#10b981');
            port.setAttribute('class', 'port');
            port.addEventListener('click', (e) => {
                e.stopPropagation();
                completeFlowConnection(eq.id);
            });
            g.appendChild(port);
        }

        // Click to select
        g.addEventListener('click', (e) => {
            if (!e.target.classList.contains('port')) {
                selectFlowEquipment(eq.id);
            }
        });

        // Multi-select drag
        let isDragging = false;
        let startX, startY;
        let dragOffsets = [];

        g.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('port')) return;
            isDragging = true;
            
            if (!isSelected) {
                APP_STATE.flowDesigner.selectedIds = [eq.id];
                renderFlowCanvas();
            }
            
            // Calculate offsets for all selected items
            dragOffsets = APP_STATE.flowDesigner.selectedIds.map(id => {
                const item = APP_STATE.flowDesigner.equipment.find(e => e.id === id);
                return {
                    id: id,
                    offsetX: e.clientX / APP_STATE.flowDesigner.zoom - item.x,
                    offsetY: e.clientY / APP_STATE.flowDesigner.zoom - item.y
                };
            });
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                dragOffsets.forEach(offset => {
                    const item = APP_STATE.flowDesigner.equipment.find(eq => eq.id === offset.id);
                    if (item) {
                        item.x = e.clientX / APP_STATE.flowDesigner.zoom - offset.offsetX;
                        item.y = e.clientY / APP_STATE.flowDesigner.zoom - offset.offsetY;
                    }
                });
                renderFlowCanvas();
            }
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                saveFlowToLocalStorage();
            }
        });

        layer.appendChild(g);
    });
    
    // Apply zoom/pan transform
    const equipLayer = document.getElementById('equipmentLayer');
    const connLayer = document.getElementById('connectionsLayer');
    if (equipLayer) equipLayer.setAttribute('transform', `translate(${APP_STATE.flowDesigner.panX}, ${APP_STATE.flowDesigner.panY}) scale(${APP_STATE.flowDesigner.zoom})`);
    if (connLayer) connLayer.setAttribute('transform', `translate(${APP_STATE.flowDesigner.panX}, ${APP_STATE.flowDesigner.panY}) scale(${APP_STATE.flowDesigner.zoom})`);
}

function selectFlowEquipment(id) {
    APP_STATE.flowDesigner.selectedEquipment = id;
    APP_STATE.flowDesigner.selectedIds = [id];
    renderFlowCanvas();
    updateFlowInspector();
}

                function addFlowEquipment(type, x, y) {
            const def = EQUIPMENT_TYPES[type];
            
            // For finish mills, populate available products from products tab
            let params = { ...def.defaultParams };
            if (type === 'finish_mill') {
                params.available_products = Object.keys(APP_STATE.products);
            }
            
            const equipment = {
                id: `eq_${APP_STATE.flowDesigner.nextId++}`,
                type: type,
                name: `${def.name} ${APP_STATE.flowDesigner.nextId - 1}`,
                x: x - def.width / 2,
                y: y - def.height / 2,
                params: params
            };
            
            APP_STATE.flowDesigner.equipment.push(equipment);
            renderFlowCanvas();
            saveFlowToLocalStorage();
        }

        function renderFlowCanvas() {
            renderFlowConnections();
            renderFlowEquipment();
        }

        function renderFlowConnections() {
            const layer = document.getElementById('connectionsLayer');
            if (!layer) return;
            
            layer.innerHTML = '';

            APP_STATE.flowDesigner.connections.forEach(conn => {
                const fromEq = APP_STATE.flowDesigner.equipment.find(e => e.id === conn.from);
                const toEq = APP_STATE.flowDesigner.equipment.find(e => e.id === conn.to);

                if (!fromEq || !toEq) return;

                const fromDef = EQUIPMENT_TYPES[fromEq.type];
                const toDef = EQUIPMENT_TYPES[toEq.type];

                const fromX = fromEq.x + fromDef.width;
                const fromY = fromEq.y + fromDef.height / 2;
                const toX = toEq.x;
                const toY = toEq.y + toDef.height / 2;

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const d = `M ${fromX} ${fromY} L ${toX} ${toY}`;
                line.setAttribute('d', d);
                line.setAttribute('class', 'connection-line');
                line.setAttribute('marker-end', 'url(#arrowhead)');
                line.addEventListener('click', () => {
                    if (confirm('Delete connection?')) {
                        APP_STATE.flowDesigner.connections = APP_STATE.flowDesigner.connections.filter(c => c.id !== conn.id);
                        renderFlowCanvas();
                        saveFlowToLocalStorage();
                    }
                });

                layer.appendChild(line);
            });
        }

        function renderFlowEquipment() {
            const layer = document.getElementById('equipmentLayer');
            if (!layer) return;
            
            layer.innerHTML = '';

            APP_STATE.flowDesigner.equipment.forEach(eq => {
                const def = EQUIPMENT_TYPES[eq.type];
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('class', `equipment-node ${APP_STATE.flowDesigner.selectedEquipment === eq.id ? 'selected' : ''}`);

                // Box
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', eq.x);
                rect.setAttribute('y', eq.y);
                rect.setAttribute('width', def.width);
                rect.setAttribute('height', def.height);
                rect.setAttribute('rx', 10);
                rect.setAttribute('fill', def.color);
                rect.setAttribute('stroke', 'white');
                rect.setAttribute('stroke-width', 2);
                g.appendChild(rect);

                // Icon
                const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                icon.setAttribute('x', eq.x + def.width / 2);
                icon.setAttribute('y', eq.y + 40);
                icon.setAttribute('text-anchor', 'middle');
                icon.setAttribute('font-size', '32');
                icon.textContent = def.icon;
                g.appendChild(icon);

                // Name
                const name = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                name.setAttribute('x', eq.x + def.width / 2);
                name.setAttribute('y', eq.y + def.height - 20);
                name.setAttribute('text-anchor', 'middle');
                name.setAttribute('fill', 'white');
                name.setAttribute('font-size', '11');
                name.setAttribute('font-weight', 'bold');
                
                let displayName = eq.name;
                if (eq.type === 'raw_material' && eq.params.material_name) {
                    displayName = eq.params.material_name;
                } else if (eq.type === 'fuel' && eq.params.fuel_name) {
                    displayName = eq.params.fuel_name;
                } else if (eq.type === 'additive' && eq.params.additive_name) {
                    displayName = eq.params.additive_name;
                } else if (eq.type === 'kiln' && eq.params.clinker_type) {
                    // Add clinker type to kiln name
                    const clinkerTypes = {
                        'gray': 'Gray',
                        'white': 'White',
                        'oil_well': 'Oil Well',
                        'sulphate_resistant': 'SR',
                        'low_heat': 'Low Heat'
                    };
                    const typeLabel = clinkerTypes[eq.params.clinker_type] || '';
                    displayName = typeLabel ? `${eq.name} (${typeLabel})` : eq.name;
                }
                
                name.textContent = displayName;
                g.appendChild(name);

                // Status
                const status = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                status.setAttribute('cx', eq.x + def.width - 10);
                status.setAttribute('cy', eq.y + 10);
                status.setAttribute('r', 4);
                status.setAttribute('fill', '#10b981');
                g.appendChild(status);

                // Ports
                if (def.outputs.length > 0) {
                    const port = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    port.setAttribute('cx', eq.x + def.width);
                    port.setAttribute('cy', eq.y + def.height / 2);
                    port.setAttribute('r', 6);
                    port.setAttribute('fill', '#3b82f6');
                    port.setAttribute('class', 'port');
                    port.addEventListener('click', (e) => {
                        e.stopPropagation();
                        startFlowConnection(eq.id);
                    });
                    g.appendChild(port);
                }

                if (def.inputs.length > 0) {
                    const port = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    port.setAttribute('cx', eq.x);
                    port.setAttribute('cy', eq.y + def.height / 2);
                    port.setAttribute('r', 6);
                    port.setAttribute('fill', '#10b981');
                    port.setAttribute('class', 'port');
                    port.addEventListener('click', (e) => {
                        e.stopPropagation();
                        completeFlowConnection(eq.id);
                    });
                    g.appendChild(port);
                }

                // Events
                g.addEventListener('click', () => selectFlowEquipment(eq.id));

                // Drag
                let isDragging = false;
                let startX, startY;

                g.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('port')) return;
                    isDragging = true;
                    startX = e.clientX - eq.x;
                    startY = e.clientY - eq.y;
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        eq.x = e.clientX - startX;
                        eq.y = e.clientY - startY;
                        renderFlowCanvas();
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        saveFlowToLocalStorage();
                    }
                });

                layer.appendChild(g);
            });
        }

        function startFlowConnection(equipmentId) {
            APP_STATE.flowDesigner.connecting = { from: equipmentId };
        }

        function completeFlowConnection(equipmentId) {
            if (!APP_STATE.flowDesigner.connecting) return;

            const fromEq = APP_STATE.flowDesigner.equipment.find(e => e.id === APP_STATE.flowDesigner.connecting.from);
            const toEq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);

            if (!fromEq || !toEq || fromEq.id === toEq.id) {
                APP_STATE.flowDesigner.connecting = null;
                return;
            }

            const fromType = EQUIPMENT_TYPES[fromEq.type];
            const toType = EQUIPMENT_TYPES[toEq.type];

            const canConnect = fromType.outputs.some(out => toType.inputs.includes(out));

            if (canConnect) {
                const connection = {
                    id: `conn_${APP_STATE.flowDesigner.nextId++}`,
                    from: fromEq.id,
                    to: toEq.id,
                    material: fromType.outputs.find(out => toType.inputs.includes(out))
                };
                APP_STATE.flowDesigner.connections.push(connection);
                saveFlowToLocalStorage();
            } else {
                alert('Incompatible materials!');
            }

            APP_STATE.flowDesigner.connecting = null;
            renderFlowCanvas();
        }

        function selectFlowEquipment(id) {
            APP_STATE.flowDesigner.selectedEquipment = id;
            renderFlowCanvas();
            updateFlowInspector();
        }

        function updateFlowInspector() {
            const panel = document.getElementById('flowInspector');
            if (!panel) return;
            
            if (!APP_STATE.flowDesigner.selectedEquipment) {
                panel.innerHTML = '<div class="text-gray-400 text-sm">Select equipment to view specs</div>';
                return;
            }

            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === APP_STATE.flowDesigner.selectedEquipment);
            if (!eq) return;

            const def = EQUIPMENT_TYPES[eq.type];

            let specsHTML = '';

            // Generate specs form based on equipment type
            if (eq.type === 'kiln') {
                specsHTML = `
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Clinker Type</label>
                            <select onchange="updateEquipmentParam('${eq.id}', 'clinker_type', this.value)"
                                    class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                                <option value="gray" ${(eq.params.clinker_type || 'gray') === 'gray' ? 'selected' : ''}>Gray Clinker (OPC)</option>
                                <option value="white" ${eq.params.clinker_type === 'white' ? 'selected' : ''}>White Clinker</option>
                                <option value="oil_well" ${eq.params.clinker_type === 'oil_well' ? 'selected' : ''}>Oil Well Cement Clinker</option>
                                <option value="sulphate_resistant" ${eq.params.clinker_type === 'sulphate_resistant' ? 'selected' : ''}>Sulphate Resistant Clinker</option>
                                <option value="low_heat" ${eq.params.clinker_type === 'low_heat' ? 'selected' : ''}>Low Heat Clinker</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Type of clinker produced by this kiln</p>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">TPD (Tons Per Day)</label>
                            <input type="number" value="${eq.params.tpd || 2000}" 
                                   onchange="updateEquipmentParam('${eq.id}', 'tpd', parseFloat(this.value))"
                                   class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">GCal/TM of Clinker</label>
                            <input type="number" value="${eq.params.gcal_per_tm_ck || 750}" step="0.1"
                                   onchange="updateEquipmentParam('${eq.id}', 'gcal_per_tm_ck', parseFloat(this.value))"
                                   class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Raw Meal to Clinker Factor</label>
                            <input type="number" value="${eq.params.rm_to_clinker_factor || 1.55}" step="0.01"
                                   onchange="updateEquipmentParam('${eq.id}', 'rm_to_clinker_factor', parseFloat(this.value))"
                                   class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                        </div>
                    </div>
                `;
            } else if (eq.type === 'finish_mill') {
                const availableProducts = Object.keys(APP_STATE.products);
                if (!eq.params.products) eq.params.products = {};
                
                specsHTML = `
                    <div class="space-y-3">
                        <div class="text-xs font-semibold text-gray-300 mb-2">Products & Capacity</div>
                        ${availableProducts.map(prodId => {
                            const product = APP_STATE.products[prodId];
                            const isEnabled = eq.params.products[prodId]?.enabled || false;
                            const tpd = eq.params.products[prodId]?.tpd || 0;
                            
                            return `
                                <div class="bg-gray-800 rounded p-3 border border-gray-700">
                                    <div class="flex items-center justify-between mb-2">
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input type="checkbox" ${isEnabled ? 'checked' : ''} 
                                                   onchange="toggleProductForMill('${eq.id}', '${prodId}', this.checked)"
                                                   class="rounded">
                                            <span class="text-sm font-semibold text-white">${product.name}</span>
                                        </label>
                                    </div>
                                    ${isEnabled ? `
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">TPD Capacity</label>
                                            <input type="number" value="${tpd}" 
                                                   onchange="updateMillProductTPD('${eq.id}', '${prodId}', parseFloat(this.value))"
                                                   class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-sm">
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else if (eq.type === 'silo') {
                // Collect all materials available in the factory
                const allMaterials = [
                    // Raw materials from Tab 1
                    ...window.AVAILABLE_RAW_MATERIALS,
                    // Products from Tab 1
                    ...Object.values(APP_STATE.products).map(p => p.name),
                    // Process intermediates
                    'Raw Meal',
                    'Clinker',
                    'Cement (Bulk)',
                    'Packed Cement'
                ];
                
                // Remove duplicates
                const uniqueMaterials = [...new Set(allMaterials)];
                
                specsHTML = `
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Material Type</label>
                            <select onchange="updateEquipmentParam('${eq.id}', 'material_type', this.value)"
                                    class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                                <option value="">-- Select Material --</option>
                                ${uniqueMaterials.map(material => 
                                    `<option value="${material}" ${eq.params.material_type === material ? 'selected' : ''}>${material}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Min Volume (Tons)</label>
                            <input type="number" value="${eq.params.min_volume || 2000}" 
                                   onchange="updateEquipmentParam('${eq.id}', 'min_volume', parseFloat(this.value))"
                                   class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Max Volume (Tons)</label>
                            <input type="number" value="${eq.params.max_volume || 15000}" 
                                   onchange="updateEquipmentParam('${eq.id}', 'max_volume', parseFloat(this.value))"
                                   class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                        </div>
                    </div>
                `;
            } else if (eq.type === 'packing') {
                const availableProducts = Object.keys(APP_STATE.products);
                specsHTML = `
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Product</label>
                            <select onchange="updateEquipmentParam('${eq.id}', 'product', this.value)"
                                    class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                                <option value="">-- Select Product --</option>
                                ${availableProducts.map(prodId => {
                                    const product = APP_STATE.products[prodId];
                                    return `<option value="${prodId}" ${eq.params.product === prodId ? 'selected' : ''}>${product.name}</option>`;
                                }).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Pallets per Hour</label>
                            <input type="number" value="${eq.params.pallets_per_hour || 100}" 
                                   onchange="updateEquipmentParam('${eq.id}', 'pallets_per_hour', parseFloat(this.value))"
                                   class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Hours of Operation</label>
                            <input type="number" value="${eq.params.hours_operation || 18}" 
                                   onchange="updateEquipmentParam('${eq.id}', 'hours_operation', parseFloat(this.value))"
                                   class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                        </div>
                    </div>
                `;
            } else if (eq.type === 'loadout') {
                specsHTML = `
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Loads per Hour</label>
                            <input type="number" value="${eq.params.loads_per_hour || 4}" step="0.1"
                                   onchange="updateEquipmentParam('${eq.id}', 'loads_per_hour', parseFloat(this.value))"
                                   class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                            <div class="text-xs text-gray-500 mt-1">
                                ~${Math.round((eq.params.loads_per_hour || 4) * 25)} TPH (avg 25 tons/load)
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Hours of Operation</label>
                            <input type="number" value="${eq.params.hours_operation || 16}" min="0" max="24"
                                   onchange="updateEquipmentParam('${eq.id}', 'hours_operation', parseFloat(this.value))"
                                   class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                        </div>
                    </div>
                `;
            } else {
                // Generic parameters for other equipment
                specsHTML = `
                    <div class="text-xs text-gray-400">
                        Basic equipment - no additional specs required
                    </div>
                `;
            }

            panel.innerHTML = `
                <div class="bg-gray-900 rounded-lg p-4 mb-4">
                    <div class="mb-3">
                        <label class="block text-xs font-semibold text-gray-300 mb-1">Equipment Name</label>
                        <input type="text" value="${eq.name}" 
                               onchange="updateEquipmentName('${eq.id}', this.value)"
                               class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm font-semibold">
                    </div>
                    <div class="text-xs text-gray-400 mb-3">Type: ${def.name}</div>
                    ${specsHTML}
                </div>
                <div class="bg-gray-900 rounded-lg p-4">
                    <button onclick="removeFlowEquipment('${eq.id}')" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded text-sm">
                        üóëÔ∏è Remove Equipment
                    </button>
                </div>
            `;
        }

        function updateEquipmentParam(equipmentId, paramName, value) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq) return;
            
            eq.params[paramName] = value;
            saveFlowToLocalStorage();
            updateFlowInspector(); // Refresh to show updated values
        }

        function updateEquipmentName(equipmentId, newName) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq) return;
            
            eq.name = newName;
            saveFlowToLocalStorage();
            renderFlowCanvas(); // Re-render to show new name on canvas
            updateFlowInspector(); // Refresh inspector
        }

        function toggleProductForMill(equipmentId, productId, enabled) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq) return;
            
            if (!eq.params.products) eq.params.products = {};
            
            if (enabled) {
                eq.params.products[productId] = { enabled: true, tpd: 0 };
            } else {
                delete eq.params.products[productId];
            }
            
            saveFlowToLocalStorage();
            updateFlowInspector();
        }

        function updateMillProductTPD(equipmentId, productId, tpd) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq || !eq.params.products || !eq.params.products[productId]) return;
            
            eq.params.products[productId].tpd = tpd;
            saveFlowToLocalStorage();
        }

        function removeFlowEquipment(id) {
            if (confirm('Remove equipment?')) {
                APP_STATE.flowDesigner.equipment = APP_STATE.flowDesigner.equipment.filter(e => e.id !== id);
                APP_STATE.flowDesigner.connections = APP_STATE.flowDesigner.connections.filter(c => c.from !== id && c.to !== id);
                APP_STATE.flowDesigner.selectedEquipment = null;
                renderFlowCanvas();
                updateFlowInspector();
                saveFlowToLocalStorage();
            }
        }

        // ============================================
        // TAB 3: DEMAND PLANNING
        // ============================================
        
        function renderDemandPlanningTab() {
            const products = Object.values(APP_STATE.products);
            
            if (products.length === 0) {
                return `
                    <div class="p-6">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
                            <svg class="w-16 h-16 mx-auto text-yellow-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">No Products Defined</h3>
                            <p class="text-gray-600 mb-4">Define products in Tab 1 first</p>
                            <button onclick="switchTab('products')" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                                Go to Products & Recipes
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // Get date range: 30 days back + today + 60 days forward
            const today = new Date(APP_STATE.currentDate);
            const startDate = new Date(today);
            startDate.setDate(startDate.getDate() - 30);
            
            const endDate = new Date(today);
            endDate.setDate(endDate.getDate() + 60);
            
            const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            
            return `
                <div class="bg-white border-b border-gray-200 px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Demand Planning</h2>
                            <p class="text-sm text-gray-500">Daily demand requirements by product (TPD)</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="flex items-center space-x-2 text-sm">
                                <div class="flex items-center space-x-1">
                                    <div class="w-3 h-3 bg-white border border-gray-300"></div>
                                    <span class="text-gray-600">Actual</span>
                                </div>
                                <div class="flex items-center space-x-1 ml-3">
                                    <div class="w-3 h-3 bg-blue-50 border border-blue-200"></div>
                                    <span class="text-gray-600">Today</span>
                                </div>
                                <div class="flex items-center space-x-1 ml-3">
                                    <div class="w-3 h-3 bg-yellow-50 border border-yellow-200"></div>
                                    <span class="text-gray-600">Forecast</span>
                                </div>
                            </div>
                            <button onclick="exportDemandData()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
                                üì• Export Demand
                            </button>
                        </div>
                    </div>
                </div>

                <div class="p-6">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        ${renderDemandGrid(products, startDate, totalDays, today)}
                    </div>
                </div>
            `;
        }

        function renderDemandGrid(products, startDate, totalDays, today) {
            // Use shared date header generation
            const dateHeaders = generateDateHeaders(startDate, totalDays, today);
            
            return `
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-100 border-b-2 border-gray-300">
                                <th class="sticky left-0 bg-gray-100 z-10 px-4 py-3 text-left font-semibold text-gray-700 border-r border-gray-300" style="min-width: 200px;">
                                    Product
                                </th>
                                ${dateHeaders.map(header => `
                                    <th class="px-3 py-2 text-center border-l border-gray-200 ${header.isWeekend ? 'bg-gray-200' : ''}" style="min-width: 80px;">
                                        <div class="text-xs font-semibold text-gray-600">${header.dayName}</div>
                                        <div class="text-sm font-bold text-gray-900">${header.month} ${header.day}</div>
                                    </th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${products.map(product => renderDemandProductRow(product, dateHeaders)).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderDemandProductRow(product, dateHeaders) {
            return `
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                    <td class="sticky left-0 bg-white z-10 px-4 py-3 font-semibold border-r border-gray-300" style="min-width: 200px;">
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 rounded-full" style="background-color: ${product.color};"></div>
                            <span>${product.name}</span>
                        </div>
                    </td>
                    ${dateHeaders.map(header => {
                        const demandData = getDemandForDate(product.id, header.dateStr);
                        const value = demandData.value || 0;
                        
                        let bgClass = 'bg-white';
                        if (header.isToday) {
                            bgClass = 'bg-blue-50';
                        } else if (header.isFuture) {
                            bgClass = 'bg-yellow-50';
                        }
                        
                        if (header.isWeekend) {
                            bgClass += ' opacity-60';
                        }
                        
                        return `
                            <td class="border-l border-gray-200 ${bgClass} ${header.isWeekend ? 'bg-gray-100' : ''}">
                                <input type="number" 
                                       value="${value}" 
                                       min="0"
                                       onchange="updateDemandValue('${product.id}', '${header.dateStr}', parseFloat(this.value) || 0)"
                                       class="w-full px-2 py-2 text-center text-sm border-0 ${bgClass} ${header.isWeekend ? 'bg-gray-100' : ''} focus:ring-2 focus:ring-blue-500"
                                       style="min-width: 80px;">
                            </td>
                        `;
                    }).join('')}
                </tr>
            `;
        }

        function getDemandForDate(productId, dateStr) {
            if (!APP_STATE.demandPlan) APP_STATE.demandPlan = {};
            if (!APP_STATE.demandPlan[productId]) APP_STATE.demandPlan[productId] = {};
            
            return APP_STATE.demandPlan[productId][dateStr] || { value: 0, type: 'forecast' };
        }

        function updateDemandValue(productId, dateStr, value) {
            if (!APP_STATE.demandPlan) APP_STATE.demandPlan = {};
            if (!APP_STATE.demandPlan[productId]) APP_STATE.demandPlan[productId] = {};
            
            APP_STATE.demandPlan[productId][dateStr] = {
                value: value,
                type: 'forecast' // Can be 'actual' or 'forecast'
            };
            
            saveToLocalStorage();
        }

        function exportDemandData() {
            const data = {
                demandPlan: APP_STATE.demandPlan,
                products: APP_STATE.products,
                exportedAt: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `demand_plan_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Demand data exported!');
        }

        // ============================================
        // SHARED UTILITY: Generate Date Headers
        // ============================================
        
        function generateDateHeaders(startDate, totalDays, today) {
            const dateHeaders = [];
            for (let i = 0; i < totalDays; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + i);
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isToday = date.toDateString() === today.toDateString();
                const isPast = date < today;
                const isFuture = date > today;
                
                dateHeaders.push({
                    date: date,
                    dateStr: getDateString(date),
                    day: date.getDate(),
                    month: date.toLocaleDateString('en-US', { month: 'short' }),
                    dayName: date.toLocaleDateString('en-US', { weekday: 'short' }),
                    isWeekend: isWeekend,
                    isToday: isToday,
                    isPast: isPast,
                    isFuture: isFuture,
                    columnIndex: i
                });
            }
            return dateHeaders;
        }

        // ============================================
        // ============================================
        // TAB 4: PRODUCTION PLAN (Simple Working Version)
        // ============================================
        
        function renderProductionPlanTab() {
            // Get equipment from flow designer
            const silos = APP_STATE.flowDesigner.equipment.filter(e => e.type === 'silo');
            const kilns = APP_STATE.flowDesigner.equipment.filter(e => e.type === 'kiln');
            const finishMills = APP_STATE.flowDesigner.equipment.filter(e => e.type === 'finish_mill');
            const packers = APP_STATE.flowDesigner.equipment.filter(e => e.type === 'packing');
            const loadouts = APP_STATE.flowDesigner.equipment.filter(e => e.type === 'loadout');
            
            const allEquipment = [...kilns, ...finishMills, ...packers, ...loadouts];
            const products = Object.values(APP_STATE.products);
            
            // Date range: 30 days back + today + 60 days forward (same as Demand Planning)
            const today = new Date(APP_STATE.currentDate);
            const startDate = new Date(today);
            startDate.setDate(startDate.getDate() - 30);
            const totalDays = 91;
            
            // Generate date headers (reuse from Demand Planning)
            const dateHeaders = [];
            for (let i = 0; i < totalDays; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + i);
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isToday = date.toDateString() === today.toDateString();
                const isPast = date < today;
                const isFuture = date > today;
                
                dateHeaders.push({
                    date: date,
                    dateStr: getDateString(date),
                    day: date.getDate(),
                    month: date.toLocaleDateString('en-US', { month: 'short' }),
                    dayName: date.toLocaleDateString('en-US', { weekday: 'short' }),
                    isWeekend: isWeekend,
                    isToday: isToday,
                    isPast: isPast,
                    isFuture: isFuture,
                    dayIndex: i
                });
            }
            
            return `
                <div class="bg-white border-b border-gray-200 px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Production Plan - Daily Timeline</h2>
                            <p class="text-sm text-gray-500">Manage campaigns to optimize production and avoid inventory overflow</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="flex items-center space-x-2 text-xs mr-4">
                                <div class="flex items-center space-x-1">
                                    <div class="w-4 h-4 bg-green-200 border-2 border-green-600 rounded"></div>
                                    <span>Active</span>
                                </div>
                                <div class="flex items-center space-x-1">
                                    <div class="w-4 h-4 bg-red-200 border-2 border-red-600 rounded"></div>
                                    <span>Outage</span>
                                </div>
                                <div class="flex items-center space-x-1">
                                    <div class="w-4 h-4 bg-amber-200 border-2 border-amber-600 rounded"></div>
                                    <span>Reduced</span>
                                </div>
                                <div class="flex items-center space-x-1">
                                    <div class="w-4 h-4 bg-gray-200 border-2 border-gray-600 rounded"></div>
                                    <span>Stopped</span>
                                </div>
                            </div>
                            <button onclick="optimizeCampaigns()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm">
                                ü§ñ AI Optimize
                            </button>
                            <button onclick="exportProductionPlan()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
                                üì• Export
                            </button>
                        </div>
                    </div>
                </div>

                <div class="p-6">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <!-- Floating scrollbar - always visible -->
                        <div class="scrollbar-container" id="topScrollbar">
                            <div class="scrollbar-content" id="topScrollbarContent"></div>
                        </div>
                        
                        <!-- Main table with scroll -->
                        <div class="overflow-x-scroll overflow-y-visible" id="tableScrollContainer" style="overflow-x: scroll; -webkit-overflow-scrolling: touch;">
                            <table class="w-full border-collapse">
                                <!-- HEADER ROW -->
                                <thead class="sticky top-0 z-20 bg-gray-100">
                                    <tr class="border-b-2 border-gray-300">
                                        <th class="sticky left-0 bg-gray-100 z-30 px-4 py-3 text-left font-semibold text-gray-700 border-r border-gray-300" style="min-width: 250px;">
                                            Equipment / Product
                                        </th>
                                        ${dateHeaders.map(header => `
                                            <th class="px-3 py-2 text-center border-l border-gray-200 ${header.isWeekend ? 'bg-gray-200' : ''}" style="min-width: 80px;">
                                                <div class="text-xs font-semibold text-gray-600">${header.dayName}</div>
                                                <div class="text-sm font-bold text-gray-900">${header.month} ${header.day}</div>
                                            </th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                
                                <tbody>
                                    <!-- SECTION 1: INVENTORY -->
                                    ${renderInventorySection(products, silos, dateHeaders)}
                                    
                                    <!-- SECTION 2: KILNS -->
                                    ${renderKilnSection(kilns, dateHeaders)}
                                    
                                    <!-- SECTION 3: FINISH MILLS -->
                                    ${renderFinishMillSection(finishMills, dateHeaders, products)}
                                    
                                    <!-- SECTION 4: PACKERS -->
                                    ${renderPackerSection(packers, dateHeaders, products)}
                                    
                                    <!-- SECTION 5: LOAD OUT -->
                                    ${renderLoadoutSection(loadouts, dateHeaders)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderInventorySection(products, silos, dateHeaders) {
            if (products.length === 0) return '';
            
            let html = `
                <tr class="bg-gray-800">
                    <td class="sticky left-0 bg-gray-800 z-10 px-4 py-2 font-bold text-white border-t-2 border-gray-900" style="min-width: 250px;">
                        üì¶ DAILY PRODUCT INVENTORY (Beginning of Day)
                    </td>
                    <td colspan="${dateHeaders.length}" class="bg-gray-800 px-4 py-2 font-bold text-white border-t-2 border-gray-900"></td>
                </tr>
            `;
            
            // Show inventory rows for each product
            products.forEach(product => {
                // Find silos that hold this product
                const productSilos = silos.filter(s => s.params.material_type === product.name);
                
                if (productSilos.length > 0) {
                    productSilos.forEach(silo => {
                        html += `
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="sticky left-0 bg-white z-10 px-4 py-2 text-sm border-r border-gray-300">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-2">
                                            <div class="w-3 h-3 rounded-full" style="background-color: ${product.color};"></div>
                                            <span class="font-medium">${product.name}</span>
                                            <span class="text-gray-500">‚Ä¢ ${silo.name}</span>
                                        </div>
                                        <div class="text-xs text-gray-400">
                                            Max: ${formatNumber(silo.params.max_volume || 15000)}t
                                        </div>
                                    </div>
                                </td>
                                ${dateHeaders.map(header => {
                                    let bgClass = 'bg-white';
                                    if (header.isToday) bgClass = 'bg-blue-50';
                                    else if (header.isFuture) bgClass = 'bg-yellow-50';
                                    if (header.isWeekend) bgClass += ' opacity-60';
                                    
                                    // Placeholder inventory value
                                    const inventory = 5000 + Math.random() * 3000;
                                    const maxCapacity = silo.params.max_volume || 15000;
                                    const percentFull = (inventory / maxCapacity) * 100;
                                    
                                    // Warning colors based on capacity
                                    let textClass = 'text-gray-900';
                                    if (percentFull > 90) textClass = 'text-red-600 font-bold';
                                    else if (percentFull > 75) textClass = 'text-amber-600 font-semibold';
                                    
                                    return `
                                        <td class="border-l border-gray-200 ${bgClass} px-2 py-2 text-center text-sm ${textClass}">
                                            ${formatNumber(Math.round(inventory))}
                                        </td>
                                    `;
                                }).join('')}
                            </tr>
                        `;
                    });
                } else {
                    // Show inventory row without silo
                    html += `
                        <tr class="border-b border-gray-200 hover:bg-gray-50">
                            <td class="sticky left-0 bg-white z-10 px-4 py-2 text-sm border-r border-gray-300">
                                <div class="flex items-center space-x-2">
                                    <div class="w-3 h-3 rounded-full" style="background-color: ${product.color};"></div>
                                    <span class="font-medium">${product.name}</span>
                                    <span class="text-amber-600 text-xs">‚ö† No silo configured</span>
                                </div>
                            </td>
                            ${dateHeaders.map(header => {
                                let bgClass = 'bg-white';
                                if (header.isToday) bgClass = 'bg-blue-50';
                                else if (header.isFuture) bgClass = 'bg-yellow-50';
                                if (header.isWeekend) bgClass += ' opacity-60';
                                
                                return `
                                    <td class="border-l border-gray-200 ${bgClass} px-2 py-2 text-center text-sm text-gray-400">
                                        -
                                    </td>
                                `;
                            }).join('')}
                        </tr>
                    `;
                }
            });
            
            return html;
        }

        function renderKilnSection(kilns, dateHeaders) {
            if (kilns.length === 0) return '';
            
            let html = `
                <tr class="bg-gray-800">
                    <td class="sticky left-0 bg-gray-800 z-10 px-4 py-2 font-bold text-white border-t-2 border-gray-900" style="min-width: 250px;">
                        üî• KILNS
                    </td>
                    <td colspan="${dateHeaders.length}" class="bg-gray-800 px-4 py-2 font-bold text-white border-t-2 border-gray-900"></td>
                </tr>
            `;
            
            kilns.forEach(kiln => {
                const nominalTPD = kiln.params.tpd || 2000;
                const clinkerType = kiln.params.clinker_type || 'gray';
                const clinkerTypeLabels = {
                    'gray': 'Gray',
                    'white': 'White',
                    'oil_well': 'Oil Well',
                    'sulphate_resistant': 'SR',
                    'low_heat': 'Low Heat'
                };
                const clinkerLabel = clinkerTypeLabels[clinkerType];
                
                html += `
                    <tr class="border-b border-gray-200 hover:bg-gray-50 group">
                        <td class="sticky left-0 bg-white z-10 px-4 py-2 font-medium text-sm border-r border-gray-300">
                            <div class="flex items-center justify-between mb-1">
                                <div>
                                    <div class="font-semibold">${kiln.name}</div>
                                    <div class="text-xs text-gray-600">${clinkerLabel} Clinker</div>
                                </div>
                                <span class="text-xs text-gray-500">Nom: ${formatNumber(nominalTPD)} TPD</span>
                            </div>
                            <button onclick="addNewCampaign('${kiln.id}')" 
                                    class="text-xs text-blue-600 hover:text-blue-800 hover:bg-blue-50 px-2 py-1 rounded border border-blue-300 w-full">
                                + Add Campaign
                            </button>
                        </td>
                        ${renderKilnDailyCells(kiln, dateHeaders)}
                    </tr>
                `;
            });
            
            return html;
        }
        
        function renderKilnDailyCells(kiln, dateHeaders) {
            // Split into PAST and FUTURE sections
            const pastHeaders = dateHeaders.filter(h => h.isPast);
            const futureHeaders = dateHeaders.filter(h => !h.isPast); // Today + future
            
            let html = '';
            
            // PAST: Individual cells with bold numbers
            pastHeaders.forEach(header => {
                // Get actual production for this day (sample data for now)
                const actualTPD = getActualProduction(kiln.id, header.dateStr);
                
                let bgClass = 'bg-white';
                if (header.isWeekend) bgClass = 'bg-gray-50 opacity-60';
                
                html += `
                    <td class="border-l border-gray-200 ${bgClass} px-2 py-2 text-center text-sm">
                        <span class="font-bold text-gray-900">${actualTPD > 0 ? formatNumber(actualTPD) : '-'}</span>
                    </td>
                `;
            });
            
            // FUTURE: Campaign boxes spanning multiple days
            if (futureHeaders.length > 0) {
                const firstFutureDay = futureHeaders[0].dayIndex;
                
                html += `
                    <td colspan="${futureHeaders.length}" class="relative p-0" style="height: 60px; background: #f9fafb;">
                        ${renderKilnFutureCampaigns(kiln, futureHeaders, firstFutureDay)}
                    </td>
                `;
            }
            
            return html;
        }
        
        function getActualProduction(kilnId, dateStr) {
            // For now, generate sample actual production data
            // In production, this would come from database/CSV/API
            
            // Check if it's a weekend
            const date = new Date(dateStr);
            const dayOfWeek = date.getDay();
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            
            if (isWeekend) {
                // Reduced production on weekends (70%)
                return 1400 + Math.floor(Math.random() * 200);
            }
            
            // Weekday production with some variance
            return 1900 + Math.floor(Math.random() * 200);
        }
        
        function renderKilnFutureCampaigns(kiln, futureHeaders, firstFutureDay) {
            // Get actual campaigns from APP_STATE (will create samples if none exist)
            const allCampaigns = getAllCampaignsForKiln(kiln.id);
            
            // Filter to only future campaigns (starting from firstFutureDay onwards)
            const futureCampaigns = allCampaigns.filter(c => c.start >= firstFutureDay);
            
            // Adjust campaign positions relative to future section start
            const pixelsPerDay = 80;
            let html = '';
            
            futureCampaigns.forEach((campaign, idx) => {
                const adjustedStart = campaign.start - firstFutureDay;
                const left = adjustedStart * pixelsPerDay;
                const width = campaign.duration * pixelsPerDay;
                
                let bgColor, borderColor, label;
                
                switch(campaign.status) {
                    case 'active':
                        bgColor = 'rgba(34, 197, 94, 0.2)';
                        borderColor = '#16a34a';
                        label = `${formatNumber(campaign.tpd)} TPD`;
                        break;
                    case 'outage':
                        bgColor = 'rgba(239, 68, 68, 0.2)';
                        borderColor = '#dc2626';
                        label = campaign.reason || 'Outage';
                        break;
                    case 'reduced':
                        bgColor = 'rgba(245, 158, 11, 0.2)';
                        borderColor = '#d97706';
                        label = `${formatNumber(campaign.tpd)} TPD (Reduced)`;
                        break;
                    case 'stopped':
                        bgColor = 'rgba(156, 163, 175, 0.2)';
                        borderColor = '#6b7280';
                        label = campaign.reason || 'Stopped';
                        break;
                }
                
                html += `
                    <div class="absolute campaign-block group" 
                         data-campaign-id="${campaign.id}"
                         data-kiln-id="${kiln.id}"
                         style="left: ${left}px; width: ${width}px; height: 50px; 
                                background: ${bgColor}; border: 2px solid ${borderColor}; 
                                border-radius: 6px; top: 5px; cursor: pointer;">
                        
                        <!-- Delete X button (top right) -->
                        <button onclick="deleteCampaign(event, '${kiln.id}', '${campaign.id}')" 
                                class="absolute -top-2 -right-2 w-5 h-5 bg-red-600 text-white rounded-full text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-700 z-10"
                                style="line-height: 1.2;">√ó</button>
                        
                        <!-- Left resize handle -->
                        <div class="absolute left-0 top-0 bottom-0 w-2 cursor-ew-resize hover:bg-black hover:bg-opacity-30 z-10"
                             onmousedown="startCampaignResize(event, '${kiln.id}', '${campaign.id}', 'left')"
                             title="Drag to change start date"></div>
                        
                        <!-- Content (clickable to edit) -->
                        <div class="px-2 py-1 h-full flex flex-col justify-center"
                             onclick="editCampaignDetails(event, '${kiln.id}', '${campaign.id}')">
                            <div class="text-xs font-bold" style="color: ${borderColor};">${label}</div>
                            <div class="text-xs" style="color: ${borderColor}; opacity: 0.8;">${campaign.duration} days</div>
                        </div>
                        
                        <!-- Right resize handle -->
                        <div class="absolute right-0 top-0 bottom-0 w-2 cursor-ew-resize hover:bg-black hover:bg-opacity-30 z-10"
                             onmousedown="startCampaignResize(event, '${kiln.id}', '${campaign.id}', 'right')"
                             title="Drag to change duration"></div>
                    </div>
                `;
            });
            
            return html;
        }


        // Campaign resize logic with NO GAPS enforcement
        let resizeState = null;

        function startCampaignResize(event, equipmentId, campaignId, side) {
            event.stopPropagation();
            event.preventDefault();
            
            const pixelsPerDay = 80;
            
            // Get all campaigns for this equipment and sort by start position
            const allCampaigns = getAllCampaignsForEquipment(equipmentId);
            const campaignIndex = allCampaigns.findIndex(c => c.id === campaignId);
            
            resizeState = {
                equipmentId,
                campaignId,
                campaignIndex,
                side,
                startX: event.clientX,
                pixelsPerDay,
                allCampaigns,
                lastDelta: 0
            };
            
            document.addEventListener('mousemove', handleCampaignResize);
            document.addEventListener('mouseup', endCampaignResize);
        }

        function handleCampaignResize(event) {
            if (!resizeState) return;
            
            const deltaX = event.clientX - resizeState.startX;
            const deltaDays = Math.round(deltaX / resizeState.pixelsPerDay);
            const deltaPixels = deltaDays * resizeState.pixelsPerDay;
            
            const incrementalDelta = deltaPixels - resizeState.lastDelta;
            
            if (incrementalDelta === 0) return; // No change
            
            const campaigns = resizeState.allCampaigns;
            const currentIndex = resizeState.campaignIndex;
            
            // Get the campaign being resized
            const campaignElement = document.querySelector(`[data-campaign-id="${resizeState.campaignId}"]`);
            if (!campaignElement) return;
            
            const currentLeft = parseInt(campaignElement.style.left);
            const currentWidth = parseInt(campaignElement.style.width);
            
            if (resizeState.side === 'left') {
                // SCENARIO B: Moving left edge (changing start)
                // This changes the start position but end stays same
                // Only affects this campaign, not adjacent ones
                
                const newLeft = currentLeft + incrementalDelta;
                const newWidth = currentWidth - incrementalDelta;
                
                if (newWidth >= resizeState.pixelsPerDay) { // Minimum 1 day
                    campaignElement.style.left = newLeft + 'px';
                    campaignElement.style.width = newWidth + 'px';
                }
                
            } else {
                // SCENARIO A & C: Moving right edge (changing duration/end)
                // This affects ALL campaigns to the right (chain reaction)
                
                const newWidth = currentWidth + incrementalDelta;
                
                if (newWidth >= resizeState.pixelsPerDay) { // Minimum 1 day
                    // Resize current campaign
                    campaignElement.style.width = newWidth + 'px';
                    
                    // SHIFT ALL SUBSEQUENT CAMPAIGNS to maintain no gaps
                    for (let i = currentIndex + 1; i < campaigns.length; i++) {
                        const nextCampaign = campaigns[i];
                        const nextElement = document.querySelector(`[data-campaign-id="${nextCampaign.id}"]`);
                        
                        if (nextElement) {
                            const nextLeft = parseInt(nextElement.style.left);
                            nextElement.style.left = (nextLeft + incrementalDelta) + 'px';
                        }
                    }
                }
            }
            
            resizeState.lastDelta = deltaPixels;
        }

        function endCampaignResize() {
            if (resizeState) {
                const deltaDays = Math.round(resizeState.lastDelta / resizeState.pixelsPerDay);
                
                console.log(`Campaign ${resizeState.campaignId} resized by ${deltaDays} days on ${resizeState.side} side`);
                if (resizeState.side === 'right') {
                    console.log(`All downstream campaigns shifted by ${deltaDays} days`);
                }
                
                // Auto-save to APP_STATE (in production)
                
                resizeState = null;
            }
            document.removeEventListener('mousemove', handleCampaignResize);
            document.removeEventListener('mouseup', endCampaignResize);
        }

        function getAllCampaignsForEquipment(equipmentId) {
            // Initialize campaigns for this equipment if not exists
            if (!APP_STATE.campaigns[equipmentId]) {
                // Create initial sample campaigns starting from day 30 (today onwards)
                APP_STATE.campaigns[equipmentId] = [
                    { id: 'c1', start: 30, duration: 15, status: 'active', tpd: 2000, product: 'opc' },
                    { id: 'c2', start: 45, duration: 3, status: 'outage', tpd: 0, reason: 'Maintenance' },
                    { id: 'c3', start: 48, duration: 10, status: 'reduced', tpd: 1400, reason: 'Reduced yield', product: 'opc' },
                    { id: 'c4', start: 58, duration: 5, status: 'stopped', tpd: 0, reason: 'Inventory full' },
                    { id: 'c5', start: 63, duration: 28, status: 'active', tpd: 2000, product: 'opc' }
                ];
                saveToLocalStorage();
            }
            
            return APP_STATE.campaigns[equipmentId].sort((a, b) => a.start - b.start);
        }
        
        // Alias for backward compatibility
        function getAllCampaignsForKiln(kilnId) {
            return getAllCampaignsForEquipment(kilnId);
        }

        function deleteCampaign(event, equipmentId, campaignId) {
            event.stopPropagation();
            
            console.log(`Deleting campaign ${campaignId} from equipment ${equipmentId}`);
            
            const allCampaigns = getAllCampaignsForEquipment(equipmentId);
            const campaignIndex = allCampaigns.findIndex(c => c.id === campaignId);
            const deletedCampaign = allCampaigns[campaignIndex];
            const deletedDuration = deletedCampaign.duration;
            const pixelsPerDay = 80;
            const pixelsToShift = deletedDuration * pixelsPerDay;
            
            // Visual update: remove deleted campaign
            const element = document.querySelector(`[data-campaign-id="${campaignId}"]`);
            if (element) {
                element.remove();
            }
            
            // CRITICAL: Shift ALL campaigns AFTER the deleted one to the LEFT
            // This prevents overlap and fills the gap
            for (let i = campaignIndex + 1; i < allCampaigns.length; i++) {
                const campaign = allCampaigns[i];
                const campaignElement = document.querySelector(`[data-campaign-id="${campaign.id}"]`);
                
                if (campaignElement) {
                    const currentLeft = parseInt(campaignElement.style.left);
                    const newLeft = currentLeft - pixelsToShift;
                    campaignElement.style.left = newLeft + 'px';
                    
                    console.log(`Shifted campaign ${campaign.id} from ${currentLeft}px to ${newLeft}px (${deletedDuration} days left)`);
                }
            }
            
            // Auto-save to APP_STATE (in production)
            console.log(`Campaign deleted. ${allCampaigns.length - campaignIndex - 1} campaigns shifted ${deletedDuration} days left.`);
        }

        function editCampaignDetails(event, equipmentId, campaignId) {
            event.stopPropagation();
            
            // Get the equipment to find available products
            const equipment = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            
            // Get products this equipment can produce
            const availableProducts = getProductsForEquipment(equipment);
            
            // Get actual campaign data from APP_STATE
            const campaigns = getAllCampaignsForEquipment(equipmentId);
            const campaign = campaigns.find(c => c.id === campaignId);
            
            if (!campaign) {
                console.error(`Campaign ${campaignId} not found`);
                return;
            }
            
            // Show edit dialog with only available products
            showCampaignEditDialog(equipmentId, campaignId, campaign, availableProducts);
        }

        function showCampaignEditDialog(kilnId, campaignId, campaign, products) {
            // Calculate actual dates based on campaign start day
            const baseDate = new Date(APP_STATE.currentDate);
            baseDate.setDate(baseDate.getDate() - 30); // Start of timeline (30 days back)
            
            const startDate = new Date(baseDate);
            startDate.setDate(startDate.getDate() + campaign.start);
            
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + campaign.duration);
            
            const startDateStr = startDate.toISOString().split('T')[0];
            const endDateStr = endDate.toISOString().split('T')[0];
            
            const dialogHTML = `
                <div id="campaignEditDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeCampaignDialog()">
                    <div class="bg-white rounded-lg p-6 w-full max-w-lg" onclick="event.stopPropagation()">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-gray-900">Edit Campaign</h3>
                            <button onclick="closeCampaignDialog()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Start Date</label>
                                    <input type="date" id="campaignStartDate" value="${startDateStr}" 
                                           onchange="recalculateFromStartDate()"
                                           class="w-full border border-gray-300 rounded px-3 py-2">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">End Date</label>
                                    <input type="date" id="campaignEndDate" value="${endDateStr}" 
                                           onchange="recalculateFromEndDate()"
                                           class="w-full border border-gray-300 rounded px-3 py-2">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Duration (days)</label>
                                <input type="number" id="campaignDuration" value="${campaign.duration}" min="1" 
                                       onchange="recalculateFromDuration()"
                                       class="w-full border border-gray-300 rounded px-3 py-2">
                                <p class="text-xs text-gray-500 mt-1">Change any two fields, the third will auto-calculate</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Status</label>
                                <select id="campaignStatus" class="w-full border border-gray-300 rounded px-3 py-2"
                                        onchange="updateTPDBasedOnStatus()">
                                    <option value="active" ${campaign.status === 'active' ? 'selected' : ''}>üü¢ Active - Full Production</option>
                                    <option value="outage" ${campaign.status === 'outage' ? 'selected' : ''}>üî¥ Outage - Maintenance (0 TPD)</option>
                                    <option value="reduced" ${campaign.status === 'reduced' ? 'selected' : ''}>üü° Reduced Yield - Partial Production</option>
                                    <option value="stopped" ${campaign.status === 'stopped' ? 'selected' : ''}>‚ö™ Stopped - Inventory Full (0 TPD)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Product</label>
                                <select id="campaignProduct" class="w-full border border-gray-300 rounded px-3 py-2">
                                    ${products.map(p => `
                                        <option value="${p.id}" ${campaign.product === p.id ? 'selected' : ''}>${p.name}</option>
                                    `).join('')}
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Product being produced during this campaign</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Production Rate (TPD)</label>
                                <input type="number" id="campaignTPD" value="${campaign.tpd}" min="0" step="100"
                                       class="w-full border border-gray-300 rounded px-3 py-2">
                                <p class="text-xs text-gray-500 mt-1">Tons per day (0 for outage/stopped)</p>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-2 mt-6">
                            <button onclick="closeCampaignDialog()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded">
                                Cancel
                            </button>
                            <button onclick="saveCampaignEdit('${kilnId}', '${campaignId}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                                Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', dialogHTML);
            
            // Store base date for calculations
            window.campaignBaseDate = baseDate;
        }

        function recalculateFromStartDate() {
            const startDateStr = document.getElementById('campaignStartDate').value;
            const duration = parseInt(document.getElementById('campaignDuration').value) || 1;
            
            if (!startDateStr) return;
            
            // Calculate end date = start + duration
            const startDate = new Date(startDateStr);
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + duration);
            
            document.getElementById('campaignEndDate').value = endDate.toISOString().split('T')[0];
        }

        function recalculateFromEndDate() {
            const startDateStr = document.getElementById('campaignStartDate').value;
            const endDateStr = document.getElementById('campaignEndDate').value;
            
            if (!startDateStr || !endDateStr) return;
            
            // Calculate duration = end - start
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            const durationMs = endDate - startDate;
            const duration = Math.max(1, Math.round(durationMs / (1000 * 60 * 60 * 24)));
            
            document.getElementById('campaignDuration').value = duration;
        }

        function recalculateFromDuration() {
            const startDateStr = document.getElementById('campaignStartDate').value;
            const duration = parseInt(document.getElementById('campaignDuration').value) || 1;
            
            if (!startDateStr) return;
            
            // Calculate end date = start + duration
            const startDate = new Date(startDateStr);
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + duration);
            
            document.getElementById('campaignEndDate').value = endDate.toISOString().split('T')[0];
        }

        function updateTPDBasedOnStatus() {
            const status = document.getElementById('campaignStatus').value;
            const tpdField = document.getElementById('campaignTPD');
            
            if (status === 'outage' || status === 'stopped') {
                tpdField.value = 0;
                tpdField.classList.add('bg-gray-100');
            } else {
                tpdField.classList.remove('bg-gray-100');
                if (tpdField.value == 0) {
                    // Set to a default value if currently 0
                    tpdField.value = 2000;
                }
            }
        }

        function closeCampaignDialog() {
            const dialog = document.getElementById('campaignEditDialog');
            if (dialog) dialog.remove();
            window.campaignBaseDate = null;
        }

        function saveCampaignEdit(equipmentId, campaignId) {
            const startDateStr = document.getElementById('campaignStartDate').value;
            const endDateStr = document.getElementById('campaignEndDate').value;
            const duration = parseInt(document.getElementById('campaignDuration').value);
            const status = document.getElementById('campaignStatus').value;
            const product = document.getElementById('campaignProduct').value;
            const tpd = parseInt(document.getElementById('campaignTPD').value);
            
            // Calculate start day index from base date
            const baseDate = window.campaignBaseDate;
            const startDate = new Date(startDateStr);
            const startDay = Math.round((startDate - baseDate) / (1000 * 60 * 60 * 24));
            
            console.log('Saving campaign:', { 
                equipmentId, 
                campaignId, 
                startDay,
                startDate: startDateStr,
                endDate: endDateStr,
                duration, 
                status, 
                product, 
                tpd 
            });
            
            // Update campaign in APP_STATE
            const campaigns = getAllCampaignsForEquipment(equipmentId);
            const campaignIndex = campaigns.findIndex(c => c.id === campaignId);
            
            if (campaignIndex >= 0) {
                campaigns[campaignIndex] = {
                    ...campaigns[campaignIndex],
                    start: startDay,
                    duration: duration,
                    status: status,
                    product: product,
                    tpd: tpd
                };
                
                APP_STATE.campaigns[equipmentId] = campaigns;
                saveToLocalStorage();
            }
            
            closeCampaignDialog();
            renderApp(); // Re-render to show changes
        }

        function renderFinishMillSection(finishMills, dateHeaders, products) {
            if (finishMills.length === 0) return '';
            
            let html = `
                <tr class="bg-gray-800">
                    <td class="sticky left-0 bg-gray-800 z-10 px-4 py-2 font-bold text-white border-t-2 border-gray-900" style="min-width: 250px;">
                        üîß FINISH MILLS
                    </td>
                    <td colspan="${dateHeaders.length}" class="bg-gray-800 px-4 py-2 font-bold text-white border-t-2 border-gray-900"></td>
                </tr>
            `;
            
            finishMills.forEach(mill => {
                const nominalTPD = mill.params.tpd || 1800;
                
                html += `
                    <tr class="border-b border-gray-200 hover:bg-gray-50 group">
                        <td class="sticky left-0 bg-white z-10 px-4 py-2 font-medium text-sm border-r border-gray-300">
                            <div class="flex items-center justify-between mb-1">
                                <span>${mill.name}</span>
                                <span class="text-xs text-gray-500">Nom: ${formatNumber(nominalTPD)} TPD</span>
                            </div>
                            <button onclick="addNewCampaign('${mill.id}')" 
                                    class="text-xs text-blue-600 hover:text-blue-800 hover:bg-blue-50 px-2 py-1 rounded border border-blue-300 w-full">
                                + Add Campaign
                            </button>
                        </td>
                        ${renderMillDailyCells(mill, dateHeaders)}
                    </tr>
                `;
            });
            
            return html;
        }
        
        function renderMillDailyCells(mill, dateHeaders) {
            // Split into PAST and FUTURE sections
            const pastHeaders = dateHeaders.filter(h => h.isPast);
            const futureHeaders = dateHeaders.filter(h => !h.isPast);
            
            let html = '';
            
            // PAST: Individual cells with bold numbers
            pastHeaders.forEach(header => {
                const actualTPD = getActualProduction(mill.id, header.dateStr);
                
                let bgClass = 'bg-white';
                if (header.isWeekend) bgClass = 'bg-gray-50 opacity-60';
                
                html += `
                    <td class="border-l border-gray-200 ${bgClass} px-2 py-2 text-center text-sm">
                        <span class="font-bold text-gray-900">${actualTPD > 0 ? formatNumber(actualTPD) : '-'}</span>
                    </td>
                `;
            });
            
            // FUTURE: Campaign boxes
            if (futureHeaders.length > 0) {
                const firstFutureDay = futureHeaders[0].dayIndex;
                
                html += `
                    <td colspan="${futureHeaders.length}" class="relative p-0" style="height: 60px; background: #f9fafb;">
                        ${renderMillFutureCampaigns(mill, futureHeaders, firstFutureDay)}
                    </td>
                `;
            }
            
            return html;
        }
        
        function renderMillFutureCampaigns(mill, futureHeaders, firstFutureDay) {
            const allCampaigns = getAllCampaignsForEquipment(mill.id);
            const futureCampaigns = allCampaigns.filter(c => c.start >= firstFutureDay);
            
            const pixelsPerDay = 80;
            let html = '';
            
            futureCampaigns.forEach((campaign, idx) => {
                const adjustedStart = campaign.start - firstFutureDay;
                const left = adjustedStart * pixelsPerDay;
                const width = campaign.duration * pixelsPerDay;
                
                let bgColor, borderColor, label;
                
                switch(campaign.status) {
                    case 'active':
                        bgColor = 'rgba(34, 197, 94, 0.2)';
                        borderColor = '#16a34a';
                        label = `${formatNumber(campaign.tpd)} TPD`;
                        break;
                    case 'outage':
                        bgColor = 'rgba(239, 68, 68, 0.2)';
                        borderColor = '#dc2626';
                        label = campaign.reason || 'Outage';
                        break;
                    case 'reduced':
                        bgColor = 'rgba(245, 158, 11, 0.2)';
                        borderColor = '#d97706';
                        label = `${formatNumber(campaign.tpd)} TPD (Reduced)`;
                        break;
                    case 'stopped':
                        bgColor = 'rgba(156, 163, 175, 0.2)';
                        borderColor = '#6b7280';
                        label = campaign.reason || 'Stopped';
                        break;
                }
                
                html += `
                    <div class="absolute campaign-block group" 
                         data-campaign-id="${campaign.id}"
                         data-equipment-id="${mill.id}"
                         style="left: ${left}px; width: ${width}px; height: 50px; 
                                background: ${bgColor}; border: 2px solid ${borderColor}; 
                                border-radius: 6px; top: 5px; cursor: pointer;">
                        
                        <button onclick="deleteCampaign(event, '${mill.id}', '${campaign.id}')" 
                                class="absolute -top-2 -right-2 w-5 h-5 bg-red-600 text-white rounded-full text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-700 z-10"
                                style="line-height: 1.2;">√ó</button>
                        
                        <div class="absolute left-0 top-0 bottom-0 w-2 cursor-ew-resize hover:bg-black hover:bg-opacity-30 z-10"
                             onmousedown="startCampaignResize(event, '${mill.id}', '${campaign.id}', 'left')"
                             title="Drag to change start date"></div>
                        
                        <div class="px-2 py-1 h-full flex flex-col justify-center"
                             onclick="editCampaignDetails(event, '${mill.id}', '${campaign.id}')">
                            <div class="text-xs font-bold" style="color: ${borderColor};">${label}</div>
                            <div class="text-xs" style="color: ${borderColor}; opacity: 0.8;">${campaign.duration} days</div>
                        </div>
                        
                        <div class="absolute right-0 top-0 bottom-0 w-2 cursor-ew-resize hover:bg-black hover:bg-opacity-30 z-10"
                             onmousedown="startCampaignResize(event, '${mill.id}', '${campaign.id}', 'right')"
                             title="Drag to change duration"></div>
                    </div>
                `;
            });
            
            return html;
        }

        function renderPackerSection(packers, dateHeaders, products) {
            if (packers.length === 0) return '';
            
            let html = `
                <tr class="bg-gray-800">
                    <td class="sticky left-0 bg-gray-800 z-10 px-4 py-2 font-bold text-white border-t-2 border-gray-900" style="min-width: 250px;">
                        üì¶ PACKERS
                    </td>
                    <td colspan="${dateHeaders.length}" class="bg-gray-800 px-4 py-2 font-bold text-white border-t-2 border-gray-900"></td>
                </tr>
            `;
            
            packers.forEach(packer => {
                html += `
                    <tr class="border-b border-gray-200 hover:bg-gray-50 group">
                        <td class="sticky left-0 bg-white z-10 px-4 py-2 font-medium text-sm border-r border-gray-300">
                            ${packer.name}
                        </td>
                        <td colspan="${dateHeaders.length}" class="relative p-0" style="height: 60px; background: #f9fafb;">
                            <div class="absolute inset-0 flex items-center justify-center">
                                <button onclick="openCampaignEditor('${packer.id}', 'packer')" 
                                        class="text-xs text-gray-400 hover:text-blue-600 hover:bg-blue-50 px-3 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                                    + Add Campaign
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            return html;
        }

        function renderLoadoutSection(loadouts, dateHeaders) {
            if (loadouts.length === 0) return '';
            
            let html = `
                <tr class="bg-gray-800">
                    <td class="sticky left-0 bg-gray-800 z-10 px-4 py-2 font-bold text-white border-t-2 border-gray-900" style="min-width: 250px;">
                        üöö LOAD OUT
                    </td>
                    <td colspan="${dateHeaders.length}" class="bg-gray-800 px-4 py-2 font-bold text-white border-t-2 border-gray-900"></td>
                </tr>
            `;
            
            loadouts.forEach(loadout => {
                html += `
                    <tr class="border-b border-gray-200 hover:bg-gray-50 group">
                        <td class="sticky left-0 bg-white z-10 px-4 py-2 font-medium text-sm border-r border-gray-300">
                            ${loadout.name}
                        </td>
                        <td colspan="${dateHeaders.length}" class="relative p-0" style="height: 60px; background: #f9fafb;">
                            <div class="absolute inset-0 flex items-center justify-center text-xs text-gray-400">
                                Dispatch follows demand plan
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            return html;
        }

        function addNewCampaign(equipmentId) {
            // Open dialog to create new campaign
            const equipment = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            
            // Get products this equipment can produce based on equipment type and specs
            const availableProducts = getProductsForEquipment(equipment);
            
            if (availableProducts.length === 0) {
                alert('This equipment has no products configured.\n\nPlease configure products in the Process Flow Designer (Tab 2) by double-clicking the equipment and selecting which products it can produce.');
                return;
            }
            
            // Create empty campaign template
            const newCampaign = {
                start: 30, // Default to today (day 30)
                duration: 7,
                status: 'active',
                product: availableProducts[0].id, // Default to first available product
                tpd: equipment.params.tpd || 2000
            };
            
            showAddCampaignDialog(equipmentId, newCampaign, availableProducts);
        }
        
        function getProductsForEquipment(equipment) {
            // Get products based on ACTUAL Process Flow connections (Tab 2)
            
            // Get all connections FROM this equipment
            const connections = APP_STATE.flowDesigner.connections.filter(c => c.from === equipment.id);
            
            // Get unique products from connections
            const productIds = new Set();
            connections.forEach(conn => {
                if (conn.product) {
                    productIds.add(conn.product);
                }
            });
            
            // Return actual product objects
            const products = [];
            productIds.forEach(productId => {
                const product = APP_STATE.products[productId];
                if (product) {
                    products.push(product);
                }
            });
            
            console.log(`Equipment ${equipment.name} (${equipment.id}) can produce:`, products.map(p => p.name));
            
            // If no connections found, check equipment.params.products as fallback
            if (products.length === 0 && equipment.params && equipment.params.products) {
                const allProducts = Object.values(APP_STATE.products);
                allProducts.forEach(product => {
                    if (equipment.params.products[product.id]?.enabled === true) {
                        products.push(product);
                    }
                });
            }
            
            return products;
        }
        
        
        function showAddCampaignDialog(equipmentId, campaign, products) {
            // Calculate actual dates
            const baseDate = new Date(APP_STATE.currentDate);
            baseDate.setDate(baseDate.getDate() - 30); // Start of timeline
            
            const startDate = new Date(baseDate);
            startDate.setDate(startDate.getDate() + campaign.start);
            
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + campaign.duration);
            
            const startDateStr = startDate.toISOString().split('T')[0];
            const endDateStr = endDate.toISOString().split('T')[0];
            
            const dialogHTML = `
                <div id="campaignEditDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeCampaignDialog()">
                    <div class="bg-white rounded-lg p-6 w-full max-w-lg" onclick="event.stopPropagation()">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-gray-900">Add New Campaign</h3>
                            <button onclick="closeCampaignDialog()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Start Date</label>
                                    <input type="date" id="campaignStartDate" value="${startDateStr}" 
                                           onchange="recalculateFromStartDate()"
                                           class="w-full border border-gray-300 rounded px-3 py-2">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">End Date</label>
                                    <input type="date" id="campaignEndDate" value="${endDateStr}" 
                                           onchange="recalculateFromEndDate()"
                                           class="w-full border border-gray-300 rounded px-3 py-2">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Duration (days)</label>
                                <input type="number" id="campaignDuration" value="${campaign.duration}" min="1" 
                                       onchange="recalculateFromDuration()"
                                       class="w-full border border-gray-300 rounded px-3 py-2">
                                <p class="text-xs text-gray-500 mt-1">Change any two fields, the third will auto-calculate</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Status</label>
                                <select id="campaignStatus" class="w-full border border-gray-300 rounded px-3 py-2"
                                        onchange="updateTPDBasedOnStatus()">
                                    <option value="active" ${campaign.status === 'active' ? 'selected' : ''}>üü¢ Active - Full Production</option>
                                    <option value="outage" ${campaign.status === 'outage' ? 'selected' : ''}>üî¥ Outage - Maintenance (0 TPD)</option>
                                    <option value="reduced" ${campaign.status === 'reduced' ? 'selected' : ''}>üü° Reduced Yield - Partial Production</option>
                                    <option value="stopped" ${campaign.status === 'stopped' ? 'selected' : ''}>‚ö™ Stopped - Inventory Full (0 TPD)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Product</label>
                                <select id="campaignProduct" class="w-full border border-gray-300 rounded px-3 py-2">
                                    ${products.map(p => `
                                        <option value="${p.id}" ${campaign.product === p.id ? 'selected' : ''}>${p.name}</option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Production Rate (TPD)</label>
                                <input type="number" id="campaignTPD" value="${campaign.tpd}" min="0" step="100"
                                       class="w-full border border-gray-300 rounded px-3 py-2">
                            </div>
                            
                            <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
                                <p class="text-xs text-yellow-800">
                                    ‚ö†Ô∏è If this campaign overlaps existing campaigns, they will be automatically split to accommodate the new campaign.
                                </p>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-2 mt-6">
                            <button onclick="closeCampaignDialog()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded">
                                Cancel
                            </button>
                            <button onclick="saveNewCampaign('${equipmentId}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                                Add Campaign
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', dialogHTML);
            window.campaignBaseDate = baseDate;
        }
        
        function saveNewCampaign(equipmentId) {
            const startDateStr = document.getElementById('campaignStartDate').value;
            const endDateStr = document.getElementById('campaignEndDate').value;
            const duration = parseInt(document.getElementById('campaignDuration').value);
            const status = document.getElementById('campaignStatus').value;
            const product = document.getElementById('campaignProduct').value;
            const tpd = parseInt(document.getElementById('campaignTPD').value);
            
            // Calculate start day index
            const baseDate = window.campaignBaseDate;
            const startDate = new Date(startDateStr);
            const startDay = Math.round((startDate - baseDate) / (1000 * 60 * 60 * 24));
            const endDay = startDay + duration;
            
            console.log('Adding new campaign:', { equipmentId, startDay, endDay, duration, status, product, tpd });
            
            // Get existing campaigns
            const existingCampaigns = getAllCampaignsForEquipment(equipmentId);
            
            // Insert new campaign and split any overlapping campaigns
            const updatedCampaigns = insertCampaignWithSplit(existingCampaigns, {
                id: 'c' + Date.now(),
                start: startDay,
                duration: duration,
                status: status,
                product: product,
                tpd: tpd
            });
            
            // Save updated campaigns
            APP_STATE.campaigns[equipmentId] = updatedCampaigns;
            saveToLocalStorage();
            
            closeCampaignDialog();
            renderApp();
        }
        
        function insertCampaignWithSplit(existingCampaigns, newCampaign) {
            const newStart = newCampaign.start;
            const newEnd = newCampaign.start + newCampaign.duration;
            const result = [];
            
            console.log(`Inserting campaign: ${newStart}-${newEnd}`);
            
            let newCampaignInserted = false;
            
            existingCampaigns.forEach(existing => {
                const existStart = existing.start;
                const existEnd = existing.start + existing.duration;
                
                console.log(`Checking existing campaign: ${existStart}-${existEnd}`);
                
                // Case 1: No overlap - existing campaign is completely before new campaign
                if (existEnd <= newStart) {
                    console.log('  ‚Üí Keep (before new campaign)');
                    result.push(existing);
                    return;
                }
                
                // Case 2: No overlap - existing campaign is completely after new campaign
                if (existStart >= newEnd) {
                    // Insert new campaign before this one if not already inserted
                    if (!newCampaignInserted) {
                        console.log('  ‚Üí Insert new campaign here');
                        result.push(newCampaign);
                        newCampaignInserted = true;
                    }
                    console.log('  ‚Üí Keep (after new campaign)');
                    result.push(existing);
                    return;
                }
                
                // Case 3: Overlap - split existing campaign
                console.log('  ‚Üí OVERLAP DETECTED - splitting');
                
                // Part 1: Before new campaign (if any)
                if (existStart < newStart) {
                    const part1 = {
                        ...existing,
                        id: existing.id + '_part1',
                        duration: newStart - existStart
                    };
                    console.log(`    ‚Üí Part 1: ${part1.start}-${part1.start + part1.duration}`);
                    result.push(part1);
                }
                
                // Insert new campaign (only once)
                if (!newCampaignInserted) {
                    console.log(`    ‚Üí Insert new campaign: ${newStart}-${newEnd}`);
                    result.push(newCampaign);
                    newCampaignInserted = true;
                }
                
                // Part 2: After new campaign (if any)
                if (existEnd > newEnd) {
                    const part2 = {
                        ...existing,
                        id: existing.id + '_part2',
                        start: newEnd,
                        duration: existEnd - newEnd
                    };
                    console.log(`    ‚Üí Part 2: ${part2.start}-${part2.start + part2.duration}`);
                    result.push(part2);
                }
            });
            
            // If new campaign is after all existing campaigns
            if (!newCampaignInserted) {
                console.log('Insert new campaign at end');
                result.push(newCampaign);
            }
            
            return result.sort((a, b) => a.start - b.start);
        }
        
        function openCampaignEditor(equipmentId, equipmentType) {
            alert(`Campaign editor for ${equipmentType} - Coming soon!\n\nYou'll be able to set:\n- Start date & duration\n- Status: Active, Outage, Reduced, Stopped\n- Production rate (TPD)\n- Reason for outage/stoppage`);
        }

        function editCampaign(equipmentId, startDay) {
            alert(`Edit campaign starting day ${startDay}`);
        }

        function optimizeCampaigns() {
            alert('ü§ñ AI Optimization:\n\nThe system will analyze:\n- Demand forecast\n- Inventory levels & capacities\n- Equipment constraints\n- Minimize outages\n\nRecommend optimal campaigns to:\n‚úì Meet demand\n‚úì Avoid silo overflow\n‚úì Minimize production stoppages');
        }

        function exportProductionPlan() {
            alert('Export functionality coming soon');
        }
        function renderMonitorTab() {
            return `
                <div class="p-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center">
                        <svg class="w-16 h-16 mx-auto text-blue-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Production Monitoring</h3>
                        <p class="text-gray-600 mb-4">Coming soon: Real-time production tracking, inventory levels, and performance analytics</p>
                        <div class="text-sm text-gray-500">
                            This tab will show:
                            <ul class="mt-2 space-y-1">
                                <li>‚Ä¢ Daily production vs targets</li>
                                <li>‚Ä¢ Inventory levels and projections</li>
                                <li>‚Ä¢ Equipment utilization</li>
                                <li>‚Ä¢ Alerts and notifications</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        // ============================================
        // SAVE/LOAD
        // ============================================
        
        function saveToLocalStorage() {
            try {
                const data = {
                    products: APP_STATE.products,
                    flowDesigner: {
                        equipment: APP_STATE.flowDesigner.equipment,
                        connections: APP_STATE.flowDesigner.connections,
                        nextId: APP_STATE.flowDesigner.nextId
                    },
                    productionPlan: APP_STATE.productionPlan,
                    demandPlan: APP_STATE.demandPlan,
                    inventory: APP_STATE.inventory,
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem('cementPlanner_' + APP_STATE.currentLocation, JSON.stringify(data));
            } catch (error) {
                console.error('Save error:', error);
            }
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('cementPlanner_' + (APP_STATE.currentLocation || 'MIA'));
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.products) {
                        APP_STATE.products = data.products;
                        // Migrate old family names to new ones
                        const familyMap = {
                            'raw_material': 'ck_raw',
                            'clinker': 'cem_raw',
                            'additive': 'cem_raw'
                        };
                        Object.values(APP_STATE.products).forEach(p => {
                            if (familyMap[p.family]) p.family = familyMap[p.family];
                        });
                    }
                    if (data.flowDesigner) {
                        APP_STATE.flowDesigner.equipment = data.flowDesigner.equipment || [];
                        APP_STATE.flowDesigner.connections = data.flowDesigner.connections || [];
                        APP_STATE.flowDesigner.nextId = data.flowDesigner.nextId || 1;
                    }
                    if (data.productionPlan) APP_STATE.productionPlan = data.productionPlan;
                    if (data.demandPlan) APP_STATE.demandPlan = data.demandPlan;
                    if (data.inventory) APP_STATE.inventory = data.inventory;
                    console.log('Loaded from localStorage');
                }
            } catch (error) {
                console.error('Load error:', error);
            }
        }

        function saveFlowToLocalStorage() {
            saveToLocalStorage();
        }

        function loadFlowFromLocalStorage() {
            loadFromLocalStorage();
        }

        function exportFlowToFile() {
            const data = {
                equipment: APP_STATE.flowDesigner.equipment,
                connections: APP_STATE.flowDesigner.connections,
                nextId: APP_STATE.flowDesigner.nextId,
                exportedAt: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flow_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importFlowFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        APP_STATE.flowDesigner.equipment = data.equipment;
                        APP_STATE.flowDesigner.connections = data.connections;
                        APP_STATE.flowDesigner.nextId = data.nextId || 1;
                        renderFlowCanvas();
                        saveToLocalStorage();
                        alert('‚úÖ Flow loaded!');
                    } catch (err) {
                        alert('‚ùå Error: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function exportAllData() {
            const data = {
                products: APP_STATE.products,
                flowDesigner: APP_STATE.flowDesigner,
                productionPlan: APP_STATE.productionPlan,
                exportedAt: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cement_planner_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ All data exported!');
        }

        // ============================================
        // INITIALIZE
        // ============================================
        
        function generateSampleDemandData() {
            // Only generate if demandPlan is empty
            if (APP_STATE.demandPlan && Object.keys(APP_STATE.demandPlan).length > 0) {
                return; // Already has data, don't overwrite
            }
            
            const today = new Date(APP_STATE.currentDate);
            const products = Object.keys(APP_STATE.products);
            
            // Generate demand for each product
            products.forEach(productId => {
                if (!APP_STATE.demandPlan[productId]) {
                    APP_STATE.demandPlan[productId] = {};
                }
                
                // Set different base demand for each product
                let baseDemand;
                let forecastDemand;
                
                if (productId === 'opc') {
                    baseDemand = 1800;      // Past average
                    forecastDemand = 2000;   // Future target
                } else if (productId === 'il11') {
                    baseDemand = 1200;      // Past average
                    forecastDemand = 1500;   // Future target
                } else if (productId === 'il8') {
                    baseDemand = 800;       // Past average
                    forecastDemand = 900;    // Future target
                } else if (productId === 'ppc') {
                    baseDemand = 1500;      // Past average
                    forecastDemand = 1800;   // Future target
                } else {
                    baseDemand = 1000;      // Default
                    forecastDemand = 1200;   // Default
                }
                
                // Generate past 30 days with realistic variation
                for (let i = -30; i < 0; i++) {
                    const date = new Date(today);
                    date.setDate(date.getDate() + i);
                    const dateStr = getDateString(date);
                    const dayOfWeek = date.getDay();
                    
                    // Weekends have lower demand
                    const weekendFactor = (dayOfWeek === 0 || dayOfWeek === 6) ? 0.6 : 1.0;
                    
                    // Add random variation ¬±15%
                    const variation = 0.85 + (Math.random() * 0.3);
                    
                    const demand = Math.round(baseDemand * weekendFactor * variation);
                    
                    APP_STATE.demandPlan[productId][dateStr] = {
                        value: demand,
                        type: 'actual'
                    };
                }
                
                // Today's demand (transition point)
                const todayStr = getDateString(today);
                APP_STATE.demandPlan[productId][todayStr] = {
                    value: Math.round((baseDemand + forecastDemand) / 2),
                    type: 'actual'
                };
                
                // Future 60 days with set forecast value
                for (let i = 1; i <= 60; i++) {
                    const date = new Date(today);
                    date.setDate(date.getDate() + i);
                    const dateStr = getDateString(date);
                    const dayOfWeek = date.getDay();
                    
                    // Weekends have lower demand
                    const weekendFactor = (dayOfWeek === 0 || dayOfWeek === 6) ? 0.6 : 1.0;
                    
                    const demand = Math.round(forecastDemand * weekendFactor);
                    
                    APP_STATE.demandPlan[productId][dateStr] = {
                        value: demand,
                        type: 'forecast'
                    };
                }
            });
            
            console.log('‚úÖ Generated sample demand data');
            saveToLocalStorage();
        }
        
        console.log('Loading from localStorage...');
        loadFromLocalStorage();
        
        console.log('Generating sample demand data...');
        try {
            generateSampleDemandData();
            console.log('Sample data generated successfully');
        } catch (error) {
            console.error('Error generating sample data:', error);
        }
        
        console.log('Rendering app...');
        try {
            renderApp();
            console.log('App rendered successfully');
        } catch (error) {
            console.error('Error rendering app:', error);
            document.getElementById('app').innerHTML = `
                <div style="padding: 20px; color: red; font-family: monospace;">
                    <h1>Error Loading Application</h1>
                    <pre>${error.message}\n${error.stack}</pre>
                </div>
            `;
        }
        
        console.log('=== CEMENT PLANNER INITIALIZED ===');
    </script>
</body>
</html>
