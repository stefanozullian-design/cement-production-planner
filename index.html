<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cement Production Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Product color coding */
        .product-opc { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-left: 4px solid #3b82f6; }
        .product-il11 { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid #f59e0b; }
        .product-il8 { background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); border-left: 4px solid #ec4899; }
        .product-ppc { background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border-left: 4px solid #6366f1; }
        
        .product-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-opc { background: #3b82f6; color: white; }
        .badge-il11 { background: #f59e0b; color: white; }
        .badge-il8 { background: #ec4899; color: white; }
        .badge-ppc { background: #6366f1; color: white; }
        
        .product-card {
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .product-card.selected {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .recipe-ingredient {
            display: grid;
            grid-template-columns: 200px 1fr 100px;
            gap: 12px;
            align-items: center;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .ingredient-slider {
            width: 100%;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .calendar-day {
            min-height: 80px;
            border: 1px solid #e5e7eb;
            padding: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .calendar-day:hover {
            background: #f3f4f6;
            border-color: #3b82f6;
        }
        
        .calendar-day.selected {
            background: #dbeafe;
            border-color: #3b82f6;
            border-width: 2px;
        }
        
        .calendar-day.maintenance {
            background: repeating-linear-gradient(45deg, #fef2f2, #fef2f2 10px, #fee2e2 10px, #fee2e2 20px);
        }
        
        .calendar-day.shutdown {
            background: #f3f4f6;
        }
        
        /* Process Flow Styles */
        .toolbar-item {
            cursor: grab;
            transition: all 0.2s;
        }
        
        .toolbar-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .equipment-node {
            cursor: move;
            transition: all 0.2s;
        }
        
        .equipment-node:hover {
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.3));
        }
        
        .equipment-node.selected {
            filter: drop-shadow(0 0 12px #3b82f6);
        }
        
        .connection-line {
            stroke: #9ca3af;
            stroke-width: 3;
            fill: none;
            cursor: pointer;
        }
        
        .connection-line:hover {
            stroke: #3b82f6;
            stroke-width: 4;
        }
        
        .port {
            cursor: crosshair;
            transition: all 0.2s;
        }
        
        .port:hover {
            r: 8;
            fill: #3b82f6;
        }
        
        .hidden {
            display: none;
        }
        
        /* Sticky scrollbar container - always visible at top */
        .scrollbar-container {
            position: sticky;
            top: 60px; /* Below the sticky date header */
            z-index: 15;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            overflow-x: scroll;
            overflow-y: hidden;
            height: 20px;
        }
        
        .scrollbar-container::-webkit-scrollbar {
            height: 12px;
        }
        
        .scrollbar-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        .scrollbar-container::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 6px;
        }
        
        .scrollbar-container::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        
        /* Force scrollbar to always show */
        .scrollbar-content {
            height: 1px;
        }
    
        
        /* Flow Designer v2 - Selection & Zoom */
        .connection-line {
            stroke: #9ca3af;
            stroke-width: 3;
            fill: none;
            cursor: pointer;
            transition: stroke-width 0.2s;
        }
        
        .connection-line:hover {
            stroke: #3b82f6;
            stroke-width: 5;
        }
        
        .equipment-node {
            cursor: move;
        }
        
        .equipment-node.selected rect {
            filter: drop-shadow(0px 4px 12px rgba(59, 130, 246, 0.6));
        }
        
        .port {
            cursor: pointer;
            transition: r 0.2s;
        }
        
        .port:hover {
            r: 8;
        }
        
        #flowCanvas {
            cursor: crosshair;
        }
        </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <!-- Product Recipe Modal -->
    <div id="recipeModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-3xl border border-gray-200 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-900" id="recipeModalTitle">Edit Product Recipe</h3>
                <button onclick="closeRecipeModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="recipeModalContent"></div>
            <div class="flex justify-end space-x-2 mt-6">
                <button onclick="closeRecipeModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded">Cancel</button>
                <button onclick="saveRecipe()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Save Recipe</button>
            </div>
        </div>
    </div>

    <!-- Production Day Modal -->
    <div id="dayModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl border border-gray-200 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-900" id="dayModalTitle">Edit Production Day</h3>
                <button onclick="closeDayModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="dayModalContent"></div>
            <div class="flex justify-end space-x-2 mt-6">
                <button onclick="closeDayModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded">Cancel</button>
                <button onclick="saveDayPlan()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        console.log('=== CEMENT PLANNER STARTING ===');
        
        // ============================================
        // GLOBAL STATE
        // ============================================
        
        console.log('Initializing APP_STATE...');
        
        // ============================================
        // CEMEX FLORIDA REGION - LOCATIONS
        // ============================================
        const CEMEX_LOCATIONS = {
            'MIA': { code: 'MIA', name: 'Miami Plant',           type: 'plant',    icon: 'üè≠', color: '#1d4ed8', bg: '#eff6ff' },
            'BRS': { code: 'BRS', name: 'Brooksville Plant',     type: 'plant',    icon: 'üè≠', color: '#15803d', bg: '#f0fdf4' },
            'PEV': { code: 'PEV', name: 'Port Everglades',       type: 'terminal', icon: 'üö¢', color: '#0e7490', bg: '#ecfeff' },
            'WPB': { code: 'WPB', name: 'West Palm Beach',       type: 'terminal', icon: 'üö¢', color: '#0369a1', bg: '#f0f9ff' },
            'ORL': { code: 'ORL', name: 'Orlando Terminal',      type: 'terminal', icon: 'üöÇ', color: '#7c3aed', bg: '#f5f3ff' },
            'SUB': { code: 'SUB', name: 'Sutton Terminal',       type: 'terminal', icon: 'üöÇ', color: '#b45309', bg: '#fffbeb' },
            'JAX': { code: 'JAX', name: 'Jacksonville Terminal', type: 'terminal', icon: 'üöÇ', color: '#9f1239', bg: '#fff1f2' }
        };

        const APP_STATE = {
            currentTab: 'products',
            currentDate: new Date(),
            currentLocation: localStorage.getItem('cemex_current_location') || 'MIA',
            
            // Product Definitions
            products: {
                opc: {
                    id: 'opc',
                    name: 'OPC (Ordinary Portland Cement)',
                    recipe: {
                        clinker: 95,
                        gypsum: 5,
                        limestone: 0,
                        fly_ash: 0,
                        slag: 0,
                        pozzolana: 0,
                        additives: 0
                    },
                    color: '#3b82f6'
                },
                il11: {
                    id: 'il11',
                    name: 'IL(11) - Portland Limestone Cement',
                    recipe: {
                        clinker: 84,
                        gypsum: 5,
                        limestone: 11,
                        fly_ash: 0,
                        slag: 0,
                        pozzolana: 0,
                        additives: 0
                    },
                    color: '#f59e0b'
                }
            },
            
            // Equipment in process flow
            flowDesigner: {
                equipment: [],
                connections: [],
                nextId: 1,
                selectedEquipment: null,
                connecting: null,
                zoom: 1,
                panX: 0,
                panY: 0,
                selection: { active: false, startX: 0, startY: 0, endX: 0, endY: 0 },
                selectedIds: []
            },
            
            // Rules of Engagement for simulation
            rules: {
                // System rules (hardcoded, cannot be changed)
                system: {
                    silo_single_product: true,
                    equipment_single_product: true,
                    inventory_non_negative: true,
                    recipe_adherence: true,
                    silo_capacity_limits: true
                },
                // Operational rules (user-configurable)
                operational: {
                    clinker_shortage_response: 'stop_mills_sequential', // 'stop_mills_sequential', 'stop_all_immediately', 'reduce_production'
                    campaign_minimum_hours: 24, // Minimum hours a mill must run on one product
                    changeover_time_hours: 0, // Hours needed to switch products (0 = instant)
                    default_operating_mode: '24/7', // '24/7' or 'shifts'
                    product_priorities: {}, // { product_id: priority_number } - lower number = higher priority
                    allow_mid_campaign_switch: false, // Can mills switch products before minimum campaign length?
                    inventory_safety_factor: 1.1 // Multiplier for minimum inventory thresholds
                },
                // Holidays / Non-working days
                holidays: []  // Array of date strings in YYYY-MM-DD format
            },
            
            // Production Plan (by date, by equipment)
            productionPlan: {
                // Format: 'YYYY-MM-DD': { equipment_id: { status: 'production|maintenance|shutdown', product: 'opc', target_tpd: 2000 } }
            },
            
            // Campaigns (by equipment)
            campaigns: {
                // Format: { equipment_id: [ { id, start, duration, status, product, tpd, reason } ] }
                // Example: 'kiln_1': [ { id: 'c1', start: 0, duration: 15, status: 'active', tpd: 2000 } ]
            },
            
            // Demand Plan (by product, by date)
            demandPlan: {
                // Format: { product_id: { 'YYYY-MM-DD': { value: 1500, type: 'actual|forecast' } } }
            },
            
            // Demand Planning UI state
            demandPlanning: {
                collapsedMonths: [] // Array of 'YYYY-MM' strings for collapsed months
            },
            
            // Inventory tracking (by silo, by product, by date)
            inventory: {
                // Format: { silo_id: { product_id: { 'YYYY-MM-DD': beginning_inventory_tons } } }
            },
            
            // Current view year/month for production plan
            planView: {
                year: 2025,
                month: 2 // February
            }
        };

        // Equipment type definitions for Process Flow
        const EQUIPMENT_TYPES = {
            raw_material: {
                name: 'Raw Material',
                color: '#84cc16',
                icon: 'ü™®',
                width: 100,
                height: 100,
                outputs: ['raw_material'],
                inputs: [],
                defaultParams: { supply_rate: 3000, cost_per_ton: 30, material_name: 'Limestone' }
            },
            fuel: {
                name: 'Fuel',
                color: '#18181b',
                icon: '‚ö´',
                width: 100,
                height: 100,
                outputs: ['fuel'],
                inputs: [],
                defaultParams: { supply_rate: 500, gcal_per_ton: 6000, cost_per_ton: 80, fuel_name: 'Coal' }
            },
            additive: {
                name: 'Additive',
                color: '#f5f5f4',
                icon: 'üíé',
                width: 100,
                height: 100,
                outputs: ['additive'],
                inputs: [],
                defaultParams: { supply_rate: 300, cost_per_ton: 40, additive_name: 'Gypsum' }
            },
            raw_mill: {
                name: 'Raw Mill',
                color: '#dc2626',
                icon: '‚öôÔ∏è',
                width: 100,
                height: 100,
                inputs: ['raw_material'],
                outputs: ['raw_meal'],
                defaultParams: { nominal_tph: 120, hours: 22, utilization: 0.85, efficiency: 0.95 }
            },
            kiln: {
                name: 'Kiln',
                color: '#ea580c',
                icon: 'üî•',
                width: 100,
                height: 100,
                inputs: ['raw_meal', 'fuel'],
                outputs: ['clinker'],
                defaultParams: { 
                    tpd: 2000,
                    gcal_per_tm_ck: 750,
                    rm_to_clinker_factor: 1.55
                }
            },
            silo: {
                name: 'Silo',
                color: '#6b7280',
                icon: 'üè∫',
                width: 100,
                height: 120,
                inputs: ['raw_material', 'fuel', 'clinker', 'cement', 'raw_meal', 'additive'],
                outputs: ['raw_material', 'fuel', 'clinker', 'cement', 'raw_meal', 'additive'],
                defaultParams: { 
                    min_volume: 2000,
                    max_volume: 15000,
                    material_type: 'Clinker' 
                }
            },
            finish_mill: {
                name: 'Finish Mill',
                color: '#3b82f6',
                icon: 'üîß',
                width: 120,
                height: 100,
                inputs: ['clinker', 'additive'],
                outputs: ['cement'],
                defaultParams: { 
                    products: {} // Will store product_id: { enabled: true, tpd: 1800 }
                }
            },
            packing: {
                name: 'Packing System',
                color: '#eab308',
                icon: 'üì¶',
                width: 120,
                height: 100,
                inputs: ['cement'],
                outputs: ['packed'],
                defaultParams: { 
                    product: '',
                    pallets_per_hour: 100,
                    hours_operation: 18
                }
            },
            loadout: {
                name: 'Loadout',
                color: '#8b5cf6',
                icon: 'üöö',
                width: 100,
                height: 100,
                inputs: ['cement', 'packed'],
                outputs: [],
                defaultParams: { 
                    loads_per_hour: 4,  // 4 loads/hour √ó 25 tons = 100 TPH
                    hours_operation: 16  // Default 16 hours/day
                }
            }
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function formatNumber(num) {
            return Math.round(num).toLocaleString();
        }

        function adjustColor(color, amount) {
            const num = parseInt(color.replace('#', ''), 16);
            const r = Math.max(0, Math.min(255, (num >> 16) + amount));
            const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
            const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
            return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
        }

        function getDateString(date) {
            return date.toISOString().split('T')[0];
        }

        function parseDate(dateStr) {
            return new Date(dateStr + 'T12:00:00'); // Noon to avoid timezone issues
        }

        // ============================================
        // MAIN RENDER
        // ============================================
        
        function renderApp() {
            const app = document.getElementById('app');
            
            let content = '';
            content += renderHeader();
            content += renderNavTabs();
            
            switch (APP_STATE.currentTab) {
                case 'products':
                    content += renderProductsTab();
                    break;
                case 'flow':
                    content += renderFlowDesignerTab();
                    break;
                case 'demand':
                    content += renderDemandPlanningTab();
                    break;
                case 'plan':
                    content += renderProductionPlanTab();
                    break;
                case 'monitor':
                    content += renderMonitorTab();
                    break;
            }
            
            app.innerHTML = content;
            
            // Initialize tab-specific functionality
            if (APP_STATE.currentTab === 'flow') {
                initializeFlowDesigner();
            }
            
            if (APP_STATE.currentTab === 'plan') {
                initializeProductionPlanScrollSync();
            }
        }
        
        function initializeProductionPlanScrollSync() {
            const topScrollbar = document.getElementById('topScrollbar');
            const tableContainer = document.getElementById('tableScrollContainer');
            const topScrollbarContent = document.getElementById('topScrollbarContent');
            
            if (!topScrollbar || !tableContainer || !topScrollbarContent) return;
            
            // Set scrollbar content width to match table width
            const table = tableContainer.querySelector('table');
            if (table) {
                topScrollbarContent.style.width = table.scrollWidth + 'px';
            }
            
            // Sync top scrollbar with table scroll
            topScrollbar.addEventListener('scroll', function() {
                tableContainer.scrollLeft = topScrollbar.scrollLeft;
            });
            
            // Sync table scroll with top scrollbar
            tableContainer.addEventListener('scroll', function() {
                topScrollbar.scrollLeft = tableContainer.scrollLeft;
            });
        }

        // ============================================
        // HEADER
        // ============================================
        
        function renderHeader() {
            const loc = CEMEX_LOCATIONS[APP_STATE.currentLocation] || CEMEX_LOCATIONS['MIA'];
            const isPlant = loc.type === 'plant';
            return `
                <div class="border-b border-gray-200 shadow-sm" style="background:white;">
                    <!-- TOP BAR: Location identifier & switcher -->
                    <div class="px-6 py-2 flex items-center justify-between" style="background:${loc.color}; color:white;">
                        <div class="flex items-center space-x-2 text-sm font-medium">
                            <span class="font-bold text-white text-base tracking-wide">CEMEX</span>
                            <span class="opacity-60">‚Ä∫</span>
                            <span class="opacity-90">Florida Region</span>
                            <span class="opacity-60">‚Ä∫</span>
                            <span class="font-bold">${loc.icon} ${loc.name}</span>
                            <span class="ml-2 px-2 py-0.5 rounded text-xs font-bold" style="background:rgba(255,255,255,0.25)">${loc.code}</span>
                            <span class="px-2 py-0.5 rounded text-xs" style="background:rgba(255,255,255,0.15)">${isPlant ? 'üè≠ Plant' : 'üì¶ Terminal'}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs opacity-75">Switch:</span>
                            ${Object.values(CEMEX_LOCATIONS).map(l => `
                                <button onclick="switchLocation('${l.code}')"
                                        title="${l.name}"
                                        class="px-2 py-0.5 rounded text-xs font-bold transition-all ${l.code === APP_STATE.currentLocation
                                            ? 'bg-white text-gray-800 shadow'
                                            : 'text-white opacity-60 hover:opacity-100'
                                        }">
                                    ${l.icon} ${l.code}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    <!-- BOTTOM BAR: App title + date -->
                    <div class="px-6 py-3 flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="p-2 rounded-lg text-white" style="background:${loc.color}">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                            </div>
                            <div>
                                <h1 class="text-lg font-bold text-gray-900">Production Planning System</h1>
                                <p class="text-xs text-gray-400">Configure ‚Üí Design ‚Üí Plan ‚Üí Monitor</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="text-right">
                                <div class="text-xs text-gray-400">Today</div>
                                <div class="text-sm font-bold text-gray-900">${APP_STATE.currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>
                            </div>
                            <button onclick="exportAllData()" class="text-white px-3 py-1.5 rounded-lg text-sm" style="background:${loc.color}">
                                üì• Export
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function switchLocation(code) {
            if (!CEMEX_LOCATIONS[code]) return;
            if (code === APP_STATE.currentLocation) return;

            // Save current location data first
            saveToLocalStorage();

            // Switch location
            APP_STATE.currentLocation = code;
            localStorage.setItem('cemex_current_location', code);

            // Reset state for new location (keep UI state)
            APP_STATE.products = {};
            APP_STATE.flowDesigner = { equipment: [], connections: [], nextId: 1 };
            APP_STATE.productionPlan = { campaigns: {} };
            APP_STATE.demandPlan = {};
            APP_STATE.inventory = {};
            APP_STATE.currentTab = 'products';

            // Load new location's data
            loadFromLocalStorage();
            renderApp();
        }

        // ============================================
        // NAVIGATION
        // ============================================
        
        function renderNavTabs() {
            const tabs = [
                { id: 'products', label: '1. Products & Recipes', icon: 'üìã' },
                { id: 'flow', label: '2. Process Flow', icon: 'üè≠' },
                { id: 'demand', label: '3. Demand Planning', icon: 'üìà' },
                { id: 'plan', label: '4. Production Plan', icon: 'üìÖ' },
                { id: 'monitor', label: '5. Monitor & Inventory', icon: 'üìä' }
            ];
            
            return `
                <div class="bg-white border-b border-gray-200">
                    <div class="px-6">
                        <nav class="flex space-x-2">
                            ${tabs.map(tab => `
                                <button 
                                    onclick="switchTab('${tab.id}')"
                                    class="border-b-2 ${APP_STATE.currentTab === tab.id ? 'border-blue-600 text-blue-600 bg-blue-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'} py-3 px-4 font-semibold text-sm transition-colors rounded-t"
                                >
                                    <span class="mr-2">${tab.icon}</span>${tab.label}
                                </button>
                            `).join('')}
                        </nav>
                    </div>
                </div>
            `;
        }

        function switchTab(tabId) {
            APP_STATE.currentTab = tabId;
            renderApp();
        }

        // ============================================
        // GLOBAL RAW MATERIALS LIST
        // ============================================
        
        if (!window.AVAILABLE_RAW_MATERIALS) {
            window.AVAILABLE_RAW_MATERIALS = [
                'Clinker',
                'Gypsum',
                'Limestone',
                'Fly Ash',
                'Slag',
                'Pozzolana',
                'Silica Fume',
                'Rice Husk Ash',
                'Metakaolin'
            ];
        }

        // ============================================
        // TAB 1: PRODUCTS & RECIPES
        // ============================================
        
        function renderProductsTab() {
            const products = Object.values(APP_STATE.products);

            // Group products by family
            const groups = {
                'ck_raw': { label: 'ü™® CK Raw Materials', subtitle: 'Kiln feed materials for clinker production', color: '#78716c', bg: '#f5f5f4', border: '#a8a29e', products: [] },
                'cem_raw': { label: 'üî• CEM Raw Materials', subtitle: 'Clinker & additives for cement grinding', color: '#b45309', bg: '#fffbeb', border: '#fcd34d', products: [] },
                'fuel': { label: '‚õΩ Fuels', subtitle: 'Energy inputs for kiln operation', color: '#dc2626', bg: '#fef2f2', border: '#fca5a5', products: [] },
                'portland_cement': { label: 'üèóÔ∏è Portland Cement', subtitle: 'OPC and standard portland types', color: '#1d4ed8', bg: '#eff6ff', border: '#93c5fd', products: [] },
                'blended_cement': { label: 'üîÑ Blended Cement', subtitle: 'IL, PLC, PCC and blended types', color: '#059669', bg: '#f0fdf4', border: '#6ee7b7', products: [] },
                'specialty_cement': { label: '‚≠ê Specialty Cement', subtitle: 'White, oil well, SR and special types', color: '#7c3aed', bg: '#f5f3ff', border: '#c4b5fd', products: [] }
            };

            products.forEach(p => {
                const fam = p.family || 'portland_cement';
                if (groups[fam]) groups[fam].products.push(p);
                else groups['portland_cement'].products.push(p);
            });

            const groupHTML = Object.entries(groups).map(([key, group]) => `
                <div class="mb-6">
                    <!-- Section Header -->
                    <div class="flex items-center justify-between mb-2 pb-2 border-b-2" style="border-color: ${group.border}">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-bold" style="color: ${group.color}">${group.label}</span>
                            <span class="text-xs text-gray-400">${group.subtitle}</span>
                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full text-white" style="background:${group.color}">${group.products.length}</span>
                        </div>
                        <button onclick="addNewProductOfFamily('${key}')" 
                                class="text-xs px-2 py-1 rounded border font-semibold hover:opacity-80 flex items-center space-x-1"
                                style="color:${group.color}; border-color:${group.color}; background:${group.bg}">
                            <span>+</span><span>Add</span>
                        </button>
                    </div>
                    <!-- Products Grid -->
                    ${group.products.length === 0 ? `
                        <div class="text-xs text-gray-400 italic py-2 pl-2">No ${group.label.split(' ').slice(1).join(' ')} defined yet. Click + Add to create one.</div>
                    ` : `
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-2">
                            ${group.products.map(p => renderProductCard(p, group)).join('')}
                        </div>
                    `}
                </div>
            `).join('');

            return `
                <div class="p-4">
                    <div class="mb-4 flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Products & Recipes</h2>
                            <p class="text-gray-500 text-xs mt-0.5">Define materials and cement types grouped by category</p>
                        </div>
                        <button onclick="addNewProduct()" class="bg-green-600 text-white px-3 py-1.5 rounded-lg hover:bg-green-700 flex items-center space-x-1 text-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            <span>Add Product</span>
                        </button>
                    </div>
                    ${groupHTML}
                </div>
            `;
        }

        function renderProductCard(product, group) {
            const recipeItems = Object.entries(product.recipe || {});
            const totalPercentage = recipeItems.reduce((sum, [mat, pct]) => sum + pct, 0);
            const isValid = recipeItems.length === 0 || Math.abs(totalPercentage - 100) < 0.1;
            const family = product.family || 'portland_cement';
            const isBaseInput = family === 'ck_raw' || family === 'fuel';
            const borderColor = group ? group.border : '#e5e7eb';
            const bgColor = group ? group.bg : '#ffffff';

            return `
                <div class="rounded-lg border p-2 text-xs" style="background:${bgColor}; border-color:${borderColor}; border-width:1.5px;">
                    <!-- Header: name + delete -->
                    <div class="flex items-center justify-between mb-1.5">
                        <span class="font-bold text-gray-800 truncate flex-1 text-xs" title="${product.name}">${product.name}</span>
                        <div class="flex items-center space-x-1 flex-shrink-0">
                            <select onchange="updateProductFamily('${product.id}', this.value)"
                                    class="text-xs border-0 bg-transparent cursor-pointer p-0 pr-1"
                                    title="Change category"
                                    style="font-size:10px; max-width:20px; opacity:0.5">
                                <option value="ck_raw" ${family === 'ck_raw' ? 'selected' : ''}>ü™®</option>
                                <option value="cem_raw" ${family === 'cem_raw' ? 'selected' : ''}>üî•</option>
                                <option value="fuel" ${family === 'fuel' ? 'selected' : ''}>‚õΩ</option>
                                <option value="portland_cement" ${family === 'portland_cement' ? 'selected' : ''}>üèóÔ∏è</option>
                                <option value="blended_cement" ${family === 'blended_cement' ? 'selected' : ''}>üîÑ</option>
                                <option value="specialty_cement" ${family === 'specialty_cement' ? 'selected' : ''}>‚≠ê</option>
                            </select>
                            <button onclick="deleteProduct('${product.id}')" class="text-red-400 hover:text-red-600 p-0.5 rounded">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    ${isBaseInput ? `
                        <div class="text-gray-400 italic text-center py-1" style="font-size:10px">Base input ‚Äî no recipe</div>
                    ` : `
                        <!-- Recipe rows -->
                        <div class="space-y-1 mb-1.5">
                            ${recipeItems.map(([material, percentage]) => `
                                <div class="flex items-center space-x-1">
                                    <select onchange="updateMaterialName('${product.id}', '${material}', this.value)"
                                            class="border border-gray-200 rounded px-1 py-0.5 flex-1 min-w-0 bg-white" style="font-size:10px">
                                        ${getFilteredMaterialsForFamily(family).map(mat =>
                                            `<option value="${mat}" ${mat === material ? 'selected' : ''}>${mat}</option>`
                                        ).join('')}
                                        <option value="__add_new__">+ Add New...</option>
                                    </select>
                                    <input type="number"
                                           value="${percentage}"
                                           min="0" max="100" step="0.1"
                                           onchange="updateMaterialPercentage('${product.id}', '${material}', this.value)"
                                           class="border border-gray-200 rounded px-1 py-0.5 bg-white text-right"
                                           style="width:40px; font-size:10px">
                                    <span class="text-gray-400" style="font-size:10px">%</span>
                                    <button onclick="removeMaterial('${product.id}', '${material}')"
                                            class="text-red-400 hover:text-red-600 flex-shrink-0">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                            `).join('')}
                        </div>

                        <button onclick="addMaterialToProduct('${product.id}')"
                                class="w-full bg-white hover:bg-gray-100 text-gray-500 rounded border border-dashed border-gray-300 py-0.5 mb-1.5"
                                style="font-size:10px">
                            + Add
                        </button>

                        <!-- Total -->
                        <div class="flex items-center justify-between pt-1 border-t border-gray-200">
                            <span class="text-gray-500" style="font-size:10px">Total:</span>
                            <span class="font-bold ${isValid ? 'text-green-600' : 'text-red-600'}" style="font-size:10px">
                                ${recipeItems.length === 0 ? '‚Äî' : totalPercentage.toFixed(1) + '%'}
                                ${isValid ? '‚úì' : '‚úó'}
                            </span>
                        </div>
                    `}
                </div>
            `;
        }

        function addNewProduct() {
            const productName = prompt('Enter product name (e.g., OPC, PPC, IL-11):');
            if (!productName) return;
            
            const productId = productName.toLowerCase().replace(/[^a-z0-9]/g, '_');
            
            if (APP_STATE.products[productId]) {
                alert('Product with this name already exists!');
                return;
            }
            
            APP_STATE.products[productId] = {
                id: productId,
                name: productName,
                family: 'portland_cement', // Default family
                recipe: {},
                color: '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')
            };
            
            saveToLocalStorage();
            renderApp();
        }
        
        function updateProductFamily(productId, newFamily) {
            const product = APP_STATE.products[productId];
            if (!product) return;
            
            product.family = newFamily;
            
            // Clear recipe when changing family (optional - prevents invalid combinations)
            // product.recipe = {};
            
            saveToLocalStorage();
            renderApp();
        }
        
        function getFilteredMaterialsForFamily(family) {
            const allProducts = Object.values(APP_STATE.products);
            switch(family) {
                case 'ck_raw':
                case 'fuel':
                    return [];
                case 'cem_raw':
                    return allProducts.filter(p => p.family === 'ck_raw').map(p => p.name);
                case 'portland_cement':
                case 'blended_cement':
                case 'specialty_cement':
                    return allProducts.filter(p => p.family === 'cem_raw').map(p => p.name);
                default:
                    return allProducts.map(p => p.name);
            }
        }

        function addNewProductOfFamily(family) {
            const familyLabels = {
                'ck_raw': 'CK Raw Material (e.g., Limestone, Clay)',
                'cem_raw': 'CEM Raw Material (e.g., Clinker Gray, Gypsum)',
                'fuel': 'Fuel (e.g., Coal, Pet Coke)',
                'portland_cement': 'Portland Cement (e.g., OPC Type I)',
                'blended_cement': 'Blended Cement (e.g., IL-11, PLC)',
                'specialty_cement': 'Specialty Cement (e.g., White Cement, SR)'
            };
            const productName = prompt('Enter ' + (familyLabels[family] || 'product') + ' name:');
            if (!productName) return;
            const productId = productName.toLowerCase().replace(/[^a-z0-9]/g, '_') + '_' + Date.now();
            APP_STATE.products[productId] = {
                id: productId,
                name: productName,
                family: family,
                recipe: {},
                color: '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')
            };
            saveToLocalStorage();
            renderApp();
        }

        function deleteProduct(productId) {
            if (!confirm(`Delete product "${APP_STATE.products[productId].name}"?`)) return;
            
            delete APP_STATE.products[productId];
            saveToLocalStorage();
            renderApp();
        }

        function addMaterialToProduct(productId) {
            const product = APP_STATE.products[productId];
            if (!product) return;
            
            if (!product.recipe) product.recipe = {};
            
            // Find first available material not in recipe
            const usedMaterials = Object.keys(product.recipe);
            let availableMaterial = window.AVAILABLE_RAW_MATERIALS.find(mat => !usedMaterials.includes(mat));
            
            if (!availableMaterial) {
                // If all materials are used, add "New Material"
                availableMaterial = 'New Material';
            }
            
            product.recipe[availableMaterial] = 0;
            
            saveToLocalStorage();
            renderApp();
        }

        function removeMaterial(productId, material) {
            const product = APP_STATE.products[productId];
            if (!product) return;
            
            delete product.recipe[material];
            saveToLocalStorage();
            renderApp();
        }

        function updateMaterialName(productId, oldMaterial, newMaterial) {
            if (newMaterial === '__add_new__') {
                const customMaterial = prompt('Enter new material name:');
                if (!customMaterial) return;
                
                if (!window.AVAILABLE_RAW_MATERIALS.includes(customMaterial)) {
                    window.AVAILABLE_RAW_MATERIALS.push(customMaterial);
                }
                newMaterial = customMaterial;
            }
            
            const product = APP_STATE.products[productId];
            if (!product) return;
            
            const percentage = product.recipe[oldMaterial];
            delete product.recipe[oldMaterial];
            product.recipe[newMaterial] = percentage;
            
            saveToLocalStorage();
            renderApp();
        }

        function updateMaterialPercentage(productId, material, newPercentage) {
            const product = APP_STATE.products[productId];
            if (!product) return;
            
            product.recipe[material] = parseFloat(newPercentage) || 0;
            saveToLocalStorage();
            renderApp();
        }

        function closeRecipeModal() {
            document.getElementById('recipeModal').classList.remove('active');
        }

        // ============================================
        // TAB 2: PROCESS FLOW DESIGNER (Simplified - same as before)
        // ============================================
        
        function renderFlowDesignerTab() {
            return `
                <div class="bg-gray-800 border-b border-gray-700 p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-white font-semibold text-lg">Process Flow Designer</h2>
                            <p class="text-gray-400 text-sm">Design your plant layout and equipment connections</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="btnFlowRules" class="bg-purple-600 text-white px-3 py-2 rounded text-sm hover:bg-purple-700 font-semibold">
                                ‚öôÔ∏è Rules
                            </button>
                            <button id="btnFlowClear" class="bg-gray-700 text-gray-200 px-3 py-2 rounded text-sm hover:bg-gray-600">
                                üóëÔ∏è Clear
                            </button>
                            <button id="btnFlowLoad" class="bg-gray-700 text-gray-200 px-3 py-2 rounded text-sm hover:bg-gray-600">
                                üìÇ Load
                            </button>
                            <button id="btnFlowSave" class="bg-gray-700 text-gray-200 px-3 py-2 rounded text-sm hover:bg-gray-600">
                                üíæ Export
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex" style="height: calc(100vh - 280px);">
                    <!-- Left Toolbar -->
                    <div id="flowToolbar" class="w-64 bg-gray-800 border-r border-gray-700 p-4 overflow-y-auto">
                        <h3 class="text-white font-semibold mb-2 text-sm">Equipment Library</h3>
                        <p class="text-gray-400 text-xs mb-4">Drag onto canvas ‚Üí</p>
                        <div id="equipmentLibrary"></div>
                    </div>

                    <!-- Main Canvas -->
                    <div id="flowCanvasContainer" class="flex-1 relative bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900">
                        <svg id="flowCanvas" class="absolute inset-0 w-full h-full">
                            <defs>
                                <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                                    <path d="M 40 0 L 0 0 0 40" fill="none" stroke="white" stroke-width="0.5" opacity="0.1"/>
                                </pattern>
                                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                    <polygon points="0 0, 10 3, 0 6" fill="#60a5fa" />
                                </marker>
                            </defs>
                            <rect width="100%" height="100%" fill="url(#grid)" />
                            <g id="connectionsLayer"></g>
                            <g id="equipmentLayer"></g>
                        </svg>

                        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-blue-900 bg-opacity-90 text-white px-6 py-3 rounded-lg border border-blue-500">
                            <div class="flex items-center space-x-4 text-sm">
                                <div>üñ±Ô∏è <span class="font-semibold">Drag</span> from left</div>
                                <div>üîó <span class="font-semibold">Click ports</span> to connect</div>
                                <div>üìù <span class="font-semibold">Double-click</span> to edit</div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel -->
                    <div id="flowRightPanel" class="w-80 bg-gray-800 border-l border-gray-700 p-4 overflow-y-auto">
                        <div id="flowInspectorView">
                            <h3 class="text-white font-semibold mb-4">Inspector</h3>
                            <div id="flowInspector" class="text-gray-400 text-sm">
                                Select equipment to view details
                            </div>
                        </div>
                        <div id="flowRulesView" class="hidden">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-white font-semibold">Rules of Engagement</h3>
                                <button onclick="closeRulesPanel()" class="text-gray-400 hover:text-white">‚úï</button>
                            </div>
                            <div id="flowRulesContent"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function initializeFlowDesigner() {
            // Load saved flow
            loadFlowFromLocalStorage();
            
            renderFlowEquipmentLibrary();
            setupFlowDesignerEvents();
            renderFlowCanvas();
        }

        function renderFlowEquipmentLibrary() {
            const library = document.getElementById('equipmentLibrary');
            if (!library) return;
            
            library.innerHTML = '';

            const categories = {
                'Sources': ['raw_material', 'additive', 'fuel'],
                'Processing': ['raw_mill', 'kiln', 'finish_mill', 'packing'],
                'Storage': ['silo'],
                'Dispatch': ['loadout']
            };

            Object.entries(categories).forEach(([category, types]) => {
                const header = document.createElement('div');
                header.className = 'text-xs font-semibold text-gray-400 mb-2 uppercase mt-4';
                header.textContent = category;
                library.appendChild(header);

                types.forEach(type => {
                    const def = EQUIPMENT_TYPES[type];
                    if (!def) return;

                    const el = document.createElement('div');
                    el.className = 'toolbar-item bg-gray-700 rounded-lg p-3 mb-2';
                    el.style.background = `linear-gradient(135deg, ${def.color}, ${adjustColor(def.color, -20)})`;
                    el.style.cursor = 'grab';
                    el.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <div class="text-2xl">${def.icon}</div>
                            <div class="flex-1">
                                <div class="text-white font-semibold text-sm">${def.name}</div>
                            </div>
                        </div>
                    `;
                    el.draggable = true;
                    el.dataset.type = type;
                    
                    el.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('equipmentType', type);
                        el.style.opacity = '0.5';
                    });
                    
                    el.addEventListener('dragend', () => {
                        el.style.opacity = '1';
                    });
                    
                    library.appendChild(el);
                });
            });
        }

        // This contains the updated Flow Designer functions
// Will be inserted into the HTML file

function setupFlowDesignerEvents() {
    const container = document.getElementById('flowCanvasContainer');
    const canvas = document.getElementById('flowCanvas');
    
    if (!container || !canvas) return;

    let isDraggingCanvas = false;
    let isSelecting = false;
    let dragStartX = 0, dragStartY = 0;

    // Mouse wheel zoom
    canvas.addEventListener('wheel', (e) => {
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
        const newZoom = Math.max(0.25, Math.min(2, APP_STATE.flowDesigner.zoom * zoomFactor));
        
        // Zoom towards mouse position
        const zoomChange = newZoom / APP_STATE.flowDesigner.zoom;
        APP_STATE.flowDesigner.panX = mouseX - (mouseX - APP_STATE.flowDesigner.panX) * zoomChange;
        APP_STATE.flowDesigner.panY = mouseY - (mouseY - APP_STATE.flowDesigner.panY) * zoomChange;
        APP_STATE.flowDesigner.zoom = newZoom;
        
        renderFlowCanvas();
    });

    // Selection rectangle & panning
    canvas.addEventListener('mousedown', (e) => {
        if (e.target === canvas || e.target.id === 'equipmentLayer' || e.target.id === 'connectionsLayer') {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left - APP_STATE.flowDesigner.panX) / APP_STATE.flowDesigner.zoom;
            const y = (e.clientY - rect.top - APP_STATE.flowDesigner.panY) / APP_STATE.flowDesigner.zoom;
            
            // Check if clicking on empty space
            const clickedEq = APP_STATE.flowDesigner.equipment.find(eq => {
                const def = EQUIPMENT_TYPES[eq.type];
                return x >= eq.x && x <= eq.x + def.width && y >= eq.y && y <= eq.y + def.height;
            });
            
            if (!clickedEq) {
                // Start selection rectangle
                isSelecting = true;
                APP_STATE.flowDesigner.selection = {
                    active: true,
                    startX: x,
                    startY: y,
                    endX: x,
                    endY: y
                };
                APP_STATE.flowDesigner.selectedIds = []; // Clear selection
            }
        }
    });

    canvas.addEventListener('mousemove', (e) => {
        if (isSelecting) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left - APP_STATE.flowDesigner.panX) / APP_STATE.flowDesigner.zoom;
            const y = (e.clientY - rect.top - APP_STATE.flowDesigner.panY) / APP_STATE.flowDesigner.zoom;
            
            APP_STATE.flowDesigner.selection.endX = x;
            APP_STATE.flowDesigner.selection.endY = y;
            
            // Update selected items
            const minX = Math.min(APP_STATE.flowDesigner.selection.startX, x);
            const maxX = Math.max(APP_STATE.flowDesigner.selection.startX, x);
            const minY = Math.min(APP_STATE.flowDesigner.selection.startY, y);
            const maxY = Math.max(APP_STATE.flowDesigner.selection.startY, y);
            
            APP_STATE.flowDesigner.selectedIds = APP_STATE.flowDesigner.equipment
                .filter(eq => {
                    const def = EQUIPMENT_TYPES[eq.type];
                    return eq.x + def.width > minX && eq.x < maxX && 
                           eq.y + def.height > minY && eq.y < maxY;
                })
                .map(eq => eq.id);
            
            renderFlowCanvas();
        }
    });

    canvas.addEventListener('mouseup', () => {
        if (isSelecting) {
            isSelecting = false;
            APP_STATE.flowDesigner.selection.active = false;
            renderFlowCanvas();
        }
    });

    // Drag & drop from library
    container.addEventListener('dragover', (e) => e.preventDefault());
    container.addEventListener('drop', (e) => {
        e.preventDefault();
        const type = e.dataTransfer.getData('equipmentType');
        if (type) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left - APP_STATE.flowDesigner.panX) / APP_STATE.flowDesigner.zoom;
            const y = (e.clientY - rect.top - APP_STATE.flowDesigner.panY) / APP_STATE.flowDesigner.zoom;
            addFlowEquipment(type, x, y);
        }
    });

    // Buttons
    const btnFlowClear = document.getElementById('btnFlowClear');
    if (btnFlowClear) {
        btnFlowClear.addEventListener('click', () => {
            if (confirm('Clear all equipment?')) {
                APP_STATE.flowDesigner.equipment = [];
                APP_STATE.flowDesigner.connections = [];
                APP_STATE.flowDesigner.selectedEquipment = null;
                APP_STATE.flowDesigner.selectedIds = [];
                renderFlowCanvas();
                saveFlowToLocalStorage();
            }
        });
    }

    const btnFlowSave = document.getElementById('btnFlowSave');
    if (btnFlowSave) btnFlowSave.addEventListener('click', exportFlowToFile);

    const btnFlowLoad = document.getElementById('btnFlowLoad');
    if (btnFlowLoad) btnFlowLoad.addEventListener('click', importFlowFromFile);

    const btnFlowRules = document.getElementById('btnFlowRules');
    if (btnFlowRules) btnFlowRules.addEventListener('click', openRulesPanel);
}

function renderFlowCanvas() {
    renderFlowConnections();
    renderFlowEquipment();
    renderSelectionRect();
}

function renderSelectionRect() {
    const layer = document.getElementById('equipmentLayer');
    if (!layer) return;
    
    // Remove old selection rect if exists
    const oldRect = document.getElementById('selectionRect');
    if (oldRect) oldRect.remove();
    
    if (!APP_STATE.flowDesigner.selection.active) return;
    
    const sel = APP_STATE.flowDesigner.selection;
    const x = Math.min(sel.startX, sel.endX);
    const y = Math.min(sel.startY, sel.endY);
    const width = Math.abs(sel.endX - sel.startX);
    const height = Math.abs(sel.endY - sel.startY);
    
    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    rect.setAttribute('id', 'selectionRect');
    rect.setAttribute('x', x);
    rect.setAttribute('y', y);
    rect.setAttribute('width', width);
    rect.setAttribute('height', height);
    rect.setAttribute('fill', 'none');
    rect.setAttribute('stroke', '#3b82f6');
    rect.setAttribute('stroke-width', 2 / APP_STATE.flowDesigner.zoom);
    rect.setAttribute('stroke-dasharray', `${10 / APP_STATE.flowDesigner.zoom}`);
    rect.setAttribute('pointer-events', 'none');
    
    layer.appendChild(rect);
}

function renderFlowConnections() {
    const layer = document.getElementById('connectionsLayer');
    if (!layer) return;
    
    layer.innerHTML = '';

    APP_STATE.flowDesigner.connections.forEach(conn => {
        const fromEq = APP_STATE.flowDesigner.equipment.find(e => e.id === conn.from);
        const toEq = APP_STATE.flowDesigner.equipment.find(e => e.id === conn.to);

        if (!fromEq || !toEq) return;

        const fromDef = EQUIPMENT_TYPES[fromEq.type];
        const toDef = EQUIPMENT_TYPES[toEq.type];

        // Auto-smart routing: pick best sides
        const fromCenter = { x: fromEq.x + fromDef.width / 2, y: fromEq.y + fromDef.height / 2 };
        const toCenter = { x: toEq.x + toDef.width / 2, y: toEq.y + toDef.height / 2 };
        
        let fromX, fromY, toX, toY;
        
        // Determine best exit/entry points
        const dx = toCenter.x - fromCenter.x;
        const dy = toCenter.y - fromCenter.y;
        
        // From side selection
        if (Math.abs(dx) > Math.abs(dy)) {
            // Horizontal preference
            if (dx > 0) {
                fromX = fromEq.x + fromDef.width;
                fromY = fromEq.y + fromDef.height / 2;
            } else {
                fromX = fromEq.x;
                fromY = fromEq.y + fromDef.height / 2;
            }
        } else {
            // Vertical preference
            if (dy > 0) {
                fromX = fromEq.x + fromDef.width / 2;
                fromY = fromEq.y + fromDef.height;
            } else {
                fromX = fromEq.x + fromDef.width / 2;
                fromY = fromEq.y;
            }
        }
        
        // To side selection (opposite logic)
        if (Math.abs(dx) > Math.abs(dy)) {
            if (dx > 0) {
                toX = toEq.x;
                toY = toEq.y + toDef.height / 2;
            } else {
                toX = toEq.x + toDef.width;
                toY = toEq.y + toDef.height / 2;
            }
        } else {
            if (dy > 0) {
                toX = toEq.x + toDef.width / 2;
                toY = toEq.y;
            } else {
                toX = toEq.x + toDef.width / 2;
                toY = toEq.y + toDef.height;
            }
        }

        // Create beautiful Bezier curves using the dx/dy already calculated above
        // Control points create the curve
        let controlX1, controlY1, controlX2, controlY2;
        
        if (Math.abs(dx) > Math.abs(dy)) {
            // Horizontal connection - create vertical curve
            const curveAmount = Math.abs(dy) > 20 ? dy * 0.5 : 50; // Minimum 50px curve
            controlX1 = fromX + dx * 0.4;
            controlY1 = fromY + curveAmount;
            controlX2 = fromX + dx * 0.6;
            controlY2 = toY - curveAmount;
        } else {
            // Vertical connection - create horizontal curve
            const curveAmount = Math.abs(dx) > 20 ? dx * 0.5 : 50; // Minimum 50px curve
            controlX1 = fromX + curveAmount;
            controlY1 = fromY + dy * 0.4;
            controlX2 = toX - curveAmount;
            controlY2 = fromY + dy * 0.6;
        }
        
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        const d = `M ${fromX} ${fromY} C ${controlX1} ${controlY1}, ${controlX2} ${controlY2}, ${toX} ${toY}`;
        path.setAttribute('d', d);
        path.setAttribute('stroke', '#60a5fa');
        path.setAttribute('stroke-width', '4');
        path.setAttribute('fill', 'none');
        path.setAttribute('class', 'connection-line');
        path.setAttribute('marker-end', 'url(#arrowhead)');
        path.setAttribute('opacity', '0.8');
        path.style.cursor = 'pointer';
        path.addEventListener('click', () => {
            if (confirm('Delete connection?')) {
                APP_STATE.flowDesigner.connections = APP_STATE.flowDesigner.connections.filter(c => c.id !== conn.id);
                renderFlowCanvas();
                saveFlowToLocalStorage();
            }
        });

        layer.appendChild(path);
    });
}

function renderFlowEquipment() {
    const layer = document.getElementById('equipmentLayer');
    if (!layer) return;
    
    // Clear but keep selection rect
    const selRect = document.getElementById('selectionRect');
    layer.innerHTML = '';
    if (selRect) layer.appendChild(selRect);

    APP_STATE.flowDesigner.equipment.forEach(eq => {
        const def = EQUIPMENT_TYPES[eq.type];
        const isSelected = APP_STATE.flowDesigner.selectedIds.includes(eq.id);
        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        g.setAttribute('class', `equipment-node ${isSelected ? 'selected' : ''}`);

        // Box with selection highlight
        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', eq.x);
        rect.setAttribute('y', eq.y);
        rect.setAttribute('width', def.width);
        rect.setAttribute('height', def.height);
        rect.setAttribute('rx', 10);
        rect.setAttribute('fill', def.color);
        rect.setAttribute('stroke', isSelected ? '#3b82f6' : 'white');
        rect.setAttribute('stroke-width', isSelected ? 4 : 2);
        if (isSelected) {
            rect.setAttribute('filter', 'drop-shadow(0px 4px 8px rgba(59, 130, 246, 0.5))');
        }
        g.appendChild(rect);

        // Icon
        const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        icon.setAttribute('x', eq.x + def.width / 2);
        icon.setAttribute('y', eq.y + 40);
        icon.setAttribute('text-anchor', 'middle');
        icon.setAttribute('font-size', '32');
        icon.textContent = def.icon;
        g.appendChild(icon);

        // Name
        const name = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        name.setAttribute('x', eq.x + def.width / 2);
        name.setAttribute('y', eq.y + def.height - 20);
        name.setAttribute('text-anchor', 'middle');
        name.setAttribute('fill', 'white');
        name.setAttribute('font-size', '11');
        name.setAttribute('font-weight', 'bold');
        
        let displayName = eq.name;
        if (eq.type === 'raw_material' && eq.params.material_name) {
            displayName = eq.params.material_name;
        } else if (eq.type === 'fuel' && eq.params.fuel_name) {
            displayName = eq.params.fuel_name;
        } else if (eq.type === 'additive' && eq.params.additive_name) {
            displayName = eq.params.additive_name;
        } else if (eq.type === 'kiln' && eq.params.clinker_type) {
            const clinkerTypes = {
                'gray': 'Gray', 'white': 'White', 'oil_well': 'Oil Well',
                'sulphate_resistant': 'SR', 'low_heat': 'Low Heat'
            };
            const typeLabel = clinkerTypes[eq.params.clinker_type] || '';
            displayName = typeLabel ? `${eq.name} (${typeLabel})` : eq.name;
        }
        
        name.textContent = displayName;
        g.appendChild(name);

        // Status indicator
        const status = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        status.setAttribute('cx', eq.x + def.width - 10);
        status.setAttribute('cy', eq.y + 10);
        status.setAttribute('r', 4);
        status.setAttribute('fill', '#10b981');
        g.appendChild(status);

        // Ports
        if (def.outputs.length > 0) {
            const port = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            port.setAttribute('cx', eq.x + def.width);
            port.setAttribute('cy', eq.y + def.height / 2);
            port.setAttribute('r', 6);
            port.setAttribute('fill', '#3b82f6');
            port.setAttribute('class', 'port');
            port.addEventListener('click', (e) => {
                e.stopPropagation();
                startFlowConnection(eq.id);
            });
            g.appendChild(port);
        }

        if (def.inputs.length > 0) {
            const port = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            port.setAttribute('cx', eq.x);
            port.setAttribute('cy', eq.y + def.height / 2);
            port.setAttribute('r', 6);
            port.setAttribute('fill', '#10b981');
            port.setAttribute('class', 'port');
            port.addEventListener('click', (e) => {
                e.stopPropagation();
                completeFlowConnection(eq.id);
            });
            g.appendChild(port);
        }

        // Click to select
        g.addEventListener('click', (e) => {
            if (!e.target.classList.contains('port')) {
                selectFlowEquipment(eq.id);
            }
        });

        // Multi-select drag
        let isDragging = false;
        let startX, startY;
        let dragOffsets = [];

        g.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('port')) return;
            isDragging = true;
            
            if (!isSelected) {
                APP_STATE.flowDesigner.selectedIds = [eq.id];
                renderFlowCanvas();
            }
            
            // Calculate offsets for all selected items
            dragOffsets = APP_STATE.flowDesigner.selectedIds.map(id => {
                const item = APP_STATE.flowDesigner.equipment.find(e => e.id === id);
                return {
                    id: id,
                    offsetX: e.clientX / APP_STATE.flowDesigner.zoom - item.x,
                    offsetY: e.clientY / APP_STATE.flowDesigner.zoom - item.y
                };
            });
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                dragOffsets.forEach(offset => {
                    const item = APP_STATE.flowDesigner.equipment.find(eq => eq.id === offset.id);
                    if (item) {
                        item.x = e.clientX / APP_STATE.flowDesigner.zoom - offset.offsetX;
                        item.y = e.clientY / APP_STATE.flowDesigner.zoom - offset.offsetY;
                    }
                });
                renderFlowCanvas();
            }
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                saveFlowToLocalStorage();
            }
        });

        layer.appendChild(g);
    });
    
    // Apply zoom/pan transform
    const equipLayer = document.getElementById('equipmentLayer');
    const connLayer = document.getElementById('connectionsLayer');
    if (equipLayer) equipLayer.setAttribute('transform', `translate(${APP_STATE.flowDesigner.panX}, ${APP_STATE.flowDesigner.panY}) scale(${APP_STATE.flowDesigner.zoom})`);
    if (connLayer) connLayer.setAttribute('transform', `translate(${APP_STATE.flowDesigner.panX}, ${APP_STATE.flowDesigner.panY}) scale(${APP_STATE.flowDesigner.zoom})`);
}

function selectFlowEquipment(id) {
    APP_STATE.flowDesigner.selectedEquipment = id;
    APP_STATE.flowDesigner.selectedIds = [id];
    renderFlowCanvas();
    updateFlowInspector();
}

                function addFlowEquipment(type, x, y) {
            const def = EQUIPMENT_TYPES[type];
            
            // For finish mills, populate available products from products tab
            let params = { ...def.defaultParams };
            if (type === 'finish_mill') {
                params.available_products = Object.keys(APP_STATE.products);
            }
            
            const equipment = {
                id: `eq_${APP_STATE.flowDesigner.nextId++}`,
                type: type,
                name: `${def.name} ${APP_STATE.flowDesigner.nextId - 1}`,
                x: x - def.width / 2,
                y: y - def.height / 2,
                params: params
            };
            
            APP_STATE.flowDesigner.equipment.push(equipment);
            renderFlowCanvas();
            saveFlowToLocalStorage();
        }

        function renderFlowCanvas() {
            renderFlowConnections();
            renderFlowEquipment();
        }

        function renderFlowConnections() {
            const layer = document.getElementById('connectionsLayer');
            if (!layer) return;
            
            layer.innerHTML = '';

            APP_STATE.flowDesigner.connections.forEach(conn => {
                const fromEq = APP_STATE.flowDesigner.equipment.find(e => e.id === conn.from);
                const toEq = APP_STATE.flowDesigner.equipment.find(e => e.id === conn.to);

                if (!fromEq || !toEq) return;

                const fromDef = EQUIPMENT_TYPES[fromEq.type];
                const toDef = EQUIPMENT_TYPES[toEq.type];

                const fromX = fromEq.x + fromDef.width;
                const fromY = fromEq.y + fromDef.height / 2;
                const toX = toEq.x;
                const toY = toEq.y + toDef.height / 2;

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const d = `M ${fromX} ${fromY} L ${toX} ${toY}`;
                line.setAttribute('d', d);
                line.setAttribute('class', 'connection-line');
                line.setAttribute('marker-end', 'url(#arrowhead)');
                line.addEventListener('click', () => {
                    if (confirm('Delete connection?')) {
                        APP_STATE.flowDesigner.connections = APP_STATE.flowDesigner.connections.filter(c => c.id !== conn.id);
                        renderFlowCanvas();
                        saveFlowToLocalStorage();
                    }
                });

                layer.appendChild(line);
            });
        }

        function renderFlowEquipment() {
            const layer = document.getElementById('equipmentLayer');
            if (!layer) return;
            
            layer.innerHTML = '';

            APP_STATE.flowDesigner.equipment.forEach(eq => {
                const def = EQUIPMENT_TYPES[eq.type];
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('class', `equipment-node ${APP_STATE.flowDesigner.selectedEquipment === eq.id ? 'selected' : ''}`);

                // Box
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', eq.x);
                rect.setAttribute('y', eq.y);
                rect.setAttribute('width', def.width);
                rect.setAttribute('height', def.height);
                rect.setAttribute('rx', 10);
                rect.setAttribute('fill', def.color);
                rect.setAttribute('stroke', 'white');
                rect.setAttribute('stroke-width', 2);
                g.appendChild(rect);

                // Icon
                const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                icon.setAttribute('x', eq.x + def.width / 2);
                icon.setAttribute('y', eq.y + 40);
                icon.setAttribute('text-anchor', 'middle');
                icon.setAttribute('font-size', '32');
                icon.textContent = def.icon;
                g.appendChild(icon);

                // Name
                const name = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                name.setAttribute('x', eq.x + def.width / 2);
                name.setAttribute('y', eq.y + def.height - 20);
                name.setAttribute('text-anchor', 'middle');
                name.setAttribute('fill', 'white');
                name.setAttribute('font-size', '11');
                name.setAttribute('font-weight', 'bold');
                
                let displayName = eq.name;
                if (eq.type === 'raw_material' && eq.params.material_id && APP_STATE.products[eq.params.material_id]) {
                    displayName = APP_STATE.products[eq.params.material_id].name;
                } else if (eq.type === 'fuel' && eq.params.fuel_id && APP_STATE.products[eq.params.fuel_id]) {
                    displayName = APP_STATE.products[eq.params.fuel_id].name;
                } else if (eq.type === 'additive' && eq.params.additive_id && APP_STATE.products[eq.params.additive_id]) {
                    displayName = APP_STATE.products[eq.params.additive_id].name;
                } else if (eq.type === 'silo' && eq.params.product_id && APP_STATE.products[eq.params.product_id]) {
                    displayName = APP_STATE.products[eq.params.product_id].name;
                } else if (eq.type === 'kiln' && eq.params.clinker_type) {
                    const clinkerTypes = {
                        'gray': 'Gray',
                        'white': 'White',
                        'oil_well': 'Oil Well',
                        'sulphate_resistant': 'SR',
                        'low_heat': 'Low Heat'
                    };
                    const typeLabel = clinkerTypes[eq.params.clinker_type] || '';
                    displayName = typeLabel ? `${eq.name} (${typeLabel})` : eq.name;
                }
                
                name.textContent = displayName;
                g.appendChild(name);

                // Status
                const status = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                status.setAttribute('cx', eq.x + def.width - 10);
                status.setAttribute('cy', eq.y + 10);
                status.setAttribute('r', 4);
                status.setAttribute('fill', '#10b981');
                g.appendChild(status);

                // Ports
                if (def.outputs.length > 0) {
                    const port = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    port.setAttribute('cx', eq.x + def.width);
                    port.setAttribute('cy', eq.y + def.height / 2);
                    port.setAttribute('r', 6);
                    port.setAttribute('fill', '#3b82f6');
                    port.setAttribute('class', 'port');
                    port.addEventListener('click', (e) => {
                        e.stopPropagation();
                        startFlowConnection(eq.id);
                    });
                    g.appendChild(port);
                }

                if (def.inputs.length > 0) {
                    const port = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    port.setAttribute('cx', eq.x);
                    port.setAttribute('cy', eq.y + def.height / 2);
                    port.setAttribute('r', 6);
                    port.setAttribute('fill', '#10b981');
                    port.setAttribute('class', 'port');
                    port.addEventListener('click', (e) => {
                        e.stopPropagation();
                        completeFlowConnection(eq.id);
                    });
                    g.appendChild(port);
                }

                // Events
                g.addEventListener('click', () => selectFlowEquipment(eq.id));

                // Drag
                let isDragging = false;
                let startX, startY;

                g.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('port')) return;
                    isDragging = true;
                    startX = e.clientX - eq.x;
                    startY = e.clientY - eq.y;
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        eq.x = e.clientX - startX;
                        eq.y = e.clientY - startY;
                        renderFlowCanvas();
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        saveFlowToLocalStorage();
                    }
                });

                layer.appendChild(g);
            });
        }

        function startFlowConnection(equipmentId) {
            APP_STATE.flowDesigner.connecting = { from: equipmentId };
        }

        function completeFlowConnection(equipmentId) {
            if (!APP_STATE.flowDesigner.connecting) return;

            const fromEq = APP_STATE.flowDesigner.equipment.find(e => e.id === APP_STATE.flowDesigner.connecting.from);
            const toEq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);

            if (!fromEq || !toEq || fromEq.id === toEq.id) {
                APP_STATE.flowDesigner.connecting = null;
                return;
            }

            const fromType = EQUIPMENT_TYPES[fromEq.type];
            const toType = EQUIPMENT_TYPES[toEq.type];

            const canConnect = fromType.outputs.some(out => toType.inputs.includes(out));

            if (canConnect) {
                const connection = {
                    id: `conn_${APP_STATE.flowDesigner.nextId++}`,
                    from: fromEq.id,
                    to: toEq.id,
                    material: fromType.outputs.find(out => toType.inputs.includes(out))
                };
                APP_STATE.flowDesigner.connections.push(connection);
                saveFlowToLocalStorage();
            } else {
                alert('Incompatible materials!');
            }

            APP_STATE.flowDesigner.connecting = null;
            renderFlowCanvas();
        }

        function selectFlowEquipment(id) {
            APP_STATE.flowDesigner.selectedEquipment = id;
            renderFlowCanvas();
            updateFlowInspector();
        }

        function updateFlowInspector() {
            const panel = document.getElementById('flowInspector');
            if (!panel) return;
            
            if (!APP_STATE.flowDesigner.selectedEquipment) {
                panel.innerHTML = '<div class="text-gray-400 text-sm">Select equipment to view specs</div>';
                return;
            }

            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === APP_STATE.flowDesigner.selectedEquipment);
            if (!eq) return;

            const def = EQUIPMENT_TYPES[eq.type];

            let specsHTML = '';

            // Generate specs form based on equipment type
            if (eq.type === 'kiln') {
                specsHTML = `
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Clinker Type</label>
                            <select onchange="updateEquipmentParam('${eq.id}', 'clinker_type', this.value)"
                                    class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                                <option value="gray" ${(eq.params.clinker_type || 'gray') === 'gray' ? 'selected' : ''}>Gray Clinker (OPC)</option>
                                <option value="white" ${eq.params.clinker_type === 'white' ? 'selected' : ''}>White Clinker</option>
                                <option value="oil_well" ${eq.params.clinker_type === 'oil_well' ? 'selected' : ''}>Oil Well Cement Clinker</option>
                                <option value="sulphate_resistant" ${eq.params.clinker_type === 'sulphate_resistant' ? 'selected' : ''}>Sulphate Resistant Clinker</option>
                                <option value="low_heat" ${eq.params.clinker_type === 'low_heat' ? 'selected' : ''}>Low Heat Clinker</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Type of clinker produced by this kiln</p>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">TPD (Tons Per Day)</label>
                            <input type="number" value="${eq.params.tpd || 2000}" 
                                   onchange="updateEquipmentParam('${eq.id}', 'tpd', parseFloat(this.value))"
                                   class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">GCal/TM of Clinker</label>
                            <input type="number" value="${eq.params.gcal_per_tm_ck || 750}" step="0.1"
                                   onchange="updateEquipmentParam('${eq.id}', 'gcal_per_tm_ck', parseFloat(this.value))"
                                   class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Raw Meal to Clinker Factor</label>
                            <input type="number" value="${eq.params.rm_to_clinker_factor || 1.55}" step="0.01"
                                   onchange="updateEquipmentParam('${eq.id}', 'rm_to_clinker_factor', parseFloat(this.value))"
                                   class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                        </div>
                    </div>
                `;
            } else if (eq.type === 'finish_mill') {
                // Only show cement products (portland, blended, specialty)
                const availableProducts = Object.keys(APP_STATE.products).filter(prodId => {
                    const product = APP_STATE.products[prodId];
                    return product.family === 'portland_cement' || 
                           product.family === 'blended_cement' || 
                           product.family === 'specialty_cement';
                });
                
                if (!eq.params.products) eq.params.products = {};
                
                const enabledProducts = Object.entries(eq.params.products)
                    .filter(([prodId, data]) => data.enabled && APP_STATE.products[prodId])
                    .map(([prodId, data]) => ({
                        id: prodId,
                        name: APP_STATE.products[prodId].name,
                        tpd: data.tpd || 0,
                        kwh_per_ton: data.kwh_per_ton || 0
                    }));
                
                specsHTML = `
                    <div class="space-y-2">
                        <button onclick="showAddProductToMill('${eq.id}')" 
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded text-sm font-semibold">
                            + Add Product
                        </button>
                        
                        ${availableProducts.length === 0 ? `
                            <div class="bg-yellow-900 border border-yellow-600 rounded p-3 text-xs">
                                <strong class="text-yellow-200">‚ö†Ô∏è No cement products defined!</strong><br>
                                <span class="text-yellow-300">Go to Tab 1 to create cement products (Portland, Blended, or Specialty).</span><br>
                                <button onclick="switchTab('products')" class="mt-2 bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-xs">
                                    ‚Üí Go to Products Tab
                                </button>
                            </div>
                        ` : ''}
                        
                        ${enabledProducts.length > 0 ? `
                            <div class="bg-gray-900 rounded border border-gray-700 overflow-hidden">
                                <table class="w-full text-xs">
                                    <thead class="bg-gray-800 text-gray-300">
                                        <tr>
                                            <th class="text-left p-2 font-semibold">Product</th>
                                            <th class="text-right p-2 font-semibold">TPD</th>
                                            <th class="text-right p-2 font-semibold">kWh/t</th>
                                            <th class="w-8"></th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-white">
                                        ${enabledProducts.map(prod => `
                                            <tr class="border-t border-gray-800">
                                                <td class="p-2">${prod.name}</td>
                                                <td class="p-1 text-right">
                                                    <input type="number" value="${prod.tpd}" 
                                                           onchange="updateMillProductTPD('${eq.id}', '${prod.id}', parseFloat(this.value))"
                                                           class="w-16 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-right text-xs">
                                                </td>
                                                <td class="p-1 text-right">
                                                    <input type="number" value="${prod.kwh_per_ton}" 
                                                           onchange="updateMillProductEnergy('${eq.id}', '${prod.id}', parseFloat(this.value))"
                                                           class="w-16 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-right text-xs">
                                                </td>
                                                <td class="p-1 text-center">
                                                    <button onclick="removeProductFromMill('${eq.id}', '${prod.id}')"
                                                            class="text-red-400 hover:text-red-300 text-xs">
                                                        ‚úï
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<div class="text-xs text-gray-500 text-center py-3">No products added yet</div>'}
                        
                        <div id="addProductForm_${eq.id}" class="hidden bg-gray-800 rounded p-3 space-y-2">
                            <div class="text-xs font-semibold text-gray-300 mb-2">Add Product to Mill</div>
                            <select id="productSelect_${eq.id}" class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                <option value="">-- Select Product --</option>
                                ${availableProducts.filter(prodId => !eq.params.products[prodId]?.enabled).map(prodId => 
                                    `<option value="${prodId}">${APP_STATE.products[prodId].name}</option>`
                                ).join('')}
                            </select>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">TPD</label>
                                    <input type="number" id="productTPD_${eq.id}" placeholder="1800" 
                                           class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">kWh/ton</label>
                                    <input type="number" id="productEnergy_${eq.id}" placeholder="45" 
                                           class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="cancelAddProductToMill('${eq.id}')" 
                                        class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-1 rounded text-xs">
                                    Cancel
                                </button>
                                <button onclick="confirmAddProductToMill('${eq.id}')" 
                                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-1 rounded text-xs">
                                    Add
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (eq.type === 'silo') {
                const availableProducts = Object.keys(APP_STATE.products);
                
                specsHTML = `
                    <div class="space-y-2">
                        ${availableProducts.length === 0 ? `
                            <div class="bg-yellow-900 border border-yellow-600 rounded p-3 text-xs">
                                <strong class="text-yellow-200">‚ö†Ô∏è No products defined!</strong><br>
                                <span class="text-yellow-300">Create products in Tab 1 first.</span><br>
                                <button onclick="switchTab('products')" class="mt-2 bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-xs">
                                    ‚Üí Go to Products Tab
                                </button>
                            </div>
                        ` : `
                            <div>
                                <label class="block text-xs font-semibold text-gray-300 mb-1">Stored Product</label>
                                <select onchange="updateEquipmentParam('${eq.id}', 'product_id', this.value)"
                                        class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                    <option value="">-- Select Product --</option>
                                    ${availableProducts.map(prodId => {
                                        const product = APP_STATE.products[prodId];
                                        return `<option value="${prodId}" ${eq.params.product_id === prodId ? 'selected' : ''}>${product.name}</option>`;
                                    }).join('')}
                                </select>
                            </div>
                        `}
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Max Capacity (tons)</label>
                            <input type="number" value="${eq.params.max_capacity_tons || 5000}" 
                                   onchange="updateEquipmentParam('${eq.id}', 'max_capacity_tons', parseFloat(this.value))"
                                   class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Min Threshold (tons)</label>
                            <input type="number" value="${eq.params.min_threshold_tons || 500}" 
                                   onchange="updateEquipmentParam('${eq.id}', 'min_threshold_tons', parseFloat(this.value))"
                                   class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                            <div class="mt-1 text-xs text-gray-500">
                                Alert when inventory falls below this level
                            </div>
                        </div>
                    </div>
                `;
            } else if (eq.type === 'packing') {
                // Only show cement products
                const availableProducts = Object.keys(APP_STATE.products).filter(prodId => {
                    const product = APP_STATE.products[prodId];
                    return product.family === 'portland_cement' || 
                           product.family === 'blended_cement' || 
                           product.family === 'specialty_cement';
                });
                
                if (!eq.params.products) eq.params.products = {};
                
                const enabledProducts = Object.entries(eq.params.products)
                    .filter(([prodId, data]) => data.enabled && APP_STATE.products[prodId])
                    .map(([prodId, data]) => ({
                        id: prodId,
                        name: APP_STATE.products[prodId].name,
                        pallets_per_hour: data.pallets_per_hour || 0,
                        tons_per_pallet: data.tons_per_pallet || 0
                    }));
                
                specsHTML = `
                    <div class="space-y-2">
                        <button onclick="showAddProductToPacking('${eq.id}')" 
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded text-sm font-semibold">
                            + Add Product
                        </button>
                        
                        ${availableProducts.length === 0 ? `
                            <div class="bg-yellow-900 border border-yellow-600 rounded p-3 text-xs">
                                <strong class="text-yellow-200">‚ö†Ô∏è No cement products defined!</strong><br>
                                <span class="text-yellow-300">Go to Tab 1 to create cement products.</span><br>
                                <button onclick="switchTab('products')" class="mt-2 bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-xs">
                                    ‚Üí Go to Products Tab
                                </button>
                            </div>
                        ` : ''}
                        
                        ${enabledProducts.length > 0 ? `
                            <div class="bg-gray-900 rounded border border-gray-700 overflow-hidden">
                                <table class="w-full text-xs">
                                    <thead class="bg-gray-800 text-gray-300">
                                        <tr>
                                            <th class="text-left p-2 font-semibold">Product</th>
                                            <th class="text-right p-2 font-semibold">Pal/hr</th>
                                            <th class="text-right p-2 font-semibold">t/pal</th>
                                            <th class="w-8"></th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-white">
                                        ${enabledProducts.map(prod => `
                                            <tr class="border-t border-gray-800">
                                                <td class="p-2">${prod.name}</td>
                                                <td class="p-1 text-right">
                                                    <input type="number" value="${prod.pallets_per_hour}" 
                                                           onchange="updatePackingProductPallets('${eq.id}', '${prod.id}', parseFloat(this.value))"
                                                           class="w-16 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-right text-xs">
                                                </td>
                                                <td class="p-1 text-right">
                                                    <input type="number" value="${prod.tons_per_pallet}" step="0.01"
                                                           onchange="updatePackingProductTons('${eq.id}', '${prod.id}', parseFloat(this.value))"
                                                           class="w-16 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-right text-xs">
                                                </td>
                                                <td class="p-1 text-center">
                                                    <button onclick="removeProductFromPacking('${eq.id}', '${prod.id}')"
                                                            class="text-red-400 hover:text-red-300 text-xs">
                                                        ‚úï
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<div class="text-xs text-gray-500 text-center py-3">No products added yet</div>'}
                        
                        <div id="addProductFormPacking_${eq.id}" class="hidden bg-gray-800 rounded p-3 space-y-2">
                            <div class="text-xs font-semibold text-gray-300 mb-2">Add Product to Packing Line</div>
                            <select id="productSelectPacking_${eq.id}" class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                <option value="">-- Select Product --</option>
                                ${availableProducts.filter(prodId => !eq.params.products[prodId]?.enabled).map(prodId => 
                                    `<option value="${prodId}">${APP_STATE.products[prodId].name}</option>`
                                ).join('')}
                            </select>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Pallets/hour</label>
                                    <input type="number" id="productPalletsPacking_${eq.id}" placeholder="100" 
                                           class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Tons/pallet</label>
                                    <input type="number" id="productTonsPacking_${eq.id}" placeholder="1.25" step="0.01"
                                           class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="cancelAddProductToPacking('${eq.id}')" 
                                        class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-1 rounded text-xs">
                                    Cancel
                                </button>
                                <button onclick="confirmAddProductToPacking('${eq.id}')" 
                                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-1 rounded text-xs">
                                    Add
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (eq.type === 'loadout') {
                // Only show cement products
                const availableProducts = Object.keys(APP_STATE.products).filter(prodId => {
                    const product = APP_STATE.products[prodId];
                    return product.family === 'portland_cement' || 
                           product.family === 'blended_cement' || 
                           product.family === 'specialty_cement';
                });
                
                if (!eq.params.products) eq.params.products = {};
                
                const enabledProducts = Object.entries(eq.params.products)
                    .filter(([prodId, data]) => data.enabled && APP_STATE.products[prodId])
                    .map(([prodId, data]) => ({
                        id: prodId,
                        name: APP_STATE.products[prodId].name,
                        loads_per_day: data.loads_per_day || 0,
                        tons_per_load: data.tons_per_load || 0
                    }));
                
                specsHTML = `
                    <div class="space-y-2">
                        <button onclick="showAddProductToLoadout('${eq.id}')" 
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded text-sm font-semibold">
                            + Add Product
                        </button>
                        
                        ${availableProducts.length === 0 ? `
                            <div class="bg-yellow-900 border border-yellow-600 rounded p-3 text-xs">
                                <strong class="text-yellow-200">‚ö†Ô∏è No cement products defined!</strong><br>
                                <span class="text-yellow-300">Go to Tab 1 to create cement products.</span><br>
                                <button onclick="switchTab('products')" class="mt-2 bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-xs">
                                    ‚Üí Go to Products Tab
                                </button>
                            </div>
                        ` : ''}
                        
                        ${enabledProducts.length > 0 ? `
                            <div class="bg-gray-900 rounded border border-gray-700 overflow-hidden">
                                <table class="w-full text-xs">
                                    <thead class="bg-gray-800 text-gray-300">
                                        <tr>
                                            <th class="text-left p-2 font-semibold">Product</th>
                                            <th class="text-right p-2 font-semibold">Loads/day</th>
                                            <th class="text-right p-2 font-semibold">t/load</th>
                                            <th class="w-8"></th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-white">
                                        ${enabledProducts.map(prod => `
                                            <tr class="border-t border-gray-800">
                                                <td class="p-2">${prod.name}</td>
                                                <td class="p-1 text-right">
                                                    <input type="number" value="${prod.loads_per_day}" 
                                                           onchange="updateLoadoutProductLoads('${eq.id}', '${prod.id}', parseFloat(this.value))"
                                                           class="w-16 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-right text-xs">
                                                </td>
                                                <td class="p-1 text-right">
                                                    <input type="number" value="${prod.tons_per_load}" step="0.1"
                                                           onchange="updateLoadoutProductTons('${eq.id}', '${prod.id}', parseFloat(this.value))"
                                                           class="w-16 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-right text-xs">
                                                </td>
                                                <td class="p-1 text-center">
                                                    <button onclick="removeProductFromLoadout('${eq.id}', '${prod.id}')"
                                                            class="text-red-400 hover:text-red-300 text-xs">
                                                        ‚úï
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<div class="text-xs text-gray-500 text-center py-3">No products added yet</div>'}
                        
                        <div id="addProductFormLoadout_${eq.id}" class="hidden bg-gray-800 rounded p-3 space-y-2">
                            <div class="text-xs font-semibold text-gray-300 mb-2">Add Product to Loadout</div>
                            <select id="productSelectLoadout_${eq.id}" class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                <option value="">-- Select Product --</option>
                                ${availableProducts.filter(prodId => !eq.params.products[prodId]?.enabled).map(prodId => 
                                    `<option value="${prodId}">${APP_STATE.products[prodId].name}</option>`
                                ).join('')}
                            </select>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Loads/day</label>
                                    <input type="number" id="productLoadsLoadout_${eq.id}" placeholder="80" 
                                           class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Tons/load</label>
                                    <input type="number" id="productTonsLoadout_${eq.id}" placeholder="25" step="0.1"
                                           class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="cancelAddProductToLoadout('${eq.id}')" 
                                        class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-1 rounded text-xs">
                                    Cancel
                                </button>
                                <button onclick="confirmAddProductToLoadout('${eq.id}')" 
                                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-1 rounded text-xs">
                                    Add
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (eq.type === 'raw_material') {
                // Show dropdown of CK Raw materials from Tab 1
                const rawMaterials = Object.keys(APP_STATE.products).filter(prodId => {
                    return APP_STATE.products[prodId].family === 'ck_raw';
                });
                
                specsHTML = `
                    <div class="space-y-2">
                        ${rawMaterials.length === 0 ? `
                            <div class="bg-yellow-900 border border-yellow-600 rounded p-3 text-xs">
                                <strong class="text-yellow-200">‚ö†Ô∏è No raw materials defined!</strong><br>
                                <span class="text-yellow-300">Go to Tab 1 to create CK Raw materials.</span><br>
                                <button onclick="switchTab('products')" class="mt-2 bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-xs">
                                    ‚Üí Go to Products Tab
                                </button>
                            </div>
                        ` : `
                            <div>
                                <label class="block text-xs font-semibold text-gray-300 mb-1">Raw Material Type</label>
                                <select onchange="updateEquipmentParam('${eq.id}', 'material_id', this.value)"
                                        class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                    <option value="">-- Select Material --</option>
                                    ${rawMaterials.map(prodId => {
                                        const product = APP_STATE.products[prodId];
                                        return `<option value="${prodId}" ${eq.params.material_id === prodId ? 'selected' : ''}>${product.name}</option>`;
                                    }).join('')}
                                </select>
                                <div class="mt-1 text-xs text-gray-500">
                                    Direct connection - infinite availability assumed
                                </div>
                            </div>
                        `}
                    </div>
                `;
            } else if (eq.type === 'fuel') {
                // Show dropdown of Fuels from Tab 1
                const fuels = Object.keys(APP_STATE.products).filter(prodId => {
                    return APP_STATE.products[prodId].family === 'fuel';
                });
                
                specsHTML = `
                    <div class="space-y-2">
                        ${fuels.length === 0 ? `
                            <div class="bg-yellow-900 border border-yellow-600 rounded p-3 text-xs">
                                <strong class="text-yellow-200">‚ö†Ô∏è No fuels defined!</strong><br>
                                <span class="text-yellow-300">Go to Tab 1 to create Fuel products.</span><br>
                                <button onclick="switchTab('products')" class="mt-2 bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-xs">
                                    ‚Üí Go to Products Tab
                                </button>
                            </div>
                        ` : `
                            <div>
                                <label class="block text-xs font-semibold text-gray-300 mb-1">Fuel Type</label>
                                <select onchange="updateEquipmentParam('${eq.id}', 'fuel_id', this.value)"
                                        class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                    <option value="">-- Select Fuel --</option>
                                    ${fuels.map(prodId => {
                                        const product = APP_STATE.products[prodId];
                                        return `<option value="${prodId}" ${eq.params.fuel_id === prodId ? 'selected' : ''}>${product.name}</option>`;
                                    }).join('')}
                                </select>
                                <div class="mt-1 text-xs text-gray-500">
                                    Direct connection - infinite availability assumed
                                </div>
                            </div>
                        `}
                    </div>
                `;
            } else if (eq.type === 'additive') {
                // Show dropdown of CEM Raw materials from Tab 1 (for additives like gypsum)
                const additives = Object.keys(APP_STATE.products).filter(prodId => {
                    return APP_STATE.products[prodId].family === 'cem_raw';
                });
                
                specsHTML = `
                    <div class="space-y-2">
                        ${additives.length === 0 ? `
                            <div class="bg-yellow-900 border border-yellow-600 rounded p-3 text-xs">
                                <strong class="text-yellow-200">‚ö†Ô∏è No additives defined!</strong><br>
                                <span class="text-yellow-300">Go to Tab 1 to create CEM Raw materials (Gypsum, Fly Ash, etc).</span><br>
                                <button onclick="switchTab('products')" class="mt-2 bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-xs">
                                    ‚Üí Go to Products Tab
                                </button>
                            </div>
                        ` : `
                            <div>
                                <label class="block text-xs font-semibold text-gray-300 mb-1">Additive Type</label>
                                <select onchange="updateEquipmentParam('${eq.id}', 'additive_id', this.value)"
                                        class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                    <option value="">-- Select Additive --</option>
                                    ${additives.map(prodId => {
                                        const product = APP_STATE.products[prodId];
                                        return `<option value="${prodId}" ${eq.params.additive_id === prodId ? 'selected' : ''}>${product.name}</option>`;
                                    }).join('')}
                                </select>
                                <div class="mt-1 text-xs text-gray-500">
                                    Direct connection - infinite availability assumed
                                </div>
                            </div>
                        `}
                    </div>
                `;
            } else {
                // Generic parameters for other equipment
                specsHTML = `
                    <div class="text-xs text-gray-400">
                        Basic equipment - no additional specs required
                    </div>
                `;
            }

            panel.innerHTML = `
                <div class="bg-gray-900 rounded-lg p-4 mb-4">
                    <div class="mb-3">
                        <label class="block text-xs font-semibold text-gray-300 mb-1">Equipment Name</label>
                        <input type="text" value="${eq.name}" 
                               onchange="updateEquipmentName('${eq.id}', this.value)"
                               class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm font-semibold">
                    </div>
                    <div class="text-xs text-gray-400 mb-3">Type: ${def.name}</div>
                    ${specsHTML}
                </div>
                <div class="bg-gray-900 rounded-lg p-4">
                    <button onclick="removeFlowEquipment('${eq.id}')" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded text-sm">
                        üóëÔ∏è Remove Equipment
                    </button>
                </div>
            `;
        }

        function updateEquipmentParam(equipmentId, paramName, value) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq) return;
            
            eq.params[paramName] = value;
            saveFlowToLocalStorage();
            updateFlowInspector(); // Refresh to show updated values
        }

        function updateEquipmentName(equipmentId, newName) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq) return;
            
            eq.name = newName;
            saveFlowToLocalStorage();
            renderFlowCanvas(); // Re-render to show new name on canvas
            updateFlowInspector(); // Refresh inspector
        }

        function toggleProductForMill(equipmentId, productId, enabled) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq) return;
            
            if (!eq.params.products) eq.params.products = {};
            
            if (enabled) {
                eq.params.products[productId] = { enabled: true, tpd: 0 };
            } else {
                delete eq.params.products[productId];
            }
            
            saveFlowToLocalStorage();
            updateFlowInspector();
        }

        function updateMillProductTPD(equipmentId, productId, tpd) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq || !eq.params.products || !eq.params.products[productId]) return;
            
            eq.params.products[productId].tpd = tpd;
            saveFlowToLocalStorage();
        }

        function updateMillProductEnergy(equipmentId, productId, kwh_per_ton) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq || !eq.params.products || !eq.params.products[productId]) return;
            
            eq.params.products[productId].kwh_per_ton = kwh_per_ton;
            saveFlowToLocalStorage();
        }

        function showAddProductToMill(equipmentId) {
            const form = document.getElementById(`addProductForm_${equipmentId}`);
            if (form) {
                form.classList.remove('hidden');
            }
        }

        function cancelAddProductToMill(equipmentId) {
            const form = document.getElementById(`addProductForm_${equipmentId}`);
            if (form) {
                form.classList.add('hidden');
                // Reset form
                document.getElementById(`productSelect_${equipmentId}`).value = '';
                document.getElementById(`productTPD_${equipmentId}`).value = '';
                document.getElementById(`productEnergy_${equipmentId}`).value = '';
            }
        }

        function confirmAddProductToMill(equipmentId) {
            const productId = document.getElementById(`productSelect_${equipmentId}`).value;
            const tpd = parseFloat(document.getElementById(`productTPD_${equipmentId}`).value) || 0;
            const kwh_per_ton = parseFloat(document.getElementById(`productEnergy_${equipmentId}`).value) || 0;
            
            if (!productId) {
                alert('Please select a product');
                return;
            }
            
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq) return;
            
            if (!eq.params.products) eq.params.products = {};
            
            eq.params.products[productId] = {
                enabled: true,
                tpd: tpd,
                kwh_per_ton: kwh_per_ton
            };
            
            saveFlowToLocalStorage();
            updateFlowInspector();
        }

        function removeProductFromMill(equipmentId, productId) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq || !eq.params.products) return;
            
            delete eq.params.products[productId];
            
            saveFlowToLocalStorage();
            updateFlowInspector();
        }

        // ============================================
        // PACKING SYSTEM PRODUCT MANAGEMENT
        // ============================================

        function showAddProductToPacking(equipmentId) {
            const form = document.getElementById(`addProductFormPacking_${equipmentId}`);
            if (form) form.classList.remove('hidden');
        }

        function cancelAddProductToPacking(equipmentId) {
            const form = document.getElementById(`addProductFormPacking_${equipmentId}`);
            if (form) {
                form.classList.add('hidden');
                document.getElementById(`productSelectPacking_${equipmentId}`).value = '';
                document.getElementById(`productPalletsPacking_${equipmentId}`).value = '';
                document.getElementById(`productTonsPacking_${equipmentId}`).value = '';
            }
        }

        function confirmAddProductToPacking(equipmentId) {
            const productId = document.getElementById(`productSelectPacking_${equipmentId}`).value;
            const pallets_per_hour = parseFloat(document.getElementById(`productPalletsPacking_${equipmentId}`).value) || 0;
            const tons_per_pallet = parseFloat(document.getElementById(`productTonsPacking_${equipmentId}`).value) || 0;
            
            if (!productId) {
                alert('Please select a product');
                return;
            }
            
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq) return;
            
            if (!eq.params.products) eq.params.products = {};
            
            eq.params.products[productId] = {
                enabled: true,
                pallets_per_hour: pallets_per_hour,
                tons_per_pallet: tons_per_pallet
            };
            
            saveFlowToLocalStorage();
            updateFlowInspector();
        }

        function updatePackingProductPallets(equipmentId, productId, pallets_per_hour) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq || !eq.params.products || !eq.params.products[productId]) return;
            
            eq.params.products[productId].pallets_per_hour = pallets_per_hour;
            saveFlowToLocalStorage();
        }

        function updatePackingProductTons(equipmentId, productId, tons_per_pallet) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq || !eq.params.products || !eq.params.products[productId]) return;
            
            eq.params.products[productId].tons_per_pallet = tons_per_pallet;
            saveFlowToLocalStorage();
        }

        function removeProductFromPacking(equipmentId, productId) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq || !eq.params.products) return;
            
            delete eq.params.products[productId];
            
            saveFlowToLocalStorage();
            updateFlowInspector();
        }

        // ============================================
        // LOADOUT PRODUCT MANAGEMENT
        // ============================================

        function showAddProductToLoadout(equipmentId) {
            const form = document.getElementById(`addProductFormLoadout_${equipmentId}`);
            if (form) form.classList.remove('hidden');
        }

        function cancelAddProductToLoadout(equipmentId) {
            const form = document.getElementById(`addProductFormLoadout_${equipmentId}`);
            if (form) {
                form.classList.add('hidden');
                document.getElementById(`productSelectLoadout_${equipmentId}`).value = '';
                document.getElementById(`productLoadsLoadout_${equipmentId}`).value = '';
                document.getElementById(`productTonsLoadout_${equipmentId}`).value = '';
            }
        }

        function confirmAddProductToLoadout(equipmentId) {
            const productId = document.getElementById(`productSelectLoadout_${equipmentId}`).value;
            const loads_per_day = parseFloat(document.getElementById(`productLoadsLoadout_${equipmentId}`).value) || 0;
            const tons_per_load = parseFloat(document.getElementById(`productTonsLoadout_${equipmentId}`).value) || 0;
            
            if (!productId) {
                alert('Please select a product');
                return;
            }
            
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq) return;
            
            if (!eq.params.products) eq.params.products = {};
            
            eq.params.products[productId] = {
                enabled: true,
                loads_per_day: loads_per_day,
                tons_per_load: tons_per_load
            };
            
            saveFlowToLocalStorage();
            updateFlowInspector();
        }

        function updateLoadoutProductLoads(equipmentId, productId, loads_per_day) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq || !eq.params.products || !eq.params.products[productId]) return;
            
            eq.params.products[productId].loads_per_day = loads_per_day;
            saveFlowToLocalStorage();
        }

        function updateLoadoutProductTons(equipmentId, productId, tons_per_load) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq || !eq.params.products || !eq.params.products[productId]) return;
            
            eq.params.products[productId].tons_per_load = tons_per_load;
            saveFlowToLocalStorage();
        }

        function removeProductFromLoadout(equipmentId, productId) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq || !eq.params.products) return;
            
            delete eq.params.products[productId];
            
            saveFlowToLocalStorage();
            updateFlowInspector();
        }

        function removeFlowEquipment(id) {
            if (confirm('Remove equipment?')) {
                APP_STATE.flowDesigner.equipment = APP_STATE.flowDesigner.equipment.filter(e => e.id !== id);
                APP_STATE.flowDesigner.connections = APP_STATE.flowDesigner.connections.filter(c => c.from !== id && c.to !== id);
                APP_STATE.flowDesigner.selectedEquipment = null;
                renderFlowCanvas();
                updateFlowInspector();
                saveFlowToLocalStorage();
            }
        }

        // ============================================
        // RULES OF ENGAGEMENT PANEL
        // ============================================

        function openRulesPanel() {
            // Check if we're in Flow Designer tab or Production Plan tab
            const flowInspector = document.getElementById('flowInspectorView');
            const flowRules = document.getElementById('flowRulesView');
            
            if (flowInspector && flowRules) {
                // Flow Designer tab - use existing panel
                flowInspector.classList.add('hidden');
                flowRules.classList.remove('hidden');
                renderRulesPanel();
            } else {
                // Production Plan or other tab - show modal
                showRulesModal();
            }
        }

        function showRulesModal() {
            const modal = document.createElement('div');
            modal.id = 'rulesModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-purple-600 to-purple-700 text-white px-6 py-4 rounded-t-lg sticky top-0">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold">‚öôÔ∏è Rules of Engagement</h3>
                            <button onclick="closeRulesModal()" class="text-white hover:text-gray-200">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <p class="text-gray-600 mb-4">Production planning rules and constraints</p>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p class="text-sm text-blue-900">Rules panel integration coming soon...</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeRulesModal() {
            const modal = document.getElementById('rulesModal');
            if (modal) modal.remove();
        }

        function closeRulesPanel() {
            // Show inspector, hide rules
            document.getElementById('flowRulesView').classList.add('hidden');
            document.getElementById('flowInspectorView').classList.remove('hidden');
        }

        function renderRulesPanel() {
            const content = document.getElementById('flowRulesContent');
            if (!content) return;

            // Get all cement products for priority ordering
            const cementProducts = Object.keys(APP_STATE.products).filter(prodId => {
                const product = APP_STATE.products[prodId];
                return product.family === 'portland_cement' || 
                       product.family === 'blended_cement' || 
                       product.family === 'specialty_cement';
            });

            // Initialize product priorities if not set
            if (!APP_STATE.rules.operational.product_priorities || 
                Object.keys(APP_STATE.rules.operational.product_priorities).length === 0) {
                cementProducts.forEach((prodId, index) => {
                    if (!APP_STATE.rules.operational.product_priorities) {
                        APP_STATE.rules.operational.product_priorities = {};
                    }
                    APP_STATE.rules.operational.product_priorities[prodId] = index + 1;
                });
            }

            content.innerHTML = `
                <div class="space-y-4">
                    <!-- System Rules (Read-only) -->
                    <div class="bg-gray-900 rounded-lg p-3 border border-gray-700">
                        <div class="flex items-center space-x-2 mb-3">
                            <span class="text-xl">üîí</span>
                            <h4 class="text-white font-semibold text-sm">System Rules</h4>
                        </div>
                        <div class="space-y-2 text-xs">
                            <div class="flex items-start space-x-2 text-green-400">
                                <span class="mt-0.5">‚úì</span>
                                <span>Silos hold only one product (must empty to switch)</span>
                            </div>
                            <div class="flex items-start space-x-2 text-green-400">
                                <span class="mt-0.5">‚úì</span>
                                <span>Equipment produces one product at a time</span>
                            </div>
                            <div class="flex items-start space-x-2 text-green-400">
                                <span class="mt-0.5">‚úì</span>
                                <span>Inventory cannot go negative</span>
                            </div>
                            <div class="flex items-start space-x-2 text-green-400">
                                <span class="mt-0.5">‚úì</span>
                                <span>Recipes must be followed exactly</span>
                            </div>
                            <div class="flex items-start space-x-2 text-green-400">
                                <span class="mt-0.5">‚úì</span>
                                <span>Silo capacity limits enforced</span>
                            </div>
                        </div>
                    </div>

                    <!-- Operational Rules (Configurable) -->
                    <div class="bg-gray-900 rounded-lg p-3 border border-gray-700">
                        <div class="flex items-center space-x-2 mb-3">
                            <span class="text-xl">‚öôÔ∏è</span>
                            <h4 class="text-white font-semibold text-sm">Operational Rules</h4>
                        </div>
                        
                        <div class="space-y-3">
                            <!-- Clinker Shortage Response -->
                            <div>
                                <label class="block text-xs font-semibold text-gray-300 mb-1">
                                    Clinker Shortage Response
                                </label>
                                <select id="ruleClikerShortage" 
                                        class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                    <option value="stop_mills_sequential" ${APP_STATE.rules.operational.clinker_shortage_response === 'stop_mills_sequential' ? 'selected' : ''}>
                                        Stop mills one-by-one (FM ‚Üí Raw Mill ‚Üí Kiln)
                                    </option>
                                    <option value="stop_all_immediately" ${APP_STATE.rules.operational.clinker_shortage_response === 'stop_all_immediately' ? 'selected' : ''}>
                                        Stop all mills immediately
                                    </option>
                                    <option value="reduce_production" ${APP_STATE.rules.operational.clinker_shortage_response === 'reduce_production' ? 'selected' : ''}>
                                        Reduce production proportionally
                                    </option>
                                </select>
                                <div class="text-xs text-gray-500 mt-1">
                                    What happens when clinker silo is empty
                                </div>
                            </div>

                            <!-- Campaign Minimum Length -->
                            <div>
                                <label class="block text-xs font-semibold text-gray-300 mb-1">
                                    Campaign Minimum Length
                                </label>
                                <div class="flex items-center space-x-2">
                                    <input type="number" id="ruleCampaignMinHours" 
                                           value="${APP_STATE.rules.operational.campaign_minimum_hours}"
                                           min="0" max="168"
                                           class="flex-1 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                    <span class="text-gray-400 text-xs">hours</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    Minimum time a mill must run one product
                                </div>
                            </div>

                            <!-- Changeover Time -->
                            <div>
                                <label class="block text-xs font-semibold text-gray-300 mb-1">
                                    Product Changeover Time
                                </label>
                                <div class="flex items-center space-x-2">
                                    <input type="number" id="ruleChangeoverHours" 
                                           value="${APP_STATE.rules.operational.changeover_time_hours}"
                                           min="0" max="24" step="0.5"
                                           class="flex-1 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                    <span class="text-gray-400 text-xs">hours</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    Downtime when switching products (0 = instant)
                                </div>
                            </div>

                            <!-- Operating Mode -->
                            <div>
                                <label class="block text-xs font-semibold text-gray-300 mb-2">
                                    Default Operating Mode
                                </label>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center space-x-2 cursor-pointer">
                                        <input type="radio" name="operatingMode" value="24/7" 
                                               ${APP_STATE.rules.operational.default_operating_mode === '24/7' ? 'checked' : ''}
                                               class="text-blue-600">
                                        <span class="text-xs text-white">24/7 Operation</span>
                                    </label>
                                    <label class="flex items-center space-x-2 cursor-pointer">
                                        <input type="radio" name="operatingMode" value="shifts"
                                               ${APP_STATE.rules.operational.default_operating_mode === 'shifts' ? 'checked' : ''}
                                               class="text-blue-600">
                                        <span class="text-xs text-white">Shift-based</span>
                                    </label>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    FM, Raw Mill, Kiln, Packers, Loadout
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Product Priorities -->
                    ${cementProducts.length > 0 ? `
                        <div class="bg-gray-900 rounded-lg p-3 border border-gray-700">
                            <div class="flex items-center space-x-2 mb-3">
                                <span class="text-xl">üéØ</span>
                                <h4 class="text-white font-semibold text-sm">Product Priorities</h4>
                            </div>
                            <div class="text-xs text-gray-400 mb-2">
                                When capacity is limited, which products get priority?
                            </div>
                            <div class="space-y-2" id="productPriorityList">
                                ${cementProducts
                                    .sort((a, b) => {
                                        const prioA = APP_STATE.rules.operational.product_priorities[a] || 999;
                                        const prioB = APP_STATE.rules.operational.product_priorities[b] || 999;
                                        return prioA - prioB;
                                    })
                                    .map((prodId, index) => {
                                        const product = APP_STATE.products[prodId];
                                        return `
                                            <div class="flex items-center space-x-2 bg-gray-800 rounded p-2">
                                                <div class="flex flex-col space-y-1">
                                                    <button onclick="moveProductPriorityUp('${prodId}')" 
                                                            ${index === 0 ? 'disabled' : ''}
                                                            class="text-gray-400 hover:text-white disabled:opacity-30 text-xs">
                                                        ‚ñ≤
                                                    </button>
                                                    <button onclick="moveProductPriorityDown('${prodId}')" 
                                                            ${index === cementProducts.length - 1 ? 'disabled' : ''}
                                                            class="text-gray-400 hover:text-white disabled:opacity-30 text-xs">
                                                        ‚ñº
                                                    </button>
                                                </div>
                                                <div class="flex items-center space-x-2 flex-1">
                                                    <span class="text-gray-400 text-xs w-6">${index + 1}.</span>
                                                    <span class="text-white text-xs">${product.name}</span>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                            </div>
                        </div>
                    ` : `
                        <div class="bg-yellow-900 border border-yellow-600 rounded p-3 text-xs">
                            <strong class="text-yellow-200">‚ö†Ô∏è No products defined!</strong><br>
                            <span class="text-yellow-300">Create cement products in Tab 1 first.</span>
                        </div>
                    `}

                    <!-- Holidays -->
                    <div class="bg-gray-900 rounded-lg p-3 border border-gray-700">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-2">
                                <span class="text-xl">üóìÔ∏è</span>
                                <h4 class="text-white font-semibold text-sm">Holidays & Non-Working Days</h4>
                            </div>
                            <button onclick="openHolidaysPanel()" 
                                    class="bg-purple-600 hover:bg-purple-700 text-white px-2 py-1 rounded text-xs font-semibold">
                                Manage
                            </button>
                        </div>
                        <div class="text-xs text-gray-400">
                            ${APP_STATE.rules.holidays && APP_STATE.rules.holidays.length > 0 
                                ? `<strong class="text-white">${APP_STATE.rules.holidays.length}</strong> holiday${APP_STATE.rules.holidays.length !== 1 ? 's' : ''} defined`
                                : 'No holidays defined yet'}
                        </div>
                    </div>

                    <!-- Save Button -->
                    <button onclick="saveRules()" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded text-sm font-semibold">
                        üíæ Save Rules
                    </button>
                </div>
            `;
        }

        function saveRules() {
            // Save operational rules from form
            APP_STATE.rules.operational.clinker_shortage_response = 
                document.getElementById('ruleClikerShortage').value;
            
            APP_STATE.rules.operational.campaign_minimum_hours = 
                parseInt(document.getElementById('ruleCampaignMinHours').value) || 24;
            
            APP_STATE.rules.operational.changeover_time_hours = 
                parseFloat(document.getElementById('ruleChangeoverHours').value) || 0;
            
            const operatingMode = document.querySelector('input[name="operatingMode"]:checked');
            if (operatingMode) {
                APP_STATE.rules.operational.default_operating_mode = operatingMode.value;
            }

            // Save to localStorage
            saveToLocalStorage();
            
            alert('‚úÖ Rules saved successfully!');
        }

        function moveProductPriorityUp(productId) {
            const priorities = APP_STATE.rules.operational.product_priorities;
            const currentPrio = priorities[productId];
            
            // Find product with priority just above
            const products = Object.keys(priorities);
            const aboveProduct = products.find(id => priorities[id] === currentPrio - 1);
            
            if (aboveProduct) {
                // Swap priorities
                priorities[productId] = currentPrio - 1;
                priorities[aboveProduct] = currentPrio;
                renderRulesPanel();
            }
        }

        function moveProductPriorityDown(productId) {
            const priorities = APP_STATE.rules.operational.product_priorities;
            const currentPrio = priorities[productId];
            
            // Find product with priority just below
            const products = Object.keys(priorities);
            const belowProduct = products.find(id => priorities[id] === currentPrio + 1);
            
            if (belowProduct) {
                // Swap priorities
                priorities[productId] = currentPrio + 1;
                priorities[belowProduct] = currentPrio;
                renderRulesPanel();
            }
        }

        // ============================================
        // TAB 3: DEMAND PLANNING
        // ============================================
        
        function renderDemandPlanningTab() {
            // Filter to only show cement products
            const allProducts = Object.values(APP_STATE.products);
            const products = allProducts.filter(product => {
                return product.family === 'portland_cement' || 
                       product.family === 'blended_cement' || 
                       product.family === 'specialty_cement';
            });
            
            if (products.length === 0) {
                return `
                    <div class="p-6">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
                            <svg class="w-16 h-16 mx-auto text-yellow-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">No Cement Products Defined</h3>
                            <p class="text-gray-600 mb-4">Define cement products (Portland, Blended, or Specialty) in Tab 1 first</p>
                            <button onclick="switchTab('products')" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                                Go to Products & Recipes
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // Get date range: 30 days back + today + 60 days forward
            const today = new Date(APP_STATE.currentDate);
            const startDate = new Date(today);
            startDate.setDate(startDate.getDate() - 30);
            
            const endDate = new Date(today);
            endDate.setDate(endDate.getDate() + 60);
            
            const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            
            return `
                <div class="bg-white border-b border-gray-200 px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Demand Planning</h2>
                            <p class="text-sm text-gray-500">Daily demand forecast for cement products (TPD)</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="flex items-center space-x-2 text-sm">
                                <div class="flex items-center space-x-1">
                                    <div class="w-3 h-3 bg-white border border-gray-300"></div>
                                    <span class="text-gray-600">Working Day</span>
                                </div>
                                <div class="flex items-center space-x-1 ml-3">
                                    <div class="w-3 h-3 bg-blue-50 border border-blue-200"></div>
                                    <span class="text-gray-600">Today</span>
                                </div>
                                <div class="flex items-center space-x-1 ml-3">
                                    <div class="w-3 h-3 bg-red-100 border border-red-300"></div>
                                    <span class="text-gray-600">Holiday</span>
                                </div>
                            </div>
                            <button onclick="clearAllDemandData()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 text-sm font-semibold">
                                üóëÔ∏è Clear All
                            </button>
                            <button onclick="openHolidaysPanel()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm font-semibold">
                                üóìÔ∏è Holidays
                            </button>
                            <button onclick="exportDemandData()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
                                üì• Export
                            </button>
                        </div>
                    </div>
                </div>

                <div class="p-6">
                    ${renderDemandGrid(products, startDate, totalDays, today)}
                </div>
            `;
        }

        function renderDemandGrid(products, startDate, totalDays, today) {
            // Use shared date header generation
            const dateHeaders = generateDateHeaders(startDate, totalDays, today);
            
            // Group dates by year and month - MORE CAREFULLY
            const yearGroups = {};
            
            dateHeaders.forEach(header => {
                const dateObj = header.date;
                const year = dateObj.getFullYear().toString(); // "2026"
                const month = dateObj.getMonth(); // 0-11
                const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`; // "2026-01"
                
                if (!yearGroups[year]) {
                    yearGroups[year] = {
                        year: year,
                        yearShort: year.substring(2, 4), // "26"
                        months: {}
                    };
                }
                
                if (!yearGroups[year].months[monthKey]) {
                    // Get month name from actual date
                    const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
                    yearGroups[year].months[monthKey] = {
                        key: monthKey,
                        dates: [],
                        monthName: monthNames[month],
                        year: year.substring(2, 4),
                        monthNumber: month
                    };
                }
                
                yearGroups[year].months[monthKey].dates.push(header);
            });
            
            // Sort months within each year
            Object.values(yearGroups).forEach(yearGroup => {
                const sortedMonths = {};
                Object.keys(yearGroup.months)
                    .sort()
                    .forEach(key => {
                        sortedMonths[key] = yearGroup.months[key];
                    });
                yearGroup.months = sortedMonths;
            });
            
            const years = Object.values(yearGroups);
            
            // Check collapsed state
            if (!APP_STATE.demandPlanning) APP_STATE.demandPlanning = { collapsedMonths: [], collapsedYears: [] };
            const collapsedMonths = APP_STATE.demandPlanning.collapsedMonths || [];
            const collapsedYears = APP_STATE.demandPlanning.collapsedYears || [];
            
            return `
                <style>
                    .weekend-border-left {
                        border-left: 2px solid #fca5a5 !important;
                    }
                    .weekend-border-right {
                        border-right: 2px solid #fca5a5 !important;
                    }
                    .demand-product-col {
                        width: 200px !important;
                        min-width: 200px !important;
                        max-width: 200px !important;
                    }
                    /* Remove spinner arrows from number inputs */
                    .demand-input::-webkit-outer-spin-button,
                    .demand-input::-webkit-inner-spin-button {
                        -webkit-appearance: none;
                        margin: 0;
                    }
                    .demand-input[type=number] {
                        -moz-appearance: textfield;
                    }
                </style>
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 mx-6 mb-6 overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-100 border-b-2 border-gray-300">
                                <th class="sticky left-0 bg-gray-100 z-10 px-4 py-3 text-left font-semibold text-gray-700 border-r border-gray-300 demand-product-col">
                                    Product
                                </th>
                                ${years.map(yearGroup => {
                                    const isYearCollapsed = collapsedYears.includes(yearGroup.year);
                                    
                                    if (isYearCollapsed) {
                                        // Show only year total when collapsed
                                        return `
                                            <th class="px-3 py-2 text-center bg-purple-100 border-l-4 border-purple-400" style="min-width: 100px;">
                                                <div class="flex items-center justify-center space-x-1 cursor-pointer" onclick="toggleYearCollapse('${yearGroup.year}')">
                                                    <span class="text-sm font-bold text-purple-900">‚ñ∂ 20${yearGroup.yearShort}</span>
                                                </div>
                                            </th>
                                        `;
                                    }
                                    
                                    // Show months
                                    const months = Object.values(yearGroup.months);
                                    return months.map(month => {
                                        const isMonthCollapsed = collapsedMonths.includes(month.key);
                                        
                                        if (isMonthCollapsed) {
                                            // Show only month total when collapsed
                                            return `
                                                <th class="px-3 py-2 text-center bg-blue-100 border-l-2 border-blue-300" style="min-width: 100px;">
                                                    <div class="flex items-center justify-center space-x-1 cursor-pointer" onclick="toggleMonthCollapse('${month.key}')">
                                                        <span class="text-sm font-bold text-blue-900">${month.monthName} ${month.year} ‚ñ∂</span>
                                                    </div>
                                                </th>
                                            `;
                                        }
                                        
                                        // Show all days FIRST, THEN month total at end
                                        const dayHeaders = month.dates.map((header, index) => {
                                            const isHoliday = isDateHoliday(header.dateStr);
                                            let bgClass = 'bg-gray-100';
                                            if (header.isWeekend) bgClass = 'bg-gray-200';
                                            if (isHoliday) bgClass = 'bg-red-100';
                                            if (header.isToday) bgClass = 'bg-blue-100';
                                            
                                            // Add red borders for weekend separation
                                            const prevHeader = index > 0 ? month.dates[index - 1] : null;
                                            const nextHeader = index < month.dates.length - 1 ? month.dates[index + 1] : null;
                                            
                                            let borderClass = '';
                                            if (header.isWeekend && (!prevHeader || !prevHeader.isWeekend)) {
                                                borderClass += ' weekend-border-left';
                                            }
                                            if (header.isWeekend && (!nextHeader || !nextHeader.isWeekend)) {
                                                borderClass += ' weekend-border-right';
                                            }
                                            
                                            return `
                                                <th class="px-3 py-2 text-center border-l border-gray-200 ${bgClass} ${borderClass}" style="min-width: 80px;">
                                                    <div class="text-xs font-semibold text-gray-600">${header.dayName}</div>
                                                    <div class="text-sm font-bold text-gray-900">${header.day}</div>
                                                    ${isHoliday ? '<div class="text-xs text-red-600">üóìÔ∏è</div>' : ''}
                                                </th>
                                            `;
                                        }).join('');
                                        
                                        // Month total column at END with collapse arrow
                                        const monthTotalHeader = `
                                            <th class="px-3 py-2 text-center bg-blue-100 border-l-2 border-blue-300" style="min-width: 100px;">
                                                <div class="cursor-pointer" onclick="toggleMonthCollapse('${month.key}')">
                                                    <div class="text-sm font-bold text-blue-900">${month.monthName} ${month.year} ‚ñº</div>
                                                </div>
                                            </th>
                                        `;
                                        
                                        return dayHeaders + monthTotalHeader;
                                    }).join('');
                                }).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${products.map(product => renderDemandProductRow(product, years, collapsedMonths, collapsedYears)).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderDemandProductRow(product, years, collapsedMonths, collapsedYears) {
            return `
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                    <td class="sticky left-0 bg-white z-10 px-4 py-3 font-semibold border-r border-gray-300 demand-product-col">
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 rounded-full" style="background-color: ${product.color};"></div>
                            <span>${product.name}</span>
                        </div>
                    </td>
                    ${years.map(yearGroup => {
                        const isYearCollapsed = collapsedYears.includes(yearGroup.year);
                        
                        if (isYearCollapsed) {
                            // Calculate year total
                            let yearTotal = 0;
                            Object.values(yearGroup.months).forEach(month => {
                                month.dates.forEach(header => {
                                    const demandData = getDemandForDate(product.id, header.dateStr);
                                    yearTotal += demandData.value || 0;
                                });
                            });
                            
                            return `
                                <td class="border-l-4 border-purple-400 bg-purple-50 px-3 py-2 text-center font-bold text-purple-900">
                                    ${Math.round(yearTotal).toLocaleString()}
                                </td>
                            `;
                        }
                        
                        // Show months
                        const months = Object.values(yearGroup.months);
                        return months.map(month => {
                            const isMonthCollapsed = collapsedMonths.includes(month.key);
                            
                            // Calculate month total
                            let monthTotal = 0;
                            month.dates.forEach(header => {
                                const demandData = getDemandForDate(product.id, header.dateStr);
                                monthTotal += demandData.value || 0;
                            });
                            
                            if (isMonthCollapsed) {
                                // Show only month total when collapsed
                                return `
                                    <td class="border-l-2 border-blue-300 bg-blue-50 px-3 py-2 text-center font-bold text-blue-900">
                                        <span id="monthtotal_${product.id}_${month.key}">${Math.round(monthTotal).toLocaleString()}</span>
                                    </td>
                                `;
                            }
                            
                            // Show all day cells + month total at end
                            const dayCells = month.dates.map((header, index) => {
                                const demandData = getDemandForDate(product.id, header.dateStr);
                                const value = demandData.value || 0;
                                const isHoliday = isDateHoliday(header.dateStr);
                                
                                let bgClass = 'bg-white';
                                if (isHoliday) {
                                    bgClass = 'bg-red-50';
                                } else if (header.isToday) {
                                    bgClass = 'bg-blue-50';
                                }
                                
                                if (header.isWeekend && !isHoliday) {
                                    bgClass = 'bg-gray-50';
                                }
                                
                                // Add red borders for weekend separation
                                const prevHeader = index > 0 ? month.dates[index - 1] : null;
                                const nextHeader = index < month.dates.length - 1 ? month.dates[index + 1] : null;
                                
                                let borderClass = '';
                                if (header.isWeekend && (!prevHeader || !prevHeader.isWeekend)) {
                                    borderClass += ' weekend-border-left';
                                }
                                if (header.isWeekend && (!nextHeader || !nextHeader.isWeekend)) {
                                    borderClass += ' weekend-border-right';
                                }
                                
                                return `
                                    <td class="border-l border-gray-200 ${bgClass} ${borderClass}">
                                        <input type="number" 
                                               id="demand_${product.id}_${header.dateStr}"
                                               value="${value}" 
                                               min="0"
                                               ${isHoliday ? 'disabled' : ''}
                                               data-product-id="${product.id}"
                                               data-product-name="${product.name.replace(/'/g, '&apos;')}"
                                               data-date="${header.dateStr}"
                                               data-month-key="${month.key}"
                                               oninput="updateDemandValueLive('${product.id}', '${header.dateStr}', '${month.key}', parseFloat(this.value) || 0)"
                                               onfocus="this.select()"
                                               onkeydown="handleDemandKeyNavigation(event, '${product.id}', '${header.dateStr}')"
                                               oncontextmenu="showForecastDialog(event, '${product.id}', '${header.dateStr}'); return false;"
                                               class="demand-input w-full px-2 py-2 text-center text-sm border-0 ${bgClass} ${isHoliday ? 'cursor-not-allowed opacity-60' : ''} focus:ring-2 focus:ring-blue-500"
                                               style="min-width: 80px;"
                                               title="${isHoliday ? 'Holiday - No production' : 'Right-click for forecast'}">
                                    </td>
                                `;
                            }).join('');
                            
                            // Month total cell at END
                            const monthTotalCell = `
                                <td class="border-l-2 border-blue-300 bg-blue-50 px-3 py-2 text-center font-bold text-blue-900">
                                    <span id="monthtotal_${product.id}_${month.key}">${Math.round(monthTotal).toLocaleString()}</span>
                                </td>
                            `;
                            
                            return dayCells + monthTotalCell;
                        }).join('');
                    }).join('')}
                </tr>
            `;
        }

        function getDemandForDate(productId, dateStr) {
            if (!APP_STATE.demandPlan) APP_STATE.demandPlan = {};
            if (!APP_STATE.demandPlan[productId]) APP_STATE.demandPlan[productId] = {};
            
            return APP_STATE.demandPlan[productId][dateStr] || { value: 0, type: 'forecast' };
        }

        function updateDemandValue(productId, dateStr, value) {
            if (!APP_STATE.demandPlan) APP_STATE.demandPlan = {};
            if (!APP_STATE.demandPlan[productId]) APP_STATE.demandPlan[productId] = {};
            
            APP_STATE.demandPlan[productId][dateStr] = {
                value: value,
                type: 'forecast' // Can be 'actual' or 'forecast'
            };
            
            saveToLocalStorage();
        }

        function updateDemandValueLive(productId, dateStr, monthKey, value) {
            // Update the value
            if (!APP_STATE.demandPlan) APP_STATE.demandPlan = {};
            if (!APP_STATE.demandPlan[productId]) APP_STATE.demandPlan[productId] = {};
            
            APP_STATE.demandPlan[productId][dateStr] = {
                value: value,
                type: 'forecast'
            };
            
            // Recalculate month total LIVE
            let monthTotal = 0;
            const allInputs = document.querySelectorAll(`input[data-product-id="${productId}"][data-month-key="${monthKey}"]`);
            allInputs.forEach(input => {
                const val = parseFloat(input.value) || 0;
                monthTotal += val;
            });
            
            // Update the month total display
            const totalElement = document.getElementById(`monthtotal_${productId}_${monthKey}`);
            if (totalElement) {
                totalElement.textContent = Math.round(monthTotal).toLocaleString();
            }
            
            saveToLocalStorage();
        }

        function handleDemandKeyNavigation(event, currentProductId, currentDateStr) {
            const key = event.key;
            
            // Only handle arrow keys
            if (!['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(key)) {
                return;
            }
            
            event.preventDefault();
            
            const allInputs = Array.from(document.querySelectorAll('.demand-input:not([disabled])'));
            const currentIndex = allInputs.findIndex(input => 
                input.dataset.productId === currentProductId && 
                input.dataset.date === currentDateStr
            );
            
            if (currentIndex === -1) return;
            
            let targetIndex = currentIndex;
            
            // Get table dimensions (number of date columns)
            const firstProductInputs = allInputs.filter(input => 
                input.dataset.productId === currentProductId
            );
            const columnsPerRow = firstProductInputs.length;
            
            switch(key) {
                case 'ArrowLeft':
                    targetIndex = currentIndex - 1;
                    break;
                case 'ArrowRight':
                    targetIndex = currentIndex + 1;
                    break;
                case 'ArrowUp':
                    targetIndex = currentIndex - columnsPerRow;
                    break;
                case 'ArrowDown':
                    targetIndex = currentIndex + columnsPerRow;
                    break;
            }
            
            // Focus the target input if it exists
            if (targetIndex >= 0 && targetIndex < allInputs.length) {
                allInputs[targetIndex].focus();
                allInputs[targetIndex].select();
            }
        }

        // ============================================
        // FORECASTING FEATURE
        // ============================================

        function showForecastDialog(event, productId, dateStr) {
            event.preventDefault();
            
            const input = event.target;
            const productName = input.dataset.productName || 'Product';
            
            // Calculate moving averages
            const averages = calculateMovingAverages(productId, dateStr);
            
            // Detect weekend pattern
            const weekendPattern = detectWeekendPattern(productId, dateStr);
            
            // Suggest forecast based on weighted average (more weight on recent data)
            let suggestedForecast = 0;
            if (averages.avg7 > 0) {
                suggestedForecast = Math.round((averages.avg7 * 0.5 + averages.avg10 * 0.3 + averages.avg30 * 0.2) / 25) * 25;
            } else if (averages.avg10 > 0) {
                suggestedForecast = Math.round((averages.avg10 * 0.6 + averages.avg30 * 0.4) / 25) * 25;
            } else if (averages.avg30 > 0) {
                suggestedForecast = Math.round(averages.avg30 / 25) * 25;
            } else {
                suggestedForecast = 100; // Default if no history
            }
            
            // Format date
            const date = new Date(dateStr + 'T00:00:00');
            const formattedDate = date.toLocaleDateString('en-US', { 
                weekday: 'short',
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
            
            // Weekend pattern display
            let weekendPatternText = 'No weekend pattern detected';
            if (weekendPattern.detected) {
                const satText = weekendPattern.saturday > 0 ? `${weekendPattern.saturday} TPD` : '0';
                const sunText = weekendPattern.sunday > 0 ? `${weekendPattern.sunday} TPD` : '0';
                weekendPatternText = `Sat: ${satText}, Sun: ${sunText}`;
            }
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'forecastModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-5 py-3 rounded-t-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <span class="text-xl">üìä</span>
                                <div>
                                    <h3 class="text-base font-semibold">${productName}</h3>
                                    <p class="text-xs text-blue-100">${formattedDate}</p>
                                </div>
                            </div>
                            <button onclick="closeForecastDialog()" class="text-white hover:text-gray-200">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-5">
                        <!-- Historical Buttons -->
                        <div class="mb-4">
                            <div class="grid grid-cols-3 gap-2 mb-2">
                                <button onclick="selectForecastPeriod(7, ${averages.avg7})" 
                                        id="period_7"
                                        class="period-btn border-2 border-gray-300 rounded-lg p-2 text-center hover:border-blue-500 hover:bg-blue-50 transition-all">
                                    <div class="text-xs font-semibold text-gray-600">Roll_7d</div>
                                    <div class="text-lg font-bold text-gray-900">${averages.avg7 > 0 ? Math.round(averages.avg7) : 'N/A'}</div>
                                </button>
                                <button onclick="selectForecastPeriod(10, ${averages.avg10})" 
                                        id="period_10"
                                        class="period-btn border-2 border-gray-300 rounded-lg p-2 text-center hover:border-blue-500 hover:bg-blue-50 transition-all">
                                    <div class="text-xs font-semibold text-gray-600">Roll_10d</div>
                                    <div class="text-lg font-bold text-gray-900">${averages.avg10 > 0 ? Math.round(averages.avg10) : 'N/A'}</div>
                                </button>
                                <button onclick="selectForecastPeriod(30, ${averages.avg30})" 
                                        id="period_30"
                                        class="period-btn border-2 border-gray-300 rounded-lg p-2 text-center hover:border-blue-500 hover:bg-blue-50 transition-all">
                                    <div class="text-xs font-semibold text-gray-600">Roll_30d</div>
                                    <div class="text-lg font-bold text-gray-900">${averages.avg30 > 0 ? Math.round(averages.avg30) : 'N/A'}</div>
                                </button>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs text-gray-600">Custom:</span>
                                <input type="number" 
                                       id="customDays" 
                                       placeholder="Days"
                                       min="1"
                                       max="90"
                                       class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm"
                                       onchange="selectCustomPeriod(this.value)">
                                <span class="text-xs text-gray-600">days</span>
                            </div>
                        </div>
                        
                        <!-- Forecast Value -->
                        <div class="mb-4 bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-3 border border-gray-200">
                            <div class="text-center mb-2">
                                <div class="text-3xl font-bold text-blue-600" id="forecastValue">${suggestedForecast.toLocaleString()}</div>
                                <div class="text-xs text-gray-600">tons per day</div>
                            </div>
                            
                            <div class="flex items-center justify-center space-x-1 mb-2">
                                <button onclick="adjustForecast(-100)" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs font-bold">
                                    -100
                                </button>
                                <button onclick="adjustForecast(-25)" class="bg-orange-500 hover:bg-orange-600 text-white px-2 py-1 rounded text-xs font-bold">
                                    -25
                                </button>
                                <button onclick="adjustForecast(25)" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs font-bold">
                                    +25
                                </button>
                                <button onclick="adjustForecast(100)" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs font-bold">
                                    +100
                                </button>
                            </div>
                            
                            <input type="range" 
                                   id="forecastSlider" 
                                   min="0" 
                                   max="5000" 
                                   step="25" 
                                   value="${suggestedForecast}"
                                   oninput="updateForecastDisplay(this.value)"
                                   class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer slider-thumb">
                        </div>
                        
                        <!-- Range Selection Buttons -->
                        <div class="mb-4">
                            <h4 class="text-xs font-semibold text-gray-700 mb-2">Apply To:</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="selectRange('single')" 
                                        id="range_single"
                                        class="range-btn border-2 border-blue-500 bg-blue-50 rounded-lg p-2 text-center hover:bg-blue-100 transition-all">
                                    <div class="text-xs font-semibold text-blue-900">DATE</div>
                                    <div class="text-xs font-semibold text-blue-900">ONLY</div>
                                </button>
                                <button onclick="selectRange('month')" 
                                        id="range_month"
                                        class="range-btn border-2 border-gray-300 rounded-lg p-2 text-center hover:border-blue-500 hover:bg-blue-50 transition-all">
                                    <div class="text-xs font-semibold text-gray-700">End</div>
                                    <div class="text-xs font-semibold text-gray-700">Month</div>
                                </button>
                                <button onclick="selectRange('year')" 
                                        id="range_year"
                                        class="range-btn border-2 border-gray-300 rounded-lg p-2 text-center hover:border-blue-500 hover:bg-blue-50 transition-all">
                                    <div class="text-xs font-semibold text-gray-700">End</div>
                                    <div class="text-xs font-semibold text-gray-700">Year</div>
                                </button>
                                <button onclick="selectRange('custom'); document.getElementById('customRangeDays').focus()" 
                                        id="range_custom"
                                        class="range-btn border-2 border-gray-300 rounded-lg p-2 text-center hover:border-blue-500 hover:bg-blue-50 transition-all">
                                    <div class="text-xs font-semibold text-gray-700">Days:</div>
                                    <input type="number" 
                                           id="customRangeDays" 
                                           placeholder="#"
                                           min="1"
                                           onclick="event.stopPropagation(); selectRange('custom')"
                                           class="w-full text-center text-xs font-semibold border-0 bg-transparent focus:outline-none">
                                </button>
                            </div>
                        </div>
                        
                        <!-- Weekend Pattern -->
                        <div class="mb-4 bg-purple-50 border border-purple-200 rounded p-2">
                            <p class="text-xs text-purple-900">
                                <strong>Weekend:</strong> ${weekendPatternText}
                            </p>
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex space-x-2">
                            <button onclick="closeForecastDialog()" 
                                    class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-lg font-semibold text-sm">
                                Cancel
                            </button>
                            <button onclick="applyForecast('${productId}', '${dateStr}')" 
                                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold text-sm">
                                Apply
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add custom slider styling
            const style = document.createElement('style');
            style.textContent = `
                .slider-thumb::-webkit-slider-thumb {
                    appearance: none;
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    background: #2563eb;
                    cursor: pointer;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                }
                .slider-thumb::-moz-range-thumb {
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    background: #2563eb;
                    cursor: pointer;
                    border: none;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                }
                .period-btn.selected {
                    border-color: #2563eb !important;
                    background-color: #dbeafe !important;
                }
                .range-btn.selected {
                    border-color: #2563eb !important;
                    background-color: #dbeafe !important;
                }
            `;
            
            document.body.appendChild(style);
            document.body.appendChild(modal);
            
            // Store weekend pattern data
            window.currentWeekendPattern = weekendPattern;
            window.currentForecastDate = dateStr;
            window.currentSelectedRange = 'single';
        }

        function calculateMovingAverages(productId, targetDateStr) {
            const targetDate = new Date(targetDateStr + 'T00:00:00');
            const productData = APP_STATE.demandPlan[productId] || {};
            
            // Helper function to get past dates
            const getPastDates = (days) => {
                const dates = [];
                for (let i = 1; i <= days; i++) {
                    const date = new Date(targetDate);
                    date.setDate(date.getDate() - i);
                    dates.push(getDateString(date));
                }
                return dates;
            };
            
            // Calculate average for a period, excluding weekends and holidays
            const calculateAvg = (dates) => {
                let sum = 0;
                let count = 0;
                
                dates.forEach(dateStr => {
                    const date = new Date(dateStr + 'T00:00:00');
                    const dayOfWeek = date.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    const isHoliday = isDateHoliday(dateStr);
                    
                    // Only include working days
                    if (!isWeekend && !isHoliday && productData[dateStr]) {
                        const value = productData[dateStr].value || 0;
                        if (value > 0) { // Only count non-zero values
                            sum += value;
                            count++;
                        }
                    }
                });
                
                return count > 0 ? sum / count : 0;
            };
            
            return {
                avg7: calculateAvg(getPastDates(7)),
                avg10: calculateAvg(getPastDates(10)),
                avg30: calculateAvg(getPastDates(30))
            };
        }

        function detectWeekendPattern(productId, targetDateStr) {
            const targetDate = new Date(targetDateStr + 'T00:00:00');
            const productData = APP_STATE.demandPlan[productId] || {};
            
            // Look back 4 weekends (28 days)
            const saturdays = [];
            const sundays = [];
            
            for (let i = 1; i <= 28; i++) {
                const date = new Date(targetDate);
                date.setDate(date.getDate() - i);
                const dateStr = getDateString(date);
                const dayOfWeek = date.getDay();
                
                if (dayOfWeek === 6) { // Saturday
                    const value = (productData[dateStr] && productData[dateStr].value) || 0;
                    saturdays.push(value);
                } else if (dayOfWeek === 0) { // Sunday
                    const value = (productData[dateStr] && productData[dateStr].value) || 0;
                    sundays.push(value);
                }
            }
            
            // Function to calculate pattern value based on rule:
            // If most are 0 ‚Üí 0, if most are non-zero ‚Üí average of non-zeros
            const calculatePatternValue = (values) => {
                if (values.length === 0) return 0;
                
                const nonZeroValues = values.filter(v => v > 0);
                const zeroCount = values.length - nonZeroValues.length;
                
                // If most are zero, return 0
                if (zeroCount > nonZeroValues.length) {
                    return 0;
                }
                
                // Otherwise, average the non-zero values and round to 25
                if (nonZeroValues.length > 0) {
                    const avg = nonZeroValues.reduce((a, b) => a + b, 0) / nonZeroValues.length;
                    return Math.round(avg / 25) * 25;
                }
                
                return 0;
            };
            
            const saturdayValue = calculatePatternValue(saturdays);
            const sundayValue = calculatePatternValue(sundays);
            
            return {
                detected: saturdays.length > 0 || sundays.length > 0,
                saturday: saturdayValue,
                sunday: sundayValue,
                saturdayRatio: 0, // Will be calculated when applying
                sundayRatio: 0    // Will be calculated when applying
            };
        }

        function selectForecastPeriod(days, avgValue) {
            // Highlight selected button
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById(`period_${days}`).classList.add('selected');
            
            // Update forecast value (rounded to 25)
            const rounded = Math.round(avgValue / 25) * 25;
            updateForecastDisplay(rounded);
        }

        function selectCustomPeriod(days) {
            const numDays = parseInt(days);
            if (!numDays || numDays < 1) return;
            
            // Calculate custom average (need to extract productId and dateStr from modal context)
            const modal = document.getElementById('forecastModal');
            if (!modal) return;
            
            // Highlight custom period
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('selected'));
            
            // For now, just clear the selection since we'd need to recalculate
            // In a full implementation, we'd calculate the custom period average here
            alert(`Custom ${numDays}-day average calculation would go here`);
        }

        function selectRange(rangeType) {
            // Update UI
            document.querySelectorAll('.range-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById(`range_${rangeType}`).classList.add('selected');
            
            // Store selection
            window.currentSelectedRange = rangeType;
        }

        function updateForecastDisplay(value) {
            // Round to nearest 25
            const rounded = Math.round(value / 25) * 25;
            document.getElementById('forecastValue').textContent = rounded.toLocaleString();
            document.getElementById('forecastSlider').value = rounded;
            document.getElementById('forecastDirectInput').value = rounded;
        }

        function adjustForecast(amount) {
            const slider = document.getElementById('forecastSlider');
            const currentValue = parseInt(slider.value);
            const newValue = Math.max(0, Math.min(5000, currentValue + amount));
            const rounded = Math.round(newValue / 25) * 25;
            updateForecastDisplay(rounded);
        }

        function setForecastFromInput(value) {
            const numValue = parseInt(value) || 0;
            const rounded = Math.round(numValue / 25) * 25;
            const clamped = Math.max(0, Math.min(5000, rounded));
            updateForecastDisplay(clamped);
        }

        function applyForecast(productId, startDateStr) {
            const forecastValue = parseInt(document.getElementById('forecastValue').textContent.replace(/,/g, ''));
            const weekendPattern = window.currentWeekendPattern || { detected: false, saturday: 0, sunday: 0 };
            
            // Get selected range
            const rangeType = window.currentSelectedRange || 'single';
            
            let endDateStr = startDateStr;
            const startDate = new Date(startDateStr + 'T00:00:00');
            
            // Determine end date based on selection
            if (rangeType === 'month') {
                const endDate = new Date(startDate);
                endDate.setMonth(endDate.getMonth() + 1);
                endDate.setDate(0);
                endDateStr = getDateString(endDate);
            } else if (rangeType === 'year') {
                const endDate = new Date(startDate);
                endDate.setMonth(11);
                endDate.setDate(31);
                endDateStr = getDateString(endDate);
            } else if (rangeType === 'custom') {
                const customDays = parseInt(document.getElementById('customRangeDays').value);
                if (customDays && customDays > 0) {
                    const endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + customDays - 1);
                    endDateStr = getDateString(endDate);
                } else {
                    alert('Please enter number of days');
                    return;
                }
            }
            
            // Calculate weekend values based on detected pattern
            // If pattern detected, use historical ratios, otherwise use 0
            let saturdayForecast = 0;
            let sundayForecast = 0;
            
            if (weekendPattern.detected && weekendPattern.saturday > 0) {
                // Calculate ratio from historical weekday average
                const weekdayAvg = calculateWeekdayAverage(productId, startDateStr);
                if (weekdayAvg > 0) {
                    const satRatio = weekendPattern.saturday / weekdayAvg;
                    saturdayForecast = Math.round((forecastValue * satRatio) / 25) * 25;
                }
            }
            
            if (weekendPattern.detected && weekendPattern.sunday > 0) {
                const weekdayAvg = calculateWeekdayAverage(productId, startDateStr);
                if (weekdayAvg > 0) {
                    const sunRatio = weekendPattern.sunday / weekdayAvg;
                    sundayForecast = Math.round((forecastValue * sunRatio) / 25) * 25;
                }
            }
            
            // Get all dates in range
            const datesToUpdate = [];
            let currentDate = new Date(startDate);
            const finalDate = new Date(endDateStr + 'T00:00:00');
            
            while (currentDate <= finalDate) {
                const dateStr = getDateString(currentDate);
                const dayOfWeek = currentDate.getDay();
                const isHoliday = isDateHoliday(dateStr);
                
                if (!isHoliday) {
                    let valueToApply = forecastValue; // Default for weekdays
                    
                    if (dayOfWeek === 6) { // Saturday
                        valueToApply = saturdayForecast;
                    } else if (dayOfWeek === 0) { // Sunday
                        valueToApply = sundayForecast;
                    }
                    
                    // Only add if value > 0 (skip days with 0 pattern)
                    if (valueToApply > 0) {
                        datesToUpdate.push({ dateStr, value: valueToApply });
                    }
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Track affected months
            const affectedMonths = new Set();
            
            // Apply forecast to all dates
            datesToUpdate.forEach(({ dateStr, value }) => {
                const input = document.getElementById(`demand_${productId}_${dateStr}`);
                if (input && !input.disabled) {
                    input.value = value;
                    
                    const monthKey = input.dataset.monthKey;
                    if (monthKey) {
                        affectedMonths.add(monthKey);
                    }
                    updateDemandValueLive(productId, dateStr, monthKey, value);
                }
            });
            
            closeForecastDialog();
            
            // Show success message
            const weekdayCount = datesToUpdate.filter(d => d.value === forecastValue).length;
            const saturdayCount = datesToUpdate.filter(d => d.value === saturdayForecast && d.value > 0).length;
            const sundayCount = datesToUpdate.filter(d => d.value === sundayForecast && d.value > 0).length;
            
            let message = `${weekdayCount} weekday${weekdayCount !== 1 ? 's' : ''} @ ${forecastValue.toLocaleString()} TPD`;
            if (saturdayCount > 0) {
                message += `, ${saturdayCount} Sat @ ${saturdayForecast.toLocaleString()} TPD`;
            }
            if (sundayCount > 0) {
                message += `, ${sundayCount} Sun @ ${sundayForecast.toLocaleString()} TPD`;
            }
            
            const successMsg = document.createElement('div');
            successMsg.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            successMsg.innerHTML = `
                <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span><strong>Forecast applied!</strong> ${message}</span>
                </div>
            `;
            document.body.appendChild(successMsg);
            setTimeout(() => successMsg.remove(), 5000);
        }

        function calculateWeekdayAverage(productId, targetDateStr) {
            const targetDate = new Date(targetDateStr + 'T00:00:00');
            const productData = APP_STATE.demandPlan[productId] || {};
            
            let sum = 0;
            let count = 0;
            
            // Look back 28 days for weekday average
            for (let i = 1; i <= 28; i++) {
                const date = new Date(targetDate);
                date.setDate(date.getDate() - i);
                const dateStr = getDateString(date);
                const dayOfWeek = date.getDay();
                
                // Only weekdays (Mon-Fri)
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    const value = (productData[dateStr] && productData[dateStr].value) || 0;
                    if (value > 0) {
                        sum += value;
                        count++;
                    }
                }
            }
            
            return count > 0 ? sum / count : 0;
        }

        function closeForecastDialog() {
            const modal = document.getElementById('forecastModal');
            if (modal) modal.remove();
        }

        function toggleMonthCollapse(monthKey) {
            if (!APP_STATE.demandPlanning) {
                APP_STATE.demandPlanning = { collapsedMonths: [], collapsedYears: [] };
            }
            if (!APP_STATE.demandPlanning.collapsedMonths) {
                APP_STATE.demandPlanning.collapsedMonths = [];
            }
            
            const index = APP_STATE.demandPlanning.collapsedMonths.indexOf(monthKey);
            if (index > -1) {
                // Expand
                APP_STATE.demandPlanning.collapsedMonths.splice(index, 1);
            } else {
                // Collapse
                APP_STATE.demandPlanning.collapsedMonths.push(monthKey);
            }
            
            saveToLocalStorage();
            // Refresh demand planning tab
            switchTab('demand');
        }

        function toggleYearCollapse(year) {
            if (!APP_STATE.demandPlanning) {
                APP_STATE.demandPlanning = { collapsedMonths: [], collapsedYears: [] };
            }
            if (!APP_STATE.demandPlanning.collapsedYears) {
                APP_STATE.demandPlanning.collapsedYears = [];
            }
            
            const index = APP_STATE.demandPlanning.collapsedYears.indexOf(year);
            if (index > -1) {
                // Expand
                APP_STATE.demandPlanning.collapsedYears.splice(index, 1);
            } else {
                // Collapse
                APP_STATE.demandPlanning.collapsedYears.push(year);
            }
            
            saveToLocalStorage();
            // Refresh demand planning tab
            switchTab('demand');
        }

        function exportDemandData() {
            const data = {
                demandPlan: APP_STATE.demandPlan,
                products: APP_STATE.products,
                exportedAt: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `demand_plan_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Demand data exported!');
        }

        function clearAllDemandData() {
            if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL demand planning data!\n\nAre you sure you want to continue?')) {
                return;
            }
            
            if (!confirm('This action cannot be undone. Clear all demand data?')) {
                return;
            }
            
            // Clear demand plan
            APP_STATE.demandPlan = {};
            
            // Save to localStorage
            saveToLocalStorage();
            
            // Refresh the view
            switchTab('demand');
            
            // Show success message
            alert('‚úÖ All demand data has been cleared!');
        }

        // ============================================
        // HOLIDAYS MANAGEMENT
        // ============================================

        function isDateHoliday(dateStr) {
            if (!APP_STATE.rules || !APP_STATE.rules.holidays) return false;
            return APP_STATE.rules.holidays.includes(dateStr);
        }

        function openHolidaysPanel() {
            const modal = document.createElement('div');
            modal.id = 'holidaysModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col">
                    <div class="bg-purple-600 text-white px-6 py-4 flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <span class="text-2xl">üóìÔ∏è</span>
                            <h3 class="text-lg font-semibold">Holidays & Non-Working Days</h3>
                        </div>
                        <button onclick="closeHolidaysPanel()" class="text-white hover:text-gray-200">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="p-6 flex-1 overflow-y-auto">
                        <div class="mb-4">
                            <p class="text-sm text-gray-600 mb-4">
                                Mark days when production does not run (holidays, maintenance shutdowns, etc.)
                            </p>
                            
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                                <h4 class="font-semibold text-sm text-blue-900 mb-2">Add Holiday</h4>
                                <div class="flex items-center space-x-2">
                                    <input type="date" id="newHolidayDate" 
                                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <input type="text" id="newHolidayName" 
                                           placeholder="Holiday name (optional)"
                                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <button onclick="addHoliday()" 
                                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm font-semibold whitespace-nowrap">
                                        + Add
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-sm text-gray-700 mb-2">Current Holidays (${APP_STATE.rules.holidays ? APP_STATE.rules.holidays.length : 0})</h4>
                            <div id="holidaysList" class="space-y-2">
                                ${renderHolidaysList()}
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 px-6 py-4 flex items-center justify-between border-t">
                        <div class="text-sm text-gray-600">
                            <strong>Note:</strong> Holidays affect simulation and demand planning
                        </div>
                        <button onclick="closeHolidaysPanel()" 
                                class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 text-sm font-semibold">
                            Done
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeHolidaysPanel() {
            const modal = document.getElementById('holidaysModal');
            if (modal) modal.remove();
            // Refresh demand planning if on that tab
            const activeTab = document.querySelector('.tab-button.active');
            if (activeTab && activeTab.dataset.tab === 'demand') {
                switchTab('demand');
            }
        }

        function renderHolidaysList() {
            if (!APP_STATE.rules.holidays || APP_STATE.rules.holidays.length === 0) {
                return '<div class="text-sm text-gray-500 text-center py-4">No holidays defined yet</div>';
            }
            
            // Group holidays by year-month for better organization
            const sortedHolidays = [...APP_STATE.rules.holidays].sort();
            
            return sortedHolidays.map(dateStr => {
                const date = new Date(dateStr + 'T00:00:00');
                const formatted = date.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                return `
                    <div class="flex items-center justify-between bg-red-50 border border-red-200 rounded px-3 py-2">
                        <div class="flex items-center space-x-2">
                            <span class="text-red-600">üóìÔ∏è</span>
                            <span class="text-sm font-medium text-gray-900">${formatted}</span>
                        </div>
                        <button onclick="removeHoliday('${dateStr}')" 
                                class="text-red-600 hover:text-red-800 text-xs">
                            Remove
                        </button>
                    </div>
                `;
            }).join('');
        }

        function addHoliday() {
            const dateInput = document.getElementById('newHolidayDate');
            const nameInput = document.getElementById('newHolidayName');
            
            if (!dateInput.value) {
                alert('Please select a date');
                return;
            }
            
            const dateStr = dateInput.value; // Already in YYYY-MM-DD format
            
            if (!APP_STATE.rules.holidays) {
                APP_STATE.rules.holidays = [];
            }
            
            if (APP_STATE.rules.holidays.includes(dateStr)) {
                alert('This date is already marked as a holiday');
                return;
            }
            
            APP_STATE.rules.holidays.push(dateStr);
            APP_STATE.rules.holidays.sort(); // Keep sorted
            
            saveToLocalStorage();
            
            // Clear inputs
            dateInput.value = '';
            nameInput.value = '';
            
            // Refresh list
            document.getElementById('holidaysList').innerHTML = renderHolidaysList();
        }

        function removeHoliday(dateStr) {
            if (!APP_STATE.rules.holidays) return;
            
            APP_STATE.rules.holidays = APP_STATE.rules.holidays.filter(d => d !== dateStr);
            saveToLocalStorage();
            
            // Refresh list
            document.getElementById('holidaysList').innerHTML = renderHolidaysList();
        }

        // ============================================
        // SHARED UTILITY: Generate Date Headers
        // ============================================
        
        function generateDateHeaders(startDate, totalDays, today) {
            const dateHeaders = [];
            for (let i = 0; i < totalDays; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + i);
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isToday = date.toDateString() === today.toDateString();
                const isPast = date < today;
                const isFuture = date > today;
                
                dateHeaders.push({
                    date: date,
                    dateStr: getDateString(date),
                    day: date.getDate(),
                    month: date.toLocaleDateString('en-US', { month: 'short' }),
                    dayName: date.toLocaleDateString('en-US', { weekday: 'short' }),
                    isWeekend: isWeekend,
                    isToday: isToday,
                    isPast: isPast,
                    isFuture: isFuture,
                    columnIndex: i
                });
            }
            return dateHeaders;
        }

        // ============================================
        // ============================================
        // TAB 4: PRODUCTION PLAN - Campaign & Inventory Management
        // ============================================
        
        // Initialize production plan state
        if (!APP_STATE.productionPlan) {
            APP_STATE.productionPlan = {
                campaigns: [],          // All campaigns
                inventoryHistory: {},   // Historical inventory data
                campaignTemplates: []   // Saved campaign templates
            };
        }
        
        function renderProductionPlanTab() {
            const today = new Date(APP_STATE.currentDate);
            const startDate = new Date(today);
            startDate.setDate(startDate.getDate() - 30);  // 30 days back
            const totalDays = 91;  // 30 past + today + 60 future
            
            const dateHeaders = generateDateHeaders(startDate, totalDays, today);
            
            return `
                <div class="bg-white border-b border-gray-200 px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">üè≠ Production Plan</h2>
                            <p class="text-sm text-gray-500">Campaign scheduling & inventory management</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button onclick="openCampaignForm()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm font-semibold">
                                + Campaign
                            </button>
                            <button onclick="openRulesPanel()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm">
                                ‚öôÔ∏è Rules
                            </button>
                            <button onclick="showRecommendations()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
                                üí° AI Suggest
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Main Content: Campaigns + Inventories -->
                <div class="p-6 space-y-6">
                    <!-- TOP SECTION: Equipment Campaigns -->
                    ${renderCampaignSection(dateHeaders)}
                    
                    <!-- BOTTOM SECTION: Silo Inventories -->
                    ${renderInventorySection2(dateHeaders)}
                    
                    <!-- PERFORMANCE METRICS -->
                    ${renderPerformanceMetrics()}
                </div>
            `;
        }

        function renderCampaignSection(dateHeaders) {
            const kilns = APP_STATE.flowDesigner.equipment.filter(e => e.type === 'kiln');
            const finishMills = APP_STATE.flowDesigner.equipment.filter(e => e.type === 'finish_mill');
            const allEquipment = [...kilns, ...finishMills];
            
            if (allEquipment.length === 0) {
                return `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
                        <p class="text-yellow-800">‚ö†Ô∏è No equipment configured. Please set up equipment in Process Flow (Tab 2)</p>
                    </div>
                `;
            }
            
            // Group dates by week for display
            const weeks = groupDatesByWeek(dateHeaders);
            
            return `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="bg-gray-800 px-4 py-3 rounded-t-lg">
                        <h3 class="text-white font-semibold">üìÖ Equipment Campaign Schedule</h3>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="sticky left-0 bg-gray-100 z-10 px-4 py-3 text-left font-semibold text-gray-700 border-r border-gray-300" style="min-width: 200px;">
                                        Equipment
                                    </th>
                                    ${renderWeekHeaders(weeks)}
                                </tr>
                            </thead>
                            <tbody>
                                ${allEquipment.map(eq => renderEquipmentRow(eq, weeks)).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function groupDatesByWeek(dateHeaders) {
            const weeks = [];
            let currentWeek = [];
            let currentWeekStart = null;
            
            dateHeaders.forEach((header, index) => {
                const dayOfWeek = header.date.getDay();
                
                // Start new week on Monday (or first day)
                if (dayOfWeek === 1 || index === 0) {
                    if (currentWeek.length > 0) {
                        weeks.push({
                            start: currentWeekStart,
                            dates: currentWeek
                        });
                    }
                    currentWeek = [header];
                    currentWeekStart = header.dateStr;
                } else {
                    currentWeek.push(header);
                }
            });
            
            // Add last week
            if (currentWeek.length > 0) {
                weeks.push({
                    start: currentWeekStart,
                    dates: currentWeek
                });
            }
            
            return weeks;
        }

        function renderWeekHeaders(weeks) {
            return weeks.map(week => {
                const startDate = week.dates[0].date;
                const endDate = week.dates[week.dates.length - 1].date;
                const monthStart = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const monthEnd = endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                return `
                    <th class="px-3 py-2 text-center border-l border-gray-300 bg-gray-50" style="min-width: 150px;">
                        <div class="text-xs font-semibold text-gray-600">${monthStart} - ${monthEnd}</div>
                        <div class="text-xs text-gray-500">${week.dates.length} days</div>
                    </th>
                `;
            }).join('');
        }

        function renderEquipmentRow(equipment, weeks) {
            const capacity = equipment.params.tpd || equipment.params.tph * 24 || 0;
            const campaigns = getCampaignsForEquipment(equipment.id);
            
            return `
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                    <td class="sticky left-0 bg-white z-10 px-4 py-3 border-r border-gray-300">
                        <div class="font-semibold text-gray-900">${equipment.name}</div>
                        <div class="text-xs text-gray-600">${equipment.type === 'kiln' ? 'Kiln' : 'Finish Mill'}</div>
                        <div class="text-xs text-gray-500">Capacity: ${formatNumber(capacity)} TPD</div>
                        <button onclick="openCampaignForm('${equipment.id}')" 
                                class="mt-2 text-xs text-blue-600 hover:bg-blue-50 px-2 py-1 rounded border border-blue-300 w-full">
                            + Add Campaign
                        </button>
                    </td>
                    ${renderEquipmentWeekCells(equipment, weeks, campaigns)}
                </tr>
            `;
        }

        function renderEquipmentWeekCells(equipment, weeks, campaigns) {
            return weeks.map(week => {
                const weekCampaigns = campaigns.filter(c => 
                    dateRangesOverlap(c.startDate, c.endDate, week.dates[0].dateStr, week.dates[week.dates.length - 1].dateStr)
                );
                
                let cellContent = '';
                if (weekCampaigns.length > 0) {
                    cellContent = weekCampaigns.map(campaign => {
                        let bgColor = 'bg-green-100 border-green-600';
                        let icon = '‚ñ∂Ô∏è';
                        
                        if (campaign.type === 'maintenance') {
                            bgColor = 'bg-red-100 border-red-600';
                            icon = 'üîß';
                        } else if (campaign.type === 'stoppage') {
                            bgColor = 'bg-gray-100 border-gray-600';
                            icon = '‚è∏Ô∏è';
                        }
                        
                        return `
                            <div class="${bgColor} border-2 rounded p-2 mb-1 cursor-pointer hover:shadow-md"
                                 onclick="editCampaign('${campaign.id}')">
                                <div class="text-xs font-semibold">${icon} ${campaign.productName || campaign.type}</div>
                                <div class="text-xs text-gray-600">${campaign.duration || 0} days</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    // Default: Running at capacity
                    cellContent = `
                        <div class="bg-blue-50 border-2 border-blue-400 rounded p-2">
                            <div class="text-xs font-semibold">‚úì Running</div>
                            <div class="text-xs text-gray-600">Default capacity</div>
                        </div>
                    `;
                }
                
                return `
                    <td class="border-l border-gray-200 px-2 py-2">
                        ${cellContent}
                    </td>
                `;
            }).join('');
        }

        function renderInventorySection2(dateHeaders) {
            const silos = APP_STATE.flowDesigner.equipment.filter(e => e.type === 'silo');
            const products = Object.values(APP_STATE.products);
            
            if (silos.length === 0) {
                return `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
                        <p class="text-yellow-800">‚ö†Ô∏è No silos configured. Please add silos in Process Flow (Tab 2)</p>
                    </div>
                `;
            }
            
            // Calculate inventories based on campaigns
            const inventories = calculateInventories(dateHeaders);
            
            return `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="bg-gray-800 px-4 py-3">
                        <h3 class="text-white font-semibold">üì¶ Silo Inventory Levels (Calculated)</h3>
                    </div>
                    
                    <div class="p-4 space-y-4">
                        ${silos.map(silo => renderSiloInventoryChart(silo, inventories, dateHeaders)).join('')}
                    </div>
                </div>
            `;
        }

        function renderSiloInventoryChart(silo, inventories, dateHeaders) {
            const capacity = silo.params.max_volume || 10000;
            const siloInventories = inventories[silo.id] || {};
            
            // Get 7 representative days to display
            const displayDates = dateHeaders.filter((h, i) => i % 13 === 0).slice(0, 7);
            
            return `
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <div class="font-semibold text-gray-900">${silo.name}</div>
                            <div class="text-xs text-gray-600">${silo.params.material_type || 'Unknown'}</div>
                        </div>
                        <div class="text-sm text-gray-600">
                            Capacity: ${formatNumber(capacity)} tons
                        </div>
                    </div>
                    
                    <!-- Mini timeline chart -->
                    <div class="flex items-end space-x-2 h-24 mb-2">
                        ${displayDates.map(date => {
                            const inv = siloInventories[date.dateStr] || { ending: capacity * 0.5 };
                            const level = inv.ending;
                            const percent = (level / capacity) * 100;
                            const height = Math.max(5, (percent / 100) * 96);  // Max 96px (h-24)
                            
                            // Traffic light color
                            let barColor = 'bg-green-500';
                            if (percent < 10 || percent > 90) barColor = 'bg-red-500';
                            else if (percent < 20 || percent > 80) barColor = 'bg-yellow-500';
                            
                            return `
                                <div class="flex-1 flex flex-col items-center">
                                    <div class="${barColor} w-full rounded-t" style="height: ${height}px;" 
                                         title="${formatNumber(level)} tons (${Math.round(percent)}%)"></div>
                                    <div class="text-xs text-gray-500 mt-1">${date.month} ${date.day}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Current level -->
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-600">Current Level:</span>
                        <span class="font-semibold">${formatNumber(siloInventories[APP_STATE.currentDate]?.ending || 0)} tons</span>
                    </div>
                    
                    <!-- Capacity bar -->
                    ${renderCapacityBar(siloInventories[APP_STATE.currentDate]?.ending || 0, capacity)}
                </div>
            `;
        }

        function renderCapacityBar(current, capacity) {
            const percent = (current / capacity) * 100;
            let barColor = 'bg-green-500';
            let statusIcon = 'üü¢';
            let statusText = 'Optimal';
            
            if (percent >= 90) {
                barColor = 'bg-red-500';
                statusIcon = 'üî¥';
                statusText = 'Critical - Near Full';
            } else if (percent >= 80) {
                barColor = 'bg-yellow-500';
                statusIcon = 'üü°';
                statusText = 'Warning - High';
            } else if (percent <= 10) {
                barColor = 'bg-red-500';
                statusIcon = 'üî¥';
                statusText = 'Critical - Low';
            } else if (percent <= 20) {
                barColor = 'bg-yellow-500';
                statusIcon = 'üü°';
                statusText = 'Warning - Low';
            }
            
            return `
                <div class="mt-2">
                    <div class="flex items-center justify-between text-xs mb-1">
                        <span class="text-gray-600">${statusIcon} ${statusText}</span>
                        <span class="font-semibold">${Math.round(percent)}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="${barColor} h-2 rounded-full transition-all" style="width: ${Math.min(100, percent)}%"></div>
                    </div>
                </div>
            `;
        }

        function renderPerformanceMetrics() {
            // Calculate rolling averages
            const metrics = calculateRollingAverages();
            
            return `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h3 class="font-semibold text-gray-900 mb-4">üìä Production Performance</h3>
                    
                    <div class="grid grid-cols-3 gap-4">
                        ${Object.keys(metrics).map(productName => `
                            <div class="border border-gray-200 rounded p-3">
                                <div class="font-semibold text-gray-900 mb-2">${productName}</div>
                                <div class="space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">7-day avg:</span>
                                        <span class="font-semibold">${formatNumber(metrics[productName].avg7)} TPD</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">15-day avg:</span>
                                        <span class="font-semibold">${formatNumber(metrics[productName].avg15)} TPD</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">30-day avg:</span>
                                        <span class="font-semibold">${formatNumber(metrics[productName].avg30)} TPD</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // ============================================
        // CAMPAIGN MANAGEMENT
        // ============================================

        function openCampaignForm(equipmentId = null) {
            const equipment = APP_STATE.flowDesigner.equipment;
            const products = Object.values(APP_STATE.products);
            
            const modal = document.createElement('div');
            modal.id = 'campaignFormModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-4 rounded-t-lg sticky top-0">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold">‚úèÔ∏è Create Campaign</h3>
                            <button onclick="closeCampaignForm()" class="text-white hover:text-gray-200">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <!-- Campaign Type -->
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Campaign Type</label>
                            <div class="flex space-x-3">
                                <label class="flex-1">
                                    <input type="radio" name="campaignType" value="production" checked onchange="toggleCampaignFields()"
                                           class="mr-2">
                                    <span class="text-sm">Production</span>
                                </label>
                                <label class="flex-1">
                                    <input type="radio" name="campaignType" value="maintenance" onchange="toggleCampaignFields()"
                                           class="mr-2">
                                    <span class="text-sm">Maintenance</span>
                                </label>
                                <label class="flex-1">
                                    <input type="radio" name="campaignType" value="stoppage" onchange="toggleCampaignFields()"
                                           class="mr-2">
                                    <span class="text-sm">Forced Stop</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Equipment Selection -->
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Equipment</label>
                            <select id="campaignEquipment" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="">Select equipment...</option>
                                ${equipment.filter(e => e.type === 'kiln' || e.type === 'finish_mill').map(eq => `
                                    <option value="${eq.id}" ${eq.id === equipmentId ? 'selected' : ''}>
                                        ${eq.name} (${eq.type === 'kiln' ? 'Kiln' : 'Mill'})
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <!-- Product Selection (for production only) -->
                        <div class="mb-4" id="productSelection">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Product</label>
                            <select id="campaignProduct" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="">Select product...</option>
                                ${products.map(p => `
                                    <option value="${p.id}">${p.name}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <!-- Date Range -->
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Start Date</label>
                                <input type="date" id="campaignStartDate" 
                                       value="${APP_STATE.currentDate}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">End Date</label>
                                <input type="date" id="campaignEndDate" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                        
                        <!-- Duration Display -->
                        <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                            <div class="text-sm text-blue-900">
                                <strong>Duration:</strong> <span id="campaignDuration">0 days</span>
                            </div>
                        </div>
                        
                        <!-- Production Rate (for production only) -->
                        <div class="mb-4" id="productionRateSection">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Production Rate</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="rateType" value="capacity" checked class="mr-2">
                                    <span class="text-sm">Use equipment capacity</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="rateType" value="custom" class="mr-2">
                                    <span class="text-sm">Custom rate:</span>
                                    <input type="number" id="customRate" placeholder="TPD" 
                                           class="ml-2 px-2 py-1 border border-gray-300 rounded w-32">
                                </label>
                            </div>
                        </div>
                        
                        <!-- Recurring -->
                        <div class="mb-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="campaignRecurring" class="mr-2">
                                <span class="text-sm font-semibold">Repeat this campaign</span>
                            </label>
                            <div id="recurringOptions" class="ml-6 mt-2 hidden">
                                <label class="text-sm text-gray-600">
                                    Every <input type="number" id="recurringInterval" value="1" min="1" max="52"
                                                 class="w-16 px-2 py-1 border border-gray-300 rounded mx-1">
                                    <select id="recurringUnit" class="px-2 py-1 border border-gray-300 rounded">
                                        <option value="week">week(s)</option>
                                        <option value="month">month(s)</option>
                                    </select>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Save as Template -->
                        <div class="mb-6 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                            <label class="flex items-center mb-2">
                                <input type="checkbox" id="saveAsTemplate" class="mr-2">
                                <span class="text-sm font-semibold text-purple-900">üíæ Save as Template</span>
                            </label>
                            <input type="text" id="templateName" placeholder="Template name..."
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex space-x-3">
                            <button onclick="closeCampaignForm()" 
                                    class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 rounded-lg font-semibold">
                                Cancel
                            </button>
                            <button onclick="createCampaign()" 
                                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold">
                                Create Campaign
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Setup event listeners
            document.getElementById('campaignStartDate').addEventListener('change', updateCampaignDuration);
            document.getElementById('campaignEndDate').addEventListener('change', updateCampaignDuration);
            document.getElementById('campaignRecurring').addEventListener('change', function() {
                document.getElementById('recurringOptions').classList.toggle('hidden', !this.checked);
            });
            
            updateCampaignDuration();
        }

        function toggleCampaignFields() {
            const type = document.querySelector('input[name="campaignType"]:checked').value;
            const isProduction = type === 'production';
            
            document.getElementById('productSelection').style.display = isProduction ? 'block' : 'none';
            document.getElementById('productionRateSection').style.display = isProduction ? 'block' : 'none';
        }

        function updateCampaignDuration() {
            const start = new Date(document.getElementById('campaignStartDate').value);
            const end = new Date(document.getElementById('campaignEndDate').value);
            
            if (start && end && end >= start) {
                const days = Math.round((end - start) / (1000 * 60 * 60 * 24)) + 1;
                document.getElementById('campaignDuration').textContent = `${days} days`;
            } else {
                document.getElementById('campaignDuration').textContent = '0 days';
            }
        }

        function createCampaign() {
            const type = document.querySelector('input[name="campaignType"]:checked').value;
            const equipmentId = document.getElementById('campaignEquipment').value;
            const productId = document.getElementById('campaignProduct')?.value;
            const startDate = document.getElementById('campaignStartDate').value;
            const endDate = document.getElementById('campaignEndDate').value;
            
            if (!equipmentId || !startDate || !endDate) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (type === 'production' && !productId) {
                alert('Please select a product for production campaign');
                return;
            }
            
            const campaign = {
                id: 'camp_' + Date.now(),
                type: type,
                equipmentId: equipmentId,
                productId: productId,
                productName: productId ? APP_STATE.products[productId].name : null,
                startDate: startDate,
                endDate: endDate,
                duration: Math.round((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1,
                createdAt: new Date().toISOString()
            };
            
            // Add production rate if production campaign
            if (type === 'production') {
                const rateType = document.querySelector('input[name="rateType"]:checked').value;
                if (rateType === 'custom') {
                    campaign.customRate = parseFloat(document.getElementById('customRate').value) || 0;
                }
            }
            
            // Save campaign
            APP_STATE.productionPlan.campaigns.push(campaign);
            
            // Save as template if requested
            if (document.getElementById('saveAsTemplate').checked) {
                const templateName = document.getElementById('templateName').value;
                if (templateName) {
                    APP_STATE.productionPlan.campaignTemplates.push({
                        name: templateName,
                        template: { ...campaign, id: null, startDate: null, endDate: null }
                    });
                }
            }
            
            saveToLocalStorage();
            closeCampaignForm();
            switchTab('production');
            
            alert('‚úÖ Campaign created successfully!');
        }

        function closeCampaignForm() {
            const modal = document.getElementById('campaignFormModal');
            if (modal) modal.remove();
        }

        // ============================================
        // INVENTORY CALCULATIONS
        // ============================================

        function calculateInventories(dateHeaders) {
            // This will calculate beginning/ending inventory for each silo for each day
            // Based on campaigns, production, and demand
            
            const inventories = {};
            const silos = APP_STATE.flowDesigner.equipment.filter(e => e.type === 'silo');
            
            silos.forEach(silo => {
                inventories[silo.id] = {};
                const capacity = silo.params.max_volume || 10000;
                
                // Initialize with starting inventory (default 50% capacity)
                let currentInventory = capacity * 0.5;
                
                dateHeaders.forEach(header => {
                    const dateStr = header.dateStr;
                    
                    // Get production for this silo's product
                    const production = getProductionForDate(silo, dateStr);
                    
                    // Get demand from Demand Plan
                    const demand = getDemandForDate2(silo.params.material_type, dateStr);
                    
                    // Calculate beginning inventory
                    const beginning = currentInventory;
                    
                    // Calculate ending inventory
                    const ending = Math.max(0, Math.min(capacity, beginning + production - demand));
                    
                    inventories[silo.id][dateStr] = {
                        beginning: beginning,
                        production: production,
                        demand: demand,
                        ending: ending
                    };
                    
                    // Update for next day
                    currentInventory = ending;
                });
            });
            
            return inventories;
        }

        function getProductionForDate(silo, dateStr) {
            // Get all campaigns that produce material for this silo on this date
            const materialType = silo.params.material_type;
            const campaigns = APP_STATE.productionPlan.campaigns.filter(c => 
                c.type === 'production' &&
                c.productName === materialType &&
                dateStr >= c.startDate &&
                dateStr <= c.endDate
            );
            
            let totalProduction = 0;
            
            campaigns.forEach(campaign => {
                const equipment = APP_STATE.flowDesigner.equipment.find(e => e.id === campaign.equipmentId);
                if (equipment) {
                    const capacity = equipment.params.tpd || equipment.params.tph * 24 || 0;
                    const rate = campaign.customRate || capacity;
                    totalProduction += rate;
                }
            });
            
            return totalProduction;
        }

        function getDemandForDate2(productName, dateStr) {
            // Get demand from Demand Planning tab
            const product = Object.values(APP_STATE.products).find(p => p.name === productName);
            if (!product) return 0;
            
            const demandData = APP_STATE.demandPlan[product.id];
            if (!demandData || !demandData[dateStr]) return 0;
            
            return demandData[dateStr].value || 0;
        }

        function getCampaignsForEquipment(equipmentId) {
            return APP_STATE.productionPlan.campaigns.filter(c => c.equipmentId === equipmentId);
        }

        function dateRangesOverlap(start1, end1, start2, end2) {
            return start1 <= end2 && end1 >= start2;
        }

        function calculateRollingAverages() {
            // Calculate 7, 15, 30 day rolling averages for each product
            const metrics = {};
            const products = Object.values(APP_STATE.products);
            
            products.forEach(product => {
                metrics[product.name] = {
                    avg7: 0,
                    avg15: 0,
                    avg30: 0
                };
            });
            
            return metrics;
        }

        function showRecommendations() {
            alert('üí° Smart Recommendations:\n\n‚Ä¢ Clinker silo reaching 90% in 5 days\n‚Ä¢ Suggest: Stop Kiln 1 for 10 days\n‚Ä¢ OPC inventory stable - no changes needed');
        }

        function editCampaign(campaignId) {
            // TODO: Open campaign form in edit mode
            alert('Edit campaign: ' + campaignId);
        }

        // ============================================
        // TAB 5: MONITOR & INVENTORY
        // ============================================
        function renderMonitorTab() {
            return `
                <div class="p-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center">
                        <svg class="w-16 h-16 mx-auto text-blue-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Production Monitoring</h3>
                        <p class="text-gray-600 mb-4">Coming soon: Real-time production tracking, inventory levels, and performance analytics</p>
                        <div class="text-sm text-gray-500">
                            This tab will show:
                            <ul class="mt-2 space-y-1">
                                <li>‚Ä¢ Daily production vs targets</li>
                                <li>‚Ä¢ Inventory levels and projections</li>
                                <li>‚Ä¢ Equipment utilization</li>
                                <li>‚Ä¢ Alerts and notifications</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        // ============================================
        // SAVE/LOAD
        // ============================================
        
        function saveToLocalStorage() {
            try {
                const data = {
                    products: APP_STATE.products,
                    flowDesigner: {
                        equipment: APP_STATE.flowDesigner.equipment,
                        connections: APP_STATE.flowDesigner.connections,
                        nextId: APP_STATE.flowDesigner.nextId
                    },
                    productionPlan: APP_STATE.productionPlan,
                    demandPlan: APP_STATE.demandPlan,
                    inventory: APP_STATE.inventory,
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem('cementPlanner_' + APP_STATE.currentLocation, JSON.stringify(data));
            } catch (error) {
                console.error('Save error:', error);
            }
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('cementPlanner_' + (APP_STATE.currentLocation || 'MIA'));
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.products) {
                        APP_STATE.products = data.products;
                        // Migrate old family names to new ones
                        const familyMap = {
                            'raw_material': 'ck_raw',
                            'clinker': 'cem_raw',
                            'additive': 'cem_raw'
                        };
                        Object.values(APP_STATE.products).forEach(p => {
                            if (familyMap[p.family]) p.family = familyMap[p.family];
                        });
                    }
                    if (data.flowDesigner) {
                        APP_STATE.flowDesigner.equipment = data.flowDesigner.equipment || [];
                        APP_STATE.flowDesigner.connections = data.flowDesigner.connections || [];
                        APP_STATE.flowDesigner.nextId = data.flowDesigner.nextId || 1;
                    }
                    if (data.productionPlan) APP_STATE.productionPlan = data.productionPlan;
                    if (data.demandPlan) APP_STATE.demandPlan = data.demandPlan;
                    if (data.inventory) APP_STATE.inventory = data.inventory;
                    console.log('Loaded from localStorage');
                }
            } catch (error) {
                console.error('Load error:', error);
            }
        }

        function saveFlowToLocalStorage() {
            saveToLocalStorage();
        }

        function loadFlowFromLocalStorage() {
            loadFromLocalStorage();
        }

        function exportFlowToFile() {
            const data = {
                equipment: APP_STATE.flowDesigner.equipment,
                connections: APP_STATE.flowDesigner.connections,
                nextId: APP_STATE.flowDesigner.nextId,
                exportedAt: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flow_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importFlowFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        APP_STATE.flowDesigner.equipment = data.equipment;
                        APP_STATE.flowDesigner.connections = data.connections;
                        APP_STATE.flowDesigner.nextId = data.nextId || 1;
                        renderFlowCanvas();
                        saveToLocalStorage();
                        alert('‚úÖ Flow loaded!');
                    } catch (err) {
                        alert('‚ùå Error: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function exportAllData() {
            const data = {
                products: APP_STATE.products,
                flowDesigner: APP_STATE.flowDesigner,
                productionPlan: APP_STATE.productionPlan,
                exportedAt: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cement_planner_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ All data exported!');
        }

        // ============================================
        // INITIALIZE
        // ============================================
        
        console.log('Loading from localStorage...');
        loadFromLocalStorage();
        
        console.log('Rendering app...');
        try {
            renderApp();
            console.log('App rendered successfully');
        } catch (error) {
            console.error('Error rendering app:', error);
            document.getElementById('app').innerHTML = `
                <div style="padding: 20px; color: red; font-family: monospace;">
                    <h1>Error Loading Application</h1>
                    <pre>${error.message}\n${error.stack}</pre>
                </div>
            `;
        }
        
        console.log('=== CEMENT PLANNER INITIALIZED ===');
    </script>
</body>
</html>
