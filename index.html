<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cement Production Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Product color coding */
        .product-opc { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-left: 4px solid #3b82f6; }
        .product-il11 { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid #f59e0b; }
        .product-il8 { background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); border-left: 4px solid #ec4899; }
        .product-ppc { background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border-left: 4px solid #6366f1; }
        
        .product-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-opc { background: #3b82f6; color: white; }
        .badge-il11 { background: #f59e0b; color: white; }
        .badge-il8 { background: #ec4899; color: white; }
        .badge-ppc { background: #6366f1; color: white; }
        
        .product-card {
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .product-card.selected {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .recipe-ingredient {
            display: grid;
            grid-template-columns: 200px 1fr 100px;
            gap: 12px;
            align-items: center;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .ingredient-slider {
            width: 100%;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .calendar-day {
            min-height: 80px;
            border: 1px solid #e5e7eb;
            padding: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .calendar-day:hover {
            background: #f3f4f6;
            border-color: #3b82f6;
        }
        
        .calendar-day.selected {
            background: #dbeafe;
            border-color: #3b82f6;
            border-width: 2px;
        }
        
        .calendar-day.maintenance {
            background: repeating-linear-gradient(45deg, #fef2f2, #fef2f2 10px, #fee2e2 10px, #fee2e2 20px);
        }
        
        .calendar-day.shutdown {
            background: #f3f4f6;
        }
        
        /* Process Flow Styles */
        .toolbar-item {
            cursor: grab;
            transition: all 0.2s;
        }
        
        .toolbar-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .equipment-node {
            cursor: move;
            transition: all 0.2s;
        }
        
        .equipment-node:hover {
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.3));
        }
        
        .equipment-node.selected {
            filter: drop-shadow(0 0 12px #3b82f6);
        }
        
        .connection-line {
            stroke: #9ca3af;
            stroke-width: 3;
            fill: none;
            cursor: pointer;
            transition: stroke-width 0.2s;
        }
        
        .connection-line:hover {
            stroke: #3b82f6;
            stroke-width: 5;
        }
        
        .port {
            cursor: crosshair;
            transition: all 0.2s;
        }
        
        .port:hover {
            r: 8;
            fill: #3b82f6;
        }
        
        .hidden {
            display: none;
        }
        
        /* Sticky scrollbar container */
        .scrollbar-container {
            position: sticky;
            top: 60px;
            z-index: 15;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            overflow-x: scroll;
            overflow-y: hidden;
            height: 20px;
        }
        
        .scrollbar-container::-webkit-scrollbar {
            height: 12px;
        }
        
        .scrollbar-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        .scrollbar-container::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 6px;
        }
        
        .scrollbar-container::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        
        .scrollbar-content {
            height: 1px;
        }
        
        .equipment-node.selected rect {
            filter: drop-shadow(0px 4px 12px rgba(59, 130, 246, 0.6));
        }
        
        #flowCanvas {
            cursor: crosshair;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <div id="recipeModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-3xl border border-gray-200 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-900" id="recipeModalTitle">Edit Product Recipe</h3>
                <button onclick="closeRecipeModal()" class="text-gray-400 hover:text-gray-600 font-bold text-xl">&times;</button>
            </div>
            <div id="recipeModalContent"></div>
            <div class="flex justify-end space-x-2 mt-6">
                <button onclick="closeRecipeModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded font-semibold">Cancel</button>
                <button onclick="saveRecipe()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold">Save Recipe</button>
            </div>
        </div>
    </div>

    <div id="dayModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl border border-gray-200 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-900" id="dayModalTitle">Edit Production Day</h3>
                <button onclick="closeDayModal()" class="text-gray-400 hover:text-gray-600 font-bold text-xl">&times;</button>
            </div>
            <div id="dayModalContent"></div>
            <div class="flex justify-end space-x-2 mt-6">
                <button onclick="closeDayModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded font-semibold">Cancel</button>
                <button onclick="saveDayPlan()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        console.log('=== CEMENT PLANNER STARTING ===');
        
        // ============================================
        // GLOBAL STATE
        // ============================================
        
        const CEMEX_LOCATIONS = {
            'MIA': { code: 'MIA', name: 'Miami Plant', type: 'plant', color: '#1d4ed8', bg: '#eff6ff' },
            'BRS': { code: 'BRS', name: 'Brooksville Plant', type: 'plant', color: '#15803d', bg: '#f0fdf4' },
            'PEV': { code: 'PEV', name: 'Port Everglades', type: 'terminal', color: '#0e7490', bg: '#ecfeff' },
            'WPB': { code: 'WPB', name: 'West Palm Beach', type: 'terminal', color: '#0369a1', bg: '#f0f9ff' },
            'ORL': { code: 'ORL', name: 'Orlando Terminal', type: 'terminal', color: '#7c3aed', bg: '#f5f3ff' },
            'SUB': { code: 'SUB', name: 'Sutton Terminal', type: 'terminal', color: '#b45309', bg: '#fffbeb' },
            'JAX': { code: 'JAX', name: 'Jacksonville Terminal', type: 'terminal', color: '#9f1239', bg: '#fff1f2' }
        };

        const APP_STATE = {
            currentTab: 'products',
            currentDate: new Date(),
            currentLocation: localStorage.getItem('cemex_current_location') || 'MIA',
            
            products: {
                opc: {
                    id: 'opc',
                    name: 'OPC (Ordinary Portland Cement)',
                    family: 'cementitious',
                    recipe: { clinker: 95, gypsum: 5, limestone: 0, fly_ash: 0, slag: 0, pozzolana: 0, additives: 0 },
                    color: '#3b82f6'
                },
                il11: {
                    id: 'il11',
                    name: 'IL(11) - Portland Limestone Cement',
                    family: 'cementitious',
                    recipe: { clinker: 84, gypsum: 5, limestone: 11, fly_ash: 0, slag: 0, pozzolana: 0, additives: 0 },
                    color: '#f59e0b'
                }
            },
            
            flowDesigner: {
                equipment: [],
                connections: [],
                nextId: 1,
                selectedEquipment: null,
                connecting: null,
                zoom: 1,
                panX: 0,
                panY: 0,
                selection: { active: false, startX: 0, startY: 0, endX: 0, endY: 0 },
                selectedIds: []
            },
            
            rules: {
                system: {
                    silo_single_product: true,
                    equipment_single_product: true,
                    inventory_non_negative: true,
                    recipe_adherence: true,
                    silo_capacity_limits: true
                },
                operational: {
                    clinker_shortage_response: 'stop_mills_sequential',
                    campaign_minimum_hours: 24,
                    changeover_time_hours: 0,
                    default_operating_mode: '24/7',
                    product_priorities: {},
                    allow_mid_campaign_switch: false,
                    inventory_safety_factor: 1.1
                },
                holidays: [] 
            },
            
            productionPlan: {
                campaigns: [],
                inventoryHistory: {},
                campaignTemplates: []
            },
            
            demandPlan: {},
            demandPlanning: { collapsedMonths: [] },
            inventory: {},
            planView: { year: 2025, month: 2 }
        };

        const EQUIPMENT_TYPES = {
            raw_material: {
                name: 'Raw Material',
                color: '#84cc16',
                width: 30,
                height: 30,
                outputs: ['raw_material'],
                inputs: [],
                defaultParams: { supply_rate: 3000, cost_per_ton: 30, material_name: 'Limestone' }
            },
            fuel: {
                name: 'Fuel',
                color: '#18181b',
                width: 30,
                height: 30,
                outputs: ['fuel'],
                inputs: [],
                defaultParams: { supply_rate: 500, gcal_per_ton: 6000, cost_per_ton: 80, fuel_name: 'Coal' }
            },
            unloading: {
                name: 'Unloading',
                color: '#f97316',
                width: 30,
                height: 30,
                inputs: ['raw_material', 'fuel'],
                outputs: ['raw_material', 'fuel'],
                defaultParams: { unloading_rate: 500, material_type: 'Raw Material' }
            },
            raw_mill: {
                name: 'Raw Mill',
                color: '#dc2626',
                width: 30,
                height: 30,
                inputs: ['raw_material'],
                outputs: ['raw_meal'],
                defaultParams: { nominal_tph: 120, hours: 22, utilization: 0.85, efficiency: 0.95 }
            },
            kiln: {
                name: 'Kiln',
                color: '#ea580c',
                width: 30,
                height: 30,
                inputs: ['raw_meal', 'fuel'],
                outputs: ['clinker'],
                defaultParams: { tpd: 2000, gcal_per_tm_ck: 750, rm_to_clinker_factor: 1.55 }
            },
            storage: {
                name: 'Storage',
                color: '#6b7280',
                width: 30,
                height: 30,
                inputs: ['raw_material', 'fuel', 'clinker', 'cement', 'raw_meal'],
                outputs: ['raw_material', 'fuel', 'clinker', 'cement', 'raw_meal'],
                defaultParams: { min_volume: 2000, max_volume: 15000, material_type: 'Clinker' }
            },
            finish_mill: {
                name: 'Finish Mill',
                color: '#3b82f6',
                width: 30,
                height: 30,
                inputs: ['clinker'],
                outputs: ['cement'],
                defaultParams: { products: {} }
            },
            packing: {
                name: 'Packing',
                color: '#eab308',
                width: 30,
                height: 30,
                inputs: ['cement'],
                outputs: ['packed'],
                defaultParams: { product: '', pallets_per_hour: 100, hours_operation: 18 }
            },
            loadout: {
                name: 'Loadout',
                color: '#8b5cf6',
                width: 30,
                height: 30,
                inputs: ['cement', 'packed'],
                outputs: [],
                defaultParams: { loads_per_hour: 4, hours_operation: 16 }
            }
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function formatNumber(num) {
            return Math.round(num).toLocaleString();
        }

        function adjustColor(color, amount) {
            const num = parseInt(color.replace('#', ''), 16);
            const r = Math.max(0, Math.min(255, (num >> 16) + amount));
            const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
            const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
            return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
        }

        function getDateString(date) {
            return date.toISOString().split('T')[0];
        }

        function parseDate(dateStr) {
            return new Date(dateStr + 'T12:00:00');
        }

        // ============================================
        // MAIN RENDER
        // ============================================
        
        function renderApp() {
            const app = document.getElementById('app');
            
            let content = '';
            content += renderHeader();
            content += renderNavTabs();
            
            switch (APP_STATE.currentTab) {
                case 'products':
                    content += renderProductsTab();
                    break;
                case 'flow':
                    content += renderFlowDesignerTab();
                    break;
                case 'demand':
                    content += renderDemandPlanningTab();
                    break;
                case 'plan':
                    content += renderProductionPlanTab();
                    break;
                case 'monitor':
                    content += renderMonitorTab();
                    break;
            }
            
            app.innerHTML = content;
            
            if (APP_STATE.currentTab === 'flow') {
                initializeFlowDesigner();
            }
            if (APP_STATE.currentTab === 'plan') {
                initializeProductionPlanScrollSync();
            }
        }
        
        function initializeProductionPlanScrollSync() {
            const topScrollbar = document.getElementById('topScrollbar');
            const tableContainer = document.getElementById('tableScrollContainer');
            const topScrollbarContent = document.getElementById('topScrollbarContent');
            
            if (!topScrollbar || !tableContainer || !topScrollbarContent) return;
            
            const table = tableContainer.querySelector('table');
            if (table) {
                topScrollbarContent.style.width = table.scrollWidth + 'px';
            }
            
            topScrollbar.addEventListener('scroll', function() {
                tableContainer.scrollLeft = topScrollbar.scrollLeft;
            });
            
            tableContainer.addEventListener('scroll', function() {
                topScrollbar.scrollLeft = tableContainer.scrollLeft;
            });
        }

        // ============================================
        // HEADER
        // ============================================
        
        function renderHeader() {
            const loc = CEMEX_LOCATIONS[APP_STATE.currentLocation] || CEMEX_LOCATIONS['MIA'];
            const isPlant = loc.type === 'plant';
            return `
                <div class="border-b border-gray-200 shadow-sm" style="background:white;">
                    <div class="px-6 py-2 flex items-center justify-between" style="background:${loc.color}; color:white;">
                        <div class="flex items-center space-x-2 text-sm font-medium">
                            <span class="font-bold text-white text-base tracking-wide">CEMEX</span>
                            <span class="opacity-60">&rsaquo;</span>
                            <span class="opacity-90">Florida Region</span>
                            <span class="opacity-60">&rsaquo;</span>
                            <span class="font-bold">${loc.name}</span>
                            <span class="ml-2 px-2 py-0.5 rounded text-xs font-bold" style="background:rgba(255,255,255,0.25)">${loc.code}</span>
                            <span class="px-2 py-0.5 rounded text-xs" style="background:rgba(255,255,255,0.15)">${isPlant ? 'Plant' : 'Terminal'}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs opacity-75">Switch:</span>
                            ${Object.values(CEMEX_LOCATIONS).map(l => `
                                <button onclick="switchLocation('${l.code}')"
                                        title="${l.name}"
                                        class="px-2 py-0.5 rounded text-xs font-bold transition-all ${l.code === APP_STATE.currentLocation
                                            ? 'bg-white text-gray-800 shadow'
                                            : 'text-white opacity-60 hover:opacity-100'
                                        }">
                                    ${l.code}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    <div class="px-6 py-3 flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="p-2 rounded-lg text-white font-bold" style="background:${loc.color}">
                                PPS
                            </div>
                            <div>
                                <h1 class="text-lg font-bold text-gray-900">Production Planning System</h1>
                                <p class="text-xs text-gray-400">Configure &rarr; Design &rarr; Plan &rarr; Monitor</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="text-right">
                                <div class="text-xs text-gray-400">Today</div>
                                <div class="text-sm font-bold text-gray-900">${APP_STATE.currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>
                            </div>
                            <button onclick="resetAllData()" class="bg-red-600 text-white px-3 py-1.5 rounded-lg text-sm hover:bg-red-700 font-semibold">
                                Reset
                            </button>
                            <button onclick="showDataManagementMenu()" class="text-white px-3 py-1.5 rounded-lg text-sm font-semibold" style="background:${loc.color}">
                                Data
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function switchLocation(code) {
            if (!CEMEX_LOCATIONS[code]) return;
            if (code === APP_STATE.currentLocation) return;

            saveToLocalStorage();
            APP_STATE.currentLocation = code;
            localStorage.setItem('cemex_current_location', code);

            APP_STATE.products = {};
            APP_STATE.flowDesigner = { equipment: [], connections: [], nextId: 1 };
            APP_STATE.productionPlan = { campaigns: [], inventoryHistory: {}, campaignTemplates: [] };
            APP_STATE.demandPlan = {};
            APP_STATE.inventory = {};
            APP_STATE.currentTab = 'products';

            loadFromLocalStorage();
            renderApp();
        }

        // ============================================
        // NAVIGATION
        // ============================================
        
        function renderNavTabs() {
            const tabs = [
                { id: 'products', label: '1. Products & Recipes' },
                { id: 'flow', label: '2. Process Flow' },
                { id: 'demand', label: '3. Demand Planning' },
                { id: 'plan', label: '4. Production Plan' },
                { id: 'monitor', label: '5. Monitor & Inventory' }
            ];
            
            return `
                <div class="bg-white border-b border-gray-200">
                    <div class="px-6">
                        <nav class="flex space-x-2">
                            ${tabs.map(tab => `
                                <button 
                                    onclick="switchTab('${tab.id}')"
                                    class="border-b-2 ${APP_STATE.currentTab === tab.id ? 'border-blue-600 text-blue-600 bg-blue-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'} py-3 px-4 font-semibold text-sm transition-colors rounded-t"
                                >
                                    ${tab.label}
                                </button>
                            `).join('')}
                        </nav>
                    </div>
                </div>
            `;
        }

        function switchTab(tabId) {
            APP_STATE.currentTab = tabId;
            renderApp();
        }

        if (!window.AVAILABLE_RAW_MATERIALS) {
            window.AVAILABLE_RAW_MATERIALS = [
                'Clinker', 'Gypsum', 'Limestone', 'Fly Ash', 'Slag', 
                'Pozzolana', 'Silica Fume', 'Rice Husk Ash', 'Metakaolin'
            ];
        }

        // ============================================
        // TAB 1: PRODUCTS & RECIPES
        // ============================================
        
        function renderProductsTab() {
            const products = Object.values(APP_STATE.products);

            const groups = {
                'raw_materials': { label: 'Raw Materials', subtitle: 'Base materials (inputs)', color: '#78716c', bg: '#f5f5f4', border: '#a8a29e', products: [], hasRecipe: false },
                'fuels': { label: 'Fuels', subtitle: 'Energy sources', color: '#dc2626', bg: '#fef2f2', border: '#fca5a5', products: [], hasRecipe: false },
                'intermediate': { label: 'Intermediate Products', subtitle: 'Clinkers (made from raw materials)', color: '#ea580c', bg: '#fff7ed', border: '#fdba74', products: [], hasRecipe: true, recipeFrom: ['raw_materials'] },
                'cementitious': { label: 'Cementitious Products', subtitle: 'Final products (sold)', color: '#2563eb', bg: '#eff6ff', border: '#93c5fd', products: [], hasRecipe: true, recipeFrom: ['intermediate', 'raw_materials'] }
            };

            products.forEach(p => {
                const fam = p.family || 'cementitious';
                if (groups[fam]) groups[fam].products.push(p);
                else groups['cementitious'].products.push(p);
            });

            return `
                <div class="p-4">
                    <div class="mb-4 flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Products & Recipes</h2>
                            <p class="text-gray-500 text-xs mt-0.5">Define materials, intermediates, and final products</p>
                        </div>
                        <button onclick="addNewProduct()" class="bg-green-600 text-white px-3 py-1.5 rounded-lg hover:bg-green-700 flex items-center space-x-1 text-sm font-semibold">
                            <span>Add Product</span>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-4 gap-4">
                        ${Object.entries(groups).map(([key, group]) => `
                            <div class="border-2 rounded-lg p-3" style="border-color: ${group.border}; background: ${group.bg};">
                                <div class="mb-3 pb-2 border-b-2" style="border-color: ${group.border};">
                                    <div class="font-bold text-sm mb-1" style="color: ${group.color};">${group.label}</div>
                                    <div class="text-xs text-gray-500 mb-2">${group.subtitle}</div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs font-semibold px-2 py-0.5 rounded-full text-white" style="background:${group.color};">
                                            ${group.products.length} items
                                        </span>
                                        <button onclick="addNewProductOfFamily('${key}')" 
                                                class="text-xs px-2 py-1 rounded border font-semibold hover:opacity-80"
                                                style="color:${group.color}; border-color:${group.color};">
                                            + Add
                                        </button>
                                    </div>
                                </div>
                                <div class="space-y-2 max-h-[600px] overflow-y-auto">
                                    ${group.products.length === 0 ? `
                                        <div class="text-xs text-gray-400 italic py-2">No items yet</div>
                                    ` : `
                                        ${group.products.map(p => renderProductCardCompact(p, group, key)).join('')}
                                    `}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderProductCardCompact(product, group, familyKey) {
            const recipeItems = Object.entries(product.recipe || {});
            const totalPercentage = recipeItems.reduce((sum, [mat, pct]) => sum + pct, 0);
            const isValid = recipeItems.length === 0 || Math.abs(totalPercentage - 100) < 0.1;
            const hasRecipe = group.hasRecipe;
            
            return `
                <div class="bg-white rounded border p-2 hover:shadow-md transition-shadow cursor-pointer"
                     style="border-color: ${group.border};"
                     onclick="editProduct('${product.id}')">
                    <div class="flex items-center justify-between mb-1">
                        <span class="font-semibold text-xs text-gray-900 truncate flex-1" title="${product.name}">
                            ${product.name}
                        </span>
                        <button onclick="event.stopPropagation(); deleteProduct('${product.id}')" 
                                class="text-red-500 font-bold hover:text-red-700 px-1 rounded flex-shrink-0">
                            &times;
                        </button>
                    </div>
                    
                    <div class="flex items-center space-x-1 mb-1">
                        <div class="w-3 h-3 rounded-full border" style="background: ${product.color || '#gray'}; border-color: ${group.border};"></div>
                        <span class="text-xs text-gray-500">${product.color || 'No color'}</span>
                    </div>
                    
                    ${hasRecipe ? `
                        <div class="mt-2 pt-2 border-t" style="border-color: ${group.border};">
                            ${recipeItems.length === 0 ? `
                                <div class="text-xs text-gray-400 italic">No recipe</div>
                            ` : `
                                <div class="text-xs space-y-0.5">
                                    ${recipeItems.slice(0, 3).map(([material, pct]) => `
                                        <div class="flex justify-between">
                                            <span class="text-gray-600 truncate">${material}</span>
                                            <span class="text-gray-900 font-semibold ml-1">${pct}%</span>
                                        </div>
                                    `).join('')}
                                    ${recipeItems.length > 3 ? `
                                        <div class="text-gray-400 italic">+${recipeItems.length - 3} more...</div>
                                    ` : ''}
                                    <div class="flex justify-between pt-1 border-t font-semibold ${isValid ? 'text-green-600' : 'text-red-600'}">
                                        <span>Total:</span>
                                        <span>${totalPercentage.toFixed(1)}%</span>
                                    </div>
                                </div>
                            `}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function addNewProduct() {
            const productName = prompt('Enter product name:');
            if (!productName) return;
            const productId = productName.toLowerCase().replace(/[^a-z0-9]/g, '_');
            if (APP_STATE.products[productId]) { alert('Product with this name already exists!'); return; }
            APP_STATE.products[productId] = {
                id: productId, name: productName, family: 'cementitious', recipe: {},
                color: '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')
            };
            saveToLocalStorage(); renderApp();
        }
        
        function updateProductFamily(productId, newFamily) {
            const product = APP_STATE.products[productId];
            if (!product) return;
            product.family = newFamily;
            if (newFamily === 'raw_materials' || newFamily === 'fuels') { product.recipe = {}; }
            saveToLocalStorage(); renderApp();
        }
        
        function getAvailableRecipeMaterials(family) {
            const allProducts = Object.values(APP_STATE.products);
            if (family === 'intermediate') return allProducts.filter(p => p.family === 'raw_materials');
            else if (family === 'cementitious') return allProducts.filter(p => p.family === 'intermediate' || p.family === 'raw_materials');
            return [];
        }

        function addNewProductOfFamily(family) {
            const familyLabels = {
                'raw_materials': 'Raw Material (e.g., Limestone, Gypsum, Fly Ash)',
                'fuels': 'Fuel (e.g., Coal, Natural Gas, Pet Coke)',
                'intermediate': 'Intermediate Product (e.g., Gray Clinker, White Clinker)',
                'cementitious': 'Cementitious Product (e.g., OPC Type I, IL-11, Slag)'
            };
            const productName = prompt(`Enter ${familyLabels[family]} name:`);
            if (!productName) return;
            const productId = productName.toLowerCase().replace(/[^a-z0-9]/g, '_');
            if (APP_STATE.products[productId]) { alert('Product with this name already exists!'); return; }
            APP_STATE.products[productId] = {
                id: productId, name: productName, family: family, recipe: {},
                color: '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')
            };
            saveToLocalStorage(); renderApp();
        }
        
        function editProduct(productId) {
            const product = APP_STATE.products[productId];
            if (!product) return;
            const hasRecipe = product.family === 'intermediate' || product.family === 'cementitious';
            const availableMaterials = hasRecipe ? getAvailableRecipeMaterials(product.family) : [];
            
            const modal = document.createElement('div');
            modal.id = 'editProductModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-4 rounded-t-lg sticky top-0">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold">Edit Product: ${product.name}</h3>
                            <button onclick="closeEditProductModal()" class="text-white hover:text-gray-200 font-bold text-xl">&times;</button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Product Name</label>
                            <input type="text" id="editProductName" value="${product.name}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                            <select id="editProductFamily" class="w-full px-3 py-2 border border-gray-300 rounded-lg" onchange="updateRecipeEditorVisibility()">
                                <option value="raw_materials" ${product.family === 'raw_materials' ? 'selected' : ''}>Raw Materials</option>
                                <option value="fuels" ${product.family === 'fuels' ? 'selected' : ''}>Fuels</option>
                                <option value="intermediate" ${product.family === 'intermediate' ? 'selected' : ''}>Intermediate Products</option>
                                <option value="cementitious" ${product.family === 'cementitious' ? 'selected' : ''}>Cementitious Products</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Color</label>
                            <div class="flex items-center space-x-2">
                                <input type="color" id="editProductColor" value="${product.color || '#3b82f6'}" class="h-10 w-20 border border-gray-300 rounded cursor-pointer">
                                <input type="text" id="editProductColorHex" value="${product.color || '#3b82f6'}" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg font-mono text-sm" onchange="document.getElementById('editProductColor').value = this.value">
                            </div>
                        </div>
                        <div id="recipeEditor" style="display: ${hasRecipe ? 'block' : 'none'};">
                            <div class="mb-4 bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <label class="text-sm font-semibold text-gray-700">Recipe (must total 100%)</label>
                                    <span id="recipeTotal" class="text-sm font-bold">0%</span>
                                </div>
                                <div id="recipeItems" class="space-y-2 mb-3">
                                    ${Object.entries(product.recipe || {}).map(([material, pct]) => `
                                        <div class="flex items-center space-x-2">
                                            <input type="text" value="${material}" readonly class="flex-1 px-2 py-1 border border-gray-300 rounded bg-gray-100 text-sm">
                                            <input type="number" value="${pct}" step="0.1" min="0" max="100" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm" onchange="updateRecipeTotal()">
                                            <button onclick="this.parentElement.remove(); updateRecipeTotal();" class="text-red-500 font-bold hover:text-red-700 px-2">&times;</button>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="flex items-center space-x-2">
                                    <select id="newRecipeMaterial" class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm">
                                        <option value="">Select material...</option>
                                        ${availableMaterials.map(m => `<option value="${m.name}">${m.name} (${m.family})</option>`).join('')}
                                    </select>
                                    <button onclick="addRecipeItem()" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 font-semibold">+ Add</button>
                                </div>
                            </div>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="closeEditProductModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-lg font-semibold">Cancel</button>
                            <button onclick="saveProductEdits('${productId}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold">Save Changes</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('editProductColor').addEventListener('change', function() {
                document.getElementById('editProductColorHex').value = this.value;
            });
            updateRecipeTotal();
        }
        
        function updateRecipeEditorVisibility() {
            const family = document.getElementById('editProductFamily').value;
            const hasRecipe = family === 'intermediate' || family === 'cementitious';
            document.getElementById('recipeEditor').style.display = hasRecipe ? 'block' : 'none';
        }
        
        function addRecipeItem() {
            const material = document.getElementById('newRecipeMaterial').value;
            if (!material) return;
            const recipeItems = document.getElementById('recipeItems');
            const newItem = document.createElement('div');
            newItem.className = 'flex items-center space-x-2';
            newItem.innerHTML = `
                <input type="text" value="${material}" readonly class="flex-1 px-2 py-1 border border-gray-300 rounded bg-gray-100 text-sm">
                <input type="number" value="0" step="0.1" min="0" max="100" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm" onchange="updateRecipeTotal()">
                <button onclick="this.parentElement.remove(); updateRecipeTotal();" class="text-red-500 font-bold hover:text-red-700 px-2">&times;</button>
            `;
            recipeItems.appendChild(newItem);
            document.getElementById('newRecipeMaterial').value = '';
            updateRecipeTotal();
        }
        
        function updateRecipeTotal() {
            const items = document.getElementById('recipeItems').querySelectorAll('div');
            let total = 0;
            items.forEach(item => {
                const input = item.querySelector('input[type="number"]');
                if (input) total += parseFloat(input.value) || 0;
            });
            const totalSpan = document.getElementById('recipeTotal');
            totalSpan.textContent = total.toFixed(1) + '%';
            if (Math.abs(total - 100) < 0.1) {
                totalSpan.className = 'text-sm font-bold text-green-600';
            } else {
                totalSpan.className = 'text-sm font-bold text-red-600';
            }
        }
        
        function saveProductEdits(productId) {
            const product = APP_STATE.products[productId];
            if (!product) return;
            const name = document.getElementById('editProductName').value;
            const family = document.getElementById('editProductFamily').value;
            const color = document.getElementById('editProductColorHex').value;
            if (!name) { alert('Product name is required'); return; }
            
            const hasRecipe = family === 'intermediate' || family === 'cementitious';
            let recipe = {};
            let total = 0;
            if (hasRecipe) {
                const items = document.getElementById('recipeItems').querySelectorAll('div');
                items.forEach(item => {
                    const materialInput = item.querySelector('input[type="text"]');
                    const pctInput = item.querySelector('input[type="number"]');
                    if (materialInput && pctInput) {
                        const material = materialInput.value;
                        const pct = parseFloat(pctInput.value) || 0;
                        if (material && pct > 0) { recipe[material] = pct; total += pct; }
                    }
                });
                if (Object.keys(recipe).length > 0 && Math.abs(total - 100) > 0.1) {
                    alert(`Recipe must total 100%! Current total: ${total.toFixed(1)}%`);
                    return;
                }
            }
            product.name = name; product.family = family; product.color = color; product.recipe = recipe;
            saveToLocalStorage(); closeEditProductModal(); renderApp();
            alert('Product updated successfully!');
        }
        
        function closeEditProductModal() {
            const modal = document.getElementById('editProductModal');
            if (modal) modal.remove();
        }

        function deleteProduct(productId) {
            if (!confirm(`Delete product "${APP_STATE.products[productId].name}"?`)) return;
            delete APP_STATE.products[productId];
            saveToLocalStorage(); renderApp();
        }

        // ============================================
        // TAB 2: PROCESS FLOW DESIGNER
        // ============================================

        function renderFlowDesignerTab() {
            return `
                <div class="bg-gray-800 border-b border-gray-700 p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-white font-semibold text-lg">Process Flow Designer</h2>
                            <p class="text-gray-400 text-sm">Design your plant layout and equipment connections</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="btnFlowRules" class="bg-purple-600 text-white px-3 py-2 rounded text-sm hover:bg-purple-700 font-semibold">Rules</button>
                            <button id="btnFlowClear" class="bg-gray-700 text-gray-200 px-3 py-2 rounded text-sm hover:bg-gray-600 font-semibold">Clear</button>
                            <button id="btnFlowLoad" class="bg-gray-700 text-gray-200 px-3 py-2 rounded text-sm hover:bg-gray-600 font-semibold">Load</button>
                            <button id="btnFlowSave" class="bg-gray-700 text-gray-200 px-3 py-2 rounded text-sm hover:bg-gray-600 font-semibold">Export</button>
                        </div>
                    </div>
                </div>
                <div class="flex" style="height: calc(100vh - 280px);">
                    <div id="flowToolbar" class="w-64 bg-gray-800 border-r border-gray-700 p-4 overflow-y-auto">
                        <h3 class="text-white font-semibold mb-2 text-sm">Equipment Library</h3>
                        <p class="text-gray-400 text-xs mb-4">Drag onto canvas &rarr;</p>
                        <div id="equipmentLibrary"></div>
                    </div>
                    <div id="flowCanvasContainer" class="flex-1 relative bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900">
                        <svg id="flowCanvas" class="absolute inset-0 w-full h-full">
                            <defs>
                                <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                                    <path d="M 40 0 L 0 0 0 40" fill="none" stroke="white" stroke-width="0.5" opacity="0.1"/>
                                </pattern>
                                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                    <polygon points="0 0, 10 3, 0 6" fill="#60a5fa" />
                                </marker>
                            </defs>
                            <rect width="100%" height="100%" fill="url(#grid)" />
                            <g id="connectionsLayer"></g>
                            <g id="equipmentLayer"></g>
                        </svg>
                        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-blue-900 bg-opacity-90 text-white px-6 py-3 rounded-lg border border-blue-500">
                            <div class="flex items-center space-x-4 text-sm font-semibold">
                                <div>Drag from left</div>
                                <div>Click ports to connect</div>
                                <div>Click items to edit</div>
                            </div>
                        </div>
                    </div>
                    <div id="flowRightPanel" class="w-80 bg-gray-800 border-l border-gray-700 p-4 overflow-y-auto">
                        <div id="flowInspectorView">
                            <h3 class="text-white font-semibold mb-4">Inspector</h3>
                            <div id="flowInspector" class="text-gray-400 text-sm">Select equipment to view details</div>
                        </div>
                        <div id="flowRulesView" class="hidden">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-white font-semibold">Rules of Engagement</h3>
                                <button onclick="closeRulesPanel()" class="text-gray-400 hover:text-white font-bold">&times;</button>
                            </div>
                            <div id="flowRulesContent"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function initializeFlowDesigner() {
            loadFlowFromLocalStorage();
            renderFlowEquipmentLibrary();
            setupFlowDesignerEvents();
            renderFlowCanvas();
        }

        function renderFlowEquipmentLibrary() {
            const library = document.getElementById('equipmentLibrary');
            if (!library) return;
            library.innerHTML = '';
            const categories = {
                'Sources': ['raw_material', 'fuel'],
                'Unloading': ['unloading'],
                'Processing': ['raw_mill', 'kiln', 'finish_mill', 'packing'],
                'Storage': ['storage'],
                'Dispatch': ['loadout']
            };
            Object.entries(categories).forEach(([category, types]) => {
                const header = document.createElement('div');
                header.className = 'text-xs font-semibold text-gray-400 mb-2 uppercase mt-4';
                header.textContent = category;
                library.appendChild(header);
                types.forEach(type => {
                    const def = EQUIPMENT_TYPES[type];
                    if (!def) return;
                    const el = document.createElement('div');
                    el.className = 'toolbar-item bg-gray-700 rounded-lg p-3 mb-2';
                    el.style.background = `linear-gradient(135deg, ${def.color}, ${adjustColor(def.color, -20)})`;
                    el.style.cursor = 'grab';
                    el.innerHTML = `<div class="text-white font-semibold text-sm text-center">${def.name}</div>`;
                    el.draggable = true;
                    el.dataset.type = type;
                    el.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('equipmentType', type);
                        el.style.opacity = '0.5';
                    });
                    el.addEventListener('dragend', () => { el.style.opacity = '1'; });
                    library.appendChild(el);
                });
            });
        }

        function setupFlowDesignerEvents() {
            const container = document.getElementById('flowCanvasContainer');
            const canvas = document.getElementById('flowCanvas');
            if (!container || !canvas) return;

            let isDraggingCanvas = false;
            let isSelecting = false;

            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
                const newZoom = Math.max(0.25, Math.min(2, APP_STATE.flowDesigner.zoom * zoomFactor));
                const zoomChange = newZoom / APP_STATE.flowDesigner.zoom;
                APP_STATE.flowDesigner.panX = mouseX - (mouseX - APP_STATE.flowDesigner.panX) * zoomChange;
                APP_STATE.flowDesigner.panY = mouseY - (mouseY - APP_STATE.flowDesigner.panY) * zoomChange;
                APP_STATE.flowDesigner.zoom = newZoom;
                renderFlowCanvas();
            });

            canvas.addEventListener('mousedown', (e) => {
                if (e.target === canvas || e.target.id === 'equipmentLayer' || e.target.id === 'connectionsLayer') {
                    const rect = canvas.getBoundingClientRect();
                    const x = (e.clientX - rect.left - APP_STATE.flowDesigner.panX) / APP_STATE.flowDesigner.zoom;
                    const y = (e.clientY - rect.top - APP_STATE.flowDesigner.panY) / APP_STATE.flowDesigner.zoom;
                    const clickedEq = APP_STATE.flowDesigner.equipment.find(eq => {
                        const def = EQUIPMENT_TYPES[eq.type];
                        return x >= eq.x && x <= eq.x + def.width && y >= eq.y && y <= eq.y + def.height;
                    });
                    if (!clickedEq) {
                        isSelecting = true;
                        APP_STATE.flowDesigner.selection = { active: true, startX: x, startY: y, endX: x, endY: y };
                        APP_STATE.flowDesigner.selectedIds = [];
                    }
                }
            });

            canvas.addEventListener('mousemove', (e) => {
                if (isSelecting) {
                    const rect = canvas.getBoundingClientRect();
                    const x = (e.clientX - rect.left - APP_STATE.flowDesigner.panX) / APP_STATE.flowDesigner.zoom;
                    const y = (e.clientY - rect.top - APP_STATE.flowDesigner.panY) / APP_STATE.flowDesigner.zoom;
                    APP_STATE.flowDesigner.selection.endX = x;
                    APP_STATE.flowDesigner.selection.endY = y;
                    const minX = Math.min(APP_STATE.flowDesigner.selection.startX, x);
                    const maxX = Math.max(APP_STATE.flowDesigner.selection.startX, x);
                    const minY = Math.min(APP_STATE.flowDesigner.selection.startY, y);
                    const maxY = Math.max(APP_STATE.flowDesigner.selection.startY, y);
                    APP_STATE.flowDesigner.selectedIds = APP_STATE.flowDesigner.equipment.filter(eq => {
                        const def = EQUIPMENT_TYPES[eq.type];
                        return eq.x + def.width > minX && eq.x < maxX && eq.y + def.height > minY && eq.y < maxY;
                    }).map(eq => eq.id);
                    renderFlowCanvas();
                }
            });

            canvas.addEventListener('mouseup', () => {
                if (isSelecting) {
                    isSelecting = false;
                    APP_STATE.flowDesigner.selection.active = false;
                    renderFlowCanvas();
                }
            });

            container.addEventListener('dragover', (e) => e.preventDefault());
            container.addEventListener('drop', (e) => {
                e.preventDefault();
                const type = e.dataTransfer.getData('equipmentType');
                if (type) {
                    const rect = canvas.getBoundingClientRect();
                    const x = (e.clientX - rect.left - APP_STATE.flowDesigner.panX) / APP_STATE.flowDesigner.zoom;
                    const y = (e.clientY - rect.top - APP_STATE.flowDesigner.panY) / APP_STATE.flowDesigner.zoom;
                    addFlowEquipment(type, x, y);
                }
            });

            const btnFlowClear = document.getElementById('btnFlowClear');
            if (btnFlowClear) {
                btnFlowClear.addEventListener('click', () => {
                    if (confirm('Clear all equipment?')) {
                        APP_STATE.flowDesigner.equipment = [];
                        APP_STATE.flowDesigner.connections = [];
                        APP_STATE.flowDesigner.selectedEquipment = null;
                        APP_STATE.flowDesigner.selectedIds = [];
                        renderFlowCanvas();
                        saveFlowToLocalStorage();
                    }
                });
            }

            const btnFlowSave = document.getElementById('btnFlowSave');
            if (btnFlowSave) btnFlowSave.addEventListener('click', exportFlowToFile);
            const btnFlowLoad = document.getElementById('btnFlowLoad');
            if (btnFlowLoad) btnFlowLoad.addEventListener('click', importFlowFromFile);
            const btnFlowRules = document.getElementById('btnFlowRules');
            if (btnFlowRules) btnFlowRules.addEventListener('click', openRulesPanel);
        }

        function renderFlowCanvas() {
            renderFlowConnections();
            renderFlowEquipment();
            renderSelectionRect();
        }

        function renderSelectionRect() {
            const layer = document.getElementById('equipmentLayer');
            if (!layer) return;
            const oldRect = document.getElementById('selectionRect');
            if (oldRect) oldRect.remove();
            if (!APP_STATE.flowDesigner.selection.active) return;
            const sel = APP_STATE.flowDesigner.selection;
            const x = Math.min(sel.startX, sel.endX);
            const y = Math.min(sel.startY, sel.endY);
            const width = Math.abs(sel.endX - sel.startX);
            const height = Math.abs(sel.endY - sel.startY);
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('id', 'selectionRect');
            rect.setAttribute('x', x);
            rect.setAttribute('y', y);
            rect.setAttribute('width', width);
            rect.setAttribute('height', height);
            rect.setAttribute('fill', 'none');
            rect.setAttribute('stroke', '#3b82f6');
            rect.setAttribute('stroke-width', 2 / APP_STATE.flowDesigner.zoom);
            rect.setAttribute('stroke-dasharray', `${10 / APP_STATE.flowDesigner.zoom}`);
            rect.setAttribute('pointer-events', 'none');
            layer.appendChild(rect);
        }

        function renderFlowConnections() {
            const layer = document.getElementById('connectionsLayer');
            if (!layer) return;
            layer.innerHTML = '';
            APP_STATE.flowDesigner.connections.forEach(conn => {
                const fromEq = APP_STATE.flowDesigner.equipment.find(e => e.id === conn.from);
                const toEq = APP_STATE.flowDesigner.equipment.find(e => e.id === conn.to);
                if (!fromEq || !toEq) return;

                const fromDef = EQUIPMENT_TYPES[fromEq.type];
                const toDef = EQUIPMENT_TYPES[toEq.type];
                const fromCenter = { x: fromEq.x + fromDef.width / 2, y: fromEq.y + fromDef.height / 2 };
                const toCenter = { x: toEq.x + toDef.width / 2, y: toEq.y + toDef.height / 2 };
                
                let fromX, fromY, toX, toY;
                const dx = toCenter.x - fromCenter.x;
                const dy = toCenter.y - fromCenter.y;
                
                if (Math.abs(dx) > Math.abs(dy)) {
                    if (dx > 0) { fromX = fromEq.x + fromDef.width; fromY = fromEq.y + fromDef.height / 2; }
                    else { fromX = fromEq.x; fromY = fromEq.y + fromDef.height / 2; }
                } else {
                    if (dy > 0) { fromX = fromEq.x + fromDef.width / 2; fromY = fromEq.y + fromDef.height; }
                    else { fromX = fromEq.x + fromDef.width / 2; fromY = fromEq.y; }
                }
                
                if (Math.abs(dx) > Math.abs(dy)) {
                    if (dx > 0) { toX = toEq.x; toY = toEq.y + toDef.height / 2; }
                    else { toX = toEq.x + toDef.width; toY = toEq.y + toDef.height / 2; }
                } else {
                    if (dy > 0) { toX = toEq.x + toDef.width / 2; toY = toEq.y; }
                    else { toX = toEq.x + toDef.width / 2; toY = toEq.y + toDef.height; }
                }

                let controlX1, controlY1, controlX2, controlY2;
                if (Math.abs(dx) > Math.abs(dy)) {
                    const curveAmount = Math.abs(dy) > 20 ? dy * 0.5 : 50;
                    controlX1 = fromX + dx * 0.4; controlY1 = fromY + curveAmount;
                    controlX2 = fromX + dx * 0.6; controlY2 = toY - curveAmount;
                } else {
                    const curveAmount = Math.abs(dx) > 20 ? dx * 0.5 : 50;
                    controlX1 = fromX + curveAmount; controlY1 = fromY + dy * 0.4;
                    controlX2 = toX - curveAmount; controlY2 = fromY + dy * 0.6;
                }
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const d = `M ${fromX} ${fromY} C ${controlX1} ${controlY1}, ${controlX2} ${controlY2}, ${toX} ${toY}`;
                path.setAttribute('d', d);
                path.setAttribute('stroke', '#60a5fa');
                path.setAttribute('stroke-width', '4');
                path.setAttribute('fill', 'none');
                path.setAttribute('class', 'connection-line');
                path.setAttribute('marker-end', 'url(#arrowhead)');
                path.setAttribute('opacity', '0.8');
                path.addEventListener('click', () => {
                    if (confirm('Delete connection?')) {
                        APP_STATE.flowDesigner.connections = APP_STATE.flowDesigner.connections.filter(c => c.id !== conn.id);
                        renderFlowCanvas();
                        saveFlowToLocalStorage();
                    }
                });
                layer.appendChild(path);
            });
        }

        function renderFlowEquipment() {
            const layer = document.getElementById('equipmentLayer');
            if (!layer) return;
            const selRect = document.getElementById('selectionRect');
            layer.innerHTML = '';
            if (selRect) layer.appendChild(selRect);

            APP_STATE.flowDesigner.equipment.forEach(eq => {
                const def = EQUIPMENT_TYPES[eq.type];
                const isSelected = APP_STATE.flowDesigner.selectedIds.includes(eq.id);
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('class', `equipment-node ${isSelected ? 'selected' : ''}`);

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', eq.x);
                rect.setAttribute('y', eq.y);
                rect.setAttribute('width', def.width);
                rect.setAttribute('height', def.height);
                rect.setAttribute('fill', def.color);
                rect.setAttribute('stroke', isSelected ? '#3b82f6' : 'white');
                rect.setAttribute('stroke-width', isSelected ? 4 : 2);
                g.appendChild(rect);

                const name = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                name.setAttribute('x', eq.x + def.width / 2);
                name.setAttribute('y', eq.y + def.height + 12);
                name.setAttribute('text-anchor', 'middle');
                name.setAttribute('fill', '#1f2937');
                name.setAttribute('font-size', '10');
                name.setAttribute('font-weight', 'bold');
                
                let displayName = eq.name;
                if (eq.type === 'raw_material' && eq.params.material_name) displayName = eq.params.material_name;
                else if (eq.type === 'fuel' && eq.params.fuel_name) displayName = eq.params.fuel_name;
                
                name.textContent = displayName;
                g.appendChild(name);

                const status = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                status.setAttribute('cx', eq.x + def.width - 4);
                status.setAttribute('cy', eq.y + 4);
                status.setAttribute('r', 3);
                status.setAttribute('fill', '#10b981');
                g.appendChild(status);

                if (def.outputs.length > 0) {
                    const port = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    port.setAttribute('cx', eq.x + def.width);
                    port.setAttribute('cy', eq.y + def.height / 2);
                    port.setAttribute('r', 4);
                    port.setAttribute('fill', '#3b82f6');
                    port.setAttribute('class', 'port');
                    port.addEventListener('click', (e) => { e.stopPropagation(); startFlowConnection(eq.id); });
                    g.appendChild(port);
                }

                if (def.inputs.length > 0) {
                    const port = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    port.setAttribute('cx', eq.x);
                    port.setAttribute('cy', eq.y + def.height / 2);
                    port.setAttribute('r', 4);
                    port.setAttribute('fill', '#10b981');
                    port.setAttribute('class', 'port');
                    port.addEventListener('click', (e) => { e.stopPropagation(); completeFlowConnection(eq.id); });
                    g.appendChild(port);
                }

                g.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('port')) selectFlowEquipment(eq.id);
                });

                let isDragging = false;
                let dragOffsets = [];

                g.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('port')) return;
                    isDragging = true;
                    if (!isSelected) {
                        APP_STATE.flowDesigner.selectedIds = [eq.id];
                        renderFlowCanvas();
                    }
                    dragOffsets = APP_STATE.flowDesigner.selectedIds.map(id => {
                        const item = APP_STATE.flowDesigner.equipment.find(e => e.id === id);
                        return { id: id, offsetX: e.clientX / APP_STATE.flowDesigner.zoom - item.x, offsetY: e.clientY / APP_STATE.flowDesigner.zoom - item.y };
                    });
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        dragOffsets.forEach(offset => {
                            const item = APP_STATE.flowDesigner.equipment.find(eq => eq.id === offset.id);
                            if (item) {
                                item.x = e.clientX / APP_STATE.flowDesigner.zoom - offset.offsetX;
                                item.y = e.clientY / APP_STATE.flowDesigner.zoom - offset.offsetY;
                            }
                        });
                        renderFlowCanvas();
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging) { isDragging = false; saveFlowToLocalStorage(); }
                });

                layer.appendChild(g);
            });
            
            const equipLayer = document.getElementById('equipmentLayer');
            const connLayer = document.getElementById('connectionsLayer');
            if (equipLayer) equipLayer.setAttribute('transform', `translate(${APP_STATE.flowDesigner.panX}, ${APP_STATE.flowDesigner.panY}) scale(${APP_STATE.flowDesigner.zoom})`);
            if (connLayer) connLayer.setAttribute('transform', `translate(${APP_STATE.flowDesigner.panX}, ${APP_STATE.flowDesigner.panY}) scale(${APP_STATE.flowDesigner.zoom})`);
        }

        function addFlowEquipment(type, x, y) {
            const def = EQUIPMENT_TYPES[type];
            let params = { ...def.defaultParams };
            if (type === 'finish_mill') params.available_products = Object.keys(APP_STATE.products);
            
            const equipment = {
                id: `eq_${APP_STATE.flowDesigner.nextId++}`,
                type: type,
                name: `${def.name} ${APP_STATE.flowDesigner.nextId - 1}`,
                x: x - def.width / 2,
                y: y - def.height / 2,
                params: params
            };
            APP_STATE.flowDesigner.equipment.push(equipment);
            renderFlowCanvas();
            saveFlowToLocalStorage();
        }

        function startFlowConnection(equipmentId) {
            APP_STATE.flowDesigner.connecting = { from: equipmentId };
        }

        function completeFlowConnection(equipmentId) {
            if (!APP_STATE.flowDesigner.connecting) return;
            const fromEq = APP_STATE.flowDesigner.equipment.find(e => e.id === APP_STATE.flowDesigner.connecting.from);
            const toEq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!fromEq || !toEq || fromEq.id === toEq.id) {
                APP_STATE.flowDesigner.connecting = null; return;
            }
            const fromType = EQUIPMENT_TYPES[fromEq.type];
            const toType = EQUIPMENT_TYPES[toEq.type];
            const canConnect = fromType.outputs.some(out => toType.inputs.includes(out));

            if (canConnect) {
                const connection = {
                    id: `conn_${APP_STATE.flowDesigner.nextId++}`,
                    from: fromEq.id,
                    to: toEq.id,
                    material: fromType.outputs.find(out => toType.inputs.includes(out))
                };
                APP_STATE.flowDesigner.connections.push(connection);
                saveFlowToLocalStorage();
            } else {
                alert('Incompatible materials!');
            }
            APP_STATE.flowDesigner.connecting = null;
            renderFlowCanvas();
        }

        function selectFlowEquipment(id) {
            APP_STATE.flowDesigner.selectedEquipment = id;
            APP_STATE.flowDesigner.selectedIds = [id];
            renderFlowCanvas();
            updateFlowInspector();
        }

        function updateFlowInspector() {
            const panel = document.getElementById('flowInspector');
            if (!panel) return;
            if (!APP_STATE.flowDesigner.selectedEquipment) {
                panel.innerHTML = '<div class="text-gray-400 text-sm">Select equipment to view specs</div>'; return;
            }
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === APP_STATE.flowDesigner.selectedEquipment);
            if (!eq) return;
            const def = EQUIPMENT_TYPES[eq.type];
            let specsHTML = '';

            if (eq.type === 'kiln') {
                specsHTML = `
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Clinker Type</label>
                            <select onchange="updateEquipmentParam('${eq.id}', 'clinker_type', this.value)" class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                                <option value="gray" ${(eq.params.clinker_type || 'gray') === 'gray' ? 'selected' : ''}>Gray Clinker (OPC)</option>
                                <option value="white" ${eq.params.clinker_type === 'white' ? 'selected' : ''}>White Clinker</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">TPD (Tons Per Day)</label>
                            <input type="number" value="${eq.params.tpd || 2000}" onchange="updateEquipmentParam('${eq.id}', 'tpd', parseFloat(this.value))" class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                        </div>
                    </div>
                `;
            } else if (eq.type === 'finish_mill') {
                const availableProducts = Object.keys(APP_STATE.products).filter(prodId => APP_STATE.products[prodId].family === 'cementitious');
                if (!eq.params.products) eq.params.products = {};
                const enabledProducts = Object.entries(eq.params.products).filter(([prodId, data]) => data.enabled && APP_STATE.products[prodId]).map(([prodId, data]) => ({ id: prodId, name: APP_STATE.products[prodId].name, tpd: data.tpd || 0, kwh_per_ton: data.kwh_per_ton || 0 }));
                
                specsHTML = `
                    <div class="space-y-2">
                        <button onclick="showAddProductToMill('${eq.id}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded text-sm font-semibold">+ Add Product</button>
                        ${enabledProducts.length > 0 ? `
                            <div class="bg-gray-900 rounded border border-gray-700 overflow-hidden">
                                <table class="w-full text-xs text-white">
                                    <thead class="bg-gray-800 text-gray-300">
                                        <tr><th class="text-left p-2 font-semibold">Product</th><th class="text-right p-2 font-semibold">TPD</th><th class="w-8"></th></tr>
                                    </thead>
                                    <tbody>
                                        ${enabledProducts.map(prod => `
                                            <tr class="border-t border-gray-800">
                                                <td class="p-2">${prod.name}</td>
                                                <td class="p-1 text-right"><input type="number" value="${prod.tpd}" onchange="updateMillProductTPD('${eq.id}', '${prod.id}', parseFloat(this.value))" class="w-16 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-right text-xs"></td>
                                                <td class="p-1 text-center"><button onclick="removeProductFromMill('${eq.id}', '${prod.id}')" class="text-red-400 hover:text-red-300 font-bold">&times;</button></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<div class="text-xs text-gray-500 text-center py-3">No products added yet</div>'}
                        <div id="addProductForm_${eq.id}" class="hidden bg-gray-800 rounded p-3 space-y-2">
                            <div class="text-xs font-semibold text-gray-300 mb-2">Add Product to Mill</div>
                            <select id="productSelect_${eq.id}" class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                <option value="">-- Select Product --</option>
                                ${availableProducts.filter(prodId => !eq.params.products[prodId]?.enabled).map(prodId => `<option value="${prodId}">${APP_STATE.products[prodId].name}</option>`).join('')}
                            </select>
                            <div class="flex gap-2 mt-2">
                                <button onclick="cancelAddProductToMill('${eq.id}')" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-1 rounded text-xs font-semibold">Cancel</button>
                                <button onclick="confirmAddProductToMill('${eq.id}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-1 rounded text-xs font-semibold">Add</button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (eq.type === 'storage') {
                const availableProducts = Object.keys(APP_STATE.products);
                specsHTML = `
                    <div class="space-y-2">
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Stored Product</label>
                            <select onchange="updateEquipmentParam('${eq.id}', 'product_id', this.value)" class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                <option value="">-- Select Product --</option>
                                ${availableProducts.map(prodId => `<option value="${prodId}" ${eq.params.product_id === prodId ? 'selected' : ''}>${APP_STATE.products[prodId].name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Max Capacity (tons)</label>
                            <input type="number" value="${eq.params.max_capacity_tons || 5000}" onchange="updateEquipmentParam('${eq.id}', 'max_capacity_tons', parseFloat(this.value))" class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                        </div>
                    </div>
                `;
            } else {
                specsHTML = `<div class="text-xs text-gray-400">Basic equipment - no additional specs required</div>`;
            }

            panel.innerHTML = `
                <div class="bg-gray-900 rounded-lg p-4 mb-4">
                    <div class="mb-3">
                        <label class="block text-xs font-semibold text-gray-300 mb-1">Equipment Name</label>
                        <input type="text" value="${eq.name}" onchange="updateEquipmentName('${eq.id}', this.value)" class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm font-semibold">
                    </div>
                    <div class="text-xs text-gray-400 mb-3">Type: ${def.name}</div>
                    ${specsHTML}
                </div>
                <div class="bg-gray-900 rounded-lg p-4">
                    <button onclick="removeFlowEquipment('${eq.id}')" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded text-sm font-semibold">
                        Remove Equipment
                    </button>
                </div>
            `;
        }

        function updateEquipmentParam(equipmentId, paramName, value) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq) return;
            eq.params[paramName] = value;
            saveFlowToLocalStorage(); updateFlowInspector();
        }

        function updateEquipmentName(equipmentId, newName) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq) return;
            eq.name = newName;
            saveFlowToLocalStorage(); renderFlowCanvas(); updateFlowInspector();
        }

        function updateMillProductTPD(equipmentId, productId, tpd) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq || !eq.params.products || !eq.params.products[productId]) return;
            eq.params.products[productId].tpd = tpd;
            saveFlowToLocalStorage();
        }

        function showAddProductToMill(equipmentId) {
            const form = document.getElementById(`addProductForm_${equipmentId}`);
            if (form) form.classList.remove('hidden');
        }

        function cancelAddProductToMill(equipmentId) {
            const form = document.getElementById(`addProductForm_${equipmentId}`);
            if (form) {
                form.classList.add('hidden');
                document.getElementById(`productSelect_${equipmentId}`).value = '';
            }
        }

        function confirmAddProductToMill(equipmentId) {
            const productId = document.getElementById(`productSelect_${equipmentId}`).value;
            if (!productId) { alert('Please select a product'); return; }
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq) return;
            if (!eq.params.products) eq.params.products = {};
            eq.params.products[productId] = { enabled: true, tpd: 0, kwh_per_ton: 0 };
            saveFlowToLocalStorage(); updateFlowInspector();
        }

        function removeProductFromMill(equipmentId, productId) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq || !eq.params.products) return;
            delete eq.params.products[productId];
            saveFlowToLocalStorage(); updateFlowInspector();
        }

        function removeFlowEquipment(id) {
            if (confirm('Remove equipment?')) {
                APP_STATE.flowDesigner.equipment = APP_STATE.flowDesigner.equipment.filter(e => e.id !== id);
                APP_STATE.flowDesigner.connections = APP_STATE.flowDesigner.connections.filter(c => c.from !== id && c.to !== id);
                APP_STATE.flowDesigner.selectedEquipment = null;
                renderFlowCanvas(); updateFlowInspector(); saveFlowToLocalStorage();
            }
        }

        // ============================================
        // RULES OF ENGAGEMENT PANEL
        // ============================================

        function openRulesPanel() {
            const flowInspector = document.getElementById('flowInspectorView');
            const flowRules = document.getElementById('flowRulesView');
            if (flowInspector && flowRules) {
                flowInspector.classList.add('hidden');
                flowRules.classList.remove('hidden');
                renderRulesPanel();
            } else {
                showRulesModal();
            }
        }

        function showRulesModal() {
            const modal = document.createElement('div');
            modal.id = 'rulesModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-purple-600 to-purple-700 text-white px-6 py-4 rounded-t-lg sticky top-0 flex items-center justify-between">
                        <h3 class="text-lg font-semibold">Rules of Engagement</h3>
                        <button onclick="closeRulesModal()" class="text-white hover:text-gray-200 font-bold text-xl">&times;</button>
                    </div>
                    <div class="p-6">
                        <p class="text-gray-600 mb-4">Production planning rules and constraints</p>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p class="text-sm text-blue-900">Rules panel integration loaded.</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeRulesModal() {
            const modal = document.getElementById('rulesModal');
            if (modal) modal.remove();
        }

        function closeRulesPanel() {
            document.getElementById('flowRulesView').classList.add('hidden');
            document.getElementById('flowInspectorView').classList.remove('hidden');
        }

        function renderRulesPanel() {
            const content = document.getElementById('flowRulesContent');
            if (!content) return;
            const cementProducts = Object.keys(APP_STATE.products).filter(p => APP_STATE.products[p].family === 'cementitious');
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-gray-900 rounded-lg p-3 border border-gray-700">
                        <h4 class="text-white font-semibold text-sm mb-3">Operational Rules</h4>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-semibold text-gray-300 mb-1">Campaign Min Length (hrs)</label>
                                <input type="number" id="ruleCampaignMinHours" value="${APP_STATE.rules.operational.campaign_minimum_hours}" min="0" max="168" class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                            </div>
                        </div>
                    </div>
                    <button onclick="saveRules()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded text-sm font-semibold">Save Rules</button>
                </div>
            `;
        }

        function saveRules() {
            const hoursEl = document.getElementById('ruleCampaignMinHours');
            if(hoursEl) APP_STATE.rules.operational.campaign_minimum_hours = parseInt(hoursEl.value) || 24;
            saveToLocalStorage();
            alert('Rules saved successfully!');
        }

        // ============================================
        // TAB 3: DEMAND PLANNING
        // ============================================
        
        function renderDemandPlanningTab() {
            const allProducts = Object.values(APP_STATE.products);
            const products = allProducts.filter(p => p.family === 'cementitious');
            
            if (products.length === 0) {
                return `
                    <div class="p-6">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">No Cement Products Defined</h3>
                            <button onclick="switchTab('products')" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-semibold">Go to Products</button>
                        </div>
                    </div>
                `;
            }
            
            const today = new Date(APP_STATE.currentDate);
            const startDate = new Date(today);
            startDate.setDate(startDate.getDate() - 30);
            const totalDays = 91; 
            
            return `
                <div class="bg-white border-b border-gray-200 px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Demand Planning</h2>
                            <p class="text-sm text-gray-500">Daily demand forecast</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button onclick="exportDemandData()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm font-semibold">Export</button>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    ${renderDemandGrid(products, startDate, totalDays, today)}
                </div>
            `;
        }

        function renderDemandGrid(products, startDate, totalDays, today) {
            const dateHeaders = generateDateHeaders(startDate, totalDays, today);
            return `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-100 border-b-2 border-gray-300">
                                <th class="sticky left-0 bg-gray-100 z-10 px-4 py-3 text-left font-semibold text-gray-700 border-r border-gray-300 min-w-[200px]">Product</th>
                                ${dateHeaders.map(h => `<th class="px-3 py-2 text-center text-xs font-semibold text-gray-600 min-w-[80px] border-l border-gray-200">${h.month} ${h.day}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${products.map(p => `
                                <tr class="border-b border-gray-200 hover:bg-gray-50">
                                    <td class="sticky left-0 bg-white z-10 px-4 py-3 font-semibold border-r border-gray-300">
                                        <div class="flex items-center space-x-2">
                                            <div class="w-3 h-3 rounded-full" style="background-color: ${p.color};"></div>
                                            <span>${p.name}</span>
                                        </div>
                                    </td>
                                    ${dateHeaders.map(h => {
                                        const val = getDemandForDate(p.id, h.dateStr).value || 0;
                                        return `<td class="border-l border-gray-200"><input type="number" value="${val}" class="w-full px-2 py-2 text-center text-sm border-0 bg-transparent focus:ring-2 focus:ring-blue-500" onchange="updateDemandValue('${p.id}', '${h.dateStr}', this.value)"></td>`;
                                    }).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function getDemandForDate(productId, dateStr) {
            if (!APP_STATE.demandPlan || !APP_STATE.demandPlan[productId]) return { value: 0 };
            return APP_STATE.demandPlan[productId][dateStr] || { value: 0 };
        }

        function updateDemandValue(productId, dateStr, value) {
            if (!APP_STATE.demandPlan) APP_STATE.demandPlan = {};
            if (!APP_STATE.demandPlan[productId]) APP_STATE.demandPlan[productId] = {};
            APP_STATE.demandPlan[productId][dateStr] = { value: parseFloat(value) || 0, type: 'forecast' };
            saveToLocalStorage();
        }

        function exportDemandData() {
            const data = { demandPlan: APP_STATE.demandPlan, exportedAt: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `demand_plan_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ============================================
        // TAB 4: PRODUCTION PLAN
        // ============================================
        
        function renderProductionPlanTab() {
            const today = new Date(APP_STATE.currentDate);
            const startDate = new Date(today);
            startDate.setDate(startDate.getDate() - 30);
            const dateHeaders = generateDateHeaders(startDate, 91, today);
            
            return `
                <div class="bg-white border-b border-gray-200 px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Production Plan</h2>
                            <p class="text-sm text-gray-500">Campaign scheduling</p>
                        </div>
                        <button onclick="openRulesPanel()" class="bg-purple-600 text-white px-3 py-2 rounded-lg hover:bg-purple-700 text-sm font-semibold">Rules</button>
                    </div>
                </div>
                <div class="p-6" id="tableScrollContainer" style="overflow-x: auto;">
                    ${renderUnifiedProductionTable(dateHeaders)}
                </div>
            `;
        }

        function renderUnifiedProductionTable(dateHeaders) {
            const kilns = APP_STATE.flowDesigner.equipment.filter(e => e.type === 'kiln');
            const finishMills = APP_STATE.flowDesigner.equipment.filter(e => e.type === 'finish_mill');
            const allEquipment = [...kilns, ...finishMills];
            
            if (allEquipment.length === 0) {
                return `<div class="bg-yellow-50 p-6 text-center text-yellow-800 rounded-lg">No equipment configured.</div>`;
            }
            
            return `
                <table class="w-full border-collapse bg-white border border-gray-200">
                    <thead class="bg-gray-100">
                        <tr class="border-b-2 border-gray-300">
                            <th class="sticky left-0 bg-gray-100 px-4 py-3 text-left font-semibold text-gray-700 border-r min-w-[200px]">Equipment</th>
                            ${dateHeaders.map(h => `<th class="px-2 py-2 text-center text-xs text-gray-600 border-l min-w-[60px]">${h.month} ${h.day}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${allEquipment.map(eq => renderEquipmentDailyRow(eq, dateHeaders)).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderEquipmentDailyRow(equipment, dateHeaders) {
            const campaigns = getCampaignsForEquipment(equipment.id);
            return `
                <tr class="border-b border-gray-200 hover:bg-gray-50 h-10">
                    <td class="sticky left-0 bg-white px-3 py-2 border-r font-semibold text-sm">
                        <div class="flex justify-between items-center">
                            <span>${equipment.name}</span>
                            <button onclick="openCampaignForm('${equipment.id}')" class="text-blue-600 border border-blue-300 rounded px-2 text-xs hover:bg-blue-50">+</button>
                        </div>
                    </td>
                    ${renderCampaignTimeline(equipment, campaigns, dateHeaders)}
                </tr>
            `;
        }

        function renderCampaignTimeline(equipment, campaigns, dateHeaders) {
            const dateMap = {};
            campaigns.forEach(campaign => {
                const startDate = new Date(campaign.startDate + 'T00:00:00');
                const endDate = new Date(campaign.endDate + 'T00:00:00');
                dateHeaders.forEach(header => {
                    const currentDate = new Date(header.dateStr + 'T00:00:00');
                    if (currentDate >= startDate && currentDate <= endDate) dateMap[header.dateStr] = campaign;
                });
            });
            
            let html = '';
            let inCampaign = false;
            let campaignLength = 0;
            let currentCampaign = null;
            
            dateHeaders.forEach((header) => {
                const campaign = dateMap[header.dateStr];
                if (campaign && !inCampaign) {
                    inCampaign = true; campaignLength = 1; currentCampaign = campaign;
                } else if (campaign && inCampaign && campaign.id === currentCampaign.id) {
                    campaignLength++;
                } else if ((!campaign || campaign.id !== currentCampaign?.id) && inCampaign) {
                    html += renderCampaignCell(currentCampaign, campaignLength);
                    inCampaign = false; campaignLength = 0; currentCampaign = null;
                    if (campaign) { inCampaign = true; campaignLength = 1; currentCampaign = campaign; }
                    else html += `<td class="border-l bg-white p-0"></td>`;
                } else {
                    html += `<td class="border-l bg-white p-0"></td>`;
                }
            });
            if (inCampaign) html += renderCampaignCell(currentCampaign, campaignLength);
            return html;
        }

        function renderCampaignCell(campaign, colspan) {
            const bgColor = campaign.type === 'production' ? 'bg-green-500' : 'bg-red-500';
            const name = campaign.productName || campaign.type;
            return `
                <td colspan="${colspan}" class="p-0 h-10">
                    <div onclick="editCampaign('${campaign.id}')" class="${bgColor} text-white cursor-pointer hover:opacity-90 flex items-center justify-between px-2 text-xs font-semibold mx-0.5 rounded h-6">
                        <span>${name}</span>
                        <span class="opacity-75">${colspan}d</span>
                    </div>
                </td>
            `;
        }

        function getCampaignsForEquipment(equipmentId) {
            return APP_STATE.productionPlan.campaigns.filter(c => c.equipmentId === equipmentId);
        }

        function openCampaignForm(equipmentId = null) {
            const equipment = APP_STATE.flowDesigner.equipment;
            const products = Object.values(APP_STATE.products);
            const modal = document.createElement('div');
            modal.id = 'campaignFormModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                    <h3 class="text-lg font-bold mb-4">Create Campaign</h3>
                    <div class="mb-3">
                        <label class="block text-sm font-semibold mb-1">Equipment</label>
                        <select id="campaignEq" class="w-full border rounded px-2 py-1">
                            ${equipment.filter(e => e.type === 'kiln' || e.type === 'finish_mill').map(e => `<option value="${e.id}" ${e.id === equipmentId ? 'selected' : ''}>${e.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-semibold mb-1">Product</label>
                        <select id="campaignProd" class="w-full border rounded px-2 py-1">
                            ${products.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <div>
                            <label class="block text-sm font-semibold mb-1">Start</label>
                            <input type="date" id="campStart" class="w-full border rounded px-2 py-1">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">End</label>
                            <input type="date" id="campEnd" class="w-full border rounded px-2 py-1">
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="document.getElementById('campaignFormModal').remove()" class="flex-1 bg-gray-200 py-2 rounded font-semibold">Cancel</button>
                        <button onclick="saveCampaign()" class="flex-1 bg-blue-600 text-white py-2 rounded font-semibold">Save</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveCampaign() {
            const eqId = document.getElementById('campaignEq').value;
            const prodId = document.getElementById('campaignProd').value;
            const start = document.getElementById('campStart').value;
            const end = document.getElementById('campEnd').value;
            if (!eqId || !prodId || !start || !end) { alert('Fill all fields'); return; }
            APP_STATE.productionPlan.campaigns.push({
                id: 'camp_' + Date.now(), type: 'production', equipmentId: eqId, productId: prodId,
                productName: APP_STATE.products[prodId].name, startDate: start, endDate: end
            });
            saveToLocalStorage();
            document.getElementById('campaignFormModal').remove();
            renderApp();
        }

        function editCampaign(id) {
            const c = APP_STATE.productionPlan.campaigns.find(x => x.id === id);
            if (!c) return;
            if(confirm(`Delete campaign for ${c.productName}?`)) {
                APP_STATE.productionPlan.campaigns = APP_STATE.productionPlan.campaigns.filter(x => x.id !== id);
                saveToLocalStorage();
                renderApp();
            }
        }

        // ============================================
        // TAB 5: MONITOR & INVENTORY
        // ============================================
        function renderMonitorTab() {
            return `
                <div class="p-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Production Monitoring</h3>
                        <p class="text-gray-600 mb-4">Coming soon: Real-time production tracking, inventory levels, and performance analytics</p>
                    </div>
                </div>
            `;
        }

        // ============================================
        // SHARED UTILITY
        // ============================================
        function generateDateHeaders(startDate, totalDays, today) {
            const dateHeaders = [];
            for (let i = 0; i < totalDays; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + i);
                dateHeaders.push({
                    date: date,
                    dateStr: getDateString(date),
                    day: date.getDate(),
                    month: date.toLocaleDateString('en-US', { month: 'short' }),
                    dayName: date.toLocaleDateString('en-US', { weekday: 'short' })
                });
            }
            return dateHeaders;
        }

        // ============================================
        // SAVE/LOAD / DATA MGMT
        // ============================================
        function saveToLocalStorage() {
            try {
                const data = {
                    products: APP_STATE.products,
                    flowDesigner: APP_STATE.flowDesigner,
                    productionPlan: APP_STATE.productionPlan,
                    demandPlan: APP_STATE.demandPlan,
                    inventory: APP_STATE.inventory
                };
                localStorage.setItem('cementPlanner_' + APP_STATE.currentLocation, JSON.stringify(data));
            } catch (e) {}
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('cementPlanner_' + (APP_STATE.currentLocation || 'MIA'));
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.products) APP_STATE.products = data.products;
                    if (data.flowDesigner) APP_STATE.flowDesigner = data.flowDesigner;
                    if (data.productionPlan) APP_STATE.productionPlan = data.productionPlan;
                    if (data.demandPlan) APP_STATE.demandPlan = data.demandPlan;
                    if (data.inventory) APP_STATE.inventory = data.inventory;
                }
            } catch (e) {}
        }

        function showDataManagementMenu() {
            const modal = document.createElement('div');
            modal.id = 'dataManagementModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                    <h3 class="text-lg font-bold mb-4">Data Management</h3>
                    <div class="space-y-3">
                        <button onclick="document.getElementById('dataManagementModal').remove()" class="w-full bg-gray-200 hover:bg-gray-300 py-2 rounded font-semibold">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function resetAllData() {
            if (confirm('WARNING: This will DELETE ALL DATA for this plant! Continue?')) {
                localStorage.removeItem('cementPlanner_' + APP_STATE.currentLocation);
                window.location.reload();
            }
        }

        // Init
        loadFromLocalStorage();
        renderApp();
    </script>
</body>
</html>
