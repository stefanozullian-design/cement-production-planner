<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cement Production Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: #e5e7eb;
        }
        
        /* Product color coding */
        .product-opc { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-left: 4px solid #3b82f6; }
        .product-il11 { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid #f59e0b; }
        .product-il8 { background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); border-left: 4px solid #ec4899; }
        .product-ppc { background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border-left: 4px solid #6366f1; }
        
        .product-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-opc { background: #3b82f6; color: white; }
        .badge-il11 { background: #f59e0b; color: white; }
        .badge-il8 { background: #ec4899; color: white; }
        .badge-ppc { background: #6366f1; color: white; }
        
        .product-card {
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .product-card.selected {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .recipe-ingredient {
            display: grid;
            grid-template-columns: 200px 1fr 100px;
            gap: 12px;
            align-items: center;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .ingredient-slider {
            width: 100%;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .calendar-day {
            min-height: 80px;
            border: 1px solid #e5e7eb;
            padding: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .calendar-day:hover {
            background: #f3f4f6;
            border-color: #3b82f6;
        }
        
        .calendar-day.selected {
            background: #dbeafe;
            border-color: #3b82f6;
            border-width: 2px;
        }
        
        .calendar-day.maintenance {
            background: repeating-linear-gradient(45deg, #fef2f2, #fef2f2 10px, #fee2e2 10px, #fee2e2 20px);
        }
        
        .calendar-day.shutdown {
            background: #f3f4f6;
        }
        
        /* Process Flow Styles */
        .toolbar-item {
            cursor: grab;
            transition: all 0.2s;
        }
        
        .toolbar-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .equipment-node {
            cursor: move;
            transition: all 0.2s;
        }
        
        .equipment-node:hover {
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.3));
        }
        
        .equipment-node.selected {
            filter: drop-shadow(0 0 12px #3b82f6);
        }
        
        .connection-line {
            stroke: #9ca3af;
            stroke-width: 3;
            fill: none;
            cursor: pointer;
        }
        
        .connection-line:hover {
            stroke: #3b82f6;
            stroke-width: 4;
        }
        
        .port {
            cursor: crosshair;
            transition: all 0.2s;
        }
        
        .port:hover {
            r: 8;
            fill: #3b82f6;
        }
        
        .hidden {
            display: none;
        }
        
        /* Sticky scrollbar container - always visible at top */
        .scrollbar-container {
            position: sticky;
            top: 60px; /* Below the sticky date header */
            z-index: 15;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            overflow-x: scroll;
            overflow-y: hidden;
            height: 20px;
        }
        
        .scrollbar-container::-webkit-scrollbar {
            height: 12px;
        }
        
        .scrollbar-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        .scrollbar-container::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 6px;
        }
        
        .scrollbar-container::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        
        /* Force scrollbar to always show */
        .scrollbar-content {
            height: 1px;
        }
    
        
        /* Flow Designer v2 - Selection & Zoom */
        .connection-line {
            stroke: #9ca3af;
            stroke-width: 3;
            fill: none;
            cursor: pointer;
            transition: stroke-width 0.2s;
        }
        
        .connection-line:hover {
            stroke: #3b82f6;
            stroke-width: 5;
        }
        
        .equipment-node {
            cursor: move;
        }
        
        .equipment-node.selected rect {
            filter: drop-shadow(0px 4px 12px rgba(59, 130, 246, 0.6));
        }
        
        .port {
            cursor: pointer;
            transition: r 0.2s;
        }
        
        .port:hover {
            r: 8;
        }
        
        #flowCanvas {
            cursor: crosshair;
        }
        </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <!-- Product Recipe Modal -->
    <div id="recipeModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-3xl border border-gray-200 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-900" id="recipeModalTitle">Edit Product Recipe</h3>
                <button onclick="closeRecipeModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="recipeModalContent"></div>
            <div class="flex justify-end space-x-2 mt-6">
                <button onclick="closeRecipeModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded">Cancel</button>
                <button onclick="saveRecipe()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Save Recipe</button>
            </div>
        </div>
    </div>

    <!-- Production Day Modal -->
    <div id="dayModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl border border-gray-200 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-900" id="dayModalTitle">Edit Production Day</h3>
                <button onclick="closeDayModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="dayModalContent"></div>
            <div class="flex justify-end space-x-2 mt-6">
                <button onclick="closeDayModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded">Cancel</button>
                <button onclick="saveDayPlan()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        console.log('=== CEMENT PLANNER STARTING ===');
        
        // ============================================
        // GLOBAL STATE
        // ============================================
        
        console.log('Initializing APP_STATE...');
        
        // ============================================
        // CEMEX FLORIDA REGION - LOCATIONS
        // ============================================
        const CEMEX_LOCATIONS = {
            'MIA': { code: 'MIA', name: 'Miami Plant',           type: 'plant',    icon: 'üè≠', color: '#1d4ed8', bg: '#eff6ff' },
            'BRS': { code: 'BRS', name: 'Brooksville Plant',     type: 'plant',    icon: 'üè≠', color: '#15803d', bg: '#f0fdf4' },
            'PEV': { code: 'PEV', name: 'Port Everglades',       type: 'terminal', icon: 'üö¢', color: '#0e7490', bg: '#ecfeff' },
            'WPB': { code: 'WPB', name: 'West Palm Beach',       type: 'terminal', icon: 'üö¢', color: '#0369a1', bg: '#f0f9ff' },
            'ORL': { code: 'ORL', name: 'Orlando Terminal',      type: 'terminal', icon: 'üöÇ', color: '#7c3aed', bg: '#f5f3ff' },
            'SUB': { code: 'SUB', name: 'Sutton Terminal',       type: 'terminal', icon: 'üöÇ', color: '#b45309', bg: '#fffbeb' },
            'JAX': { code: 'JAX', name: 'Jacksonville Terminal', type: 'terminal', icon: 'üöÇ', color: '#9f1239', bg: '#fff1f2' }
        };

        // ============================================
        // DATA MODEL FOUNDATION (v1 - multi-region ready)
        // ============================================
        const DATA_MODEL = {
            version: '0.3.0',
            hierarchy: {
                countryRegionFacility: true,
                defaultCountryCode: 'USA'
            },
            tables: {
                region: ['region_id','region_code','region_name','country_code','active'],
                facility_type: ['facility_type_id','facility_type_code','facility_type_name','active'],
                facility: ['facility_id','facility_code','facility_name','facility_type_id','region_id','sap_code','active'],
                product: ['product_id','product_code','product_name','product_category','uom_mass','landed_cost_usd_per_stn','calorific_power_mmbtu_per_stn','co2_factor_kgco2_per_mmbtu','active'],
                recipe_header: ['recipe_id','output_product_id','version_no','effective_start','effective_end','active'],
                recipe_component: ['recipe_line_id','recipe_id','component_product_id','pct_of_output'],
                customer: ['customer_id','customer_code','customer_name','active'],
                equipment: ['equipment_id','equipment_code','equipment_name','equipment_type_id','facility_id','active'],
                storage_unit: ['storage_unit_id','storage_code','storage_name','storage_type','facility_id','min_capacity','max_capacity','active'],
                connection: ['connection_id','from_node_type','from_node_id','to_node_type','to_node_id','active'],
                connection_allowed_material: ['id','connection_id','material_or_product_code'],
                rule: ['rule_id','rule_key','rule_name','rule_type','enabled','country_code','region_id','facility_id','equipment_id','storage_unit_id','param_num','param_text','param_bool'],
                scenario: ['scenario_id','scenario_type','scenario_owner','base_official_snapshot_at','active'],
                publish_log: ['id','domain','date_from','date_to','published_by','published_at','note']
            },
            nodeTypes: ['facility','equipment','storage_unit','transfer_point','loadout'],
            scenarioTypes: ['OFFICIAL','SANDBOX']
        };

        const APP_STATE = {
            currentTab: 'products',
            currentDate: new Date(),
            currentLocation: localStorage.getItem('cemex_current_location') || 'MIA',
            currentUser: localStorage.getItem('cementPlanner_currentUser') || 'local_user',
            dataModelVersion: DATA_MODEL.version,
            scenarioContext: {
                activeDomain: 'plan',
                viewMode: 'sandbox', // 'official' | 'sandbox'
                officialStorage: {
                    type: 'sharepoint_file',
                    path: localStorage.getItem('cementPlanner_official_path') || '',
                    configured: false
                },
                sandboxStorage: {
                    type: 'local_file',
                    preferredPath: localStorage.getItem('cementPlanner_sandbox_path') || ''
                },
                sandboxMeta: {
                    owner: localStorage.getItem('cementPlanner_currentUser') || 'local_user',
                    lastClonedFromOfficialAt: null,
                    dirtyDomains: { actuals: false, demand: false, plan: false, masters: false }
                }
            },
            orgStructure: {
                countries: [{ code: 'USA', name: 'United States', active: true }],
                regions: [{ id: 'FL', code: 'FL', name: 'Florida', countryCode: 'USA', active: true }],
                facilityTypes: [
                    { id: 'plant', code: 'PLANT', name: 'Plant', active: true },
                    { id: 'terminal', code: 'TERMINAL', name: 'Terminal', active: true }
                ]
            },
            networkMap: {
                nodes: [],
                connections: [],
                allowedByConnection: []
            },
            rulesBook: {
                scopedRules: [],
                resolutionMode: 'most_specific_match'
            },
            
            // Product Definitions
            products: {
                opc: {
                    id: 'opc',
                    code: 'OPC',
                    name: 'OPC (Ordinary Portland Cement)',
                    recipe: {
                        clinker: 95,
                        gypsum: 5,
                        limestone: 0,
                        fly_ash: 0,
                        slag: 0,
                        pozzolana: 0,
                        additives: 0
                    },
                    uomMass: 'STn',
                    landedCostUsdPerStn: '',
                    color: '#3b82f6'
                },
                il11: {
                    id: 'il11',
                    code: 'IL11',
                    name: 'IL(11) - Portland Limestone Cement',
                    recipe: {
                        clinker: 84,
                        gypsum: 5,
                        limestone: 11,
                        fly_ash: 0,
                        slag: 0,
                        pozzolana: 0,
                        additives: 0
                    },
                    uomMass: 'STn',
                    landedCostUsdPerStn: '',
                    color: '#f59e0b'
                }
            },
            
            // Equipment in process flow
            flowDesigner: {
                equipment: [],
                connections: [],
                nextId: 1,
                selectedEquipment: null,
                connecting: null,
                zoom: 1,
                panX: 0,
                panY: 0,
                selection: { active: false, startX: 0, startY: 0, endX: 0, endY: 0 },
                selectedIds: []
            },
            
            // Rules of Engagement for simulation
            rules: {
                // System rules (hardcoded, cannot be changed)
                system: {
                    silo_single_product: true,
                    equipment_single_product: true,
                    inventory_non_negative: true,
                    recipe_adherence: true,
                    silo_capacity_limits: true
                },
                // Operational rules (user-configurable)
                operational: {
                    clinker_shortage_response: 'stop_mills_sequential', // 'stop_mills_sequential', 'stop_all_immediately', 'reduce_production'
                    campaign_minimum_hours: 24, // Minimum hours a mill must run on one product
                    changeover_time_hours: 0, // Hours needed to switch products (0 = instant)
                    default_operating_mode: '24/7', // '24/7' or 'shifts'
                    product_priorities: {}, // { product_id: priority_number } - lower number = higher priority
                    allow_mid_campaign_switch: false, // Can mills switch products before minimum campaign length?
                    inventory_safety_factor: 1.1 // Multiplier for minimum inventory thresholds
                },
                // Holidays / Non-working days
                holidays: []  // Array of date strings in YYYY-MM-DD format
            },
            
            // Production Plan (campaigns & inventory tracking)
            productionPlan: {
                campaigns: [],           // All campaigns
                inventoryHistory: {},    // Historical inventory data
                campaignTemplates: []    // Saved campaign templates
            },
            
            // Campaigns (by equipment)
            campaigns: {
                // Format: { equipment_id: [ { id, start, duration, status, product, tpd, reason } ] }
                // Example: 'kiln_1': [ { id: 'c1', start: 0, duration: 15, status: 'active', tpd: 2000 } ]
            },
            
            // Demand Plan (by product, by date)
            demandPlan: {
                // Format: { product_id: { 'YYYY-MM-DD': { value: 1500, type: 'actual|forecast' } } }
            },
            
            // Demand Planning UI state
            demandPlanning: {
                collapsedMonths: [] // Array of 'YYYY-MM' strings for collapsed months
            },
            
            // Inventory tracking (by silo, by product, by date)
            inventory: {
                // Format: { silo_id: { product_id: { 'YYYY-MM-DD': beginning_inventory_tons } } }
            },
            
            // Daily actuals capture (yesterday form)
            actuals: {
                production: [], // [{date, facilityId, equipmentId, productId, quantityStn}]
                shipments: [],  // [{date, facilityId, productId, quantityStn, type:'customer'}]
                inventoryEOD: [] // [{date, facilityId, storageId, productId, endingInventoryStn}]
            },
            
            // Current view year/month for production plan
            planView: {
                year: 2025,
                month: 2 // February
            }
        };

        // Equipment type definitions for Process Flow
        const EQUIPMENT_TYPES = {
            raw_material: {
                name: 'Raw Material',
                color: '#84cc16',
                // icon: 'ü™®',
                width: 30,
                height: 30,
                outputs: ['raw_material'],
                inputs: [],
                defaultParams: { supply_rate: 3000, cost_per_ton: 30, material_name: 'Limestone' }
            },
            fuel: {
                name: 'Fuel',
                color: '#18181b',
                // icon: '‚ö´',
                width: 30,
                height: 30,
                outputs: ['fuel'],
                inputs: [],
                defaultParams: { supply_rate: 500, gcal_per_ton: 6000, cost_per_ton: 80, fuel_name: 'Coal' }
            },
            unloading: {
                name: 'Unloading',
                color: '#f97316',
                // icon: 'üèóÔ∏è',
                width: 30,
                height: 30,
                inputs: ['raw_material', 'fuel'],
                outputs: ['raw_material', 'fuel'],
                defaultParams: { 
                    unloading_rate: 500,
                    material_type: 'Raw Material'
                }
            },
            raw_mill: {
                name: 'Raw Mill',
                color: '#dc2626',
                // icon: '‚öôÔ∏è',
                width: 30,
                height: 30,
                inputs: ['raw_material'],
                outputs: ['raw_meal'],
                defaultParams: { nominal_tph: 120, hours: 22, utilization: 0.85, efficiency: 0.95, products: {} }
            },
            kiln: {
                name: 'Kiln',
                color: '#ea580c',
                // icon: 'üî•',
                width: 30,
                height: 30,
                inputs: ['raw_meal', 'fuel'],
                outputs: ['clinker'],
                defaultParams: { 
                    products: {},
                    rm_to_clinker_factor: 1.55
                }
            },
            storage: {
                name: 'Storage',
                color: '#6b7280',
                // icon: 'üè∫',
                width: 30,
                height: 30,
                inputs: ['raw_material', 'fuel', 'clinker', 'cement', 'raw_meal'],
                outputs: ['raw_material', 'fuel', 'clinker', 'cement', 'raw_meal'],
                defaultParams: { 
                    min_volume: 2000,
                    max_volume: 15000,
                    material_type: 'Clinker' 
                }
            },
            finish_mill: {
                name: 'Finish Mill',
                color: '#3b82f6',
                // icon: 'üîß',
                width: 30,
                height: 30,
                inputs: ['clinker'],
                outputs: ['cement'],
                defaultParams: { 
                    products: {} // Will store product_id: { enabled: true, tpd: 1800 }
                }
            },
            packing: {
                name: 'Packing',
                color: '#eab308',
                // icon: 'üì¶',
                width: 30,
                height: 30,
                inputs: ['cement'],
                outputs: ['packed'],
                defaultParams: { 
                    product: '',
                    pallets_per_hour: 100,
                    hours_operation: 18
                }
            },
            loadout: {
                name: 'Loadout',
                color: '#8b5cf6',
                // icon: 'üöö',
                width: 30,
                height: 30,
                inputs: ['cement', 'packed'],
                outputs: [],
                defaultParams: { 
                    loads_per_hour: 4,  // 4 loads/hour √ó 25 tons = 100 TPH
                    hours_operation: 16  // Default 16 hours/day
                }
            }
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function formatNumber(num) {
            return Math.round(num).toLocaleString();
        }

        function adjustColor(color, amount) {
            const num = parseInt(color.replace('#', ''), 16);
            const r = Math.max(0, Math.min(255, (num >> 16) + amount));
            const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
            const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
            return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
        }

        function getDateString(date) {
            return date.toISOString().split('T')[0];
        }

        function parseDate(dateStr) {
            return new Date(dateStr + 'T12:00:00'); // Noon to avoid timezone issues
        }

        // ============================================
        // MAIN RENDER
        // ============================================
        
        function renderApp() {
            const app = document.getElementById('app');
            
            let content = '';
            content += renderHeader();
            content += renderNavTabs();
            
            switch (APP_STATE.currentTab) {
                case 'products':
                    content += renderProductsTab();
                    break;
                case 'flow':
                    content += renderFlowDesignerTab();
                    break;
                case 'demand':
                    content += renderDemandPlanningTab();
                    break;
                case 'plan':
                    content += renderProductionPlanTab();
                    break;
                case 'monitor':
                    content += renderMonitorTab();
                    break;
            }
            
            app.innerHTML = content;
            
            // Initialize tab-specific functionality
            if (APP_STATE.currentTab === 'flow') {
                initializeFlowDesigner();
            }
            
            if (APP_STATE.currentTab === 'plan') {
                initializeProductionPlanScrollSync();
            }
        }
        
        function initializeProductionPlanScrollSync() {
            const topScrollbar = document.getElementById('topScrollbar');
            const tableContainer = document.getElementById('tableScrollContainer');
            const topScrollbarContent = document.getElementById('topScrollbarContent');
            
            if (!topScrollbar || !tableContainer || !topScrollbarContent) return;
            
            // Set scrollbar content width to match table width
            const table = tableContainer.querySelector('table');
            if (table) {
                topScrollbarContent.style.width = table.scrollWidth + 'px';
            }
            
            // Sync top scrollbar with table scroll
            topScrollbar.addEventListener('scroll', function() {
                tableContainer.scrollLeft = topScrollbar.scrollLeft;
            });
            
            // Sync table scroll with top scrollbar
            tableContainer.addEventListener('scroll', function() {
                topScrollbar.scrollLeft = tableContainer.scrollLeft;
            });
        }

        // ============================================
        // HEADER
        // ============================================
        
        function renderHeader() {
            const loc = CEMEX_LOCATIONS[APP_STATE.currentLocation] || CEMEX_LOCATIONS['MIA'];
            const isPlant = loc.type === 'plant';
            return `
                <div class="border-b border-gray-200 shadow-sm" style="background:white;">
                    <!-- TOP BAR: Location identifier & switcher -->
                    <div class="px-6 py-2 flex items-center justify-between" style="background:${loc.color}; color:white;">
                        <div class="flex items-center space-x-2 text-sm font-medium">
                            <span class="font-bold text-white text-base tracking-wide">CEMEX</span>
                            <span class="opacity-60">‚Ä∫</span>
                            <span class="opacity-90">Florida Region</span>
                            <span class="opacity-60">‚Ä∫</span>
                            <span class="font-bold">${loc.icon} ${loc.name}</span>
                            <span class="ml-2 px-2 py-0.5 rounded text-xs font-bold" style="background:rgba(255,255,255,0.25)">${loc.code}</span>
                            <span class="px-2 py-0.5 rounded text-xs" style="background:rgba(255,255,255,0.15)">${isPlant ? 'üè≠ Plant' : 'üì¶ Terminal'}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs opacity-75">Switch:</span>
                            ${Object.values(CEMEX_LOCATIONS).map(l => `
                                <button onclick="switchLocation('${l.code}')"
                                        title="${l.name}"
                                        class="px-2 py-0.5 rounded text-xs font-bold transition-all ${l.code === APP_STATE.currentLocation
                                            ? 'bg-white text-gray-800 shadow'
                                            : 'text-white opacity-60 hover:opacity-100'
                                        }">
                                    ${l.icon} ${l.code}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    <!-- BOTTOM BAR: App title + date -->
                    <div class="px-6 py-3 flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="p-2 rounded-lg text-white" style="background:${loc.color}">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                            </div>
                            <div>
                                <h1 class="text-lg font-bold text-gray-900">FANO Version - Production Planning System</h1>
                                <p class="text-xs text-gray-400">Configure ‚Üí Design ‚Üí Plan ‚Üí Monitor</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="text-right">
                                <div class="text-xs text-gray-400">Today</div>
                                <div class="text-sm font-bold text-gray-900">${APP_STATE.currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>
                            </div>
                            <button onclick="resetAllData()" class="bg-red-600 text-white px-3 py-1.5 rounded-lg text-sm hover:bg-red-700" title="Clear all data for this plant">
                                üóëÔ∏è Reset
                            </button>
                            <button onclick="showDataManagementMenu()" class="text-white px-3 py-1.5 rounded-lg text-sm" style="background:${loc.color}">
                                üìÅ Data
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function switchLocation(code) {
            if (!CEMEX_LOCATIONS[code]) return;
            if (code === APP_STATE.currentLocation) return;

            // Save current location data first
            saveToLocalStorage();

            // Switch location
            APP_STATE.currentLocation = code;
            localStorage.setItem('cemex_current_location', code);

            // Reset state for new location (keep UI state)
            APP_STATE.products = {};
            APP_STATE.flowDesigner = { equipment: [], connections: [], nextId: 1 };
            APP_STATE.productionPlan = { 
                campaigns: [],           // ‚Üê ARRAY, not object!
                inventoryHistory: {},
                campaignTemplates: []
            };
            APP_STATE.demandPlan = {};
            APP_STATE.inventory = {};
            APP_STATE.currentTab = 'products';

            // Load new location's data
            loadFromLocalStorage();
            if (typeof migrateEquipmentIdsIfNeeded === "function") { migrateEquipmentIdsIfNeeded(); }
            renderApp();
        }

        // ============================================
        // NAVIGATION
        // ============================================
        
        function renderNavTabs() {
            const tabs = [
                { id: 'products', label: '1. Products & Recipes', icon: 'üìã' },
                { id: 'flow', label: '2. Process Flow', icon: 'üè≠' },
                { id: 'demand', label: '3. Demand Planning', icon: 'üìà' },
                { id: 'plan', label: '4. Production Plan', icon: 'üìÖ' },
                { id: 'monitor', label: '5. Monitor & Inventory', icon: 'üìä' }
            ];
            
            return `
                <div class="bg-white border-b border-gray-200">
                    <div class="px-6">
                        <nav class="flex space-x-2">
                            ${tabs.map(tab => `
                                <button 
                                    onclick="switchTab('${tab.id}')"
                                    class="border-b-2 ${APP_STATE.currentTab === tab.id ? 'border-blue-600 text-blue-600 bg-blue-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'} py-3 px-4 font-semibold text-sm transition-colors rounded-t"
                                >
                                    <span class="mr-2">${tab.icon}</span>${tab.label}
                                </button>
                            `).join('')}
                        </nav>
                    </div>
                </div>
            `;
        }

        function switchTab(tabId) {
            APP_STATE.currentTab = tabId;
            renderApp();
        }

        // ============================================
        // GLOBAL RAW MATERIALS LIST
        // ============================================
        
        if (!window.AVAILABLE_RAW_MATERIALS) {
            window.AVAILABLE_RAW_MATERIALS = [
                'Clinker',
                'Gypsum',
                'Limestone',
                'Fly Ash',
                'Slag',
                'Pozzolana',
                'Silica Fume',
                'Rice Husk Ash',
                'Metakaolin'
            ];
        }

        // ============================================
        // TAB 1: PRODUCTS & RECIPES
        // ============================================
        
        function renderProductsTab() {
            const products = Object.values(APP_STATE.products);

            // Group products by NEW family structure
            const groups = {
                'raw_materials': { 
                    label: 'ü™® Raw Materials', 
                    subtitle: 'Base materials (inputs)', 
                    color: '#78716c', 
                    bg: '#f5f5f4', 
                    border: '#a8a29e', 
                    products: [],
                    hasRecipe: false
                },
                'fuels': { 
                    label: '‚õΩ Fuels', 
                    subtitle: 'Energy sources', 
                    color: '#dc2626', 
                    bg: '#fef2f2', 
                    border: '#fca5a5', 
                    products: [],
                    hasRecipe: false
                },
                'intermediate': { 
                    label: 'üî• Intermediate Products', 
                    subtitle: 'Clinkers (made from raw materials)', 
                    color: '#ea580c', 
                    bg: '#fff7ed', 
                    border: '#fdba74', 
                    products: [],
                    hasRecipe: true,
                    recipeFrom: ['raw_materials']
                },
                'cementitious': { 
                    label: 'üèóÔ∏è Cementitious Products', 
                    subtitle: 'Final products (sold)', 
                    color: '#2563eb', 
                    bg: '#eff6ff', 
                    border: '#93c5fd', 
                    products: [],
                    hasRecipe: true,
                    recipeFrom: ['intermediate', 'raw_materials']
                }
            };

            products.forEach(p => {
                const fam = p.family || 'cementitious';
                if (groups[fam]) groups[fam].products.push(p);
                else groups['cementitious'].products.push(p);
            });

            return `
                <div class="p-4">
                    <div class="mb-4 flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Materials, Products & Recipes</h2>
                            <p class="text-gray-500 text-xs mt-0.5">Define Raw Materials, Fuels, Intermediate Products, and Finished Products</p>
                        </div>
                        <button onclick="addNewProduct()" class="bg-green-600 text-white px-3 py-1.5 rounded-lg hover:bg-green-700 flex items-center space-x-1 text-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            <span>Add Product</span>
                        </button>
                    </div>
                    
                    <div class="mb-4 bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-blue-900">
                        <div class="font-semibold mb-1">Recommended setup order for a new site</div>
                        <div>1) Define Raw Materials / Fuels / Intermediate / Finished Products  ‚Üí  2) Define Recipes  ‚Üí  3) Go to <b>Process Flow</b> to add equipment and connections.</div>
                        <div class="text-xs mt-1 text-blue-700">US default units in forms: mass in <b>STn</b>, cost in <b>USD/STn</b>, fuel heat in <b>MMBTU/STn</b>.</div>
                    </div>

                    <!-- 4 COLUMNS SIDE BY SIDE -->
                    <div class="grid grid-cols-4 gap-4">
                        ${Object.entries(groups).map(([key, group]) => `
                            <div class="border-2 rounded-lg p-3" style="border-color: ${group.border}; background: ${group.bg};">
                                <!-- Column Header -->
                                <div class="mb-3 pb-2 border-b-2" style="border-color: ${group.border};">
                                    <div class="font-bold text-sm mb-1" style="color: ${group.color};">${group.label}</div>
                                    <div class="text-xs text-gray-500 mb-2">${group.subtitle}</div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs font-semibold px-2 py-0.5 rounded-full text-white" style="background:${group.color};">
                                            ${group.products.length} items
                                        </span>
                                        <button onclick="addNewProductOfFamily('${key}')" 
                                                class="text-xs px-2 py-1 rounded border font-semibold hover:opacity-80"
                                                style="color:${group.color}; border-color:${group.color};">
                                            + Add
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Products List -->
                                <div class="space-y-2 max-h-[600px] overflow-y-auto">
                                    ${group.products.length === 0 ? `
                                        <div class="text-xs text-gray-400 italic py-2">No items yet</div>
                                    ` : `
                                        ${group.products.map(p => renderProductCardCompact(p, group, key)).join('')}
                                    `}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderProductCardCompact(product, group, familyKey) {
            const recipeItems = Object.entries(product.recipe || {});
            const totalPercentage = recipeItems.reduce((sum, [mat, pct]) => sum + pct, 0);
            const isValid = recipeItems.length === 0 || Math.abs(totalPercentage - 100) < 0.1;
            const hasRecipe = group.hasRecipe;
            
            return `
                <div class="bg-white rounded border p-2 hover:shadow-md transition-shadow cursor-pointer"
                     style="border-color: ${group.border};"
                     onclick="editProduct('${product.id}')">
                    <!-- Product Name -->
                    <div class="flex items-center justify-between mb-1">
                        <span class="font-semibold text-xs text-gray-900 truncate flex-1" title="${product.name}">
                            ${product.name}
                        </span>
                        <button onclick="event.stopPropagation(); deleteProduct('${product.id}')" 
                                class="text-red-400 hover:text-red-600 p-0.5 rounded flex-shrink-0">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="text-[11px] text-gray-500 mb-1">Code: <span class="font-mono">${product.code || product.id || '-'}</span></div>
                    <!-- Color Indicator -->
                    <div class="flex items-center space-x-1 mb-1">
                        <div class="w-3 h-3 rounded-full border" style="background: ${product.color || '#gray'}; border-color: ${group.border};"></div>
                        <span class="text-xs text-gray-500">${product.color || 'No color'}</span>
                    </div>
                    
                    ${product.landedCostUsdPerStn !== undefined && product.landedCostUsdPerStn !== '' ? `
                        <div class="text-[11px] text-gray-600 mt-1">Landed Cost: <span class="font-semibold">USD/STn ${Number(product.landedCostUsdPerStn).toFixed(2)}</span></div>
                    ` : ''}
                    ${product.family === 'fuels' ? `
                        <div class="text-[11px] text-gray-600 mt-1">Heat: <span class="font-semibold">${product.calorificPowerMMBTUPerStn ?? ''} MMBTU/STn</span></div>
                    ` : ''}
                    <!-- Recipe Summary (if applicable) -->
                    ${hasRecipe ? `
                        <div class="mt-2 pt-2 border-t" style="border-color: ${group.border};">
                            ${recipeItems.length === 0 ? `
                                <div class="text-xs text-gray-400 italic">No recipe</div>
                            ` : `
                                <div class="text-xs space-y-0.5">
                                    ${recipeItems.slice(0, 3).map(([material, pct]) => `
                                        <div class="flex justify-between">
                                            <span class="text-gray-600 truncate">${material}</span>
                                            <span class="text-gray-900 font-semibold ml-1">${pct}%</span>
                                        </div>
                                    `).join('')}
                                    ${recipeItems.length > 3 ? `
                                        <div class="text-gray-400 italic">+${recipeItems.length - 3} more...</div>
                                    ` : ''}
                                    <div class="flex justify-between pt-1 border-t font-semibold ${isValid ? 'text-green-600' : 'text-red-600'}">
                                        <span>Total:</span>
                                        <span>${totalPercentage.toFixed(1)}%</span>
                                    </div>
                                </div>
                            `}
                        </div>
                    ` : ''}
                </div>
            `;
        }


        function addNewProduct() {
            const productName = prompt('Enter product name:');
            if (!productName) return;
            
            const productId = productName.toLowerCase().replace(/[^a-z0-9]/g, '_');
            
            if (APP_STATE.products[productId]) {
                alert('Product with this name already exists!');
                return;
            }
            
            APP_STATE.products[productId] = {
                id: productId,
                name: productName,
                family: 'cementitious', // Default to cementitious
                recipe: {},
                color: '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')
            };
            
            saveToLocalStorage();
            renderApp();
        }
        
        function updateProductFamily(productId, newFamily) {
            const product = APP_STATE.products[productId];
            if (!product) return;
            
            product.family = newFamily;
            
            // Clear recipe when changing to families without recipes
            if (newFamily === 'raw_materials' || newFamily === 'fuels') {
                product.recipe = {};
            }
            
            saveToLocalStorage();
            renderApp();
        }
        
        function getAvailableRecipeMaterials(family) {
            const allProducts = Object.values(APP_STATE.products);
            
            if (family === 'intermediate') {
                // Intermediate products can only use raw materials
                return allProducts.filter(p => p.family === 'raw_materials');
            } else if (family === 'cementitious') {
                // Cementitious products can use intermediate + raw materials
                return allProducts.filter(p => p.family === 'intermediate' || p.family === 'raw_materials');
            }
            
            return [];
        }

        function addNewProductOfFamily(family) {
            const familyLabels = {
                'raw_materials': 'Raw Material (e.g., Limestone, Gypsum, Fly Ash)',
                'fuels': 'Fuel (e.g., Coal, Natural Gas, Pet Coke)',
                'intermediate': 'Intermediate Product (e.g., Gray Clinker, White Clinker)',
                'cementitious': 'Cementitious Product (e.g., OPC Type I, IL-11, Slag)'
            };
            
            const productName = prompt(`Enter ${familyLabels[family]} name:`);
            if (!productName) return;
            
            const productId = productName.toLowerCase().replace(/[^a-z0-9]/g, '_');
            
            if (APP_STATE.products[productId]) {
                alert('Product with this name already exists!');
                return;
            }
            
            APP_STATE.products[productId] = {
                id: productId,
                code: productId.toUpperCase(),
                name: productName,
                family: family,
                recipe: {},
                uomMass: 'STn',
                landedCostUsdPerStn: '',
                calorificPowerMMBTUPerStn: '',
                co2FactorKgCO2PerMMBTU: '',
                color: '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')
            };
            
            saveToLocalStorage();
            renderApp();
        }
        
        function editProduct(productId) {
            const product = APP_STATE.products[productId];
            if (!product) return;
            
            const hasRecipe = product.family === 'intermediate' || product.family === 'cementitious';
            const availableMaterials = hasRecipe ? getAvailableRecipeMaterials(product.family) : [];
            
            const modal = document.createElement('div');
            modal.id = 'editProductModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-4 rounded-t-lg sticky top-0">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold">‚úèÔ∏è Edit Material/Product: ${product.name}</h3>
                            <button onclick="closeEditProductModal()" class="text-white hover:text-gray-200">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <!-- Product Name -->
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Product Name</label>
                            <input type="text" id="editProductName" value="${product.name}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        
                        <!-- Product Code -->
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Code</label>
                            <input type="text" id="editProductCode" value="${product.code || product.id || ''}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono"
                                   placeholder="e.g. CLK, OPC12, FA, PETCOKE">
                        </div>

                        <!-- Family -->
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                            <select id="editProductFamily" class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                    onchange="updateRecipeEditorVisibility()">
                                <option value="raw_materials" ${product.family === 'raw_materials' ? 'selected' : ''}>Raw Materials</option>
                                <option value="fuels" ${product.family === 'fuels' ? 'selected' : ''}>Fuels</option>
                                <option value="intermediate" ${product.family === 'intermediate' ? 'selected' : ''}>Intermediate Products</option>
                                <option value="cementitious" ${product.family === 'cementitious' ? 'selected' : ''} >Finished Products</option>
                            </select>
                        </div>
                        
                        <!-- Color -->
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Color</label>
                            <div class="flex items-center space-x-2">
                                <input type="color" id="editProductColor" value="${product.color || '#3b82f6'}"
                                       class="h-10 w-20 border border-gray-300 rounded cursor-pointer">
                                <input type="text" id="editProductColorHex" value="${product.color || '#3b82f6'}"
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg font-mono text-sm"
                                       onchange="document.getElementById('editProductColor').value = this.value">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Mass Unit (display)</label>
                                <select id="editProductUomMass" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="STn" ${(product.uomMass||'STn')==='STn'?'selected':''}>STn (Short Tons)</option>
                                    <option value="MT" ${(product.uomMass||'STn')==='MT'?'selected':''}>MT (Metric Tons)</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">US default in forms: STn</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Landed Cost (USD/STn)</label>
                                <input type="number" id="editLandedCostUsdPerStn" value="${product.landedCostUsdPerStn ?? ''}" step="0.01" min="0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="e.g. 42.50">
                            </div>
                        </div>

                        <div id="fuelFields" class="mb-4 ${product.family === 'fuels' ? '' : 'hidden'}">
                            <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                                <div class="font-semibold text-sm text-amber-900 mb-3">Fuel Properties</div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Calorific Power (MMBTU/STn)</label>
                                        <input type="number" id="editFuelCalorific" value="${product.calorificPowerMMBTUPerStn ?? ''}" step="0.001" min="0"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">CO‚ÇÇ Factor (kgCO2/MMBTU)</label>
                                        <input type="number" id="editFuelCO2Factor" value="${product.co2FactorKgCO2PerMMBTU ?? ''}" step="0.001" min="0"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recipe Editor (for intermediate and finished products only) -->
                        <div id="recipeEditor" style="display: ${hasRecipe ? 'block' : 'none'};">
                            <div class="mb-4 bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <label class="text-sm font-semibold text-gray-700">Recipe (must total 100%)</label>
                                    <span id="recipeTotal" class="text-sm font-bold">0%</span>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-600 mb-1">Recipe Effective Start</label>
                                        <input type="date" id="editRecipeEffectiveStart" value="${product.recipeEffectiveStart || ''}" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-600 mb-1">Recipe Effective End</label>
                                        <input type="date" id="editRecipeEffectiveEnd" value="${product.recipeEffectiveEnd || ''}" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                    </div>
                                </div>
                                
                                <div id="recipeItems" class="space-y-2 mb-3">
                                    ${Object.entries(product.recipe || {}).map(([material, pct]) => `
                                        <div class="flex items-center space-x-2">
                                            <input type="text" value="${material}" readonly
                                                   class="flex-1 px-2 py-1 border border-gray-300 rounded bg-gray-100 text-sm">
                                            <input type="number" value="${pct}" step="0.1" min="0" max="100"
                                                   class="w-20 px-2 py-1 border border-gray-300 rounded text-sm"
                                                   onchange="updateRecipeTotal()">
                                            <button onclick="this.parentElement.remove(); updateRecipeTotal();"
                                                    class="text-red-500 hover:text-red-700 p-1">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <div class="flex items-center space-x-2">
                                    <select id="newRecipeMaterial" class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm">
                                        <option value="">Select material...</option>
                                        ${availableMaterials.map(m => `
                                            <option value="${m.name}">${m.name} (${m.family})</option>
                                        `).join('')}
                                    </select>
                                    <button onclick="addRecipeItem()" 
                                            class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                        + Add
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex space-x-3">
                            <button onclick="closeEditProductModal()" 
                                    class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-lg font-semibold">
                                Cancel
                            </button>
                            <button onclick="saveProductEdits('${productId}')" 
                                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold">
                                Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Sync color inputs
            document.getElementById('editProductColor').addEventListener('change', function() {
                document.getElementById('editProductColorHex').value = this.value;
            });
            
            updateRecipeTotal();
        }
        
        function updateRecipeEditorVisibility() {
            const family = document.getElementById('editProductFamily').value;
            const hasRecipe = family === 'intermediate' || family === 'cementitious';
            document.getElementById('recipeEditor').style.display = hasRecipe ? 'block' : 'none';
            const fuelBox = document.getElementById('fuelFields');
            if (fuelBox) fuelBox.classList.toggle('hidden', family !== 'fuels');
        }
        
        function addRecipeItem() {
            const material = document.getElementById('newRecipeMaterial').value;
            if (!material) return;
            
            const recipeItems = document.getElementById('recipeItems');
            const newItem = document.createElement('div');
            newItem.className = 'flex items-center space-x-2';
            newItem.innerHTML = `
                <input type="text" value="${material}" readonly
                       class="flex-1 px-2 py-1 border border-gray-300 rounded bg-gray-100 text-sm">
                <input type="number" value="0" step="0.1" min="0" max="100"
                       class="w-20 px-2 py-1 border border-gray-300 rounded text-sm"
                       onchange="updateRecipeTotal()">
                <button onclick="this.parentElement.remove(); updateRecipeTotal();"
                        class="text-red-500 hover:text-red-700 p-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;
            
            recipeItems.appendChild(newItem);
            document.getElementById('newRecipeMaterial').value = '';
            updateRecipeTotal();
        }
        
        function updateRecipeTotal() {
            const items = document.getElementById('recipeItems').querySelectorAll('div');
            let total = 0;
            
            items.forEach(item => {
                const input = item.querySelector('input[type="number"]');
                if (input) {
                    total += parseFloat(input.value) || 0;
                }
            });
            
            const totalSpan = document.getElementById('recipeTotal');
            totalSpan.textContent = total.toFixed(1) + '%';
            
            // Color code based on validity
            if (Math.abs(total - 100) < 0.1) {
                totalSpan.className = 'text-sm font-bold text-green-600';
            } else {
                totalSpan.className = 'text-sm font-bold text-red-600';
            }
        }
        
        function saveProductEdits(productId) {
            const product = APP_STATE.products[productId];
            if (!product) return;
            
            // Get values
            const name = document.getElementById('editProductName').value.trim();
            const code = document.getElementById('editProductCode').value.trim();
            const family = document.getElementById('editProductFamily').value;
            const color = document.getElementById('editProductColorHex').value;
            const uomMass = document.getElementById('editProductUomMass')?.value || 'STn';
            const landedCostUsdPerStnRaw = document.getElementById('editLandedCostUsdPerStn')?.value ?? '';
            const fuelCalorificRaw = document.getElementById('editFuelCalorific')?.value ?? '';
            const fuelCO2Raw = document.getElementById('editFuelCO2Factor')?.value ?? '';
            const recipeEffectiveStart = document.getElementById('editRecipeEffectiveStart')?.value || '';
            const recipeEffectiveEnd = document.getElementById('editRecipeEffectiveEnd')?.value || '';
            
            // Validate
            if (!name) {
                alert('Product name is required');
                return;
            }
            
            // Build recipe if applicable
            const hasRecipe = family === 'intermediate' || family === 'cementitious';
            let recipe = {};
            let total = 0;
            
            if (hasRecipe) {
                const items = document.getElementById('recipeItems').querySelectorAll('div');
                items.forEach(item => {
                    const materialInput = item.querySelector('input[type="text"]');
                    const pctInput = item.querySelector('input[type="number"]');
                    if (materialInput && pctInput) {
                        const material = materialInput.value;
                        const pct = parseFloat(pctInput.value) || 0;
                        if (material && pct > 0) {
                            recipe[material] = pct;
                            total += pct;
                        }
                    }
                });
                
                // Validate recipe totals 100%
                if (Object.keys(recipe).length > 0 && Math.abs(total - 100) > 0.1) {
                    alert(`Recipe must total 100%! Current total: ${total.toFixed(1)}%`);
                    return;
                }
            }
            
            // Update product
            product.name = name;
            product.code = code || (product.id || '').toUpperCase();
            product.family = family;
            product.color = color;
            product.uomMass = uomMass;
            product.landedCostUsdPerStn = landedCostUsdPerStnRaw === '' ? '' : Number(landedCostUsdPerStnRaw);
            product.calorificPowerMMBTUPerStn = fuelCalorificRaw === '' ? '' : Number(fuelCalorificRaw);
            product.co2FactorKgCO2PerMMBTU = fuelCO2Raw === '' ? '' : Number(fuelCO2Raw);
            product.recipeEffectiveStart = recipeEffectiveStart;
            product.recipeEffectiveEnd = recipeEffectiveEnd;
            product.recipe = recipe;
            
            saveToLocalStorage();
            closeEditProductModal();
            renderApp();
            
            alert('‚úÖ Product updated successfully!');
        }
        
        function closeEditProductModal() {
            const modal = document.getElementById('editProductModal');
            if (modal) modal.remove();
        }

        function deleteProduct(productId) {
            if (!confirm(`Delete product "${APP_STATE.products[productId].name}"?`)) return;
            
            delete APP_STATE.products[productId];
            saveToLocalStorage();
            renderApp();
        }

        function addMaterialToProduct(productId) {
            const product = APP_STATE.products[productId];
            if (!product) return;
            
            if (!product.recipe) product.recipe = {};
            
            // Find first available material not in recipe
            const usedMaterials = Object.keys(product.recipe);
            let availableMaterial = window.AVAILABLE_RAW_MATERIALS.find(mat => !usedMaterials.includes(mat));
            
            if (!availableMaterial) {
                // If all materials are used, add "New Material"
                availableMaterial = 'New Material';
            }
            
            product.recipe[availableMaterial] = 0;
            
            saveToLocalStorage();
            renderApp();
        }

        function removeMaterial(productId, material) {
            const product = APP_STATE.products[productId];
            if (!product) return;
            
            delete product.recipe[material];
            saveToLocalStorage();
            renderApp();
        }

        function updateMaterialName(productId, oldMaterial, newMaterial) {
            if (newMaterial === '__add_new__') {
                const customMaterial = prompt('Enter new material name:');
                if (!customMaterial) return;
                
                if (!window.AVAILABLE_RAW_MATERIALS.includes(customMaterial)) {
                    window.AVAILABLE_RAW_MATERIALS.push(customMaterial);
                }
                newMaterial = customMaterial;
            }
            
            const product = APP_STATE.products[productId];
            if (!product) return;
            
            const percentage = product.recipe[oldMaterial];
            delete product.recipe[oldMaterial];
            product.recipe[newMaterial] = percentage;
            
            saveToLocalStorage();
            renderApp();
        }

        function updateMaterialPercentage(productId, material, newPercentage) {
            const product = APP_STATE.products[productId];
            if (!product) return;
            
            product.recipe[material] = parseFloat(newPercentage) || 0;
            saveToLocalStorage();
            renderApp();
        }

        function closeRecipeModal() {
            document.getElementById('recipeModal').classList.remove('active');
        }

        // ============================================
        // TAB 2: PROCESS FLOW DESIGNER (Simplified - same as before)
        // ============================================
        
        // Helper function to get available products for each equipment type
        function getProductsForEquipment(equipmentType) {
            const allProducts = Object.values(APP_STATE.products);
            
            switch(equipmentType) {
                case 'raw_material':
                    return allProducts.filter(p => p.family === 'raw_materials');
                    
                case 'fuel':
                    return allProducts.filter(p => p.family === 'fuels');
                    
                case 'unloading':
                case 'storage':
                    // ALL products
                    return allProducts.filter(p => 
                        p.family === 'raw_materials' || 
                        p.family === 'fuels' || 
                        p.family === 'intermediate' || 
                        p.family === 'cementitious'
                    );
                    
                case 'raw_mill':
                case 'kiln':
                    return allProducts.filter(p => p.family === 'intermediate');
                    
                case 'finish_mill':
                case 'packing':
                case 'loadout':
                    return allProducts.filter(p => p.family === 'cementitious');
                    
                default:
                    return allProducts;
            }
        }
        
        function renderFlowDesignerTab() {
            return `
                <div class="bg-gray-800 border-b border-gray-700 p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-white font-semibold text-lg">Process Flow Designer</h2>
                            <p class="text-gray-400 text-sm">Design your plant layout and equipment connections</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="btnFlowRules" class="bg-purple-600 text-white px-3 py-2 rounded text-sm hover:bg-purple-700 font-semibold">
                                ‚öôÔ∏è Rules
                            </button>
                            <button id="btnFlowClear" class="bg-gray-700 text-gray-200 px-3 py-2 rounded text-sm hover:bg-gray-600">
                                üóëÔ∏è Clear
                            </button>
                            <button id="btnFlowLoad" class="bg-gray-700 text-gray-200 px-3 py-2 rounded text-sm hover:bg-gray-600">
                                üìÇ Load
                            </button>
                            <button id="btnFlowSave" class="bg-gray-700 text-gray-200 px-3 py-2 rounded text-sm hover:bg-gray-600">
                                üíæ Export
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex" style="height: calc(100vh - 280px);">
                    <!-- Left Toolbar -->
                    <div id="flowToolbar" class="w-64 bg-gray-800 border-r border-gray-700 p-4 overflow-y-auto">
                        <h3 class="text-white font-semibold mb-2 text-sm">Equipment Library</h3>
                        <p class="text-gray-400 text-xs mb-4">Drag onto canvas ‚Üí</p>
                        <div id="equipmentLibrary"></div>
                    </div>

                    <!-- Main Canvas -->
                    <div id="flowCanvasContainer" class="flex-1 relative bg-gray-200">
                        <svg id="flowCanvas" class="absolute inset-0 w-full h-full">
                            <defs>
                                <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                                    <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#9ca3af" stroke-width="0.5" opacity="0.35"/>
                                </pattern>
                                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                    <polygon points="0 0, 10 3, 0 6" fill="#60a5fa" />
                                </marker>
                            </defs>
                            <rect width="100%" height="100%" fill="url(#grid)" />
                            <g id="connectionsLayer"></g>
                            <g id="equipmentLayer"></g>
                        </svg>

                        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-white bg-opacity-95 text-gray-800 px-6 py-3 rounded-lg border border-gray-300">
                            <div class="flex items-center space-x-4 text-sm">
                                <div>üñ±Ô∏è <span class="font-semibold">Drag</span> from left</div>
                                <div>üîó <span class="font-semibold">Click ports</span> to connect</div>
                                <div>üìù <span class="font-semibold">Double-click</span> to edit</div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel -->
                    <div id="flowRightPanel" class="w-80 bg-gray-800 border-l border-gray-700 p-4 overflow-y-auto">
                        <div id="flowInspectorView">
                            <h3 class="text-white font-semibold mb-4">Inspector</h3>
                            <div id="flowInspector" class="text-gray-400 text-sm">
                                Select equipment to view details
                            </div>
                        </div>
                        <div id="flowRulesView" class="hidden">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-white font-semibold">Rules of Engagement</h3>
                                <button onclick="closeRulesPanel()" class="text-gray-400 hover:text-white">‚úï</button>
                            </div>
                            <div id="flowRulesContent"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function initializeFlowDesigner() {
            // Load saved flow
            loadFlowFromLocalStorage();
            
            renderFlowEquipmentLibrary();
            setupFlowDesignerEvents();
            renderFlowCanvas();
        }

        function renderFlowEquipmentLibrary() {
            const library = document.getElementById('equipmentLibrary');
            if (!library) return;
            
            library.innerHTML = '';

            const categories = {
                'Sources': ['raw_material', 'fuel'],
                'Unloading': ['unloading'],
                'Processing': ['raw_mill', 'kiln', 'finish_mill', 'packing'],
                'Storage': ['storage'],
                'Dispatch': ['loadout']
            };

            Object.entries(categories).forEach(([category, types]) => {
                const header = document.createElement('div');
                header.className = 'text-xs font-semibold text-gray-400 mb-2 uppercase mt-4';
                header.textContent = category;
                library.appendChild(header);

                types.forEach(type => {
                    const def = EQUIPMENT_TYPES[type];
                    if (!def) return;

                    const el = document.createElement('div');
                    el.className = 'toolbar-item bg-gray-700 rounded-lg p-3 mb-2';
                    el.style.background = `linear-gradient(135deg, ${def.color}, ${adjustColor(def.color, -20)})`;
                    el.style.cursor = 'grab';
                    el.innerHTML = `
                        <div class="text-white font-semibold text-sm text-center">${def.name}</div>
                    `;
                    el.draggable = true;
                    el.dataset.type = type;
                    
                    el.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('equipmentType', type);
                        el.style.opacity = '0.5';
                    });
                    
                    el.addEventListener('dragend', () => {
                        el.style.opacity = '1';
                    });
                    
                    library.appendChild(el);
                });
            });
        }

        // This contains the updated Flow Designer functions
// Will be inserted into the HTML file

function setupFlowDesignerEvents() {
    const container = document.getElementById('flowCanvasContainer');
    const canvas = document.getElementById('flowCanvas');
    
    if (!container || !canvas) return;

    let isDraggingCanvas = false;
    let isSelecting = false;
    let dragStartX = 0, dragStartY = 0;

    // Mouse wheel zoom
    canvas.addEventListener('wheel', (e) => {
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
        const newZoom = Math.max(0.25, Math.min(2, APP_STATE.flowDesigner.zoom * zoomFactor));
        
        // Zoom towards mouse position
        const zoomChange = newZoom / APP_STATE.flowDesigner.zoom;
        APP_STATE.flowDesigner.panX = mouseX - (mouseX - APP_STATE.flowDesigner.panX) * zoomChange;
        APP_STATE.flowDesigner.panY = mouseY - (mouseY - APP_STATE.flowDesigner.panY) * zoomChange;
        APP_STATE.flowDesigner.zoom = newZoom;
        
        renderFlowCanvas();
    });

    // Selection rectangle & panning
    canvas.addEventListener('mousedown', (e) => {
        if (e.target === canvas || e.target.id === 'equipmentLayer' || e.target.id === 'connectionsLayer') {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left - APP_STATE.flowDesigner.panX) / APP_STATE.flowDesigner.zoom;
            const y = (e.clientY - rect.top - APP_STATE.flowDesigner.panY) / APP_STATE.flowDesigner.zoom;
            
            // Check if clicking on empty space
            const clickedEq = APP_STATE.flowDesigner.equipment.find(eq => {
                const def = EQUIPMENT_TYPES[eq.type];
                return x >= eq.x && x <= eq.x + def.width && y >= eq.y && y <= eq.y + def.height;
            });
            
            if (!clickedEq) {
                // Start selection rectangle
                isSelecting = true;
                APP_STATE.flowDesigner.selection = {
                    active: true,
                    startX: x,
                    startY: y,
                    endX: x,
                    endY: y
                };
                APP_STATE.flowDesigner.selectedIds = []; // Clear selection
            }
        }
    });

    canvas.addEventListener('mousemove', (e) => {
        if (isSelecting) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left - APP_STATE.flowDesigner.panX) / APP_STATE.flowDesigner.zoom;
            const y = (e.clientY - rect.top - APP_STATE.flowDesigner.panY) / APP_STATE.flowDesigner.zoom;
            
            APP_STATE.flowDesigner.selection.endX = x;
            APP_STATE.flowDesigner.selection.endY = y;
            
            // Update selected items
            const minX = Math.min(APP_STATE.flowDesigner.selection.startX, x);
            const maxX = Math.max(APP_STATE.flowDesigner.selection.startX, x);
            const minY = Math.min(APP_STATE.flowDesigner.selection.startY, y);
            const maxY = Math.max(APP_STATE.flowDesigner.selection.startY, y);
            
            APP_STATE.flowDesigner.selectedIds = APP_STATE.flowDesigner.equipment
                .filter(eq => {
                    const def = EQUIPMENT_TYPES[eq.type];
                    return eq.x + def.width > minX && eq.x < maxX && 
                           eq.y + def.height > minY && eq.y < maxY;
                })
                .map(eq => eq.id);
            
            renderFlowCanvas();
        }
    });

    canvas.addEventListener('mouseup', () => {
        if (isSelecting) {
            isSelecting = false;
            APP_STATE.flowDesigner.selection.active = false;
            renderFlowCanvas();
        }
    });

    // Drag & drop from library
    container.addEventListener('dragover', (e) => e.preventDefault());
    container.addEventListener('drop', (e) => {
        e.preventDefault();
        const type = e.dataTransfer.getData('equipmentType');
        if (type) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left - APP_STATE.flowDesigner.panX) / APP_STATE.flowDesigner.zoom;
            const y = (e.clientY - rect.top - APP_STATE.flowDesigner.panY) / APP_STATE.flowDesigner.zoom;
            addFlowEquipment(type, x, y);
        }
    });

    // Buttons
    const btnFlowClear = document.getElementById('btnFlowClear');
    if (btnFlowClear) {
        btnFlowClear.addEventListener('click', () => {
            if (confirm('Clear all equipment?')) {
                APP_STATE.flowDesigner.equipment = [];
                APP_STATE.flowDesigner.connections = [];
                APP_STATE.flowDesigner.selectedEquipment = null;
                APP_STATE.flowDesigner.selectedIds = [];
                renderFlowCanvas();
                saveFlowToLocalStorage();
            }
        });
    }

    const btnFlowSave = document.getElementById('btnFlowSave');
    if (btnFlowSave) btnFlowSave.addEventListener('click', exportFlowToFile);

    const btnFlowLoad = document.getElementById('btnFlowLoad');
    if (btnFlowLoad) btnFlowLoad.addEventListener('click', importFlowFromFile);

    const btnFlowRules = document.getElementById('btnFlowRules');
    if (btnFlowRules) btnFlowRules.addEventListener('click', openRulesPanel);
}

function renderFlowCanvas() {
    renderFlowConnections();
    renderFlowEquipment();
    renderSelectionRect();
}

function renderSelectionRect() {
    const layer = document.getElementById('equipmentLayer');
    if (!layer) return;
    
    // Remove old selection rect if exists
    const oldRect = document.getElementById('selectionRect');
    if (oldRect) oldRect.remove();
    
    if (!APP_STATE.flowDesigner.selection.active) return;
    
    const sel = APP_STATE.flowDesigner.selection;
    const x = Math.min(sel.startX, sel.endX);
    const y = Math.min(sel.startY, sel.endY);
    const width = Math.abs(sel.endX - sel.startX);
    const height = Math.abs(sel.endY - sel.startY);
    
    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    rect.setAttribute('id', 'selectionRect');
    rect.setAttribute('x', x);
    rect.setAttribute('y', y);
    rect.setAttribute('width', width);
    rect.setAttribute('height', height);
    rect.setAttribute('fill', 'none');
    rect.setAttribute('stroke', '#3b82f6');
    rect.setAttribute('stroke-width', 2 / APP_STATE.flowDesigner.zoom);
    rect.setAttribute('stroke-dasharray', `${10 / APP_STATE.flowDesigner.zoom}`);
    rect.setAttribute('pointer-events', 'none');
    
    layer.appendChild(rect);
}

function renderFlowConnections() {
    const layer = document.getElementById('connectionsLayer');
    if (!layer) return;
    
    layer.innerHTML = '';

    APP_STATE.flowDesigner.connections.forEach(conn => {
        const fromEq = APP_STATE.flowDesigner.equipment.find(e => e.id === conn.from);
        const toEq = APP_STATE.flowDesigner.equipment.find(e => e.id === conn.to);

        if (!fromEq || !toEq) return;

        const fromDef = EQUIPMENT_TYPES[fromEq.type];
        const toDef = EQUIPMENT_TYPES[toEq.type];

        // Auto-smart routing: pick best sides
        const fromCenter = { x: fromEq.x + fromDef.width / 2, y: fromEq.y + fromDef.height / 2 };
        const toCenter = { x: toEq.x + toDef.width / 2, y: toEq.y + toDef.height / 2 };
        
        let fromX, fromY, toX, toY;
        
        // Determine best exit/entry points
        const dx = toCenter.x - fromCenter.x;
        const dy = toCenter.y - fromCenter.y;
        
        // From side selection
        if (Math.abs(dx) > Math.abs(dy)) {
            // Horizontal preference
            if (dx > 0) {
                fromX = fromEq.x + fromDef.width;
                fromY = fromEq.y + fromDef.height / 2;
            } else {
                fromX = fromEq.x;
                fromY = fromEq.y + fromDef.height / 2;
            }
        } else {
            // Vertical preference
            if (dy > 0) {
                fromX = fromEq.x + fromDef.width / 2;
                fromY = fromEq.y + fromDef.height;
            } else {
                fromX = fromEq.x + fromDef.width / 2;
                fromY = fromEq.y;
            }
        }
        
        // To side selection (opposite logic)
        if (Math.abs(dx) > Math.abs(dy)) {
            if (dx > 0) {
                toX = toEq.x;
                toY = toEq.y + toDef.height / 2;
            } else {
                toX = toEq.x + toDef.width;
                toY = toEq.y + toDef.height / 2;
            }
        } else {
            if (dy > 0) {
                toX = toEq.x + toDef.width / 2;
                toY = toEq.y;
            } else {
                toX = toEq.x + toDef.width / 2;
                toY = toEq.y + toDef.height;
            }
        }

        // Create beautiful Bezier curves using the dx/dy already calculated above
        // Control points create the curve
        let controlX1, controlY1, controlX2, controlY2;
        
        if (Math.abs(dx) > Math.abs(dy)) {
            // Horizontal connection - create vertical curve
            const curveAmount = Math.abs(dy) > 20 ? dy * 0.5 : 50; // Minimum 50px curve
            controlX1 = fromX + dx * 0.4;
            controlY1 = fromY + curveAmount;
            controlX2 = fromX + dx * 0.6;
            controlY2 = toY - curveAmount;
        } else {
            // Vertical connection - create horizontal curve
            const curveAmount = Math.abs(dx) > 20 ? dx * 0.5 : 50; // Minimum 50px curve
            controlX1 = fromX + curveAmount;
            controlY1 = fromY + dy * 0.4;
            controlX2 = toX - curveAmount;
            controlY2 = fromY + dy * 0.6;
        }
        
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        const d = `M ${fromX} ${fromY} C ${controlX1} ${controlY1}, ${controlX2} ${controlY2}, ${toX} ${toY}`;
        path.setAttribute('d', d);
        path.setAttribute('stroke', '#60a5fa');
        path.setAttribute('stroke-width', '4');
        path.setAttribute('fill', 'none');
        path.setAttribute('class', 'connection-line');
        path.setAttribute('marker-end', 'url(#arrowhead)');
        path.setAttribute('opacity', '0.8');
        path.style.cursor = 'pointer';
        path.addEventListener('click', () => {
            if (confirm('Delete connection?')) {
                APP_STATE.flowDesigner.connections = APP_STATE.flowDesigner.connections.filter(c => c.id !== conn.id);
                renderFlowCanvas();
                saveFlowToLocalStorage();
            }
        });

        layer.appendChild(path);
    });
}

function renderFlowEquipment() {
    const layer = document.getElementById('equipmentLayer');
    if (!layer) return;
    
    // Clear but keep selection rect
    const selRect = document.getElementById('selectionRect');
    layer.innerHTML = '';
    if (selRect) layer.appendChild(selRect);

    APP_STATE.flowDesigner.equipment.forEach(eq => {
        const def = EQUIPMENT_TYPES[eq.type];
        const isSelected = APP_STATE.flowDesigner.selectedIds.includes(eq.id);
        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        g.setAttribute('class', `equipment-node ${isSelected ? 'selected' : ''}`);

        // Box with selection highlight
        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', eq.x);
        rect.setAttribute('y', eq.y);
        rect.setAttribute('width', def.width);
        rect.setAttribute('height', def.height);
        rect.setAttribute('rx', 0);
        rect.setAttribute('fill', def.color);
        rect.setAttribute('stroke', isSelected ? '#3b82f6' : 'white');
        rect.setAttribute('stroke-width', isSelected ? 4 : 2);
        if (isSelected) {
            rect.setAttribute('filter', 'drop-shadow(0px 4px 8px rgba(59, 130, 246, 0.5))');
        }
        g.appendChild(rect);

        // Name (below box) - no icon
        const name = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        name.setAttribute('x', eq.x + def.width / 2);
        name.setAttribute('y', eq.y + def.height + 12);
        name.setAttribute('text-anchor', 'middle');
        name.setAttribute('fill', '#1f2937');
        name.setAttribute('font-size', '10');
        name.setAttribute('font-weight', 'bold');
        
        let displayName = eq.name;
        if (eq.type === 'raw_material' && eq.params.material_name) {
            displayName = eq.params.material_name;
        } else if (eq.type === 'fuel' && eq.params.fuel_name) {
            displayName = eq.params.fuel_name;
        } else if (eq.type === 'kiln' && eq.params.clinker_type) {
            const clinkerTypes = {
                'gray': 'Gray', 'white': 'White', 'oil_well': 'Oil Well',
                'sulphate_resistant': 'SR', 'low_heat': 'Low Heat'
            };
            const typeLabel = clinkerTypes[eq.params.clinker_type] || '';
            displayName = typeLabel ? `${eq.name} (${typeLabel})` : eq.name;
        }
        
        name.textContent = displayName;
        g.appendChild(name);

        // Status indicator
        const status = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        status.setAttribute('cx', eq.x + def.width - 4);
        status.setAttribute('cy', eq.y + 4);
        status.setAttribute('r', 3);
        status.setAttribute('fill', '#10b981');
        g.appendChild(status);

        // Ports
        if (def.outputs.length > 0) {
            const port = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            port.setAttribute('cx', eq.x + def.width);
            port.setAttribute('cy', eq.y + def.height / 2);
            port.setAttribute('r', 4);
            port.setAttribute('fill', '#3b82f6');
            port.setAttribute('class', 'port');
            port.addEventListener('click', (e) => {
                e.stopPropagation();
                startFlowConnection(eq.id);
            });
            g.appendChild(port);
        }

        if (def.inputs.length > 0) {
            const port = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            port.setAttribute('cx', eq.x);
            port.setAttribute('cy', eq.y + def.height / 2);
            port.setAttribute('r', 4);
            port.setAttribute('fill', '#10b981');
            port.setAttribute('class', 'port');
            port.addEventListener('click', (e) => {
                e.stopPropagation();
                completeFlowConnection(eq.id);
            });
            g.appendChild(port);
        }

        // Click to select
        g.addEventListener('click', (e) => {
            if (!e.target.classList.contains('port')) {
                selectFlowEquipment(eq.id);
            }
        });

        // Multi-select drag
        let isDragging = false;
        let startX, startY;
        let dragOffsets = [];

        g.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('port')) return;
            isDragging = true;
            
            if (!isSelected) {
                APP_STATE.flowDesigner.selectedIds = [eq.id];
                renderFlowCanvas();
            }
            
            // Calculate offsets for all selected items
            dragOffsets = APP_STATE.flowDesigner.selectedIds.map(id => {
                const item = APP_STATE.flowDesigner.equipment.find(e => e.id === id);
                return {
                    id: id,
                    offsetX: e.clientX / APP_STATE.flowDesigner.zoom - item.x,
                    offsetY: e.clientY / APP_STATE.flowDesigner.zoom - item.y
                };
            });
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                dragOffsets.forEach(offset => {
                    const item = APP_STATE.flowDesigner.equipment.find(eq => eq.id === offset.id);
                    if (item) {
                        item.x = e.clientX / APP_STATE.flowDesigner.zoom - offset.offsetX;
                        item.y = e.clientY / APP_STATE.flowDesigner.zoom - offset.offsetY;
                    }
                });
                renderFlowCanvas();
            }
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                saveFlowToLocalStorage();
            }
        });

        layer.appendChild(g);
    });
    
    // Apply zoom/pan transform
    const equipLayer = document.getElementById('equipmentLayer');
    const connLayer = document.getElementById('connectionsLayer');
    if (equipLayer) equipLayer.setAttribute('transform', `translate(${APP_STATE.flowDesigner.panX}, ${APP_STATE.flowDesigner.panY}) scale(${APP_STATE.flowDesigner.zoom})`);
    if (connLayer) connLayer.setAttribute('transform', `translate(${APP_STATE.flowDesigner.panX}, ${APP_STATE.flowDesigner.panY}) scale(${APP_STATE.flowDesigner.zoom})`);
}

function selectFlowEquipment(id) {
    APP_STATE.flowDesigner.selectedEquipment = id;
    APP_STATE.flowDesigner.selectedIds = [id];
    renderFlowCanvas();
    updateFlowInspector();
}

                function addFlowEquipment(type, x, y) {
            const def = EQUIPMENT_TYPES[type];
            const loc = APP_STATE.currentLocation || 'NA';

            // For finish mills, populate available products from products tab
            let params = { ...def.defaultParams };
            if (type === 'finish_mill') {
                params.available_products = Object.keys(APP_STATE.products);
            }

            // Prefer human-readable equipment names (FM1, K1, RM1, etc.)
            const prefixMap = {
              finish_mill: 'FM',
              kiln: 'K',
              raw_mill: 'RM',
              packer: 'PK',
              loadout: 'LO',
              silo: 'SILO',
              inventory: 'INV'
            };
            const prefix = prefixMap[type] || (def.name || 'EQ').toString().trim().toUpperCase().replace(/\s+/g,'_').slice(0,6);
            const seq = (APP_STATE.flowDesigner.equipment || []).filter(e => e.type === type).length + 1;
            const defaultName = `${prefix}${seq}`;

            // Stable equipment id: FACILITY_EQUIPMENTNAME (e.g., MIA_FM1)
            const existingIds = new Set((APP_STATE.flowDesigner.equipment || []).map(e => e.id));
            const baseId = (typeof getFacilityScopedEquipmentId === 'function' ? getFacilityScopedEquipmentId : window.getFacilityScopedEquipmentId)(loc, defaultName);
            const equipmentId = (typeof ensureUniqueEquipmentId === 'function' ? ensureUniqueEquipmentId : window.ensureUniqueEquipmentId)(baseId, existingIds);

            // Keep legacy counter for backwards compatibility with older flows
            APP_STATE.flowDesigner.nextId++;

            const equipment = {
                id: equipmentId,
                type: type,
                name: defaultName,
                x: x - def.width / 2,
                y: y - def.height / 2,
                params: params
            };

            APP_STATE.flowDesigner.equipment.push(equipment);
            renderFlowCanvas();
            saveFlowToLocalStorage();
        }

        
        /* duplicate renderFlowCanvas removed in refactor phase 1 */


        
        /* duplicate renderFlowConnections removed in refactor phase 1 */


        
        /* duplicate renderFlowEquipment removed in refactor phase 1 */


        function startFlowConnection(equipmentId) {
            APP_STATE.flowDesigner.connecting = { from: equipmentId };
        }

        function completeFlowConnection(equipmentId) {
            if (!APP_STATE.flowDesigner.connecting) return;

            const fromEq = APP_STATE.flowDesigner.equipment.find(e => e.id === APP_STATE.flowDesigner.connecting.from);
            const toEq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);

            if (!fromEq || !toEq || fromEq.id === toEq.id) {
                APP_STATE.flowDesigner.connecting = null;
                return;
            }

            const fromType = EQUIPMENT_TYPES[fromEq.type];
            const toType = EQUIPMENT_TYPES[toEq.type];

            const canConnect = fromType.outputs.some(out => toType.inputs.includes(out));

            if (canConnect) {
                const connection = {
                    id: `conn_${APP_STATE.flowDesigner.nextId++}`,
                    from: fromEq.id,
                    to: toEq.id,
                    material: fromType.outputs.find(out => toType.inputs.includes(out))
                };
                APP_STATE.flowDesigner.connections.push(connection);
                saveFlowToLocalStorage();
            } else {
                alert('Incompatible materials!');
            }

            APP_STATE.flowDesigner.connecting = null;
            renderFlowCanvas();
        }

        
        /* duplicate selectFlowEquipment removed in refactor phase 1 */



        function isFamilyIn(product, families) {
            const fam = String(product?.family || '').toLowerCase().trim();
            const category = String(product?.category || '').toLowerCase().trim();
            const famSet = [fam, category];
            // Some legacy/edited files may accidentally store the UI label instead of the key
            if (fam.includes('cementitious')) famSet.push('cementitious');
            if (fam.includes('finished')) famSet.push('finished_product','finished');
            if (fam.includes('intermediate')) famSet.push('intermediate','intermediate_product');
            if (fam.includes('raw')) famSet.push('raw_materials','raw_material','raw');
            if (fam.includes('fuel')) famSet.push('fuels','fuel');

            const set = families.map(f => String(f).toLowerCase().trim());

            // Direct matches
            if (set.some(x => famSet.includes(x))) return true;

            // Backward/forward compatibility aliases across taxonomies
            const aliases = {
                cementitious: ['portland_cement','blended_cement','specialty_cement','cementitious','finished_product','finished','cementitious products'],
                intermediate: ['intermediate_product','intermediate','clinker','raw_meal'],
                raw_materials: ['raw_materials','raw_material','raw','rawmaterials'],
                raw_material: ['raw_materials','raw_material','raw','rawmaterials'],
                fuels: ['fuel','fuels'],
                fuel: ['fuel','fuels'],
                finished_product: ['cementitious','finished_product','finished','portland_cement','blended_cement','specialty_cement']
            };
            return set.some(key => (aliases[key] || []).some(a => famSet.includes(a)));
        }

        function getProductsByFamilies(families) {
            return Object.keys(APP_STATE.products || {}).filter(prodId => isFamilyIn(APP_STATE.products[prodId], families));
        }

        function renderEquipmentCapabilityTable(eq, cfg) {
            if (!eq.params.products) eq.params.products = {};
            const availableProducts = getProductsByFamilies(cfg.allowedFamilies || []);
            const enabledProducts = Object.entries(eq.params.products)
                .filter(([prodId, data]) => data && data.enabled !== false && APP_STATE.products[prodId])
                .map(([prodId, data]) => ({
                    id: prodId,
                    name: APP_STATE.products[prodId].name,
                    tpd: data.tpd || 0,
                    kwh_per_ton: data.kwh_per_ton || 0,
                    mmbtu_per_stn: data.mmbtu_per_stn || 0
                }));

            return `
                <div class="space-y-2">
                    <button onclick="showAddProductCapability('${eq.id}', '${cfg.key}')" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded text-sm font-semibold">
                        + Add ${cfg.rowLabel || 'Product'} Capability
                    </button>

                    ${availableProducts.length === 0 ? `
                        <div class="bg-yellow-900 border border-yellow-600 rounded p-3 text-xs">
                            <strong class="text-yellow-200">‚ö†Ô∏è No eligible products defined!</strong><br>
                            <span class="text-yellow-300">Go to Tab 1 to create ${cfg.eligibleHint || 'products'} first.</span><br>
                            <button onclick="switchTab('products')" class="mt-2 bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-xs">
                                ‚Üí Go to Products Tab
                            </button>
                        </div>
                    ` : ''}

                    ${enabledProducts.length > 0 ? `
                        <div class="bg-gray-900 rounded border border-gray-700 overflow-hidden">
                            <table class="w-full text-xs">
                                <thead class="bg-gray-800 text-gray-300">
                                    <tr>
                                        <th class="text-left p-2 font-semibold">${cfg.rowLabel || 'Product'}</th>
                                        <th class="text-right p-2 font-semibold">Rate<br>(STn/day)</th>
                                        ${cfg.showKwh ? '<th class="text-right p-2 font-semibold">kWh/STn</th>' : ''}
                                        ${cfg.showMMBTU ? '<th class="text-right p-2 font-semibold">MMBTU/STn</th>' : ''}
                                        <th class="w-8"></th>
                                    </tr>
                                </thead>
                                <tbody class="text-white">
                                    ${enabledProducts.map(prod => `
                                        <tr class="border-t border-gray-800">
                                            <td class="p-2">${prod.name}</td>
                                            <td class="p-1 text-right">
                                                <input type="number" value="${prod.tpd}" step="0.1"
                                                       onchange="updateEquipmentCapabilityField('${eq.id}', '${prod.id}', 'tpd', parseFloat(this.value))"
                                                       class="w-20 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-right text-xs">
                                            </td>
                                            ${cfg.showKwh ? `
                                            <td class="p-1 text-right">
                                                <input type="number" value="${prod.kwh_per_ton}" step="0.1"
                                                       onchange="updateEquipmentCapabilityField('${eq.id}', '${prod.id}', 'kwh_per_ton', parseFloat(this.value))"
                                                       class="w-20 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-right text-xs">
                                            </td>` : ''}
                                            ${cfg.showMMBTU ? `
                                            <td class="p-1 text-right">
                                                <input type="number" value="${prod.mmbtu_per_stn}" step="0.001"
                                                       onchange="updateEquipmentCapabilityField('${eq.id}', '${prod.id}', 'mmbtu_per_stn', parseFloat(this.value))"
                                                       class="w-20 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-right text-xs">
                                            </td>` : ''}
                                            <td class="p-1 text-center">
                                                <button onclick="removeProductCapability('${eq.id}', '${prod.id}')"
                                                        class="text-red-400 hover:text-red-300 text-xs">‚úï</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : '<div class="text-xs text-gray-500 text-center py-3">No capabilities added yet</div>'}

                    <div id="addCapabilityForm_${eq.id}" class="hidden bg-gray-800 rounded p-3 space-y-2">
                        <div class="text-xs font-semibold text-gray-300 mb-2">Add ${cfg.rowLabel || 'Product'} Capability</div>
                        <input type="hidden" id="capCfg_${eq.id}" value="${cfg.key}">
                        <select id="capProductSelect_${eq.id}" class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                            <option value="">-- Select ${cfg.rowLabel || 'Product'} --</option>
                            ${availableProducts.filter(prodId => !eq.params.products[prodId] || eq.params.products[prodId].enabled === false).map(prodId => 
                                `<option value="${prodId}">${APP_STATE.products[prodId].name}</option>`
                            ).join('')}
                        </select>
                        <div class="grid grid-cols-${1 + (cfg.showKwh ? 1 : 0) + (cfg.showMMBTU ? 1 : 0)} gap-2">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Rate (STn/day)</label>
                                <input type="number" id="capTPD_${eq.id}" placeholder="1800" class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                            </div>
                            ${cfg.showKwh ? `
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">kWh/STn</label>
                                <input type="number" id="capKwh_${eq.id}" placeholder="45" class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                            </div>` : ''}
                            ${cfg.showMMBTU ? `
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">MMBTU/STn</label>
                                <input type="number" id="capMMBTU_${eq.id}" placeholder="3.20" class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                            </div>` : ''}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="cancelAddProductCapability('${eq.id}')" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-1 rounded text-xs">Cancel</button>
                            <button onclick="confirmAddProductCapability('${eq.id}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-1 rounded text-xs">Add</button>
                        </div>
                    </div>
                    ${cfg.note ? `<div class="text-xs text-gray-500">${cfg.note}</div>`:''}
                </div>
            `;
        }

        function updateFlowInspector() {
            const panel = document.getElementById('flowInspector');
            if (!panel) return;
            
            if (!APP_STATE.flowDesigner.selectedEquipment) {
                panel.innerHTML = '<div class="text-gray-400 text-sm">Select equipment to view specs</div>';
                return;
            }

            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === APP_STATE.flowDesigner.selectedEquipment);
            if (!eq) return;

            const def = EQUIPMENT_TYPES[eq.type];

            let specsHTML = '';

            // Generate specs form based on equipment type
            if (eq.type === 'raw_mill') {
                specsHTML = `
                    <div class="space-y-3">
                        ${renderEquipmentCapabilityTable(eq, {
                            key: 'raw_mill',
                            allowedFamilies: ['intermediate'],
                            rowLabel: 'Output',
                            eligibleHint: 'intermediate products (e.g., raw meal)',
                            showKwh: true,
                            showMMBTU: false,
                            note: 'A raw mill can be configured for multiple outputs, but the schedule will choose one at a time.'
                        })}
                    </div>
                `;
            } else if (eq.type === 'kiln') {
                specsHTML = `
                    <div class="space-y-3">
                        ${renderEquipmentCapabilityTable(eq, {
                            key: 'kiln',
                            allowedFamilies: ['intermediate'],
                            rowLabel: 'Clinker',
                            eligibleHint: 'intermediate products (clinker types)',
                            showKwh: false,
                            showMMBTU: true,
                            note: 'A kiln can produce multiple clinker products, but only one at a time in the plan. Enter thermal consumption in MMBTU/STn.'
                        })}
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Raw Meal to Clinker Factor</label>
                            <input type="number" value="${eq.params.rm_to_clinker_factor || 1.55}" step="0.01"
                                   onchange="updateEquipmentParam('${eq.id}', 'rm_to_clinker_factor', parseFloat(this.value))"
                                   class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                            <p class="text-xs text-gray-500 mt-1">Stored at kiln level. Fuel use and CO‚ÇÇ will later combine this with fuel mix and clinker output.</p>
                        </div>
                    </div>
                `;
            } else if (eq.type === 'finish_mill') {
                // Only show cement products (portland, blended, specialty)
                const availableProducts = Object.keys(APP_STATE.products).filter(prodId => {
                    const product = APP_STATE.products[prodId];
                    return isFamilyIn(product, ['cementitious','finished_product','finished']);
                });
                
                if (!eq.params.products) eq.params.products = {};
                
                const enabledProducts = Object.entries(eq.params.products)
                    .filter(([prodId, data]) => data.enabled && APP_STATE.products[prodId])
                    .map(([prodId, data]) => ({
                        id: prodId,
                        name: APP_STATE.products[prodId].name,
                        tpd: data.tpd || 0,
                        kwh_per_ton: data.kwh_per_ton || 0
                    }));
                
                specsHTML = `
                    <div class="space-y-2">
                        <button onclick="showAddProductToMill('${eq.id}')" 
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded text-sm font-semibold">
                            + Add Product
                        </button>
                        
                        ${availableProducts.length === 0 ? `
                            <div class="bg-yellow-900 border border-yellow-600 rounded p-3 text-xs">
                                <strong class="text-yellow-200">‚ö†Ô∏è No cement products defined!</strong><br>
                                <span class="text-yellow-300">Go to Tab 1 to create cement products (Portland, Blended, or Specialty).</span><br>
                                <button onclick="switchTab('products')" class="mt-2 bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-xs">
                                    ‚Üí Go to Products Tab
                                </button>
                            </div>
                        ` : ''}
                        
                        ${enabledProducts.length > 0 ? `
                            <div class="bg-gray-900 rounded border border-gray-700 overflow-hidden">
                                <table class="w-full text-xs">
                                    <thead class="bg-gray-800 text-gray-300">
                                        <tr>
                                            <th class="text-left p-2 font-semibold">Product</th>
                                            <th class="text-right p-2 font-semibold">TPD</th>
                                            <th class="text-right p-2 font-semibold">kWh/t</th>
                                            <th class="w-8"></th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-white">
                                        ${enabledProducts.map(prod => `
                                            <tr class="border-t border-gray-800">
                                                <td class="p-2">${prod.name}</td>
                                                <td class="p-1 text-right">
                                                    <input type="number" value="${prod.tpd}" 
                                                           onchange="updateMillProductTPD('${eq.id}', '${prod.id}', parseFloat(this.value))"
                                                           class="w-16 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-right text-xs">
                                                </td>
                                                <td class="p-1 text-right">
                                                    <input type="number" value="${prod.kwh_per_ton}" 
                                                           onchange="updateMillProductEnergy('${eq.id}', '${prod.id}', parseFloat(this.value))"
                                                           class="w-16 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-right text-xs">
                                                </td>
                                                <td class="p-1 text-center">
                                                    <button onclick="removeProductFromMill('${eq.id}', '${prod.id}')"
                                                            class="text-red-400 hover:text-red-300 text-xs">
                                                        ‚úï
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<div class="text-xs text-gray-500 text-center py-3">No products added yet</div>'}
                        
                        <div id="addProductForm_${eq.id}" class="hidden bg-gray-800 rounded p-3 space-y-2">
                            <div class="text-xs font-semibold text-gray-300 mb-2">Add Product to Mill</div>
                            <select id="productSelect_${eq.id}" class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                <option value="">-- Select Product --</option>
                                ${availableProducts.filter(prodId => !eq.params.products[prodId]?.enabled).map(prodId => 
                                    `<option value="${prodId}">${APP_STATE.products[prodId].name}</option>`
                                ).join('')}
                            </select>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">TPD</label>
                                    <input type="number" id="productTPD_${eq.id}" placeholder="1800" 
                                           class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">kWh/ton</label>
                                    <input type="number" id="productEnergy_${eq.id}" placeholder="45" 
                                           class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="cancelAddProductToMill('${eq.id}')" 
                                        class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-1 rounded text-xs">
                                    Cancel
                                </button>
                                <button onclick="confirmAddProductToMill('${eq.id}')" 
                                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-1 rounded text-xs">
                                    Add
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (eq.type === 'storage') {
                const availableProducts = Object.keys(APP_STATE.products);
                
                specsHTML = `
                    <div class="space-y-2">
                        ${availableProducts.length === 0 ? `
                            <div class="bg-yellow-900 border border-yellow-600 rounded p-3 text-xs">
                                <strong class="text-yellow-200">‚ö†Ô∏è No products defined!</strong><br>
                                <span class="text-yellow-300">Create products in Tab 1 first.</span><br>
                                <button onclick="switchTab('products')" class="mt-2 bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-xs">
                                    ‚Üí Go to Products Tab
                                </button>
                            </div>
                        ` : `
                            <div>
                                <label class="block text-xs font-semibold text-gray-300 mb-1">Stored Product</label>
                                <select onchange="updateEquipmentParam('${eq.id}', 'product_id', this.value)"
                                        class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                    <option value="">-- Select Product --</option>
                                    ${availableProducts.map(prodId => {
                                        const product = APP_STATE.products[prodId];
                                        return `<option value="${prodId}" ${eq.params.product_id === prodId ? 'selected' : ''}>${product.name}</option>`;
                                    }).join('')}
                                </select>
                            </div>
                        `}
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Max Capacity (tons)</label>
                            <input type="number" value="${eq.params.max_capacity_tons || 5000}" 
                                   onchange="updateEquipmentParam('${eq.id}', 'max_capacity_tons', parseFloat(this.value))"
                                   class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Min Threshold (tons)</label>
                            <input type="number" value="${eq.params.min_threshold_tons || 500}" 
                                   onchange="updateEquipmentParam('${eq.id}', 'min_threshold_tons', parseFloat(this.value))"
                                   class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                            <div class="mt-1 text-xs text-gray-500">
                                Alert when inventory falls below this level
                            </div>
                        </div>
                    </div>
                `;
            } else if (eq.type === 'packing') {
                // Only show cement products
                const availableProducts = Object.keys(APP_STATE.products).filter(prodId => {
                    const product = APP_STATE.products[prodId];
                    return isFamilyIn(product, ['cementitious','finished_product','finished']);
                });
                
                if (!eq.params.products) eq.params.products = {};
                
                const enabledProducts = Object.entries(eq.params.products)
                    .filter(([prodId, data]) => data.enabled && APP_STATE.products[prodId])
                    .map(([prodId, data]) => ({
                        id: prodId,
                        name: APP_STATE.products[prodId].name,
                        pallets_per_hour: data.pallets_per_hour || 0,
                        tons_per_pallet: data.tons_per_pallet || 0
                    }));
                
                specsHTML = `
                    <div class="space-y-2">
                        <button onclick="showAddProductToPacking('${eq.id}')" 
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded text-sm font-semibold">
                            + Add Product
                        </button>
                        
                        ${availableProducts.length === 0 ? `
                            <div class="bg-yellow-900 border border-yellow-600 rounded p-3 text-xs">
                                <strong class="text-yellow-200">‚ö†Ô∏è No cement products defined!</strong><br>
                                <span class="text-yellow-300">Go to Tab 1 to create cement products.</span><br>
                                <button onclick="switchTab('products')" class="mt-2 bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-xs">
                                    ‚Üí Go to Products Tab
                                </button>
                            </div>
                        ` : ''}
                        
                        ${enabledProducts.length > 0 ? `
                            <div class="bg-gray-900 rounded border border-gray-700 overflow-hidden">
                                <table class="w-full text-xs">
                                    <thead class="bg-gray-800 text-gray-300">
                                        <tr>
                                            <th class="text-left p-2 font-semibold">Product</th>
                                            <th class="text-right p-2 font-semibold">Pal/hr</th>
                                            <th class="text-right p-2 font-semibold">t/pal</th>
                                            <th class="w-8"></th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-white">
                                        ${enabledProducts.map(prod => `
                                            <tr class="border-t border-gray-800">
                                                <td class="p-2">${prod.name}</td>
                                                <td class="p-1 text-right">
                                                    <input type="number" value="${prod.pallets_per_hour}" 
                                                           onchange="updatePackingProductPallets('${eq.id}', '${prod.id}', parseFloat(this.value))"
                                                           class="w-16 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-right text-xs">
                                                </td>
                                                <td class="p-1 text-right">
                                                    <input type="number" value="${prod.tons_per_pallet}" step="0.01"
                                                           onchange="updatePackingProductTons('${eq.id}', '${prod.id}', parseFloat(this.value))"
                                                           class="w-16 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-right text-xs">
                                                </td>
                                                <td class="p-1 text-center">
                                                    <button onclick="removeProductFromPacking('${eq.id}', '${prod.id}')"
                                                            class="text-red-400 hover:text-red-300 text-xs">
                                                        ‚úï
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<div class="text-xs text-gray-500 text-center py-3">No products added yet</div>'}
                        
                        <div id="addProductFormPacking_${eq.id}" class="hidden bg-gray-800 rounded p-3 space-y-2">
                            <div class="text-xs font-semibold text-gray-300 mb-2">Add Product to Packing Line</div>
                            <select id="productSelectPacking_${eq.id}" class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                <option value="">-- Select Product --</option>
                                ${availableProducts.filter(prodId => !eq.params.products[prodId]?.enabled).map(prodId => 
                                    `<option value="${prodId}">${APP_STATE.products[prodId].name}</option>`
                                ).join('')}
                            </select>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Pallets/hour</label>
                                    <input type="number" id="productPalletsPacking_${eq.id}" placeholder="100" 
                                           class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Tons/pallet</label>
                                    <input type="number" id="productTonsPacking_${eq.id}" placeholder="1.25" step="0.01"
                                           class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="cancelAddProductToPacking('${eq.id}')" 
                                        class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-1 rounded text-xs">
                                    Cancel
                                </button>
                                <button onclick="confirmAddProductToPacking('${eq.id}')" 
                                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-1 rounded text-xs">
                                    Add
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (eq.type === 'loadout') {
                // Only show cement products
                const availableProducts = Object.keys(APP_STATE.products).filter(prodId => {
                    const product = APP_STATE.products[prodId];
                    return isFamilyIn(product, ['cementitious','finished_product','finished']);
                });
                
                if (!eq.params.products) eq.params.products = {};
                
                const enabledProducts = Object.entries(eq.params.products)
                    .filter(([prodId, data]) => data.enabled && APP_STATE.products[prodId])
                    .map(([prodId, data]) => ({
                        id: prodId,
                        name: APP_STATE.products[prodId].name,
                        loads_per_day: data.loads_per_day || 0,
                        tons_per_load: data.tons_per_load || 0
                    }));
                
                specsHTML = `
                    <div class="space-y-2">
                        <button onclick="showAddProductToLoadout('${eq.id}')" 
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded text-sm font-semibold">
                            + Add Product
                        </button>
                        
                        ${availableProducts.length === 0 ? `
                            <div class="bg-yellow-900 border border-yellow-600 rounded p-3 text-xs">
                                <strong class="text-yellow-200">‚ö†Ô∏è No cement products defined!</strong><br>
                                <span class="text-yellow-300">Go to Tab 1 to create cement products.</span><br>
                                <button onclick="switchTab('products')" class="mt-2 bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-xs">
                                    ‚Üí Go to Products Tab
                                </button>
                            </div>
                        ` : ''}
                        
                        ${enabledProducts.length > 0 ? `
                            <div class="bg-gray-900 rounded border border-gray-700 overflow-hidden">
                                <table class="w-full text-xs">
                                    <thead class="bg-gray-800 text-gray-300">
                                        <tr>
                                            <th class="text-left p-2 font-semibold">Product</th>
                                            <th class="text-right p-2 font-semibold">Loads/day</th>
                                            <th class="text-right p-2 font-semibold">t/load</th>
                                            <th class="w-8"></th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-white">
                                        ${enabledProducts.map(prod => `
                                            <tr class="border-t border-gray-800">
                                                <td class="p-2">${prod.name}</td>
                                                <td class="p-1 text-right">
                                                    <input type="number" value="${prod.loads_per_day}" 
                                                           onchange="updateLoadoutProductLoads('${eq.id}', '${prod.id}', parseFloat(this.value))"
                                                           class="w-16 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-right text-xs">
                                                </td>
                                                <td class="p-1 text-right">
                                                    <input type="number" value="${prod.tons_per_load}" step="0.1"
                                                           onchange="updateLoadoutProductTons('${eq.id}', '${prod.id}', parseFloat(this.value))"
                                                           class="w-16 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-right text-xs">
                                                </td>
                                                <td class="p-1 text-center">
                                                    <button onclick="removeProductFromLoadout('${eq.id}', '${prod.id}')"
                                                            class="text-red-400 hover:text-red-300 text-xs">
                                                        ‚úï
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<div class="text-xs text-gray-500 text-center py-3">No products added yet</div>'}
                        
                        <div id="addProductFormLoadout_${eq.id}" class="hidden bg-gray-800 rounded p-3 space-y-2">
                            <div class="text-xs font-semibold text-gray-300 mb-2">Add Product to Loadout</div>
                            <select id="productSelectLoadout_${eq.id}" class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                <option value="">-- Select Product --</option>
                                ${availableProducts.filter(prodId => !eq.params.products[prodId]?.enabled).map(prodId => 
                                    `<option value="${prodId}">${APP_STATE.products[prodId].name}</option>`
                                ).join('')}
                            </select>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Loads/day</label>
                                    <input type="number" id="productLoadsLoadout_${eq.id}" placeholder="80" 
                                           class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Tons/load</label>
                                    <input type="number" id="productTonsLoadout_${eq.id}" placeholder="25" step="0.1"
                                           class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="cancelAddProductToLoadout('${eq.id}')" 
                                        class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-1 rounded text-xs">
                                    Cancel
                                </button>
                                <button onclick="confirmAddProductToLoadout('${eq.id}')" 
                                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-1 rounded text-xs">
                                    Add
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (eq.type === 'raw_material') {
                // Show dropdown of CK Raw materials from Tab 1
                const rawMaterials = Object.keys(APP_STATE.products).filter(prodId => {
                    return APP_STATE.products[prodId].family === 'raw_materials';
                });
                
                specsHTML = `
                    <div class="space-y-2">
                        ${rawMaterials.length === 0 ? `
                            <div class="bg-yellow-900 border border-yellow-600 rounded p-3 text-xs">
                                <strong class="text-yellow-200">‚ö†Ô∏è No raw materials defined!</strong><br>
                                <span class="text-yellow-300">Go to Tab 1 to create CK Raw materials.</span><br>
                                <button onclick="switchTab('products')" class="mt-2 bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-xs">
                                    ‚Üí Go to Products Tab
                                </button>
                            </div>
                        ` : `
                            <div>
                                <label class="block text-xs font-semibold text-gray-300 mb-1">Raw Material Type</label>
                                <select onchange="updateEquipmentParam('${eq.id}', 'material_id', this.value)"
                                        class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                    <option value="">-- Select Material --</option>
                                    ${rawMaterials.map(prodId => {
                                        const product = APP_STATE.products[prodId];
                                        return `<option value="${prodId}" ${eq.params.material_id === prodId ? 'selected' : ''}>${product.name}</option>`;
                                    }).join('')}
                                </select>
                                <div class="mt-1 text-xs text-gray-500">
                                    Direct connection - infinite availability assumed
                                </div>
                            </div>
                        `}
                    </div>
                `;
            } else if (eq.type === 'fuel') {
                // Show dropdown of Fuels from Tab 1
                const fuels = Object.keys(APP_STATE.products).filter(prodId => {
                    return APP_STATE.products[prodId].family === 'fuel';
                });
                
                specsHTML = `
                    <div class="space-y-2">
                        ${fuels.length === 0 ? `
                            <div class="bg-yellow-900 border border-yellow-600 rounded p-3 text-xs">
                                <strong class="text-yellow-200">‚ö†Ô∏è No fuels defined!</strong><br>
                                <span class="text-yellow-300">Go to Tab 1 to create Fuel products.</span><br>
                                <button onclick="switchTab('products')" class="mt-2 bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-xs">
                                    ‚Üí Go to Products Tab
                                </button>
                            </div>
                        ` : `
                            <div>
                                <label class="block text-xs font-semibold text-gray-300 mb-1">Fuel Type</label>
                                <select onchange="updateEquipmentParam('${eq.id}', 'fuel_id', this.value)"
                                        class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                    <option value="">-- Select Fuel --</option>
                                    ${fuels.map(prodId => {
                                        const product = APP_STATE.products[prodId];
                                        return `<option value="${prodId}" ${eq.params.fuel_id === prodId ? 'selected' : ''}>${product.name}</option>`;
                                    }).join('')}
                                </select>
                                <div class="mt-1 text-xs text-gray-500">
                                    Direct connection - infinite availability assumed
                                </div>
                            </div>
                        `}
                    </div>
                `;
            } else if (eq.type === 'additive') {
                // Show dropdown of CEM Raw materials from Tab 1 (for additives like gypsum)
                const additives = Object.keys(APP_STATE.products).filter(prodId => {
                    return APP_STATE.products[prodId].family === 'raw_materials';
                });
                
                specsHTML = `
                    <div class="space-y-2">
                        ${additives.length === 0 ? `
                            <div class="bg-yellow-900 border border-yellow-600 rounded p-3 text-xs">
                                <strong class="text-yellow-200">‚ö†Ô∏è No additives defined!</strong><br>
                                <span class="text-yellow-300">Go to Tab 1 to create CEM Raw materials (Gypsum, Fly Ash, etc).</span><br>
                                <button onclick="switchTab('products')" class="mt-2 bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-xs">
                                    ‚Üí Go to Products Tab
                                </button>
                            </div>
                        ` : `
                            <div>
                                <label class="block text-xs font-semibold text-gray-300 mb-1">Additive Type</label>
                                <select onchange="updateEquipmentParam('${eq.id}', 'additive_id', this.value)"
                                        class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                    <option value="">-- Select Additive --</option>
                                    ${additives.map(prodId => {
                                        const product = APP_STATE.products[prodId];
                                        return `<option value="${prodId}" ${eq.params.additive_id === prodId ? 'selected' : ''}>${product.name}</option>`;
                                    }).join('')}
                                </select>
                                <div class="mt-1 text-xs text-gray-500">
                                    Direct connection - infinite availability assumed
                                </div>
                            </div>
                        `}
                    </div>
                `;
            } else {
                // Generic parameters for other equipment
                specsHTML = `
                    <div class="text-xs text-gray-400">
                        Basic equipment - no additional specs required
                    </div>
                `;
            }

            panel.innerHTML = `
                <div class="bg-gray-900 rounded-lg p-4 mb-4">
                    <div class="mb-3">
                        <label class="block text-xs font-semibold text-gray-300 mb-1">Equipment Name</label>
                        <input type="text" value="${eq.name}" 
                               onchange="updateEquipmentName('${eq.id}', this.value)"
                               class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm font-semibold">
                    </div>
                    <div class="text-xs text-gray-400 mb-3">Type: ${def.name}</div>
                    ${specsHTML}
                </div>
                <div class="bg-gray-900 rounded-lg p-4">
                    <button onclick="removeFlowEquipment('${eq.id}')" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded text-sm">
                        üóëÔ∏è Remove Equipment
                    </button>
                </div>
            `;
        }

        function updateEquipmentParam(equipmentId, paramName, value) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq) return;
            
            eq.params[paramName] = value;
            saveFlowToLocalStorage();
            updateFlowInspector(); // Refresh to show updated values
        }

        function updateEquipmentName(equipmentId, newName) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq) return;
            
            eq.name = newName;
            saveFlowToLocalStorage();
            renderFlowCanvas(); // Re-render to show new name on canvas
            updateFlowInspector(); // Refresh inspector
        }

        function toggleProductForMill(equipmentId, productId, enabled) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq) return;
            
            if (!eq.params.products) eq.params.products = {};
            
            if (enabled) {
                eq.params.products[productId] = { enabled: true, tpd: 0 };
            } else {
                delete eq.params.products[productId];
            }
            
            saveFlowToLocalStorage();
            updateFlowInspector();
        }


        // ============================================
        // GENERIC EQUIPMENT PRODUCT CAPABILITY MANAGEMENT
        // ============================================
        function showAddProductCapability(equipmentId, cfgKey) {
            const form = document.getElementById(`addCapabilityForm_${equipmentId}`);
            if (!form) return;
            const cfg = document.getElementById(`capCfg_${equipmentId}`);
            if (cfgKey && cfg) cfg.value = cfgKey;
            form.classList.remove('hidden');
        }

        function cancelAddProductCapability(equipmentId) {
            const form = document.getElementById(`addCapabilityForm_${equipmentId}`);
            if (form) form.classList.add('hidden');
            ['capProductSelect_', 'capTPD_', 'capKwh_', 'capMMBTU_'].forEach(prefix => {
                const el = document.getElementById(prefix + equipmentId);
                if (el) el.value = '';
            });
        }

        function confirmAddProductCapability(equipmentId) {
            const productEl = document.getElementById(`capProductSelect_${equipmentId}`);
            const tpdEl = document.getElementById(`capTPD_${equipmentId}`);
            const kwhEl = document.getElementById(`capKwh_${equipmentId}`);
            const mmbtuEl = document.getElementById(`capMMBTU_${equipmentId}`);
            const productId = productEl ? productEl.value : '';
            if (!productId) { alert('Please select a product'); return; }

            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq) return;
            if (!eq.params.products) eq.params.products = {};

            eq.params.products[productId] = {
                enabled: true,
                tpd: parseFloat(tpdEl?.value) || 0,
                kwh_per_ton: parseFloat(kwhEl?.value) || 0,
                mmbtu_per_stn: parseFloat(mmbtuEl?.value) || 0
            };
            saveFlowToLocalStorage();
            updateFlowInspector();
        }

        function updateEquipmentCapabilityField(equipmentId, productId, field, value) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq || !eq.params.products || !eq.params.products[productId]) return;
            eq.params.products[productId][field] = isNaN(value) ? 0 : value;
            saveFlowToLocalStorage();
        }

        function removeProductCapability(equipmentId, productId) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq || !eq.params.products) return;
            delete eq.params.products[productId];
            saveFlowToLocalStorage();
            updateFlowInspector();
        }

        // Backward-compatible wrappers for existing Finish Mill buttons
        function showAddProductToMill(equipmentId) {
            const legacy = document.getElementById(`addProductForm_${equipmentId}`);
            if (legacy) { legacy.classList.remove('hidden'); return; }
            showAddProductCapability(equipmentId, 'finish_mill');
        }
        function cancelAddProductToMill(equipmentId) {
            const legacy = document.getElementById(`addProductForm_${equipmentId}`);
            if (legacy) {
                legacy.classList.add('hidden');
                const ids = [`productSelect_${equipmentId}`, `productTPD_${equipmentId}`, `productEnergy_${equipmentId}`];
                ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
                return;
            }
            cancelAddProductCapability(equipmentId);
        }
        function confirmAddProductToMill(equipmentId) {
            const legacySelect = document.getElementById(`productSelect_${equipmentId}`);
            if (legacySelect) {
                const productId = legacySelect.value;
                const tpd = parseFloat(document.getElementById(`productTPD_${equipmentId}`)?.value) || 0;
                const kwh = parseFloat(document.getElementById(`productEnergy_${equipmentId}`)?.value) || 0;
                if (!productId) { alert('Please select a product'); return; }
                const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
                if (!eq) return;
                if (!eq.params.products) eq.params.products = {};
                eq.params.products[productId] = { enabled: true, tpd: tpd, kwh_per_ton: kwh };
                saveFlowToLocalStorage();
                updateFlowInspector();
                return;
            }
            confirmAddProductCapability(equipmentId);
        }
        function updateMillProductTPD(equipmentId, productId, tpd) { updateEquipmentCapabilityField(equipmentId, productId, 'tpd', tpd); }
        function updateMillProductEnergy(equipmentId, productId, kwh_per_ton) { updateEquipmentCapabilityField(equipmentId, productId, 'kwh_per_ton', kwh_per_ton); }


        // ============================================
        // PACKING SYSTEM PRODUCT MANAGEMENT
        // ============================================

        function showAddProductToPacking(equipmentId) {
            const form = document.getElementById(`addProductFormPacking_${equipmentId}`);
            if (form) form.classList.remove('hidden');
        }

        function cancelAddProductToPacking(equipmentId) {
            const form = document.getElementById(`addProductFormPacking_${equipmentId}`);
            if (form) {
                form.classList.add('hidden');
                document.getElementById(`productSelectPacking_${equipmentId}`).value = '';
                document.getElementById(`productPalletsPacking_${equipmentId}`).value = '';
                document.getElementById(`productTonsPacking_${equipmentId}`).value = '';
            }
        }

        function confirmAddProductToPacking(equipmentId) {
            const productId = document.getElementById(`productSelectPacking_${equipmentId}`).value;
            const pallets_per_hour = parseFloat(document.getElementById(`productPalletsPacking_${equipmentId}`).value) || 0;
            const tons_per_pallet = parseFloat(document.getElementById(`productTonsPacking_${equipmentId}`).value) || 0;
            
            if (!productId) {
                alert('Please select a product');
                return;
            }
            
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq) return;
            
            if (!eq.params.products) eq.params.products = {};
            
            eq.params.products[productId] = {
                enabled: true,
                pallets_per_hour: pallets_per_hour,
                tons_per_pallet: tons_per_pallet
            };
            
            saveFlowToLocalStorage();
            updateFlowInspector();
        }

        function updatePackingProductPallets(equipmentId, productId, pallets_per_hour) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq || !eq.params.products || !eq.params.products[productId]) return;
            
            eq.params.products[productId].pallets_per_hour = pallets_per_hour;
            saveFlowToLocalStorage();
        }

        function updatePackingProductTons(equipmentId, productId, tons_per_pallet) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq || !eq.params.products || !eq.params.products[productId]) return;
            
            eq.params.products[productId].tons_per_pallet = tons_per_pallet;
            saveFlowToLocalStorage();
        }

        function removeProductFromPacking(equipmentId, productId) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq || !eq.params.products) return;
            
            delete eq.params.products[productId];
            
            saveFlowToLocalStorage();
            updateFlowInspector();
        }

        // ============================================
        // LOADOUT PRODUCT MANAGEMENT
        // ============================================

        function showAddProductToLoadout(equipmentId) {
            const form = document.getElementById(`addProductFormLoadout_${equipmentId}`);
            if (form) form.classList.remove('hidden');
        }

        function cancelAddProductToLoadout(equipmentId) {
            const form = document.getElementById(`addProductFormLoadout_${equipmentId}`);
            if (form) {
                form.classList.add('hidden');
                document.getElementById(`productSelectLoadout_${equipmentId}`).value = '';
                document.getElementById(`productLoadsLoadout_${equipmentId}`).value = '';
                document.getElementById(`productTonsLoadout_${equipmentId}`).value = '';
            }
        }

        function confirmAddProductToLoadout(equipmentId) {
            const productId = document.getElementById(`productSelectLoadout_${equipmentId}`).value;
            const loads_per_day = parseFloat(document.getElementById(`productLoadsLoadout_${equipmentId}`).value) || 0;
            const tons_per_load = parseFloat(document.getElementById(`productTonsLoadout_${equipmentId}`).value) || 0;
            
            if (!productId) {
                alert('Please select a product');
                return;
            }
            
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq) return;
            
            if (!eq.params.products) eq.params.products = {};
            
            eq.params.products[productId] = {
                enabled: true,
                loads_per_day: loads_per_day,
                tons_per_load: tons_per_load
            };
            
            saveFlowToLocalStorage();
            updateFlowInspector();
        }

        function updateLoadoutProductLoads(equipmentId, productId, loads_per_day) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq || !eq.params.products || !eq.params.products[productId]) return;
            
            eq.params.products[productId].loads_per_day = loads_per_day;
            saveFlowToLocalStorage();
        }

        function updateLoadoutProductTons(equipmentId, productId, tons_per_load) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq || !eq.params.products || !eq.params.products[productId]) return;
            
            eq.params.products[productId].tons_per_load = tons_per_load;
            saveFlowToLocalStorage();
        }

        function removeProductFromLoadout(equipmentId, productId) {
            const eq = APP_STATE.flowDesigner.equipment.find(e => e.id === equipmentId);
            if (!eq || !eq.params.products) return;
            
            delete eq.params.products[productId];
            
            saveFlowToLocalStorage();
            updateFlowInspector();
        }

        function removeFlowEquipment(id) {
            if (confirm('Remove equipment?')) {
                APP_STATE.flowDesigner.equipment = APP_STATE.flowDesigner.equipment.filter(e => e.id !== id);
                APP_STATE.flowDesigner.connections = APP_STATE.flowDesigner.connections.filter(c => c.from !== id && c.to !== id);
                APP_STATE.flowDesigner.selectedEquipment = null;
                renderFlowCanvas();
                updateFlowInspector();
                saveFlowToLocalStorage();
            }
        }

        // ============================================
        // RULES OF ENGAGEMENT PANEL
        // ============================================

        function openRulesPanel() {
            // Check if we're in Flow Designer tab or Production Plan tab
            const flowInspector = document.getElementById('flowInspectorView');
            const flowRules = document.getElementById('flowRulesView');
            
            if (flowInspector && flowRules) {
                // Flow Designer tab - use existing panel
                flowInspector.classList.add('hidden');
                flowRules.classList.remove('hidden');
                renderRulesPanel();
            } else {
                // Production Plan or other tab - show modal
                showRulesModal();
            }
        }

        function showRulesModal() {
            const modal = document.createElement('div');
            modal.id = 'rulesModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-purple-600 to-purple-700 text-white px-6 py-4 rounded-t-lg sticky top-0">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold">‚öôÔ∏è Rules of Engagement</h3>
                            <button onclick="closeRulesModal()" class="text-white hover:text-gray-200">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <p class="text-gray-600 mb-4">Production planning rules and constraints</p>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p class="text-sm text-blue-900">Rules panel integration coming soon...</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeRulesModal() {
            const modal = document.getElementById('rulesModal');
            if (modal) modal.remove();
        }

        function closeRulesPanel() {
            // Show inspector, hide rules
            document.getElementById('flowRulesView').classList.add('hidden');
            document.getElementById('flowInspectorView').classList.remove('hidden');
        }

        function renderRulesPanel() {
            const content = document.getElementById('flowRulesContent');
            if (!content) return;

            // Get all cement products for priority ordering
            const cementProducts = Object.keys(APP_STATE.products).filter(prodId => {
                const product = APP_STATE.products[prodId];
                return product.family === 'portland_cement' || 
                       product.family === 'blended_cement' || 
                       product.family === 'specialty_cement';
            });

            // Initialize product priorities if not set
            if (!APP_STATE.rules.operational.product_priorities || 
                Object.keys(APP_STATE.rules.operational.product_priorities).length === 0) {
                cementProducts.forEach((prodId, index) => {
                    if (!APP_STATE.rules.operational.product_priorities) {
                        APP_STATE.rules.operational.product_priorities = {};
                    }
                    APP_STATE.rules.operational.product_priorities[prodId] = index + 1;
                });
            }

            content.innerHTML = `
                <div class="space-y-4">
                    <!-- System Rules (Read-only) -->
                    <div class="bg-gray-900 rounded-lg p-3 border border-gray-700">
                        <div class="flex items-center space-x-2 mb-3">
                            <span class="text-xl">üîí</span>
                            <h4 class="text-white font-semibold text-sm">System Rules</h4>
                        </div>
                        <div class="space-y-2 text-xs">
                            <div class="flex items-start space-x-2 text-green-400">
                                <span class="mt-0.5">‚úì</span>
                                <span>Silos hold only one product (must empty to switch)</span>
                            </div>
                            <div class="flex items-start space-x-2 text-green-400">
                                <span class="mt-0.5">‚úì</span>
                                <span>Equipment produces one product at a time</span>
                            </div>
                            <div class="flex items-start space-x-2 text-green-400">
                                <span class="mt-0.5">‚úì</span>
                                <span>Inventory cannot go negative</span>
                            </div>
                            <div class="flex items-start space-x-2 text-green-400">
                                <span class="mt-0.5">‚úì</span>
                                <span>Recipes must be followed exactly</span>
                            </div>
                            <div class="flex items-start space-x-2 text-green-400">
                                <span class="mt-0.5">‚úì</span>
                                <span>Silo capacity limits enforced</span>
                            </div>
                        </div>
                    </div>

                    <!-- Operational Rules (Configurable) -->
                    <div class="bg-gray-900 rounded-lg p-3 border border-gray-700">
                        <div class="flex items-center space-x-2 mb-3">
                            <span class="text-xl">‚öôÔ∏è</span>
                            <h4 class="text-white font-semibold text-sm">Operational Rules</h4>
                        </div>
                        
                        <div class="space-y-3">
                            <!-- Clinker Shortage Response -->
                            <div>
                                <label class="block text-xs font-semibold text-gray-300 mb-1">
                                    Clinker Shortage Response
                                </label>
                                <select id="ruleClikerShortage" 
                                        class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                    <option value="stop_mills_sequential" ${APP_STATE.rules.operational.clinker_shortage_response === 'stop_mills_sequential' ? 'selected' : ''}>
                                        Stop mills one-by-one (FM ‚Üí Raw Mill ‚Üí Kiln)
                                    </option>
                                    <option value="stop_all_immediately" ${APP_STATE.rules.operational.clinker_shortage_response === 'stop_all_immediately' ? 'selected' : ''}>
                                        Stop all mills immediately
                                    </option>
                                    <option value="reduce_production" ${APP_STATE.rules.operational.clinker_shortage_response === 'reduce_production' ? 'selected' : ''}>
                                        Reduce production proportionally
                                    </option>
                                </select>
                                <div class="text-xs text-gray-500 mt-1">
                                    What happens when clinker silo is empty
                                </div>
                            </div>

                            <!-- Campaign Minimum Length -->
                            <div>
                                <label class="block text-xs font-semibold text-gray-300 mb-1">
                                    Campaign Minimum Length
                                </label>
                                <div class="flex items-center space-x-2">
                                    <input type="number" id="ruleCampaignMinHours" 
                                           value="${APP_STATE.rules.operational.campaign_minimum_hours}"
                                           min="0" max="168"
                                           class="flex-1 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                    <span class="text-gray-400 text-xs">hours</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    Minimum time a mill must run one product
                                </div>
                            </div>

                            <!-- Changeover Time -->
                            <div>
                                <label class="block text-xs font-semibold text-gray-300 mb-1">
                                    Product Changeover Time
                                </label>
                                <div class="flex items-center space-x-2">
                                    <input type="number" id="ruleChangeoverHours" 
                                           value="${APP_STATE.rules.operational.changeover_time_hours}"
                                           min="0" max="24" step="0.5"
                                           class="flex-1 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                    <span class="text-gray-400 text-xs">hours</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    Downtime when switching products (0 = instant)
                                </div>
                            </div>

                            <!-- Operating Mode -->
                            <div>
                                <label class="block text-xs font-semibold text-gray-300 mb-2">
                                    Default Operating Mode
                                </label>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center space-x-2 cursor-pointer">
                                        <input type="radio" name="operatingMode" value="24/7" 
                                               ${APP_STATE.rules.operational.default_operating_mode === '24/7' ? 'checked' : ''}
                                               class="text-blue-600">
                                        <span class="text-xs text-white">24/7 Operation</span>
                                    </label>
                                    <label class="flex items-center space-x-2 cursor-pointer">
                                        <input type="radio" name="operatingMode" value="shifts"
                                               ${APP_STATE.rules.operational.default_operating_mode === 'shifts' ? 'checked' : ''}
                                               class="text-blue-600">
                                        <span class="text-xs text-white">Shift-based</span>
                                    </label>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    FM, Raw Mill, Kiln, Packers, Loadout
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Product Priorities -->
                    ${cementProducts.length > 0 ? `
                        <div class="bg-gray-900 rounded-lg p-3 border border-gray-700">
                            <div class="flex items-center space-x-2 mb-3">
                                <span class="text-xl">üéØ</span>
                                <h4 class="text-white font-semibold text-sm">Product Priorities</h4>
                            </div>
                            <div class="text-xs text-gray-400 mb-2">
                                When capacity is limited, which products get priority?
                            </div>
                            <div class="space-y-2" id="productPriorityList">
                                ${cementProducts
                                    .sort((a, b) => {
                                        const prioA = APP_STATE.rules.operational.product_priorities[a] || 999;
                                        const prioB = APP_STATE.rules.operational.product_priorities[b] || 999;
                                        return prioA - prioB;
                                    })
                                    .map((prodId, index) => {
                                        const product = APP_STATE.products[prodId];
                                        return `
                                            <div class="flex items-center space-x-2 bg-gray-800 rounded p-2">
                                                <div class="flex flex-col space-y-1">
                                                    <button onclick="moveProductPriorityUp('${prodId}')" 
                                                            ${index === 0 ? 'disabled' : ''}
                                                            class="text-gray-400 hover:text-white disabled:opacity-30 text-xs">
                                                        ‚ñ≤
                                                    </button>
                                                    <button onclick="moveProductPriorityDown('${prodId}')" 
                                                            ${index === cementProducts.length - 1 ? 'disabled' : ''}
                                                            class="text-gray-400 hover:text-white disabled:opacity-30 text-xs">
                                                        ‚ñº
                                                    </button>
                                                </div>
                                                <div class="flex items-center space-x-2 flex-1">
                                                    <span class="text-gray-400 text-xs w-6">${index + 1}.</span>
                                                    <span class="text-white text-xs">${product.name}</span>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                            </div>
                        </div>
                    ` : `
                        <div class="bg-yellow-900 border border-yellow-600 rounded p-3 text-xs">
                            <strong class="text-yellow-200">‚ö†Ô∏è No products defined!</strong><br>
                            <span class="text-yellow-300">Create cement products in Tab 1 first.</span>
                        </div>
                    `}

                    <!-- Holidays -->
                    <div class="bg-gray-900 rounded-lg p-3 border border-gray-700">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-2">
                                <span class="text-xl">üóìÔ∏è</span>
                                <h4 class="text-white font-semibold text-sm">Holidays & Non-Working Days</h4>
                            </div>
                            <button onclick="openHolidaysPanel()" 
                                    class="bg-purple-600 hover:bg-purple-700 text-white px-2 py-1 rounded text-xs font-semibold">
                                Manage
                            </button>
                        </div>
                        <div class="text-xs text-gray-400">
                            ${APP_STATE.rules.holidays && APP_STATE.rules.holidays.length > 0 
                                ? `<strong class="text-white">${APP_STATE.rules.holidays.length}</strong> holiday${APP_STATE.rules.holidays.length !== 1 ? 's' : ''} defined`
                                : 'No holidays defined yet'}
                        </div>
                    </div>

                    <!-- Save Button -->
                    <button onclick="saveRules()" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded text-sm font-semibold">
                        üíæ Save Rules
                    </button>
                </div>
            `;
        }

        function saveRules() {
            // Save operational rules from form
            APP_STATE.rules.operational.clinker_shortage_response = 
                document.getElementById('ruleClikerShortage').value;
            
            APP_STATE.rules.operational.campaign_minimum_hours = 
                parseInt(document.getElementById('ruleCampaignMinHours').value) || 24;
            
            APP_STATE.rules.operational.changeover_time_hours = 
                parseFloat(document.getElementById('ruleChangeoverHours').value) || 0;
            
            const operatingMode = document.querySelector('input[name="operatingMode"]:checked');
            if (operatingMode) {
                APP_STATE.rules.operational.default_operating_mode = operatingMode.value;
            }

            // Save to localStorage
            saveToLocalStorage();
            
            alert('‚úÖ Rules saved successfully!');
        }

        function moveProductPriorityUp(productId) {
            const priorities = APP_STATE.rules.operational.product_priorities;
            const currentPrio = priorities[productId];
            
            // Find product with priority just above
            const products = Object.keys(priorities);
            const aboveProduct = products.find(id => priorities[id] === currentPrio - 1);
            
            if (aboveProduct) {
                // Swap priorities
                priorities[productId] = currentPrio - 1;
                priorities[aboveProduct] = currentPrio;
                renderRulesPanel();
            }
        }

        function moveProductPriorityDown(productId) {
            const priorities = APP_STATE.rules.operational.product_priorities;
            const currentPrio = priorities[productId];
            
            // Find product with priority just below
            const products = Object.keys(priorities);
            const belowProduct = products.find(id => priorities[id] === currentPrio + 1);
            
            if (belowProduct) {
                // Swap priorities
                priorities[productId] = currentPrio + 1;
                priorities[belowProduct] = currentPrio;
                renderRulesPanel();
            }
        }

        
// ============================================
// PRODUCT / ACTUALS HELPERS (shared across tabs)
// ============================================
function isProductFamilyMatch(product, targets) {
    const fam = normalizeTextKey(product?.family || product?.category || product?.type || '');
    const code = normalizeTextKey(product?.code || '');
    const name = normalizeTextKey(product?.name || '');
    const aliases = new Set([fam, code, name]);
    const expanded = new Set();
    aliases.forEach(v => {
        expanded.add(v);
        if (v.includes('cement')) expanded.add('cementitious');
        if (v.includes('finish')) expanded.add('finished');
        if (v.includes('intermediate') || v.includes('clinker') || v.includes('raw meal') || v.includes('raw_meal')) expanded.add('intermediate');
        if (v.includes('raw')) expanded.add('raw_material');
        if (v.includes('fuel')) expanded.add('fuel');
    });
    return (targets || []).some(t => expanded.has(normalizeTextKey(t)));
}

function getFinishedProductsForFacility(facilityId) {
    const allFinished = Object.values(APP_STATE.products || {}).filter(p =>
        isProductFamilyMatch(p, ['cementitious','cementitious_products','finished','finished_product','finished_products','portland_cement','blended_cement','specialty_cement'])
    );
    if (!facilityId) return allFinished;
    const filtered = allFinished.filter(p => !p.facilityId || String(p.facilityId) === String(facilityId));
    // Fallback: if facility-specific metadata is missing/misaligned, still show finished products
    return filtered.length ? filtered : allFinished;
}

function getIntermediateProductsForFacility(facilityId) {
    return Object.values(APP_STATE.products || {}).filter(p => {
        const ok = isProductFamilyMatch(p, ['intermediate']);
        if (!ok) return false;
        if (!facilityId) return true;
        return !p.facilityId || String(p.facilityId) === String(facilityId);
    });
}

function getActualShipmentQtyForProductDate(productId, dateStr, facilityId) {
    return (APP_STATE.actuals?.shipments || [])
        .filter(r => r.date === dateStr && String(r.productId) === String(productId) && (!facilityId || String(r.facilityId) === String(facilityId)))
        .reduce((s, r) => s + Number(r.quantityStn || 0), 0);
}

function getActualProductionQtyForProductDate(productId, dateStr, facilityId, equipmentId=null) {
    return (APP_STATE.actuals?.production || [])
        .filter(r => r.date === dateStr && String(r.productId) === String(productId) &&
            (!facilityId || String(r.facilityId) === String(facilityId)) &&
            (!equipmentId || String(r.equipmentId) === String(equipmentId)))
        .reduce((s, r) => s + Number(r.quantityStn || 0), 0);
}

// ============================================
        // TAB 3: DEMAND PLANNING
        // ============================================
        
        function renderDemandPlanningTab() {
            const facilityId = APP_STATE.currentLocation || '';
            const products = getFinishedProductsForFacility(facilityId);

            if (products.length === 0) {
                return `
                    <div class="p-6">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
                            <svg class="w-16 h-16 mx-auto text-yellow-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">No Cement Products Defined</h3>
                            <p class="text-gray-600 mb-4">Define cement products (Portland, Blended, or Specialty) in Tab 1 first</p>
                            <button onclick="switchTab('products')" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                                Go to Products & Recipes
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // Get date range: 30 days back + today + 60 days forward
            const today = new Date(APP_STATE.currentDate);
            const startDate = new Date(today);
            startDate.setDate(startDate.getDate() - 30);
            
            const endDate = new Date(today);
            endDate.setDate(endDate.getDate() + 60);
            
            const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            
            return `
                <div class="bg-white border-b border-gray-200 px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Demand Planning</h2>
                            <p class="text-sm text-gray-500">Daily demand forecast for cement products (TPD)</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="flex items-center space-x-2 text-sm">
                                <div class="flex items-center space-x-1">
                                    <div class="w-3 h-3 bg-white border border-gray-300"></div>
                                    <span class="text-gray-600">Working Day</span>
                                </div>
                                <div class="flex items-center space-x-1 ml-3">
                                    <div class="w-3 h-3 bg-blue-50 border border-blue-200"></div>
                                    <span class="text-gray-600">Today</span>
                                </div>
                                <div class="flex items-center space-x-1 ml-3">
                                    <div class="w-3 h-3 bg-red-100 border border-red-300"></div>
                                    <span class="text-gray-600">Holiday</span>
                                </div>
                            </div>
                            <button onclick="clearAllDemandData()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 text-sm font-semibold">
                                üóëÔ∏è Clear All
                            </button>
                            <button onclick="openHolidaysPanel()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm font-semibold">
                                üóìÔ∏è Holidays
                            </button>
                            <button onclick="exportDemandData()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
                                üì• Export
                            </button>
                        </div>
                    </div>
                </div>

                <div class="p-6">
                    ${renderDemandGrid(products, startDate, totalDays, today)}
                </div>
            `;
        }

        function renderDemandGrid(products, startDate, totalDays, today) {
            // Use shared date header generation
            const dateHeaders = generateDateHeaders(startDate, totalDays, today);
            
            // Group dates by year and month - MORE CAREFULLY
            const yearGroups = {};
            
            dateHeaders.forEach(header => {
                const dateObj = header.date;
                const year = dateObj.getFullYear().toString(); // "2026"
                const month = dateObj.getMonth(); // 0-11
                const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`; // "2026-01"
                
                if (!yearGroups[year]) {
                    yearGroups[year] = {
                        year: year,
                        yearShort: year.substring(2, 4), // "26"
                        months: {}
                    };
                }
                
                if (!yearGroups[year].months[monthKey]) {
                    // Get month name from actual date
                    const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
                    yearGroups[year].months[monthKey] = {
                        key: monthKey,
                        dates: [],
                        monthName: monthNames[month],
                        year: year.substring(2, 4),
                        monthNumber: month
                    };
                }
                
                yearGroups[year].months[monthKey].dates.push(header);
            });
            
            // Sort months within each year
            Object.values(yearGroups).forEach(yearGroup => {
                const sortedMonths = {};
                Object.keys(yearGroup.months)
                    .sort()
                    .forEach(key => {
                        sortedMonths[key] = yearGroup.months[key];
                    });
                yearGroup.months = sortedMonths;
            });
            
            const years = Object.values(yearGroups);
            
            // Check collapsed state
            if (!APP_STATE.demandPlanning) APP_STATE.demandPlanning = { collapsedMonths: [], collapsedYears: [] };
            const collapsedMonths = APP_STATE.demandPlanning.collapsedMonths || [];
            const collapsedYears = APP_STATE.demandPlanning.collapsedYears || [];
            
            return `
                <style>
                    .weekend-border-left {
                        border-left: 2px solid #fca5a5 !important;
                    }
                    .weekend-border-right {
                        border-right: 2px solid #fca5a5 !important;
                    }
                    .demand-product-col {
                        width: 200px !important;
                        min-width: 200px !important;
                        max-width: 200px !important;
                    }
                    /* Remove spinner arrows from number inputs */
                    .demand-input::-webkit-outer-spin-button,
                    .demand-input::-webkit-inner-spin-button {
                        -webkit-appearance: none;
                        margin: 0;
                    }
                    .demand-input[type=number] {
                        -moz-appearance: textfield;
                    }
                </style>
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 mx-6 mb-6 overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-100 border-b-2 border-gray-300">
                                <th class="sticky left-0 bg-gray-100 z-10 px-4 py-3 text-left font-semibold text-gray-700 border-r border-gray-300 demand-product-col">
                                    Product
                                </th>
                                ${years.map(yearGroup => {
                                    const isYearCollapsed = collapsedYears.includes(yearGroup.year);
                                    
                                    if (isYearCollapsed) {
                                        // Show only year total when collapsed
                                        return `
                                            <th class="px-3 py-2 text-center bg-purple-100 border-l-4 border-purple-400" style="min-width: 100px;">
                                                <div class="flex items-center justify-center space-x-1 cursor-pointer" onclick="toggleYearCollapse('${yearGroup.year}')">
                                                    <span class="text-sm font-bold text-purple-900">‚ñ∂ 20${yearGroup.yearShort}</span>
                                                </div>
                                            </th>
                                        `;
                                    }
                                    
                                    // Show months
                                    const months = Object.values(yearGroup.months);
                                    return months.map(month => {
                                        const isMonthCollapsed = collapsedMonths.includes(month.key);
                                        
                                        if (isMonthCollapsed) {
                                            // Show only month total when collapsed
                                            return `
                                                <th class="px-3 py-2 text-center bg-blue-100 border-l-2 border-blue-300" style="min-width: 100px;">
                                                    <div class="flex items-center justify-center space-x-1 cursor-pointer" onclick="toggleMonthCollapse('${month.key}')">
                                                        <span class="text-sm font-bold text-blue-900">${month.monthName} ${month.year} ‚ñ∂</span>
                                                    </div>
                                                </th>
                                            `;
                                        }
                                        
                                        // Show all days FIRST, THEN month total at end
                                        const dayHeaders = month.dates.map((header, index) => {
                                            const isHoliday = isDateHoliday(header.dateStr);
                                            let bgClass = 'bg-gray-100';
                                            if (header.isWeekend) bgClass = 'bg-gray-200';
                                            if (isHoliday) bgClass = 'bg-red-100';
                                            if (header.isToday) bgClass = 'bg-blue-100';
                                            
                                            // Add red borders for weekend separation
                                            const prevHeader = index > 0 ? month.dates[index - 1] : null;
                                            const nextHeader = index < month.dates.length - 1 ? month.dates[index + 1] : null;
                                            
                                            let borderClass = '';
                                            if (header.isWeekend && (!prevHeader || !prevHeader.isWeekend)) {
                                                borderClass += ' weekend-border-left';
                                            }
                                            if (header.isWeekend && (!nextHeader || !nextHeader.isWeekend)) {
                                                borderClass += ' weekend-border-right';
                                            }
                                            
                                            return `
                                                <th class="px-3 py-2 text-center border-l border-gray-200 ${bgClass} ${borderClass}" style="min-width: 80px;">
                                                    <div class="text-xs font-semibold text-gray-600">${header.dayName}</div>
                                                    <div class="text-sm font-bold text-gray-900">${header.day}</div>
                                                    ${isHoliday ? '<div class="text-xs text-red-600">üóìÔ∏è</div>' : ''}
                                                </th>
                                            `;
                                        }).join('');
                                        
                                        // Month total column at END with collapse arrow
                                        const monthTotalHeader = `
                                            <th class="px-3 py-2 text-center bg-blue-100 border-l-2 border-blue-300" style="min-width: 100px;">
                                                <div class="cursor-pointer" onclick="toggleMonthCollapse('${month.key}')">
                                                    <div class="text-sm font-bold text-blue-900">${month.monthName} ${month.year} ‚ñº</div>
                                                </div>
                                            </th>
                                        `;
                                        
                                        return dayHeaders + monthTotalHeader;
                                    }).join('');
                                }).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${products.map(product => renderDemandProductRow(product, years, collapsedMonths, collapsedYears)).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderDemandProductRow(product, years, collapsedMonths, collapsedYears) {
            return `
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                    <td class="sticky left-0 bg-white z-10 px-4 py-3 font-semibold border-r border-gray-300 demand-product-col">
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 rounded-full" style="background-color: ${product.color};"></div>
                            <span>${product.name}</span>
                        </div>
                    </td>
                    ${years.map(yearGroup => {
                        const isYearCollapsed = collapsedYears.includes(yearGroup.year);
                        
                        if (isYearCollapsed) {
                            // Calculate year total
                            let yearTotal = 0;
                            Object.values(yearGroup.months).forEach(month => {
                                month.dates.forEach(header => {
                                    const demandData = getDemandForDate(product.id, header.dateStr);
                                    yearTotal += demandData.value || 0;
                                });
                            });
                            
                            return `
                                <td class="border-l-4 border-purple-400 bg-purple-50 px-3 py-2 text-center font-bold text-purple-900">
                                    ${Math.round(yearTotal).toLocaleString()}
                                </td>
                            `;
                        }
                        
                        // Show months
                        const months = Object.values(yearGroup.months);
                        return months.map(month => {
                            const isMonthCollapsed = collapsedMonths.includes(month.key);
                            
                            // Calculate month total
                            let monthTotal = 0;
                            month.dates.forEach(header => {
                                const demandData = getDemandForDate(product.id, header.dateStr);
                                monthTotal += demandData.value || 0;
                            });
                            
                            if (isMonthCollapsed) {
                                // Show only month total when collapsed
                                return `
                                    <td class="border-l-2 border-blue-300 bg-blue-50 px-3 py-2 text-center font-bold text-blue-900">
                                        <span id="monthtotal_${product.id}_${month.key}">${Math.round(monthTotal).toLocaleString()}</span>
                                    </td>
                                `;
                            }
                            
                            // Show all day cells + month total at end
                            const dayCells = month.dates.map((header, index) => {
                                const demandData = getDemandForDate(product.id, header.dateStr);
                                const value = demandData.value || 0;
                                const isHoliday = isDateHoliday(header.dateStr);
                                
                                let bgClass = 'bg-white';
                                if (isHoliday) {
                                    bgClass = 'bg-red-50';
                                } else if (header.isToday) {
                                    bgClass = 'bg-blue-50';
                                }
                                
                                if (header.isWeekend && !isHoliday) {
                                    bgClass = 'bg-gray-50';
                                }
                                
                                // Add red borders for weekend separation
                                const prevHeader = index > 0 ? month.dates[index - 1] : null;
                                const nextHeader = index < month.dates.length - 1 ? month.dates[index + 1] : null;
                                
                                let borderClass = '';
                                if (header.isWeekend && (!prevHeader || !prevHeader.isWeekend)) {
                                    borderClass += ' weekend-border-left';
                                }
                                if (header.isWeekend && (!nextHeader || !nextHeader.isWeekend)) {
                                    borderClass += ' weekend-border-right';
                                }
                                
                                return `
                                    <td class="border-l border-gray-200 ${bgClass} ${borderClass}">
                                        <input type="number" 
                                               id="demand_${product.id}_${header.dateStr}"
                                               value="${value}" 
                                               min="0"
                                               ${isHoliday ? 'disabled' : ''}
                                               data-product-id="${product.id}"
                                               data-product-name="${product.name.replace(/'/g, '&apos;')}"
                                               data-date="${header.dateStr}"
                                               data-month-key="${month.key}"
                                               oninput="updateDemandValueLive('${product.id}', '${header.dateStr}', '${month.key}', parseFloat(this.value) || 0)"
                                               onfocus="this.select()"
                                               onkeydown="handleDemandKeyNavigation(event, '${product.id}', '${header.dateStr}')"
                                               oncontextmenu="showForecastDialog(event, '${product.id}', '${header.dateStr}'); return false;"
                                               class="demand-input w-full px-2 py-2 text-center text-sm border-0 ${bgClass} ${isHoliday ? 'cursor-not-allowed opacity-60' : ''} focus:ring-2 focus:ring-blue-500"
                                               style="min-width: 80px;"
                                               title="${isHoliday ? 'Holiday - No production' : 'Right-click for forecast'}">
                                    </td>
                                `;
                            }).join('');
                            
                            // Month total cell at END
                            const monthTotalCell = `
                                <td class="border-l-2 border-blue-300 bg-blue-50 px-3 py-2 text-center font-bold text-blue-900">
                                    <span id="monthtotal_${product.id}_${month.key}">${Math.round(monthTotal).toLocaleString()}</span>
                                </td>
                            `;
                            
                            return dayCells + monthTotalCell;
                        }).join('');
                    }).join('')}
                </tr>
            `;
        }

        function getDemandForDate(productId, dateStr) {
            if (!APP_STATE.demandPlan) APP_STATE.demandPlan = {};
            if (!APP_STATE.demandPlan[productId]) APP_STATE.demandPlan[productId] = {};
            
            return APP_STATE.demandPlan[productId][dateStr] || { value: 0, type: 'forecast' };
        }

        function updateDemandValue(productId, dateStr, value) {
            if (!APP_STATE.demandPlan) APP_STATE.demandPlan = {};
            if (!APP_STATE.demandPlan[productId]) APP_STATE.demandPlan[productId] = {};
            
            APP_STATE.demandPlan[productId][dateStr] = {
                value: value,
                type: 'forecast' // Can be 'actual' or 'forecast'
            };
            
            saveToLocalStorage();
        }

        function updateDemandValueLive(productId, dateStr, monthKey, value) {
            // Update the value
            if (!APP_STATE.demandPlan) APP_STATE.demandPlan = {};
            if (!APP_STATE.demandPlan[productId]) APP_STATE.demandPlan[productId] = {};
            
            APP_STATE.demandPlan[productId][dateStr] = {
                value: value,
                type: 'forecast'
            };
            
            // Recalculate month total LIVE
            let monthTotal = 0;
            const allInputs = document.querySelectorAll(`input[data-product-id="${productId}"][data-month-key="${monthKey}"]`);
            allInputs.forEach(input => {
                const val = parseFloat(input.value) || 0;
                monthTotal += val;
            });
            
            // Update the month total display
            const totalElement = document.getElementById(`monthtotal_${productId}_${monthKey}`);
            if (totalElement) {
                totalElement.textContent = Math.round(monthTotal).toLocaleString();
            }
            
            saveToLocalStorage();
        }

        function handleDemandKeyNavigation(event, currentProductId, currentDateStr) {
            const key = event.key;
            
            // Only handle arrow keys
            if (!['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(key)) {
                return;
            }
            
            event.preventDefault();
            
            const allInputs = Array.from(document.querySelectorAll('.demand-input:not([disabled])'));
            const currentIndex = allInputs.findIndex(input => 
                input.dataset.productId === currentProductId && 
                input.dataset.date === currentDateStr
            );
            
            if (currentIndex === -1) return;
            
            let targetIndex = currentIndex;
            
            // Get table dimensions (number of date columns)
            const firstProductInputs = allInputs.filter(input => 
                input.dataset.productId === currentProductId
            );
            const columnsPerRow = firstProductInputs.length;
            
            switch(key) {
                case 'ArrowLeft':
                    targetIndex = currentIndex - 1;
                    break;
                case 'ArrowRight':
                    targetIndex = currentIndex + 1;
                    break;
                case 'ArrowUp':
                    targetIndex = currentIndex - columnsPerRow;
                    break;
                case 'ArrowDown':
                    targetIndex = currentIndex + columnsPerRow;
                    break;
            }
            
            // Focus the target input if it exists
            if (targetIndex >= 0 && targetIndex < allInputs.length) {
                allInputs[targetIndex].focus();
                allInputs[targetIndex].select();
            }
        }

        // ============================================
        // FORECASTING FEATURE
        // ============================================

        function showForecastDialog(event, productId, dateStr) {
            event.preventDefault();
            
            const input = event.target;
            const productName = input.dataset.productName || 'Product';
            
            // Calculate moving averages
            const averages = calculateMovingAverages(productId, dateStr);
            
            // Detect weekend pattern
            const weekendPattern = detectWeekendPattern(productId, dateStr);
            
            // Suggest forecast based on weighted average (more weight on recent data)
            let suggestedForecast = 0;
            if (averages.avg7 > 0) {
                suggestedForecast = Math.round((averages.avg7 * 0.5 + averages.avg10 * 0.3 + averages.avg30 * 0.2) / 25) * 25;
            } else if (averages.avg10 > 0) {
                suggestedForecast = Math.round((averages.avg10 * 0.6 + averages.avg30 * 0.4) / 25) * 25;
            } else if (averages.avg30 > 0) {
                suggestedForecast = Math.round(averages.avg30 / 25) * 25;
            } else {
                suggestedForecast = 100; // Default if no history
            }
            
            // Format date
            const date = new Date(dateStr + 'T00:00:00');
            const formattedDate = date.toLocaleDateString('en-US', { 
                weekday: 'short',
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
            
            // Weekend pattern display
            let weekendPatternText = 'No weekend pattern detected';
            if (weekendPattern.detected) {
                const satText = weekendPattern.saturday > 0 ? `${weekendPattern.saturday} TPD` : '0';
                const sunText = weekendPattern.sunday > 0 ? `${weekendPattern.sunday} TPD` : '0';
                weekendPatternText = `Sat: ${satText}, Sun: ${sunText}`;
            }
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'forecastModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-5 py-3 rounded-t-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <span class="text-xl">üìä</span>
                                <div>
                                    <h3 class="text-base font-semibold">${productName}</h3>
                                    <p class="text-xs text-blue-100">${formattedDate}</p>
                                </div>
                            </div>
                            <button onclick="closeForecastDialog()" class="text-white hover:text-gray-200">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-5">
                        <!-- Historical Buttons -->
                        <div class="mb-4">
                            <div class="grid grid-cols-3 gap-2 mb-2">
                                <button onclick="selectForecastPeriod(7, ${averages.avg7})" 
                                        id="period_7"
                                        class="period-btn border-2 border-gray-300 rounded-lg p-2 text-center hover:border-blue-500 hover:bg-blue-50 transition-all">
                                    <div class="text-xs font-semibold text-gray-600">Roll_7d</div>
                                    <div class="text-lg font-bold text-gray-900">${averages.avg7 > 0 ? Math.round(averages.avg7) : 'N/A'}</div>
                                </button>
                                <button onclick="selectForecastPeriod(10, ${averages.avg10})" 
                                        id="period_10"
                                        class="period-btn border-2 border-gray-300 rounded-lg p-2 text-center hover:border-blue-500 hover:bg-blue-50 transition-all">
                                    <div class="text-xs font-semibold text-gray-600">Roll_10d</div>
                                    <div class="text-lg font-bold text-gray-900">${averages.avg10 > 0 ? Math.round(averages.avg10) : 'N/A'}</div>
                                </button>
                                <button onclick="selectForecastPeriod(30, ${averages.avg30})" 
                                        id="period_30"
                                        class="period-btn border-2 border-gray-300 rounded-lg p-2 text-center hover:border-blue-500 hover:bg-blue-50 transition-all">
                                    <div class="text-xs font-semibold text-gray-600">Roll_30d</div>
                                    <div class="text-lg font-bold text-gray-900">${averages.avg30 > 0 ? Math.round(averages.avg30) : 'N/A'}</div>
                                </button>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs text-gray-600">Custom:</span>
                                <input type="number" 
                                       id="customDays" 
                                       placeholder="Days"
                                       min="1"
                                       max="90"
                                       class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm"
                                       onchange="selectCustomPeriod(this.value)">
                                <span class="text-xs text-gray-600">days</span>
                            </div>
                        </div>
                        
                        <!-- Forecast Value -->
                        <div class="mb-4 bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-3 border border-gray-200">
                            <div class="text-center mb-2">
                                <div class="text-3xl font-bold text-blue-600" id="forecastValue">${suggestedForecast.toLocaleString()}</div>
                                <div class="text-xs text-gray-600">tons per day</div>
                            </div>
                            
                            <div class="flex items-center justify-center space-x-1 mb-2">
                                <button onclick="adjustForecast(-100)" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs font-bold">
                                    -100
                                </button>
                                <button onclick="adjustForecast(-25)" class="bg-orange-500 hover:bg-orange-600 text-white px-2 py-1 rounded text-xs font-bold">
                                    -25
                                </button>
                                <button onclick="adjustForecast(25)" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs font-bold">
                                    +25
                                </button>
                                <button onclick="adjustForecast(100)" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs font-bold">
                                    +100
                                </button>
                            </div>
                            
                            <input type="range" 
                                   id="forecastSlider" 
                                   min="0" 
                                   max="5000" 
                                   step="25" 
                                   value="${suggestedForecast}"
                                   oninput="updateForecastDisplay(this.value)"
                                   class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer slider-thumb">
                        </div>
                        
                        <!-- Range Selection Buttons -->
                        <div class="mb-4">
                            <h4 class="text-xs font-semibold text-gray-700 mb-2">Apply To:</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="selectRange('single')" 
                                        id="range_single"
                                        class="range-btn border-2 border-blue-500 bg-blue-50 rounded-lg p-2 text-center hover:bg-blue-100 transition-all">
                                    <div class="text-xs font-semibold text-blue-900">DATE</div>
                                    <div class="text-xs font-semibold text-blue-900">ONLY</div>
                                </button>
                                <button onclick="selectRange('month')" 
                                        id="range_month"
                                        class="range-btn border-2 border-gray-300 rounded-lg p-2 text-center hover:border-blue-500 hover:bg-blue-50 transition-all">
                                    <div class="text-xs font-semibold text-gray-700">End</div>
                                    <div class="text-xs font-semibold text-gray-700">Month</div>
                                </button>
                                <button onclick="selectRange('year')" 
                                        id="range_year"
                                        class="range-btn border-2 border-gray-300 rounded-lg p-2 text-center hover:border-blue-500 hover:bg-blue-50 transition-all">
                                    <div class="text-xs font-semibold text-gray-700">End</div>
                                    <div class="text-xs font-semibold text-gray-700">Year</div>
                                </button>
                                <button onclick="selectRange('custom'); document.getElementById('customRangeDays').focus()" 
                                        id="range_custom"
                                        class="range-btn border-2 border-gray-300 rounded-lg p-2 text-center hover:border-blue-500 hover:bg-blue-50 transition-all">
                                    <div class="text-xs font-semibold text-gray-700">Days:</div>
                                    <input type="number" 
                                           id="customRangeDays" 
                                           placeholder="#"
                                           min="1"
                                           onclick="event.stopPropagation(); selectRange('custom')"
                                           class="w-full text-center text-xs font-semibold border-0 bg-transparent focus:outline-none">
                                </button>
                            </div>
                        </div>
                        
                        <!-- Weekend Pattern -->
                        <div class="mb-4 bg-purple-50 border border-purple-200 rounded p-2">
                            <p class="text-xs text-purple-900">
                                <strong>Weekend:</strong> ${weekendPatternText}
                            </p>
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex space-x-2">
                            <button onclick="closeForecastDialog()" 
                                    class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-lg font-semibold text-sm">
                                Cancel
                            </button>
                            <button onclick="applyForecast('${productId}', '${dateStr}')" 
                                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold text-sm">
                                Apply
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add custom slider styling
            const style = document.createElement('style');
            style.textContent = `
                .slider-thumb::-webkit-slider-thumb {
                    appearance: none;
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    background: #2563eb;
                    cursor: pointer;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                }
                .slider-thumb::-moz-range-thumb {
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    background: #2563eb;
                    cursor: pointer;
                    border: none;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                }
                .period-btn.selected {
                    border-color: #2563eb !important;
                    background-color: #dbeafe !important;
                }
                .range-btn.selected {
                    border-color: #2563eb !important;
                    background-color: #dbeafe !important;
                }
            `;
            
            document.body.appendChild(style);
            document.body.appendChild(modal);
            
            // Store weekend pattern data
            window.currentWeekendPattern = weekendPattern;
            window.currentForecastDate = dateStr;
            window.currentSelectedRange = 'single';
        }

        function calculateMovingAverages(productId, targetDateStr) {
            const targetDate = new Date(targetDateStr + 'T00:00:00');
            const productData = APP_STATE.demandPlan[productId] || {};
            
            // Helper function to get past dates
            const getPastDates = (days) => {
                const dates = [];
                for (let i = 1; i <= days; i++) {
                    const date = new Date(targetDate);
                    date.setDate(date.getDate() - i);
                    dates.push(getDateString(date));
                }
                return dates;
            };
            
            // Calculate average for a period, excluding weekends and holidays
            const calculateAvg = (dates) => {
                let sum = 0;
                let count = 0;
                
                dates.forEach(dateStr => {
                    const date = new Date(dateStr + 'T00:00:00');
                    const dayOfWeek = date.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    const isHoliday = isDateHoliday(dateStr);
                    
                    // Only include working days
                    if (!isWeekend && !isHoliday && productData[dateStr]) {
                        const value = productData[dateStr].value || 0;
                        if (value > 0) { // Only count non-zero values
                            sum += value;
                            count++;
                        }
                    }
                });
                
                return count > 0 ? sum / count : 0;
            };
            
            return {
                avg7: calculateAvg(getPastDates(7)),
                avg10: calculateAvg(getPastDates(10)),
                avg30: calculateAvg(getPastDates(30))
            };
        }

        function detectWeekendPattern(productId, targetDateStr) {
            const targetDate = new Date(targetDateStr + 'T00:00:00');
            const productData = APP_STATE.demandPlan[productId] || {};
            
            // Look back 4 weekends (28 days)
            const saturdays = [];
            const sundays = [];
            
            for (let i = 1; i <= 28; i++) {
                const date = new Date(targetDate);
                date.setDate(date.getDate() - i);
                const dateStr = getDateString(date);
                const dayOfWeek = date.getDay();
                
                if (dayOfWeek === 6) { // Saturday
                    const value = (productData[dateStr] && productData[dateStr].value) || 0;
                    saturdays.push(value);
                } else if (dayOfWeek === 0) { // Sunday
                    const value = (productData[dateStr] && productData[dateStr].value) || 0;
                    sundays.push(value);
                }
            }
            
            // Function to calculate pattern value based on rule:
            // If most are 0 ‚Üí 0, if most are non-zero ‚Üí average of non-zeros
            const calculatePatternValue = (values) => {
                if (values.length === 0) return 0;
                
                const nonZeroValues = values.filter(v => v > 0);
                const zeroCount = values.length - nonZeroValues.length;
                
                // If most are zero, return 0
                if (zeroCount > nonZeroValues.length) {
                    return 0;
                }
                
                // Otherwise, average the non-zero values and round to 25
                if (nonZeroValues.length > 0) {
                    const avg = nonZeroValues.reduce((a, b) => a + b, 0) / nonZeroValues.length;
                    return Math.round(avg / 25) * 25;
                }
                
                return 0;
            };
            
            const saturdayValue = calculatePatternValue(saturdays);
            const sundayValue = calculatePatternValue(sundays);
            
            return {
                detected: saturdays.length > 0 || sundays.length > 0,
                saturday: saturdayValue,
                sunday: sundayValue,
                saturdayRatio: 0, // Will be calculated when applying
                sundayRatio: 0    // Will be calculated when applying
            };
        }

        function selectForecastPeriod(days, avgValue) {
            // Highlight selected button
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById(`period_${days}`).classList.add('selected');
            
            // Update forecast value (rounded to 25)
            const rounded = Math.round(avgValue / 25) * 25;
            updateForecastDisplay(rounded);
        }

        function selectCustomPeriod(days) {
            const numDays = parseInt(days);
            if (!numDays || numDays < 1) return;
            
            // Calculate custom average (need to extract productId and dateStr from modal context)
            const modal = document.getElementById('forecastModal');
            if (!modal) return;
            
            // Highlight custom period
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('selected'));
            
            // For now, just clear the selection since we'd need to recalculate
            // In a full implementation, we'd calculate the custom period average here
            alert(`Custom ${numDays}-day average calculation would go here`);
        }

        function selectRange(rangeType) {
            // Update UI
            document.querySelectorAll('.range-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById(`range_${rangeType}`).classList.add('selected');
            
            // Store selection
            window.currentSelectedRange = rangeType;
        }

        function updateForecastDisplay(value) {
            // Round to nearest 25
            const rounded = Math.round(value / 25) * 25;
            document.getElementById('forecastValue').textContent = rounded.toLocaleString();
            document.getElementById('forecastSlider').value = rounded;
            document.getElementById('forecastDirectInput').value = rounded;
        }

        function adjustForecast(amount) {
            const slider = document.getElementById('forecastSlider');
            const currentValue = parseInt(slider.value);
            const newValue = Math.max(0, Math.min(5000, currentValue + amount));
            const rounded = Math.round(newValue / 25) * 25;
            updateForecastDisplay(rounded);
        }

        function setForecastFromInput(value) {
            const numValue = parseInt(value) || 0;
            const rounded = Math.round(numValue / 25) * 25;
            const clamped = Math.max(0, Math.min(5000, rounded));
            updateForecastDisplay(clamped);
        }

        function applyForecast(productId, startDateStr) {
            const forecastValue = parseInt(document.getElementById('forecastValue').textContent.replace(/,/g, ''));
            const weekendPattern = window.currentWeekendPattern || { detected: false, saturday: 0, sunday: 0 };
            
            // Get selected range
            const rangeType = window.currentSelectedRange || 'single';
            
            let endDateStr = startDateStr;
            const startDate = new Date(startDateStr + 'T00:00:00');
            
            // Determine end date based on selection
            if (rangeType === 'month') {
                const endDate = new Date(startDate);
                endDate.setMonth(endDate.getMonth() + 1);
                endDate.setDate(0);
                endDateStr = getDateString(endDate);
            } else if (rangeType === 'year') {
                const endDate = new Date(startDate);
                endDate.setMonth(11);
                endDate.setDate(31);
                endDateStr = getDateString(endDate);
            } else if (rangeType === 'custom') {
                const customDays = parseInt(document.getElementById('customRangeDays').value);
                if (customDays && customDays > 0) {
                    const endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + customDays - 1);
                    endDateStr = getDateString(endDate);
                } else {
                    alert('Please enter number of days');
                    return;
                }
            }
            
            // Calculate weekend values based on detected pattern
            // If pattern detected, use historical ratios, otherwise use 0
            let saturdayForecast = 0;
            let sundayForecast = 0;
            
            if (weekendPattern.detected && weekendPattern.saturday > 0) {
                // Calculate ratio from historical weekday average
                const weekdayAvg = calculateWeekdayAverage(productId, startDateStr);
                if (weekdayAvg > 0) {
                    const satRatio = weekendPattern.saturday / weekdayAvg;
                    saturdayForecast = Math.round((forecastValue * satRatio) / 25) * 25;
                }
            }
            
            if (weekendPattern.detected && weekendPattern.sunday > 0) {
                const weekdayAvg = calculateWeekdayAverage(productId, startDateStr);
                if (weekdayAvg > 0) {
                    const sunRatio = weekendPattern.sunday / weekdayAvg;
                    sundayForecast = Math.round((forecastValue * sunRatio) / 25) * 25;
                }
            }
            
            // Get all dates in range
            const datesToUpdate = [];
            let currentDate = new Date(startDate);
            const finalDate = new Date(endDateStr + 'T00:00:00');
            
            while (currentDate <= finalDate) {
                const dateStr = getDateString(currentDate);
                const dayOfWeek = currentDate.getDay();
                const isHoliday = isDateHoliday(dateStr);
                
                if (!isHoliday) {
                    let valueToApply = forecastValue; // Default for weekdays
                    
                    if (dayOfWeek === 6) { // Saturday
                        valueToApply = saturdayForecast;
                    } else if (dayOfWeek === 0) { // Sunday
                        valueToApply = sundayForecast;
                    }
                    
                    // Only add if value > 0 (skip days with 0 pattern)
                    if (valueToApply > 0) {
                        datesToUpdate.push({ dateStr, value: valueToApply });
                    }
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Track affected months
            const affectedMonths = new Set();
            
            // Apply forecast to all dates
            datesToUpdate.forEach(({ dateStr, value }) => {
                const input = document.getElementById(`demand_${productId}_${dateStr}`);
                if (input && !input.disabled) {
                    input.value = value;
                    
                    const monthKey = input.dataset.monthKey;
                    if (monthKey) {
                        affectedMonths.add(monthKey);
                    }
                    updateDemandValueLive(productId, dateStr, monthKey, value);
                }
            });
            
            closeForecastDialog();
            
            // Show success message
            const weekdayCount = datesToUpdate.filter(d => d.value === forecastValue).length;
            const saturdayCount = datesToUpdate.filter(d => d.value === saturdayForecast && d.value > 0).length;
            const sundayCount = datesToUpdate.filter(d => d.value === sundayForecast && d.value > 0).length;
            
            let message = `${weekdayCount} weekday${weekdayCount !== 1 ? 's' : ''} @ ${forecastValue.toLocaleString()} TPD`;
            if (saturdayCount > 0) {
                message += `, ${saturdayCount} Sat @ ${saturdayForecast.toLocaleString()} TPD`;
            }
            if (sundayCount > 0) {
                message += `, ${sundayCount} Sun @ ${sundayForecast.toLocaleString()} TPD`;
            }
            
            const successMsg = document.createElement('div');
            successMsg.className = 'fixed top-4 right-4 bg-green-600 text-gray-800 px-6 py-3 rounded-lg shadow-lg z-50';
            successMsg.innerHTML = `
                <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span><strong>Forecast applied!</strong> ${message}</span>
                </div>
            `;
            document.body.appendChild(successMsg);
            setTimeout(() => successMsg.remove(), 5000);
        }

        function calculateWeekdayAverage(productId, targetDateStr) {
            const targetDate = new Date(targetDateStr + 'T00:00:00');
            const productData = APP_STATE.demandPlan[productId] || {};
            
            let sum = 0;
            let count = 0;
            
            // Look back 28 days for weekday average
            for (let i = 1; i <= 28; i++) {
                const date = new Date(targetDate);
                date.setDate(date.getDate() - i);
                const dateStr = getDateString(date);
                const dayOfWeek = date.getDay();
                
                // Only weekdays (Mon-Fri)
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    const value = (productData[dateStr] && productData[dateStr].value) || 0;
                    if (value > 0) {
                        sum += value;
                        count++;
                    }
                }
            }
            
            return count > 0 ? sum / count : 0;
        }

        function closeForecastDialog() {
            const modal = document.getElementById('forecastModal');
            if (modal) modal.remove();
        }

        function toggleMonthCollapse(monthKey) {
            if (!APP_STATE.demandPlanning) {
                APP_STATE.demandPlanning = { collapsedMonths: [], collapsedYears: [] };
            }
            if (!APP_STATE.demandPlanning.collapsedMonths) {
                APP_STATE.demandPlanning.collapsedMonths = [];
            }
            
            const index = APP_STATE.demandPlanning.collapsedMonths.indexOf(monthKey);
            if (index > -1) {
                // Expand
                APP_STATE.demandPlanning.collapsedMonths.splice(index, 1);
            } else {
                // Collapse
                APP_STATE.demandPlanning.collapsedMonths.push(monthKey);
            }
            
            saveToLocalStorage();
            // Refresh demand planning tab
            switchTab('demand');
        }

        function toggleYearCollapse(year) {
            if (!APP_STATE.demandPlanning) {
                APP_STATE.demandPlanning = { collapsedMonths: [], collapsedYears: [] };
            }
            if (!APP_STATE.demandPlanning.collapsedYears) {
                APP_STATE.demandPlanning.collapsedYears = [];
            }
            
            const index = APP_STATE.demandPlanning.collapsedYears.indexOf(year);
            if (index > -1) {
                // Expand
                APP_STATE.demandPlanning.collapsedYears.splice(index, 1);
            } else {
                // Collapse
                APP_STATE.demandPlanning.collapsedYears.push(year);
            }
            
            saveToLocalStorage();
            // Refresh demand planning tab
            switchTab('demand');
        }

        function exportDemandData() {
            const data = {
                demandPlan: APP_STATE.demandPlan,
                products: APP_STATE.products,
                exportedAt: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `demand_plan_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Demand data exported!');
        }

        function clearAllDemandData() {
            if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL demand planning data!\n\nAre you sure you want to continue?')) {
                return;
            }
            
            if (!confirm('This action cannot be undone. Clear all demand data?')) {
                return;
            }
            
            // Clear demand plan
            APP_STATE.demandPlan = {};
            
            // Save to localStorage
            saveToLocalStorage();
            
            // Refresh the view
            switchTab('demand');
            
            // Show success message
            alert('‚úÖ All demand data has been cleared!');
        }

        // ============================================
        // HOLIDAYS MANAGEMENT
        // ============================================

        function isDateHoliday(dateStr) {
            if (!APP_STATE.rules || !APP_STATE.rules.holidays) return false;
            return APP_STATE.rules.holidays.includes(dateStr);
        }

        function openHolidaysPanel() {
            const modal = document.createElement('div');
            modal.id = 'holidaysModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col">
                    <div class="bg-purple-600 text-white px-6 py-4 flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <span class="text-2xl">üóìÔ∏è</span>
                            <h3 class="text-lg font-semibold">Holidays & Non-Working Days</h3>
                        </div>
                        <button onclick="closeHolidaysPanel()" class="text-white hover:text-gray-200">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="p-6 flex-1 overflow-y-auto">
                        <div class="mb-4">
                            <p class="text-sm text-gray-600 mb-4">
                                Mark days when production does not run (holidays, maintenance shutdowns, etc.)
                            </p>
                            
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                                <h4 class="font-semibold text-sm text-blue-900 mb-2">Add Holiday</h4>
                                <div class="flex items-center space-x-2">
                                    <input type="date" id="newHolidayDate" 
                                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <input type="text" id="newHolidayName" 
                                           placeholder="Holiday name (optional)"
                                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <button onclick="addHoliday()" 
                                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm font-semibold whitespace-nowrap">
                                        + Add
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-sm text-gray-700 mb-2">Current Holidays (${APP_STATE.rules.holidays ? APP_STATE.rules.holidays.length : 0})</h4>
                            <div id="holidaysList" class="space-y-2">
                                ${renderHolidaysList()}
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 px-6 py-4 flex items-center justify-between border-t">
                        <div class="text-sm text-gray-600">
                            <strong>Note:</strong> Holidays affect simulation and demand planning
                        </div>
                        <button onclick="closeHolidaysPanel()" 
                                class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 text-sm font-semibold">
                            Done
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeHolidaysPanel() {
            const modal = document.getElementById('holidaysModal');
            if (modal) modal.remove();
            // Refresh demand planning if on that tab
            const activeTab = document.querySelector('.tab-button.active');
            if (activeTab && activeTab.dataset.tab === 'demand') {
                switchTab('demand');
            }
        }

        function renderHolidaysList() {
            if (!APP_STATE.rules.holidays || APP_STATE.rules.holidays.length === 0) {
                return '<div class="text-sm text-gray-500 text-center py-4">No holidays defined yet</div>';
            }
            
            // Group holidays by year-month for better organization
            const sortedHolidays = [...APP_STATE.rules.holidays].sort();
            
            return sortedHolidays.map(dateStr => {
                const date = new Date(dateStr + 'T00:00:00');
                const formatted = date.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                return `
                    <div class="flex items-center justify-between bg-red-50 border border-red-200 rounded px-3 py-2">
                        <div class="flex items-center space-x-2">
                            <span class="text-red-600">üóìÔ∏è</span>
                            <span class="text-sm font-medium text-gray-900">${formatted}</span>
                        </div>
                        <button onclick="removeHoliday('${dateStr}')" 
                                class="text-red-600 hover:text-red-800 text-xs">
                            Remove
                        </button>
                    </div>
                `;
            }).join('');
        }

        function addHoliday() {
            const dateInput = document.getElementById('newHolidayDate');
            const nameInput = document.getElementById('newHolidayName');
            
            if (!dateInput.value) {
                alert('Please select a date');
                return;
            }
            
            const dateStr = dateInput.value; // Already in YYYY-MM-DD format
            
            if (!APP_STATE.rules.holidays) {
                APP_STATE.rules.holidays = [];
            }
            
            if (APP_STATE.rules.holidays.includes(dateStr)) {
                alert('This date is already marked as a holiday');
                return;
            }
            
            APP_STATE.rules.holidays.push(dateStr);
            APP_STATE.rules.holidays.sort(); // Keep sorted
            
            saveToLocalStorage();
            
            // Clear inputs
            dateInput.value = '';
            nameInput.value = '';
            
            // Refresh list
            document.getElementById('holidaysList').innerHTML = renderHolidaysList();
        }

        function removeHoliday(dateStr) {
            if (!APP_STATE.rules.holidays) return;
            
            APP_STATE.rules.holidays = APP_STATE.rules.holidays.filter(d => d !== dateStr);
            saveToLocalStorage();
            
            // Refresh list
            document.getElementById('holidaysList').innerHTML = renderHolidaysList();
        }

        // ============================================
        // SHARED UTILITY: Generate Date Headers
        // ============================================
        
        function generateDateHeaders(startDate, totalDays, today) {
            const dateHeaders = [];
            for (let i = 0; i < totalDays; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + i);
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isToday = date.toDateString() === today.toDateString();
                const isPast = date < today;
                const isFuture = date > today;
                
                dateHeaders.push({
                    date: date,
                    dateStr: getDateString(date),
                    day: date.getDate(),
                    month: date.toLocaleDateString('en-US', { month: 'short' }),
                    dayName: date.toLocaleDateString('en-US', { weekday: 'short' }),
                    isWeekend: isWeekend,
                    isToday: isToday,
                    isPast: isPast,
                    isFuture: isFuture,
                    columnIndex: i
                });
            }
            return dateHeaders;
        }

        // ============================================
        // ============================================
        // TAB 4: PRODUCTION PLAN - Campaign & Inventory Management
        // ============================================
        
        function renderProductionPlanTab() {
            try {
                const today = new Date(APP_STATE.currentDate);
                const startDate = new Date(today);
                startDate.setDate(startDate.getDate() - 30);  // 30 days back
                const totalDays = 91;  // 30 past + today + 60 future
                
                const dateHeaders = generateDateHeaders(startDate, totalDays, today);
                
                return `
                    <div class="bg-white border-b border-gray-200 px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-xl font-bold text-gray-900">üè≠ Production Plan</h2>
                                <p class="text-sm text-gray-500">Campaign scheduling & inventory management</p>
                            </div>
                            <div class="flex items-center space-x-3">
                                <button onclick="openDailyActualsForm()" class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 text-sm">
                                    üìù Daily Actuals
                                </button>
                                <button onclick="openRulesPanel()" class="bg-purple-600 text-white px-3 py-2 rounded-lg hover:bg-purple-700 text-sm">
                                    ‚öôÔ∏è Rules
                                </button>
                                <button onclick="showRecommendations()" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 text-sm">
                                    üí° Suggest
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Single Unified Table -->
                    <div class="p-6">
                        ${renderUnifiedProductionTable(dateHeaders)}
                    </div>
                `;
            } catch (error) {
                console.error('Error in renderProductionPlanTab:', error);
                return `
                    <div class="p-6">
                        <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                            <h3 class="text-red-800 font-semibold mb-2">Error Loading Production Plan</h3>
                            <p class="text-red-600 text-sm">${error.message}</p>
                            <pre class="text-xs text-red-500 mt-2 overflow-auto">${error.stack}</pre>
                        </div>
                    </div>
                `;
            }
        }

        
function renderUnifiedProductionTable(dateHeaders) {
            const kilns = APP_STATE.flowDesigner.equipment.filter(e => e.type === 'kiln');
            const finishMills = APP_STATE.flowDesigner.equipment.filter(e => e.type === 'finish_mill');
            // For now only show Kilns and Finish Mills in Production Plan (Raw Mills still used in actuals/calculations)
            const allEquipment = [...kilns, ...finishMills];

            const silos = APP_STATE.flowDesigner.equipment.filter(e => e.type === 'storage');

            if (allEquipment.length === 0 && silos.length === 0) {
                return `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
                        <p class="text-yellow-800">‚ö†Ô∏è No equipment configured. Please set up equipment in Process Flow (Tab 2)</p>
                    </div>
                `;
            }

            // Calculate inventories
            const inventories = calculateInventories(dateHeaders);

            // Group dates by month for headers
            const monthGroups = {};
            dateHeaders.forEach(header => {
                const monthKey = header.date.getFullYear() + '-' + String(header.date.getMonth()).padStart(2, '0');
                if (!monthGroups[monthKey]) {
                    monthGroups[monthKey] = {
                        monthName: header.date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }),
                        dates: []
                    };
                }
                monthGroups[monthKey].dates.push(header);
            });

            // Inventory grouping in operational reading order
            const siloGroups = {
                clinker: [],
                cement: [],
                raw_material: [],
                fuel: [],
                other: []
            };
            silos.forEach(silo => {
                const k = getSiloInventoryGroupKey(silo);
                (siloGroups[k] || siloGroups.other).push(silo);
            });

            const orderedInventoryGroups = [
                { key: 'clinker', title: 'CLINKER INVENTORY', icon: 'ü™®' },
                { key: 'cement', title: 'CEMENT INVENTORY', icon: 'üèóÔ∏è' },
                { key: 'raw_material', title: 'RAW MATERIAL INVENTORY', icon: 'üì¶' },
                { key: 'fuel', title: 'FUEL INVENTORY', icon: '‚õΩ' },
                { key: 'other', title: 'OTHER INVENTORY', icon: 'üìÅ' }
            ].filter(g => (siloGroups[g.key] || []).length > 0);

            return `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead class="sticky top-0 z-20 bg-gray-100">
                                <tr class="border-b border-gray-300">
                                    <th class="sticky left-0 bg-gray-100 z-30 px-3 py-2 text-left font-semibold text-gray-700 border-r border-gray-300" style="min-width: 200px;">
                                        Section
                                    </th>
                                    ${Object.values(monthGroups).map(month => `
                                        <th colspan="${month.dates.length}" class="px-2 py-2 text-center text-sm font-semibold text-gray-700 border-l border-gray-300">
                                            ${month.monthName}
                                        </th>
                                    `).join('')}
                                </tr>
                                <tr class="border-b-2 border-gray-300">
                                    <th class="sticky left-0 bg-gray-100 z-30 px-3 py-2 border-r border-gray-300"></th>
                                    ${dateHeaders.map(header => {
                                        const isWeekend = header.date.getDay() === 0 || header.date.getDay() === 6;
                                        const isToday = header.dateStr === getDateString(new Date(APP_STATE.currentDate));
                                        let bgClass = 'bg-gray-50';
                                        if (isToday) bgClass = 'bg-blue-100';
                                        else if (isWeekend) bgClass = 'bg-gray-200';
                                        return `
                                            <th class="${bgClass} px-2 py-2 text-center border-l border-gray-200" style="min-width: 60px;">
                                                <div class="text-xs font-semibold text-gray-600">${header.date.toLocaleDateString('en-US', { weekday: 'short' })}</div>
                                                <div class="text-sm font-bold text-gray-900">${header.date.getDate()}</div>
                                            </th>
                                        `;
                                    }).join('')}
                                </tr>
                            </thead>

                            <tbody>
                                ${allEquipment.length > 0 ? `
                                    <tr class="bg-gray-800">
                                        <td colspan="${dateHeaders.length + 1}" class="px-4 py-2 font-bold text-white text-sm">
                                            ‚öôÔ∏è EQUIPMENT CAMPAIGNS
                                        </td>
                                    </tr>
                                    ${allEquipment.map(eq => renderEquipmentDailyRow(eq, dateHeaders)).join('')}
                                ` : ''}

                                ${orderedInventoryGroups.length > 0 ? `
                                    <tr class="bg-gray-800 border-t-4 border-gray-400">
                                        <td colspan="${dateHeaders.length + 1}" class="px-4 py-2 font-bold text-white text-sm">
                                            üì¶ INVENTORY LEVELS
                                        </td>
                                    </tr>
                                    ${orderedInventoryGroups.map(group => `
                                        ${renderInventoryGroupSummaryRow(group.title, group.icon, siloGroups[group.key], inventories, dateHeaders)}
                                        ${(siloGroups[group.key] || []).map(silo => renderSiloDailyRow(silo, inventories, dateHeaders)).join('')}
                                    `).join('')}
                                ` : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }


        function renderEquipmentDailyRow(equipment, dateHeaders) {
            const capacity = equipment.params.tpd || (equipment.params.tph ? equipment.params.tph * 24 : 0);
            const campaigns = getCampaignsForEquipment(equipment.id);
            
            return `
                <tr class="border-b border-gray-200 hover:bg-gray-50" style="height: 40px;">
                    <!-- Equipment info column (sticky) -->
                    <td class="sticky left-0 bg-white z-10 px-3 py-2 border-r border-gray-300" style="height: 40px;">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-semibold text-xs text-gray-900">${equipment.name}</div>
                                <div class="text-xs text-gray-500">${formatNumber(capacity)} TPD</div>
                            </div>
                            <button onclick="openCampaignForm('${equipment.id}')" 
                                    class="text-xs text-blue-600 hover:bg-blue-50 px-1.5 py-0.5 rounded border border-blue-300">
                                +
                            </button>
                        </div>
                    </td>
                    
                    <!-- Campaign timeline -->
                    ${renderCampaignTimeline(equipment, campaigns, dateHeaders)}
                </tr>
            `;
        }

        function renderCampaignTimeline(equipment, campaigns, dateHeaders) {
            // Build a map of date -> campaign
            const dateMap = {};
            
            campaigns.forEach(campaign => {
                const startDate = new Date(campaign.startDate + 'T00:00:00');
                const endDate = new Date(campaign.endDate + 'T00:00:00');
                
                dateHeaders.forEach(header => {
                    const currentDate = new Date(header.dateStr + 'T00:00:00');
                    if (currentDate >= startDate && currentDate <= endDate) {
                        dateMap[header.dateStr] = campaign;
                    }
                });
            });
            
            // Render cells with campaign spanning
            let html = '';
            let inCampaign = false;
            let campaignStart = null;
            let campaignLength = 0;
            let currentCampaign = null;
            
            dateHeaders.forEach((header, index) => {
                const campaign = dateMap[header.dateStr];
                const isWeekend = header.date.getDay() === 0 || header.date.getDay() === 6;
                const isToday = header.dateStr === getDateString(new Date(APP_STATE.currentDate));
                
                if (campaign && !inCampaign) {
                    // Start of new campaign
                    inCampaign = true;
                    campaignStart = index;
                    campaignLength = 1;
                    currentCampaign = campaign;
                } else if (campaign && inCampaign && campaign.id === currentCampaign.id) {
                    // Continue campaign
                    campaignLength++;
                } else if ((!campaign || campaign.id !== currentCampaign?.id) && inCampaign) {
                    // End of campaign - render it
                    html += renderCampaignCell(currentCampaign, campaignLength);
                    inCampaign = false;
                    campaignStart = null;
                    campaignLength = 0;
                    currentCampaign = null;
                    
                    // Render current cell if no campaign
                    if (!campaign) {
                        html += renderEmptyCell(isWeekend, isToday);
                    } else {
                        // New campaign starts
                        inCampaign = true;
                        campaignStart = index;
                        campaignLength = 1;
                        currentCampaign = campaign;
                    }
                } else {
                    // No campaign
                    html += renderEmptyCell(isWeekend, isToday);
                }
            });
            
            // Render last campaign if still open
            if (inCampaign) {
                html += renderCampaignCell(currentCampaign, campaignLength);
            }
            
            return html;
        }

        function renderCampaignCell(campaign, colspan) {
            let bgColor = 'bg-green-500';
            let textColor = 'text-white';
            let icon = '‚ñ∂';
            
            if (campaign.type === 'maintenance') {
                bgColor = 'bg-red-500';
                icon = 'üîß';
            } else if (campaign.type === 'stoppage') {
                bgColor = 'bg-gray-500';
                icon = '‚è∏';
            }
            
            const productName = campaign.productName || campaign.type;
            
            return `
                <td colspan="${colspan}" 
                    class="p-0 relative"
                    style="height: 40px;">
                    <div onclick="editCampaign('${campaign.id}')" 
                         class="${bgColor} ${textColor} cursor-pointer hover:opacity-90 transition-opacity flex items-center justify-between px-2"
                         style="height: 20px; margin: 10px 2px; border-radius: 4px;">
                        <div class="flex items-center space-x-1">
                            <span class="text-xs">${icon}</span>
                            <span class="text-xs font-semibold">${productName}</span>
                        </div>
                        <span class="text-xs opacity-75">${colspan}d</span>
                    </div>
                </td>
            `;
        }

        function renderEmptyCell(isWeekend, isToday) {
            let bgClass = 'bg-white';
            if (isToday) bgClass = 'bg-blue-50';
            else if (isWeekend) bgClass = 'bg-gray-50';
            
            return `
                <td class="${bgClass} border-l border-gray-200 p-0" style="min-width: 60px; height: 40px;">
                    <div class="text-xs text-gray-300 text-center" style="line-height: 40px;">-</div>
                </td>
            `;
        }

        function renderCampaignSection(dateHeaders) {
            const kilns = APP_STATE.flowDesigner.equipment.filter(e => e.type === 'kiln');
            const finishMills = APP_STATE.flowDesigner.equipment.filter(e => e.type === 'finish_mill');
            const allEquipment = [...kilns, ...finishMills];
            
            if (allEquipment.length === 0) {
                return `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
                        <p class="text-yellow-800">‚ö†Ô∏è No equipment configured. Please set up equipment in Process Flow (Tab 2)</p>
                    </div>
                `;
            }
            
            // Group dates by week for display
            const weeks = groupDatesByWeek(dateHeaders);
            
            return `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="bg-gray-800 px-4 py-3 rounded-t-lg">
                        <h3 class="text-white font-semibold">üìÖ Equipment Campaign Schedule</h3>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="sticky left-0 bg-gray-100 z-10 px-4 py-3 text-left font-semibold text-gray-700 border-r border-gray-300" style="min-width: 200px;">
                                        Equipment
                                    </th>
                                    ${renderWeekHeaders(weeks)}
                                </tr>
                            </thead>
                            <tbody>
                                ${allEquipment.map(eq => renderEquipmentRow(eq, weeks)).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function groupDatesByWeek(dateHeaders) {
            const weeks = [];
            let currentWeek = [];
            let currentWeekStart = null;
            
            dateHeaders.forEach((header, index) => {
                const dayOfWeek = header.date.getDay();
                
                // Start new week on Monday (or first day)
                if (dayOfWeek === 1 || index === 0) {
                    if (currentWeek.length > 0) {
                        weeks.push({
                            start: currentWeekStart,
                            dates: currentWeek
                        });
                    }
                    currentWeek = [header];
                    currentWeekStart = header.dateStr;
                } else {
                    currentWeek.push(header);
                }
            });
            
            // Add last week
            if (currentWeek.length > 0) {
                weeks.push({
                    start: currentWeekStart,
                    dates: currentWeek
                });
            }
            
            return weeks;
        }

        function renderWeekHeaders(weeks) {
            return weeks.map(week => {
                const startDate = week.dates[0].date;
                const endDate = week.dates[week.dates.length - 1].date;
                const monthStart = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const monthEnd = endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                return `
                    <th class="px-3 py-2 text-center border-l border-gray-300 bg-gray-50" style="min-width: 150px;">
                        <div class="text-xs font-semibold text-gray-600">${monthStart} - ${monthEnd}</div>
                        <div class="text-xs text-gray-500">${week.dates.length} days</div>
                    </th>
                `;
            }).join('');
        }

        function renderEquipmentRow(equipment, weeks) {
            const capacity = equipment.params.tpd || equipment.params.tph * 24 || 0;
            const campaigns = getCampaignsForEquipment(equipment.id);
            
            return `
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                    <td class="sticky left-0 bg-white z-10 px-4 py-3 border-r border-gray-300">
                        <div class="font-semibold text-gray-900">${equipment.name}</div>
                        <div class="text-xs text-gray-600">${equipment.type === 'kiln' ? 'Kiln' : 'Finish Mill'}</div>
                        <div class="text-xs text-gray-500">Capacity: ${formatNumber(capacity)} TPD</div>
                        <button onclick="openCampaignForm('${equipment.id}')" 
                                class="mt-2 text-xs text-blue-600 hover:bg-blue-50 px-2 py-1 rounded border border-blue-300 w-full">
                            + Add Campaign
                        </button>
                    </td>
                    ${renderEquipmentWeekCells(equipment, weeks, campaigns)}
                </tr>
            `;
        }

        function renderEquipmentWeekCells(equipment, weeks, campaigns) {
            return weeks.map(week => {
                const weekCampaigns = campaigns.filter(c => 
                    dateRangesOverlap(c.startDate, c.endDate, week.dates[0].dateStr, week.dates[week.dates.length - 1].dateStr)
                );
                
                let cellContent = '';
                if (weekCampaigns.length > 0) {
                    cellContent = weekCampaigns.map(campaign => {
                        let bgColor = 'bg-green-100 border-green-600';
                        let icon = '‚ñ∂Ô∏è';
                        
                        if (campaign.type === 'maintenance') {
                            bgColor = 'bg-red-100 border-red-600';
                            icon = 'üîß';
                        } else if (campaign.type === 'stoppage') {
                            bgColor = 'bg-gray-100 border-gray-600';
                            icon = '‚è∏Ô∏è';
                        }
                        
                        return `
                            <div class="${bgColor} border-2 rounded p-2 mb-1 cursor-pointer hover:shadow-md"
                                 onclick="editCampaign('${campaign.id}')">
                                <div class="text-xs font-semibold">${icon} ${campaign.productName || campaign.type}</div>
                                <div class="text-xs text-gray-600">${campaign.duration || 0} days</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    // Default: Running at capacity
                    cellContent = `
                        <div class="bg-blue-50 border-2 border-blue-400 rounded p-2">
                            <div class="text-xs font-semibold">‚úì Running</div>
                            <div class="text-xs text-gray-600">Default capacity</div>
                        </div>
                    `;
                }
                
                return `
                    <td class="border-l border-gray-200 px-2 py-2">
                        ${cellContent}
                    </td>
                `;
            }).join('');
        }

        
        function getSiloInventoryGroupKey(silo) {
            const s = silo || {};
            const materialType = String(s?.params?.material_type || '').toLowerCase();
            const name = String(s?.name || '').toLowerCase();

            const productObj = Object.values(APP_STATE.products || {}).find(p => {
                const pn = String(p?.name || '').toLowerCase().trim();
                return pn && (materialType.includes(pn) || name.includes(pn));
            });

            const family = String(productObj?.category || productObj?.family || '').toLowerCase();
            const code = String(productObj?.code || '').toLowerCase();

            const text = [materialType, name, family, code].join(' | ');

            if (text.includes('clinker') || code.includes('clk')) return 'clinker';
            if (text.includes('fuel') || text.includes('coal') || text.includes('petcoke') || text.includes('pet coke')) return 'fuel';
            if (text.includes('cementitious') || text.includes('finished') || text.includes('portland') || text.includes('blended') || text.includes('specialty') || name.includes('/cem/')) return 'cement';
            if (text.includes('raw') || text.includes('limestone') || text.includes('gypsum') || text.includes('slag') || text.includes('fly ash') || name.includes('/rm/')) return 'raw_material';
            return 'other';
        }

        function renderInventoryGroupSummaryRow(title, icon, siloList, inventories, dateHeaders) {
            const list = Array.isArray(siloList) ? siloList : [];
            return `
                <tr class="bg-gray-200 border-t border-gray-300 border-b border-gray-300">
                    <td class="sticky left-0 bg-gray-200 z-10 px-3 py-2 border-r border-gray-300">
                        <div class="font-bold text-xs text-gray-900">${icon} ${title}</div>
                    </td>
                    ${dateHeaders.map(header => {
                        let total = 0;
                        list.forEach(silo => {
                            const inv = (inventories?.[silo.id] || {})[header.dateStr] || { ending: 0 };
                            total += Number(inv.ending || 0);
                        });
                        const isWeekend = header.date.getDay() === 0 || header.date.getDay() === 6;
                        const isToday = header.dateStr === getDateString(new Date(APP_STATE.currentDate));
                        let bgClass = 'bg-gray-100';
                        if (isToday) bgClass = 'bg-blue-50';
                        else if (isWeekend) bgClass = 'bg-gray-100';
                        return `
                            <td class="${bgClass} border-l border-gray-200 p-0" style="min-width:60px;height:32px;">
                                <div class="text-xs font-bold text-gray-800 text-center" style="line-height:32px;">
                                    ${formatNumber(Math.round(total))}
                                </div>
                            </td>
                        `;
                    }).join('')}
                </tr>
            `;
        }

        function renderSiloDailyRow(silo, inventories, dateHeaders) {
            const capacity = silo.params.max_volume || 10000;
            const siloInventories = inventories[silo.id] || {};
            
            return `
                <tr class="border-b border-gray-200 hover:bg-gray-50" style="height: 40px;">
                    <td class="sticky left-0 bg-white z-10 px-3 py-2 border-r border-gray-300" style="height: 40px;">
                        <div class="font-semibold text-xs text-gray-900">${silo.name}</div>
                    </td>
                    
                    ${dateHeaders.map(header => {
                        const inv = siloInventories[header.dateStr] || { ending: 0 };
                        const level = inv.ending;
                        const percent = (level / capacity) * 100;
                        
                        // Traffic light logic
                        let dotColor = '#10b981'; // green
                        if (percent < 10 || percent > 90) {
                            dotColor = '#ef4444'; // red
                        } else if (percent < 20 || percent > 80) {
                            dotColor = '#eab308'; // yellow
                        }
                        
                        const isWeekend = header.date.getDay() === 0 || header.date.getDay() === 6;
                        const isToday = header.dateStr === getDateString(new Date(APP_STATE.currentDate));
                        let bgClass = 'bg-white';
                        if (isToday) bgClass = 'bg-blue-50';
                        else if (isWeekend) bgClass = 'bg-gray-50';
                        
                        return `
                            <td class="${bgClass} border-l border-gray-200 p-0 relative" style="min-width: 60px; height: 40px;">
                                <!-- Traffic light dot (top-right corner) -->
                                <div style="position: absolute; top: 2px; right: 2px; width: 6px; height: 6px; border-radius: 50%; background-color: ${dotColor};"></div>
                                
                                <!-- Inventory value (centered) -->
                                <div class="text-xs font-semibold text-gray-900 text-center" style="line-height: 40px;">
                                    ${formatNumber(Math.round(level))}
                                </div>
                            </td>
                        `;
                    }).join('')}
                </tr>
            `;
        }

        function renderSiloInventoryChart(silo, inventories, dateHeaders) {
            const capacity = silo.params.max_volume || 10000;
            const siloInventories = inventories[silo.id] || {};
            
            // Get 7 representative days to display
            const displayDates = dateHeaders.filter((h, i) => i % 13 === 0).slice(0, 7);
            
            return `
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <div class="font-semibold text-gray-900">${silo.name}</div>
                            <div class="text-xs text-gray-600">${silo.params.material_type || 'Unknown'}</div>
                        </div>
                        <div class="text-sm text-gray-600">
                            Capacity: ${formatNumber(capacity)} tons
                        </div>
                    </div>
                    
                    <!-- Mini timeline chart -->
                    <div class="flex items-end space-x-2 h-24 mb-2">
                        ${displayDates.map(date => {
                            const inv = siloInventories[date.dateStr] || { ending: capacity * 0.5 };
                            const level = inv.ending;
                            const percent = (level / capacity) * 100;
                            const height = Math.max(5, (percent / 100) * 96);  // Max 96px (h-24)
                            
                            // Traffic light color
                            let barColor = 'bg-green-500';
                            if (percent < 10 || percent > 90) barColor = 'bg-red-500';
                            else if (percent < 20 || percent > 80) barColor = 'bg-yellow-500';
                            
                            return `
                                <div class="flex-1 flex flex-col items-center">
                                    <div class="${barColor} w-full rounded-t" style="height: ${height}px;" 
                                         title="${formatNumber(level)} tons (${Math.round(percent)}%)"></div>
                                    <div class="text-xs text-gray-500 mt-1">${date.month} ${date.day}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Current level -->
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-600">Current Level:</span>
                        <span class="font-semibold">${formatNumber(siloInventories[APP_STATE.currentDate]?.ending || 0)} tons</span>
                    </div>
                    
                    <!-- Capacity bar -->
                    ${renderCapacityBar(siloInventories[APP_STATE.currentDate]?.ending || 0, capacity)}
                </div>
            `;
        }

        function renderCapacityBar(current, capacity) {
            const percent = (current / capacity) * 100;
            let barColor = 'bg-green-500';
            let statusIcon = 'üü¢';
            let statusText = 'Optimal';
            
            if (percent >= 90) {
                barColor = 'bg-red-500';
                statusIcon = 'üî¥';
                statusText = 'Critical - Near Full';
            } else if (percent >= 80) {
                barColor = 'bg-yellow-500';
                statusIcon = 'üü°';
                statusText = 'Warning - High';
            } else if (percent <= 10) {
                barColor = 'bg-red-500';
                statusIcon = 'üî¥';
                statusText = 'Critical - Low';
            } else if (percent <= 20) {
                barColor = 'bg-yellow-500';
                statusIcon = 'üü°';
                statusText = 'Warning - Low';
            }
            
            return `
                <div class="mt-2">
                    <div class="flex items-center justify-between text-xs mb-1">
                        <span class="text-gray-600">${statusIcon} ${statusText}</span>
                        <span class="font-semibold">${Math.round(percent)}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="${barColor} h-2 rounded-full transition-all" style="width: ${Math.min(100, percent)}%"></div>
                    </div>
                </div>
            `;
        }

        function renderPerformanceMetrics() {
            // Calculate rolling averages
            const metrics = calculateRollingAverages();
            
            return `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h3 class="font-semibold text-gray-900 mb-4">üìä Production Performance</h3>
                    
                    <div class="grid grid-cols-3 gap-4">
                        ${Object.keys(metrics).map(productName => `
                            <div class="border border-gray-200 rounded p-3">
                                <div class="font-semibold text-gray-900 mb-2">${productName}</div>
                                <div class="space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">7-day avg:</span>
                                        <span class="font-semibold">${formatNumber(metrics[productName].avg7)} TPD</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">15-day avg:</span>
                                        <span class="font-semibold">${formatNumber(metrics[productName].avg15)} TPD</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">30-day avg:</span>
                                        <span class="font-semibold">${formatNumber(metrics[productName].avg30)} TPD</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // ============================================
        // CAMPAIGN MANAGEMENT
        // ============================================

        function openCampaignForm(equipmentId = null) {
            const equipment = APP_STATE.flowDesigner.equipment;
            const products = Object.values(APP_STATE.products);
            
            const modal = document.createElement('div');
            modal.id = 'campaignFormModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-4 rounded-t-lg sticky top-0">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold">‚úèÔ∏è Create Campaign</h3>
                            <button onclick="closeCampaignForm()" class="text-white hover:text-gray-200">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <!-- Campaign Type -->
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Campaign Type</label>
                            <div class="flex space-x-3">
                                <label class="flex-1">
                                    <input type="radio" name="campaignType" value="production" checked onchange="toggleCampaignFields()"
                                           class="mr-2">
                                    <span class="text-sm">Production</span>
                                </label>
                                <label class="flex-1">
                                    <input type="radio" name="campaignType" value="maintenance" onchange="toggleCampaignFields()"
                                           class="mr-2">
                                    <span class="text-sm">Maintenance</span>
                                </label>
                                <label class="flex-1">
                                    <input type="radio" name="campaignType" value="stoppage" onchange="toggleCampaignFields()"
                                           class="mr-2">
                                    <span class="text-sm">Forced Stop</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Equipment Selection -->
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Equipment</label>
                            <select id="campaignEquipment" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="">Select equipment...</option>
                                ${equipment.filter(e => e.type === 'kiln' || e.type === 'finish_mill').map(eq => `
                                    <option value="${eq.id}" ${eq.id === equipmentId ? 'selected' : ''}>
                                        ${eq.name} (${eq.type === 'kiln' ? 'Kiln' : 'Mill'})
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <!-- Product Selection (for production only) -->
                        <div class="mb-4" id="productSelection">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Product</label>
                            <select id="campaignProduct" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="">Select product...</option>
                                ${products.map(p => `
                                    <option value="${p.id}">${p.name}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <!-- Date Range -->
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Start Date</label>
                                <input type="date" id="campaignStartDate" 
                                       value="${APP_STATE.currentDate}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">End Date</label>
                                <input type="date" id="campaignEndDate" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                        
                        <!-- Duration Display -->
                        <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                            <div class="text-sm text-blue-900">
                                <strong>Duration:</strong> <span id="campaignDuration">0 days</span>
                            </div>
                        </div>
                        
                        <!-- Production Rate (for production only) -->
                        <div class="mb-4" id="productionRateSection">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Production Rate</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="rateType" value="capacity" checked class="mr-2">
                                    <span class="text-sm">Use equipment capacity</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="rateType" value="custom" class="mr-2">
                                    <span class="text-sm">Custom rate:</span>
                                    <input type="number" id="customRate" placeholder="TPD" 
                                           class="ml-2 px-2 py-1 border border-gray-300 rounded w-32">
                                </label>
                            </div>
                        </div>
                        
                        <!-- Recurring -->
                        <div class="mb-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="campaignRecurring" class="mr-2">
                                <span class="text-sm font-semibold">Repeat this campaign</span>
                            </label>
                            <div id="recurringOptions" class="ml-6 mt-2 hidden">
                                <label class="text-sm text-gray-600">
                                    Every <input type="number" id="recurringInterval" value="1" min="1" max="52"
                                                 class="w-16 px-2 py-1 border border-gray-300 rounded mx-1">
                                    <select id="recurringUnit" class="px-2 py-1 border border-gray-300 rounded">
                                        <option value="week">week(s)</option>
                                        <option value="month">month(s)</option>
                                    </select>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Save as Template -->
                        <div class="mb-6 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                            <label class="flex items-center mb-2">
                                <input type="checkbox" id="saveAsTemplate" class="mr-2">
                                <span class="text-sm font-semibold text-purple-900">üíæ Save as Template</span>
                            </label>
                            <input type="text" id="templateName" placeholder="Template name..."
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex space-x-3">
                            <button onclick="closeCampaignForm()" 
                                    class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 rounded-lg font-semibold">
                                Cancel
                            </button>
                            <button onclick="createCampaign()" 
                                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold">
                                Create Campaign
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Setup event listeners
            document.getElementById('campaignStartDate').addEventListener('change', updateCampaignDuration);
            document.getElementById('campaignEndDate').addEventListener('change', updateCampaignDuration);
            document.getElementById('campaignRecurring').addEventListener('change', function() {
                document.getElementById('recurringOptions').classList.toggle('hidden', !this.checked);
            });
            
            updateCampaignDuration();
        }

        function toggleCampaignFields() {
            const type = document.querySelector('input[name="campaignType"]:checked').value;
            const isProduction = type === 'production';
            
            document.getElementById('productSelection').style.display = isProduction ? 'block' : 'none';
            document.getElementById('productionRateSection').style.display = isProduction ? 'block' : 'none';
        }

        function updateCampaignDuration() {
            const start = new Date(document.getElementById('campaignStartDate').value);
            const end = new Date(document.getElementById('campaignEndDate').value);
            
            if (start && end && end >= start) {
                const days = Math.round((end - start) / (1000 * 60 * 60 * 24)) + 1;
                document.getElementById('campaignDuration').textContent = `${days} days`;
            } else {
                document.getElementById('campaignDuration').textContent = '0 days';
            }
        }

        function createCampaign() {
            const type = document.querySelector('input[name="campaignType"]:checked').value;
            const equipmentId = document.getElementById('campaignEquipment').value;
            const productId = document.getElementById('campaignProduct')?.value;
            const startDate = document.getElementById('campaignStartDate').value;
            const endDate = document.getElementById('campaignEndDate').value;
            
            if (!equipmentId || !startDate || !endDate) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (type === 'production' && !productId) {
                alert('Please select a product for production campaign');
                return;
            }
            
            const campaign = {
                id: 'camp_' + Date.now(),
                type: type,
                equipmentId: equipmentId,
                productId: productId,
                productName: productId ? APP_STATE.products[productId].name : null,
                startDate: startDate,
                endDate: endDate,
                duration: Math.round((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1,
                createdAt: new Date().toISOString()
            };
            
            // Add production rate if production campaign
            if (type === 'production') {
                const rateType = document.querySelector('input[name="rateType"]:checked').value;
                if (rateType === 'custom') {
                    campaign.customRate = parseFloat(document.getElementById('customRate').value) || 0;
                }
            }
            
            // Save campaign
            APP_STATE.productionPlan.campaigns.push(campaign);
            
            // Save as template if requested
            if (document.getElementById('saveAsTemplate').checked) {
                const templateName = document.getElementById('templateName').value;
                if (templateName) {
                    APP_STATE.productionPlan.campaignTemplates.push({
                        name: templateName,
                        template: { ...campaign, id: null, startDate: null, endDate: null }
                    });
                }
            }
            
            saveToLocalStorage();
            closeCampaignForm();
            switchTab('production');
            
            alert('‚úÖ Campaign created successfully!');
        }

        function closeCampaignForm() {
            const modal = document.getElementById('campaignFormModal');
            if (modal) modal.remove();
        }

        // ============================================
        // INVENTORY CALCULATIONS
        // ============================================


        
function calculateInventories(dateHeaders) {
    const inventories = {};
    const silos = APP_STATE.flowDesigner.equipment.filter(e => e.type === 'storage');
    const dateSummaries = buildDailyMaterialBalance(dateHeaders);
    const facilityId = APP_STATE.currentLocation || '';

    silos.forEach(silo => {
        inventories[silo.id] = {};
        const capacity = Number(silo.params.max_volume || 10000);
        const siloProductName = String(silo.params.material_type || '').trim();
        const siloProduct = findProductByName(siloProductName);
        const productId = (siloProduct && siloProduct.id) || '';
        const seedMapByDate = (productId ? (APP_STATE.inventory?.[silo.id]?.[productId] || {}) : {});

        let currentInventory = 0;
        const firstDateStr = dateHeaders?.[0]?.dateStr;
        if (firstDateStr) {
            const directSeed = Number(seedMapByDate[firstDateStr] ?? NaN);
            if (Number.isFinite(directSeed)) {
                currentInventory = directSeed;
            } else {
                const prev = new Date(firstDateStr + 'T00:00:00');
                prev.setDate(prev.getDate() - 1);
                const prevStr = getDateString(prev);
                const eodRec = (APP_STATE.actuals?.inventoryEOD || []).find(r =>
                    r.date === prevStr &&
                    String(r.storageId) === String(silo.id) &&
                    String(r.productId) === String(productId) &&
                    (!facilityId || String(r.facilityId) === String(facilityId))
                );
                if (eodRec) currentInventory = Number(eodRec.endingInventoryStn || 0);
            }
        }

        dateHeaders.forEach(header => {
            const dateStr = header.dateStr;
            const dayBal = dateSummaries[dateStr] || { productionByProduct:{}, internalConsumptionByProduct:{} };
            const productKeyName = (siloProduct?.name || siloProductName || '').trim();
            const production = Number(dayBal.productionByProduct[productKeyName] || dayBal.productionByProduct[siloProductName] || 0);
            const internalConsumption = Number(dayBal.internalConsumptionByProduct[productKeyName] || dayBal.internalConsumptionByProduct[siloProductName] || 0);
            const demand = getDemandForDate2(productKeyName || siloProductName, dateStr);

            let beginning = currentInventory;
            const explicitSeed = Number(seedMapByDate[dateStr] ?? NaN);
            if (Number.isFinite(explicitSeed)) beginning = explicitSeed;

            const rawEnding = beginning + production - demand - internalConsumption;
            const ending = Math.max(0, Math.min(capacity, rawEnding));

            inventories[silo.id][dateStr] = {
                beginning,
                production,
                demand,
                internalConsumption,
                ending,
                blockedByFull: rawEnding > capacity,
                stockout: rawEnding < 0
            };

            currentInventory = ending;
        });
    });

    return inventories;
}


function buildDailyMaterialBalance(dateHeaders) {
    const summaries = {};
    const allCampaigns = APP_STATE.productionPlan?.campaigns || [];
    const equipmentIndex = new Map((APP_STATE.flowDesigner?.equipment || []).map(e => [e.id, e]));
    const facilityId = APP_STATE.currentLocation || '';

    dateHeaders.forEach(header => {
        const dateStr = header.dateStr;
        summaries[dateStr] = { productionByProduct: {}, internalConsumptionByProduct: {} };

        // A) Planned production from campaigns
        const activeCampaigns = allCampaigns.filter(c =>
            c.type === 'production' &&
            dateStr >= c.startDate && dateStr <= c.endDate
        );

        activeCampaigns.forEach(campaign => {
            const eq = equipmentIndex.get(campaign.equipmentId);
            if (!eq) return;
            const rate = getCampaignDailyRate(campaign, eq);
            const outputProductName = String(campaign.productName || '').trim();
            if (!outputProductName || rate <= 0) return;
            incrementMap(summaries[dateStr].productionByProduct, outputProductName, rate);

            if (eq.type === 'finish_mill') {
                const recipe = getActiveRecipeForProductName(outputProductName, dateStr);
                if (recipe && Object.keys(recipe).length) {
                    Object.entries(recipe).forEach(([componentName, pct]) => {
                        const consumed = rate * (Number(pct || 0) / 100);
                        if (consumed > 0) incrementMap(summaries[dateStr].internalConsumptionByProduct, componentName, consumed);
                    });
                }
            }
            if (eq.type === 'kiln') {
                const rmToClinkerFactor = Number(eq?.params?.rm_to_clinker_factor || 1.55);
                const rawMealProductName = getDefaultRawMealProductName();
                if (rawMealProductName && rmToClinkerFactor > 0) {
                    incrementMap(summaries[dateStr].internalConsumptionByProduct, rawMealProductName, rate * rmToClinkerFactor);
                }
            }
        });

        // B) Actual production overlays for dates where user entered actuals
        const actualProdRows = (APP_STATE.actuals?.production || []).filter(r =>
            r.date === dateStr && (!facilityId || String(r.facilityId) === String(facilityId))
        );

        if (actualProdRows.length) {
            // Replace planned production with actuals for the products/equipment entered on that day
            // (keep other planned rows intact if no actual was entered for them yet)
            actualProdRows.forEach(r => {
                const qty = Number(r.quantityStn || 0);
                if (!(qty >= 0)) return;
                const eq = equipmentIndex.get(r.equipmentId);
                const product = APP_STATE.products?.[r.productId];
                const outputProductName = String(product?.name || '').trim();
                if (!eq || !outputProductName) return;

                // Remove any planned contribution for same equipment/product by subtracting it if present.
                // Simpler v1: add delta relative to zero after clearing same product's planned contribution is not traceable here.
                // We intentionally override by accumulating actuals and later prefer actuals totals when available.
                // Mark actuals in a separate map and apply after loop.
            });

            // Build exact actual production totals per product for the date
            const actualProdByProduct = {};
            actualProdRows.forEach(r => {
                const product = APP_STATE.products?.[r.productId];
                const name = String(product?.name || '').trim();
                if (!name) return;
                incrementMap(actualProdByProduct, name, Number(r.quantityStn || 0));
            });

            // Rebuild internal consumption from actual FM/Kiln rows and replace production for touched products
            const actualInternal = {};
            actualProdRows.forEach(r => {
                const eq = equipmentIndex.get(r.equipmentId);
                const product = APP_STATE.products?.[r.productId];
                const outputProductName = String(product?.name || '').trim();
                const qty = Number(r.quantityStn || 0);
                if (!eq || !outputProductName || qty <= 0) return;

                if (eq.type === 'finish_mill') {
                    const recipe = getActiveRecipeForProductName(outputProductName, dateStr);
                    if (recipe) {
                        Object.entries(recipe).forEach(([componentName, pct]) => {
                            const consumed = qty * (Number(pct || 0) / 100);
                            if (consumed > 0) incrementMap(actualInternal, componentName, consumed);
                        });
                    }
                }
                if (eq.type === 'kiln') {
                    const rmToClinkerFactor = Number(eq?.params?.rm_to_clinker_factor || 1.55);
                    const rawMealProductName = getDefaultRawMealProductName();
                    if (rawMealProductName && rmToClinkerFactor > 0) {
                        incrementMap(actualInternal, rawMealProductName, qty * rmToClinkerFactor);
                    }
                }
            });

            // Replace production totals for products with actuals entered
            Object.keys(actualProdByProduct).forEach(prodName => {
                summaries[dateStr].productionByProduct[prodName] = Number(actualProdByProduct[prodName] || 0);
            });

            // For internal consumption, overwrite components touched by actual rows
            Object.keys(actualInternal).forEach(compName => {
                summaries[dateStr].internalConsumptionByProduct[compName] = Number(actualInternal[compName] || 0);
            });
        }
    });

    return summaries;
}

function getCampaignDailyRate(campaign, equipment) {
            const customRate = Number(campaign.customRate || 0);
            if (customRate > 0) return customRate;

            // Prefer explicit product capability (product-specific TPD)
            const productName = (campaign.productName || '').trim();
            const capabilityRate = getEquipmentCapabilityRateByProductName(equipment?.id, productName);
            if (capabilityRate > 0) return capabilityRate;

            // Fallback to generic equipment rate params (legacy behavior)
            const tpd = Number(equipment?.params?.tpd || 0);
            const tph = Number(equipment?.params?.tph || 0);
            return tpd > 0 ? tpd : (tph > 0 ? tph * 24 : 0);
        }

        function getEquipmentCapabilityRateByProductName(equipmentId, productName) {
            if (!equipmentId || !productName) return 0;
            const rows = APP_STATE.equipmentProductCapabilities || [];
            const productNameNorm = normalizeTextKey(productName);
            const match = rows.find(r => {
                if (String(r.equipmentId) !== String(equipmentId)) return false;
                const rowProd = APP_STATE.products?.[r.productId];
                if (!rowProd) return false;
                return normalizeTextKey(rowProd.name) === productNameNorm;
            });
            return Number(match?.maxRateStnPerDay || match?.rate || 0);
        }

        function getActiveRecipeForProductName(productName, dateStr) {
            const allProducts = Object.values(APP_STATE.products || {});
            const product = allProducts.find(p => normalizeTextKey(p.name) === normalizeTextKey(productName));
            if (!product) return null;

            const hasRecipe = product.recipe && typeof product.recipe === 'object' && Object.keys(product.recipe).length > 0;
            if (!hasRecipe) return null;

            const start = product.recipeEffectiveStart || '';
            const end = product.recipeEffectiveEnd || '';
            const inWindow = (!start || dateStr >= start) && (!end || dateStr <= end);
            if (!inWindow) return null;

            return product.recipe;
        }

        function getDefaultRawMealProductName() {
            const allProducts = Object.values(APP_STATE.products || {});
            const candidate = allProducts.find(p => {
                const n = normalizeTextKey(p.name || '');
                const c = normalizeTextKey(p.code || '');
                return n.includes('raw meal') || c.includes('raw_meal') || c.includes('rawmeal');
            });
            return candidate ? candidate.name : 'Raw Meal';
        }

        function normalizeTextKey(v) {
            return String(v || '').trim().toLowerCase();
        }

        function incrementMap(mapObj, key, value) {
            if (!key) return;
            if (!mapObj[key]) mapObj[key] = 0;
            mapObj[key] += Number(value || 0);
        }

        function getProductionForDate(silo, dateStr) {
            // Legacy helper retained for compatibility; uses enhanced daily balance
            const productName = (silo?.params?.material_type || '').trim();
            const summary = buildDailyMaterialBalance([{ dateStr }])[dateStr];
            return Number(summary?.productionByProduct?.[productName] || 0);
        }

        function getDemandForDate2(productName, dateStr) {
            const product = Object.values(APP_STATE.products || {}).find(p => normalizeTextKey(p.name) === normalizeTextKey(productName));
            if (!product) return 0;

            // 1) Actual shipments (if entered for that date/facility) take precedence for past dates
            const facilityId = APP_STATE.currentLocation || '';
            const actualShip = getActualShipmentQtyForProductDate(product.id, dateStr, facilityId);
            if (actualShip > 0) return actualShip;

            // 2) Demand planning table value
            const demandData = APP_STATE.demandPlan?.[product.id];
            if (demandData && demandData[dateStr] && Number.isFinite(Number(demandData[dateStr].value))) {
                return Number(demandData[dateStr].value || 0);
            }

            return 0;
        }

        function getCampaignsForEquipment(equipmentId) {
            if (!APP_STATE.productionPlan || !APP_STATE.productionPlan.campaigns) {
                return [];
            }
            return APP_STATE.productionPlan.campaigns.filter(c => c.equipmentId === equipmentId);
        }

        function dateRangesOverlap(start1, end1, start2, end2) {
            return start1 <= end2 && end1 >= start2;
        }

        function calculateRollingAverages() {
            // Calculate 7, 15, 30 day rolling averages for each product
            const metrics = {};
            const products = Object.values(APP_STATE.products);
            
            products.forEach(product => {
                metrics[product.name] = {
                    avg7: 0,
                    avg15: 0,
                    avg30: 0
                };
            });
            
            return metrics;
        }

        function showRecommendations() {
            alert('üí° Smart Recommendations:\n\n‚Ä¢ Clinker silo reaching 90% in 5 days\n‚Ä¢ Suggest: Stop Kiln 1 for 10 days\n‚Ä¢ OPC inventory stable - no changes needed');
        }

        function editCampaign(campaignId) {
            // Find the campaign
            const campaign = APP_STATE.productionPlan.campaigns.find(c => c.id === campaignId);
            if (!campaign) {
                alert('Campaign not found');
                return;
            }
            
            const equipment = APP_STATE.flowDesigner.equipment;
            const products = Object.values(APP_STATE.products);
            
            const modal = document.createElement('div');
            modal.id = 'campaignFormModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-4 rounded-t-lg sticky top-0">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold">‚úèÔ∏è Edit Campaign</h3>
                            <button onclick="closeCampaignForm()" class="text-white hover:text-gray-200">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <!-- Campaign Type -->
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Campaign Type</label>
                            <div class="flex space-x-3">
                                <label class="flex-1">
                                    <input type="radio" name="campaignType" value="production" ${campaign.type === 'production' ? 'checked' : ''} onchange="toggleCampaignFields()"
                                           class="mr-2">
                                    <span class="text-sm">Production</span>
                                </label>
                                <label class="flex-1">
                                    <input type="radio" name="campaignType" value="maintenance" ${campaign.type === 'maintenance' ? 'checked' : ''} onchange="toggleCampaignFields()"
                                           class="mr-2">
                                    <span class="text-sm">Maintenance</span>
                                </label>
                                <label class="flex-1">
                                    <input type="radio" name="campaignType" value="stoppage" ${campaign.type === 'stoppage' ? 'checked' : ''} onchange="toggleCampaignFields()"
                                           class="mr-2">
                                    <span class="text-sm">Forced Stop</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Equipment Selection -->
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Equipment</label>
                            <select id="campaignEquipment" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                ${equipment.filter(e => e.type === 'kiln' || e.type === 'finish_mill').map(eq => `
                                    <option value="${eq.id}" ${eq.id === campaign.equipmentId ? 'selected' : ''}>
                                        ${eq.name} (${eq.type === 'kiln' ? 'Kiln' : 'Mill'})
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <!-- Product Selection (for production only) -->
                        <div class="mb-4" id="productSelection" style="display: ${campaign.type === 'production' ? 'block' : 'none'}">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Product</label>
                            <select id="campaignProduct" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                ${products.map(p => `
                                    <option value="${p.id}" ${p.id === campaign.productId ? 'selected' : ''}>${p.name}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <!-- Date Range -->
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Start Date</label>
                                <input type="date" id="campaignStartDate" 
                                       value="${campaign.startDate}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">End Date</label>
                                <input type="date" id="campaignEndDate" 
                                       value="${campaign.endDate}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                        
                        <!-- Duration Display -->
                        <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                            <div class="text-sm text-blue-900">
                                <strong>Duration:</strong> <span id="campaignDuration">0 days</span>
                            </div>
                        </div>
                        
                        <!-- Production Rate (for production only) -->
                        <div class="mb-4" id="productionRateSection" style="display: ${campaign.type === 'production' ? 'block' : 'none'}">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Production Rate</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="rateType" value="capacity" ${!campaign.customRate ? 'checked' : ''} class="mr-2">
                                    <span class="text-sm">Use equipment capacity</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="rateType" value="custom" ${campaign.customRate ? 'checked' : ''} class="mr-2">
                                    <span class="text-sm">Custom rate:</span>
                                    <input type="number" id="customRate" placeholder="TPD" value="${campaign.customRate || ''}"
                                           class="ml-2 px-2 py-1 border border-gray-300 rounded w-32">
                                </label>
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex space-x-3">
                            <button onclick="deleteCampaign('${campaign.id}')" 
                                    class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-semibold">
                                üóëÔ∏è Delete Campaign
                            </button>
                            <button onclick="closeCampaignForm()" 
                                    class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 rounded-lg font-semibold">
                                Cancel
                            </button>
                            <button onclick="updateCampaign('${campaign.id}')" 
                                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold">
                                Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Setup event listeners
            document.getElementById('campaignStartDate').addEventListener('change', updateCampaignDuration);
            document.getElementById('campaignEndDate').addEventListener('change', updateCampaignDuration);
            
            updateCampaignDuration();
        }

        function updateCampaign(campaignId) {
            const type = document.querySelector('input[name="campaignType"]:checked').value;
            const equipmentId = document.getElementById('campaignEquipment').value;
            const productId = document.getElementById('campaignProduct')?.value;
            const startDate = document.getElementById('campaignStartDate').value;
            const endDate = document.getElementById('campaignEndDate').value;
            
            if (!equipmentId || !startDate || !endDate) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (type === 'production' && !productId) {
                alert('Please select a product for production campaign');
                return;
            }
            
            // Find and update campaign
            const campaign = APP_STATE.productionPlan.campaigns.find(c => c.id === campaignId);
            if (!campaign) {
                alert('Campaign not found');
                return;
            }
            
            campaign.type = type;
            campaign.equipmentId = equipmentId;
            campaign.productId = productId;
            campaign.productName = productId ? APP_STATE.products[productId].name : null;
            campaign.startDate = startDate;
            campaign.endDate = endDate;
            campaign.duration = Math.round((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;
            
            // Update production rate if production campaign
            if (type === 'production') {
                const rateType = document.querySelector('input[name="rateType"]:checked').value;
                if (rateType === 'custom') {
                    campaign.customRate = parseFloat(document.getElementById('customRate').value) || 0;
                } else {
                    campaign.customRate = null;
                }
            }
            
            saveToLocalStorage();
            closeCampaignForm();
            switchTab('plan');
            
            alert('‚úÖ Campaign updated successfully!');
        }

        function deleteCampaign(campaignId) {
            if (!confirm('‚ö†Ô∏è Delete this campaign?\n\nThis action cannot be undone.')) {
                return;
            }
            
            // Remove campaign
            APP_STATE.productionPlan.campaigns = APP_STATE.productionPlan.campaigns.filter(c => c.id !== campaignId);
            
            saveToLocalStorage();
            closeCampaignForm();
            switchTab('plan');
            
            alert('‚úÖ Campaign deleted successfully!');
        }

        // ============================================
        // TAB 5: MONITOR & INVENTORY
        // ============================================
        function renderMonitorTab() {
            return `
                <div class="p-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center">
                        <svg class="w-16 h-16 mx-auto text-blue-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Production Monitoring</h3>
                        <p class="text-gray-600 mb-4">Coming soon: Real-time production tracking, inventory levels (STn), and performance analytics</p>
                        <div class="text-sm text-gray-500">
                            This tab will show:
                            <ul class="mt-2 space-y-1">
                                <li>‚Ä¢ Daily production vs targets</li>
                                <li>‚Ä¢ Inventory levels and projections</li>
                                <li>‚Ä¢ Equipment utilization</li>
                                <li>‚Ä¢ Alerts and notifications</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        // ============================================
        // SCENARIO / STORAGE FOUNDATION (v1 scaffold)
        // ============================================

        function getSandboxStorageKey() {
            const loc = APP_STATE.currentLocation || 'MIA';
            const user = (APP_STATE.currentUser || 'local_user').replace(/[^a-zA-Z0-9_-]/g, '_');
            return `cementPlanner_sandbox_${loc}_${user}`;
        }

        function getOfficialCacheKey() {
            const loc = APP_STATE.currentLocation || 'MIA';
            return `cementPlanner_officialcache_${loc}`;
        }

        function snapshotCurrentPlannerData() {
            return {
                dataModelVersion: APP_STATE.dataModelVersion || DATA_MODEL.version,
                products: APP_STATE.products,
                flowDesigner: {
                    equipment: APP_STATE.flowDesigner.equipment,
                    connections: APP_STATE.flowDesigner.connections,
                    nextId: APP_STATE.flowDesigner.nextId
                },
                productionPlan: APP_STATE.productionPlan,
                demandPlan: APP_STATE.demandPlan,
                inventory: APP_STATE.inventory,
                actuals: APP_STATE.actuals,
                orgStructure: APP_STATE.orgStructure,
                networkMap: APP_STATE.networkMap,
                rulesBook: APP_STATE.rulesBook,
                currentLocation: APP_STATE.currentLocation,
                savedAt: new Date().toISOString()
            };
        }

        function applyPlannerSnapshot(data) {
            if (!data || typeof data !== 'object') return;
            if (data.products) APP_STATE.products = data.products;
            if (data.flowDesigner) {
                APP_STATE.flowDesigner.equipment = data.flowDesigner.equipment || [];
                APP_STATE.flowDesigner.connections = data.flowDesigner.connections || [];
                APP_STATE.flowDesigner.nextId = data.flowDesigner.nextId || 1;
            }
            if (data.productionPlan) {
                APP_STATE.productionPlan = data.productionPlan;
                if (!Array.isArray(APP_STATE.productionPlan.campaigns)) APP_STATE.productionPlan.campaigns = [];
                if (!APP_STATE.productionPlan.inventoryHistory) APP_STATE.productionPlan.inventoryHistory = {};
                if (!APP_STATE.productionPlan.campaignTemplates) APP_STATE.productionPlan.campaignTemplates = [];
            }
            if (data.demandPlan) APP_STATE.demandPlan = data.demandPlan;
            if (data.inventory) APP_STATE.inventory = data.inventory;
            if (data.actuals) APP_STATE.actuals = data.actuals;
            if (!APP_STATE.actuals) APP_STATE.actuals = { production: [], shipments: [], inventoryEOD: [] };
            if (!Array.isArray(APP_STATE.actuals.production)) APP_STATE.actuals.production = [];
            if (!Array.isArray(APP_STATE.actuals.shipments)) APP_STATE.actuals.shipments = [];
            if (!Array.isArray(APP_STATE.actuals.inventoryEOD)) APP_STATE.actuals.inventoryEOD = [];
            if (data.orgStructure) APP_STATE.orgStructure = data.orgStructure;
            if (data.networkMap) APP_STATE.networkMap = data.networkMap;
            if (data.rulesBook) APP_STATE.rulesBook = data.rulesBook;
        }

        function showSandboxToast(message) {
            let el = document.getElementById('sandboxToast');
            if (!el) {
                el = document.createElement('div');
                el.id = 'sandboxToast';
                el.style.cssText = 'position:fixed;top:14px;right:14px;z-index:9999;background:#1d4ed8;color:#fff;padding:10px 14px;border-radius:10px;font-size:13px;box-shadow:0 8px 24px rgba(0,0,0,.18);opacity:0;transform:translateY(-8px);transition:all .18s ease;';
                document.body.appendChild(el);
            }
            el.textContent = message;
            el.style.opacity = '1';
            el.style.transform = 'translateY(0)';
            clearTimeout(showSandboxToast._t);
            showSandboxToast._t = setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(-8px)';
            }, 2200);
        }

        function markSandboxDirty(domain = 'plan') {
            const d = APP_STATE.scenarioContext?.sandboxMeta?.dirtyDomains;
            if (d && Object.prototype.hasOwnProperty.call(d, domain)) d[domain] = true;
        }

        function ensureSandboxMode(domain = 'plan') {
            if (APP_STATE.scenarioContext.viewMode !== 'sandbox') {
                APP_STATE.scenarioContext.viewMode = 'sandbox';
                APP_STATE.scenarioContext.activeDomain = domain;
                APP_STATE.scenarioContext.sandboxMeta.lastClonedFromOfficialAt ||= new Date().toISOString();
                showSandboxToast('You are now editing your Sandbox. Official remains unchanged.');
            }
            markSandboxDirty(domain);
        }

        function loadOfficialCacheToState() {
            try {
                const raw = localStorage.getItem(getOfficialCacheKey());
                if (!raw) return false;
                applyPlannerSnapshot(JSON.parse(raw));
                APP_STATE.scenarioContext.viewMode = 'official';
                return true;
            } catch (e) {
                console.warn('Official cache load failed', e);
                return false;
            }
        }

        function saveOfficialCacheFromState() {
            try {
                localStorage.setItem(getOfficialCacheKey(), JSON.stringify(snapshotCurrentPlannerData()));
            } catch (e) {
                console.warn('Official cache save failed', e);
            }
        }

        function saveSandboxLocal() {
            try {
                const payload = {
                    scenario: {
                        type: 'SANDBOX',
                        owner: APP_STATE.currentUser,
                        location: APP_STATE.currentLocation,
                        lastClonedFromOfficialAt: APP_STATE.scenarioContext.sandboxMeta.lastClonedFromOfficialAt,
                        dirtyDomains: APP_STATE.scenarioContext.sandboxMeta.dirtyDomains
                    },
                    snapshot: snapshotCurrentPlannerData()
                };
                localStorage.setItem(getSandboxStorageKey(), JSON.stringify(payload));
            } catch (e) {
                console.warn('Sandbox save failed', e);
            }
        }

        function loadSandboxLocal() {
            try {
                const raw = localStorage.getItem(getSandboxStorageKey());
                if (!raw) return false;
                const payload = JSON.parse(raw);
                if (payload?.snapshot) applyPlannerSnapshot(payload.snapshot);
                if (payload?.scenario) {
                    APP_STATE.scenarioContext.sandboxMeta.lastClonedFromOfficialAt = payload.scenario.lastClonedFromOfficialAt || null;
                    APP_STATE.scenarioContext.sandboxMeta.dirtyDomains = {
                        ...APP_STATE.scenarioContext.sandboxMeta.dirtyDomains,
                        ...(payload.scenario.dirtyDomains || {})
                    };
                }
                APP_STATE.scenarioContext.viewMode = 'sandbox';
                return true;
            } catch (e) {
                console.warn('Sandbox load failed', e);
                return false;
            }
        }

        function pushSandboxToOfficialDateRange(domain, dateFrom, dateTo) {
            // v1 scaffold: overwrite behavior chosen by user; date filtering integration comes next phase
            saveOfficialCacheFromState();
            const msg = domain && dateFrom && dateTo
                ? `Sandbox pushed to Official (${domain}: ${dateFrom} to ${dateTo})`
                : 'Sandbox pushed to Official (overwrite v1 behavior)';
            showSandboxToast(msg);
            return { ok: true, overwrite: true };
        }


        // ============================================
        // DAILY ACTUALS FORM (yesterday -> today's BOD)
        // ============================================

        function getYesterdayDateString() {
            const d = new Date(APP_STATE.currentDate || new Date());
            d.setDate(d.getDate() - 1);
            return getDateString(d);
        }

        function addDaysDateStr(dateStr, days) {
            const d = new Date(dateStr + 'T00:00:00');
            d.setDate(d.getDate() + Number(days || 0));
            return getDateString(d);
        }

        function findProductByName(name) {
            const n = normalizeTextKey(name || '');
            const all = Object.values(APP_STATE.products || {});
            if (!n || !all.length) return null;

            // 1) Exact by name/code/id
            let hit = all.find(p => [p?.name, p?.code, p?.id].some(v => normalizeTextKey(v) === n));
            if (hit) return hit;

            // 2) Normalize separators and common prefixes (facility/path-like labels)
            const compact = n.replace(/[^a-z0-9]/g, '');
            hit = all.find(p => {
                const keys = [p?.name, p?.code, p?.id].map(v => normalizeTextKey(v).replace(/[^a-z0-9]/g, ''));
                return keys.some(k => k && (compact.includes(k) || k.includes(compact)));
            });
            if (hit) return hit;

            // 3) Token overlap score (helps labels like "MIA / INV / CEM / MIA IL(11)")
            const stop = new Set(['mia','brs','pev','wpb','orl','sub','jax','inv','prod','cem','rm','clk','fuel']);
            const nameTokens = (n.match(/[a-z0-9]+/g) || []).filter(t => !stop.has(t));
            let best = null, bestScore = 0;
            for (const p of all) {
                const pText = [p?.name, p?.code, p?.id].map(v => normalizeTextKey(v)).join(' ');
                const pTokens = new Set((pText.match(/[a-z0-9]+/g) || []).filter(t => !stop.has(t)));
                let score = 0;
                for (const t of nameTokens) if (pTokens.has(t)) score++;
                if (score > bestScore) { bestScore = score; best = p; }
            }
            return bestScore > 0 ? best : null;
        }

        function isFinishedProductObj(p) {
            const cat = normalizeTextKey(p?.category || p?.family || '');
            return ['cementitious','finished_product','finished products','finished'].includes(cat)
                || cat.includes('cement')
                || cat.includes('finished');
        }

        function getEquipmentCapabilitiesFor(equipmentId) {
            const explicit = (APP_STATE.equipmentProductCapabilities || []).filter(r => String(r.equipmentId) === String(equipmentId));
            if (explicit.length) return explicit;
            // Fallback to capabilities stored in flow equipment params.products (legacy/current inspector path)
            const eq = (APP_STATE.flowDesigner?.equipment || []).find(e => String(e.id) === String(equipmentId));
            const paramsProducts = eq?.params?.products || {};
            return Object.entries(paramsProducts)
                .filter(([productId, cfg]) => cfg && cfg.enabled !== false)
                .map(([productId, cfg]) => ({
                    equipmentId: equipmentId,
                    productId: String(productId),
                    maxRateStnPerDay: Number(cfg.tpd || cfg.maxRateStnPerDay || cfg.rate || 0),
                    rate: Number(cfg.tpd || cfg.maxRateStnPerDay || cfg.rate || 0),
                    kwh_per_ton: Number(cfg.kwh_per_ton || cfg.electric_kwh_per_stn || 0),
                    mmbtu_per_stn: Number(cfg.mmbtu_per_stn || cfg.thermal_mmbtu_per_stn || 0)
                }));
        }

        function getCapabilityProductOptions(equipmentId) {
            return getEquipmentCapabilitiesFor(equipmentId)
                .map(r => APP_STATE.products?.[r.productId])
                .filter(Boolean);
        }

        function openDailyActualsForm() {
            const facilityId = APP_STATE.currentLocation || 'MIA';
            const dateStr = document.getElementById('actualsDate')?.value || getYesterdayDateString();
            const equipment = (APP_STATE.flowDesigner?.equipment || []);
            const storages = equipment.filter(e => e.type === 'storage');
            const rawMills = equipment.filter(e => e.type === 'raw_mill');
            const kilns = equipment.filter(e => e.type === 'kiln');
            const finishMills = equipment.filter(e => e.type === 'finish_mill');
            const finishedProducts = getFinishedProductsForFacility(facilityId);

            const modal = document.createElement('div');
            modal.id = 'dailyActualsModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 p-4 overflow-y-auto';
            modal.innerHTML = `
              <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl my-4">
                <div class="bg-gradient-to-r from-slate-700 to-slate-800 text-white px-6 py-4 rounded-t-xl sticky top-0 z-10">
                  <div class="flex items-center justify-between">
                    <div>
                      <h3 class="text-lg font-semibold">üìù Daily Actuals Entry</h3>
                      <div class="text-xs text-slate-200 mt-1">Inventories entered are Ending Inventory for selected date and become Beginning Inventory for next day</div>
                    </div>
                    <button onclick="closeDailyActualsForm()" class="text-white hover:text-gray-200 text-xl leading-none">&times;</button>
                  </div>
                </div>
                <div class="p-6 space-y-6">
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                      <label class="block text-sm font-semibold text-gray-700 mb-1">Date (Yesterday)</label>
                      <input id="actualsDate" type="date" value="${dateStr}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                      <label class="block text-sm font-semibold text-gray-700 mb-1">Facility</label>
                      <input type="text" value="${escapeHtml(facilityId)}" class="w-full px-3 py-2 border border-gray-200 bg-gray-100 rounded-lg" readonly>
                    </div>
                    <div class="flex items-end">
                      <div class="text-xs text-gray-600">Top-right selected facility is used automatically.</div>
                    </div>
                  </div>

                  <section>
                    <h4 class="font-semibold text-gray-900 mb-2">Ending Inventories Yesterday (STn)</h4>
                    <div class="border rounded-lg overflow-hidden">
                      <table class="w-full text-sm">
                        <thead class="bg-gray-100">
                          <tr>
                            <th class="text-left px-3 py-2">Storage</th>
                            <th class="text-left px-3 py-2">Product in Storage</th>
                            <th class="text-left px-3 py-2">Ending Inventory (STn)</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${storages.map(s => {
                              const p = findProductByName(s?.params?.material_type || '');
                              const nextDate = addDaysDateStr(dateStr, 1);
                              const seeded = Number(APP_STATE.inventory?.[s.id]?.[(p && p.id) || '']?.[nextDate] ?? NaN);
                              const cap = Number(s?.params?.max_volume || '');
                              return `<tr class="border-t">
                                <td class="px-3 py-2 font-medium">${escapeHtml(s.name || s.id)}</td>
                                <td class="px-3 py-2 text-gray-700">${escapeHtml((s?.params?.material_type || '').toString())}</td>
                                <td class="px-3 py-2">
                                  <input type="number" min="0" step="0.01" class="w-40 px-2 py-1 border rounded actuals-inv"
                                    data-storage-id="${escapeHtml(s.id)}" data-product-id="${escapeHtml((p && p.id) || '')}"
                                    placeholder="${Number.isFinite(cap) ? 'Cap '+cap : ''}"
                                    value="${Number.isFinite(seeded) ? seeded : ''}">
                                </td>
                              </tr>`;
                          }).join('') || `<tr><td colspan="3" class="px-3 py-3 text-gray-500">No storage units in Process Flow.</td></tr>`}
                        </tbody>
                      </table>
                    </div>
                  </section>

                  <section>
                    <h4 class="font-semibold text-gray-900 mb-2">Production Actuals Yesterday (STn)</h4>
                    <div class="space-y-4">
                      ${renderDailyActualsEquipmentGroup(rawMills, 'Raw Mills')}
                      ${renderDailyActualsEquipmentGroup(kilns, 'Kilns')}
                      ${renderDailyActualsFinishMillGroup(finishMills)}
                    </div>
                  </section>

                  <section id="dailyActualsTransfersSection" class="hidden">
                    <h4 class="font-semibold text-gray-900 mb-2">Transfers Yesterday (STn)</h4>
                    <div class="text-sm text-gray-500 border rounded-lg p-3">Transfer actuals section will be enabled when transfer lanes are explicitly detected in Process Flow / network map.</div>
                  </section>

                  <section>
                    <h4 class="font-semibold text-gray-900 mb-2">Shipments to Customers Yesterday (STn)</h4>
                    <div class="border rounded-lg overflow-hidden">
                      <table class="w-full text-sm">
                        <thead class="bg-gray-100">
                          <tr>
                            <th class="text-left px-3 py-2">Finished Product</th>
                            <th class="text-left px-3 py-2">Shipped (STn)</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${finishedProducts.map(p => {
                              const existing = (APP_STATE.actuals?.shipments || []).find(r => r.facilityId===facilityId && r.date===dateStr && r.productId===p.id);
                              return `<tr class="border-t">
                                <td class="px-3 py-2">${escapeHtml(p.name)}</td>
                                <td class="px-3 py-2"><input type="number" min="0" step="0.01" class="w-40 px-2 py-1 border rounded actuals-ship"
                                  data-product-id="${escapeHtml(p.id)}" value="${existing ? Number(existing.quantityStn||0) : ''}"></td>
                              </tr>`;
                          }).join('') || `<tr><td colspan="2" class="px-3 py-3 text-gray-500">No finished/cementitious products found.</td></tr>`}
                        </tbody>
                      </table>
                    </div>
                  </section>

                  <section>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Notes (optional)</label>
                    <textarea id="dailyActualsNotes" class="w-full border rounded-lg px-3 py-2" rows="2" placeholder="Maintenance, unusual shipments, product switches, etc."></textarea>
                  </section>

                  <div class="flex justify-end gap-3 pt-2">
                    <button onclick="closeDailyActualsForm()" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50">Cancel</button>
                    <button onclick="saveDailyActualsForm()" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Save to Sandbox</button>
                  </div>
                </div>
              </div>
            `;
            document.body.appendChild(modal);
            // Rehydrate existing finish mill rows for selected date
            const existingFmRows = (APP_STATE.actuals?.production || []).filter(r => r.facilityId===facilityId && r.date===dateStr);
            finishMills.forEach(eq => {
                const rows = existingFmRows.filter(r => r.equipmentId===eq.id);
                if (rows.length) rows.forEach(r => addDailyActualsFmRow(eq.id, r));
                else addDailyActualsFmRow(eq.id);
            });
            updateDailyActualsTransfersVisibility();
        }


        function getActualsProductPoolForEquipmentType(type) {
            const all = Object.values(APP_STATE.products || {});
            const norm = (v) => normalizeTextKey(v || '');
            if (type === 'finish_mill') {
                return all.filter(p => {
                    const c = norm(p.category || p.family || '');
                    return c.includes('cement') || c.includes('finished') || c === 'cementitious';
                });
            }
            if (type === 'kiln') {
                return all.filter(p => {
                    const c = norm(p.category || p.family || '');
                    const n = norm(p.name || '');
                    return c.includes('intermediate') || n.includes('clinker');
                });
            }
            if (type === 'raw_mill') {
                return all.filter(p => {
                    const c = norm(p.category || p.family || '');
                    const n = norm(p.name || '');
                    return c.includes('intermediate') || n.includes('raw meal');
                });
            }
            return all;
        }

        function getCapabilityMapForEquipment(equipmentId) {
            const set = new Set();
            const caps = getEquipmentCapabilitiesFor(equipmentId);
            caps.forEach(r => { if (r && r.productId) set.add(String(r.productId)); });
            return set;
        }

        function getSavedActualsProductionMapByEquipment(dateStr, facilityId) {
            const m = new Map();
            (APP_STATE.actuals?.production || []).forEach(r => {
                if (r.facilityId !== facilityId || r.date !== dateStr) return;
                m.set(`${r.equipmentId}__${r.productId}`, Number(r.quantityStn || 0));
            });
            return m;
        }


        function renderDailyActualsEquipmentGroup(equipmentList, label) {
            if (!equipmentList || !equipmentList.length) return '';
            const dateStr = (document.getElementById('actualsDate')?.value || getYesterdayDateString());
            const facilityId = APP_STATE.currentLocation || 'MIA';
            const eqType = equipmentList[0]?.type || '';
            const savedMap = getSavedActualsProductionMapByEquipment(dateStr, facilityId);

            const capProductIds = new Set();
            equipmentList.forEach(eq => getEquipmentCapabilitiesFor(eq.id).forEach(c => c.productId && capProductIds.add(String(c.productId))));
            let products = Array.from(capProductIds).map(pid => APP_STATE.products?.[pid]).filter(Boolean);

            const fallback = getActualsProductPoolForEquipmentType(eqType);
            fallback.forEach(p => { if (!products.find(x => String(x.id) === String(p.id))) products.push(p); });

            // Keep width manageable for now
            products = products.slice(0, 12);

            return `
              <div class="border rounded-lg p-3">
                <div class="font-medium text-gray-800 mb-2">${escapeHtml(label)}</div>
                <div class="text-xs text-gray-500 mb-2">Rows = equipment ¬∑ Columns = products ¬∑ Gray cells are blocked (not allowed for that equipment)</div>
                <div class="overflow-auto border rounded-lg bg-white">
                  <table class="min-w-full text-xs">
                    <thead class="bg-gray-100">
                      <tr>
                        <th class="text-left px-2 py-2 sticky left-0 bg-gray-100 z-10 min-w-[140px]">Equipment</th>
                        ${products.map(p => `<th class="text-center px-2 py-2 min-w-[110px]">${escapeHtml(p.name || p.code || p.id)}</th>`).join('')}
                      </tr>
                    </thead>
                    <tbody>
                      ${equipmentList.map(eq => {
                          const capSet = getCapabilityMapForEquipment(eq.id);
                          return `<tr class="border-t">
                            <td class="px-2 py-2 font-medium sticky left-0 bg-white z-10">${escapeHtml(eq.name || eq.id)}</td>
                            ${products.map(p => {
                                const enabled = capSet.has(String(p.id));
                                const savedVal = savedMap.get(`${eq.id}__${p.id}`);
                                if (!enabled) {
                                    return `<td class="px-1 py-1 bg-gray-100 text-center text-gray-400">‚Äî</td>`;
                                }
                                return `<td class="px-1 py-1">
                                  <input type="number" min="0" step="0.01"
                                    class="w-24 px-2 py-1 border rounded text-right actuals-prod-cell"
                                    data-equipment-id="${escapeHtml(eq.id)}"
                                    data-product-id="${escapeHtml(p.id)}"
                                    placeholder="STn"
                                    value="${Number.isFinite(savedVal) && savedVal > 0 ? savedVal : ''}">
                                </td>`;
                            }).join('')}
                          </tr>`;
                      }).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            `;
        }

        function renderDailyActualsFinishMillGroup(finishMills) {
            return renderDailyActualsEquipmentGroup(finishMills, 'Finish Mills (multi-product actuals allowed)');
        }

        function addDailyActualsFmRow(equipmentId, preset) {
            const host = document.getElementById(`dailyFmRows_${equipmentId}`);
            if (!host) return;
            const options = getCapabilityProductOptions(equipmentId);
            const row = document.createElement('div');
            row.className = 'grid grid-cols-1 md:grid-cols-12 gap-2 items-center';
            row.innerHTML = `
              <div class="md:col-span-7">
                <select class="w-full px-2 py-1 border rounded actuals-fm-product" data-equipment-id="${escapeHtml(equipmentId)}">
                  <option value="">Select product...</option>
                  ${options.map(p => `<option value="${escapeHtml(p.id)}">${escapeHtml(p.name)}</option>`).join('')}
                </select>
              </div>
              <div class="md:col-span-4">
                <input type="number" min="0" step="0.01" class="w-full px-2 py-1 border rounded actuals-fm-qty" data-equipment-id="${escapeHtml(equipmentId)}" placeholder="Production (STn)">
              </div>
              <div class="md:col-span-1 text-right">
                <button type="button" class="px-2 py-1 rounded border text-gray-600 hover:bg-white" onclick="this.closest('.grid').remove()">‚úï</button>
              </div>
            `;
            host.appendChild(row);
            if (preset) {
                const s = row.querySelector('select'); const q = row.querySelector('input');
                if (s && preset.productId) s.value = preset.productId;
                if (q && preset.quantityStn != null) q.value = preset.quantityStn;
            }
        }

        function updateDailyActualsTransfersVisibility() {
            const section = document.getElementById('dailyActualsTransfersSection');
            if (!section) return;
            const hasTransfer = (APP_STATE.flowDesigner?.connections || []).some(c => {
                const from = (APP_STATE.flowDesigner.equipment || []).find(e=>e.id===c.from);
                const to = (APP_STATE.flowDesigner.equipment || []).find(e=>e.id===c.to);
                if (!from || !to) return false;
                const fType = String(from.type||'');
                const tType = String(to.type||'');
                return (fType==='transfer' || tType==='transfer');
            });
            section.classList.toggle('hidden', !hasTransfer);
        }

        function closeDailyActualsForm() {
            const m = document.getElementById('dailyActualsModal');
            if (m) m.remove();
        }

        function saveDailyActualsForm() {
            const modal = document.getElementById('dailyActualsModal');
            if (!modal) return;
            const facilityId = APP_STATE.currentLocation || 'MIA';
            const dateStr = (document.getElementById('actualsDate')?.value || getYesterdayDateString());
            const nextDate = addDaysDateStr(dateStr, 1);

            APP_STATE.actuals ||= { production: [], shipments: [], inventoryEOD: [] };
            APP_STATE.actuals.production ||= [];
            APP_STATE.actuals.shipments ||= [];
            APP_STATE.actuals.inventoryEOD ||= [];

            // Remove existing entries for this facility/date (replace behavior)
            APP_STATE.actuals.production = APP_STATE.actuals.production.filter(r => !(r.facilityId===facilityId && r.date===dateStr));
            APP_STATE.actuals.shipments = APP_STATE.actuals.shipments.filter(r => !(r.facilityId===facilityId && r.date===dateStr));
            APP_STATE.actuals.inventoryEOD = APP_STATE.actuals.inventoryEOD.filter(r => !(r.facilityId===facilityId && r.date===dateStr));

            // Inventories (EOD yesterday -> seed BOD next day)
            modal.querySelectorAll('.actuals-inv').forEach(inp => {
                const storageId = inp.dataset.storageId;
                const productId = inp.dataset.productId;
                const v = Number(inp.value);
                if (!storageId || !productId || !Number.isFinite(v)) return;
                if (v < 0) return;
                APP_STATE.actuals.inventoryEOD.push({ date: dateStr, facilityId, storageId, productId, endingInventoryStn: v });
                APP_STATE.inventory ||= {};
                APP_STATE.inventory[storageId] ||= {};
                APP_STATE.inventory[storageId][productId] ||= {};
                APP_STATE.inventory[storageId][productId][nextDate] = v;
            });

            // Production rows (matrix cells across Raw Mills / Kilns / Finish Mills)
            modal.querySelectorAll('.actuals-prod-cell').forEach(inp => {
                const equipmentId = inp.dataset.equipmentId;
                const productId = inp.dataset.productId;
                const qty = Number(inp.value);
                if (!equipmentId || !productId || !Number.isFinite(qty) || qty <= 0) return;
                APP_STATE.actuals.production.push({ date: dateStr, facilityId, equipmentId, productId, quantityStn: qty });
            });

            // Legacy finish mill row support (kept if old modal markup is still present)
            modal.querySelectorAll('.actuals-fm-qty').forEach(inp => {
                const equipmentId = inp.dataset.equipmentId;
                const qty = Number(inp.value);
                const row = inp.closest('.grid');
                const productId = row?.querySelector('.actuals-fm-product')?.value || '';
                if (!equipmentId || !productId || !Number.isFinite(qty) || qty <= 0) return;
                APP_STATE.actuals.production.push({ date: dateStr, facilityId, equipmentId, productId, quantityStn: qty });
            });

            // Shipments -> also write into demandPlan as actuals for selected date
            modal.querySelectorAll('.actuals-ship').forEach(inp => {
                const productId = inp.dataset.productId;
                const qty = Number(inp.value);
                if (!productId || !Number.isFinite(qty) || qty < 0) return;
                APP_STATE.actuals.shipments.push({ date: dateStr, facilityId, productId, quantityStn: qty, type: 'customer' });
                APP_STATE.demandPlan ||= {};
                APP_STATE.demandPlan[productId] ||= {};
                APP_STATE.demandPlan[dateStr] = APP_STATE.demandPlan[dateStr] || APP_STATE.demandPlan[productId]; // no-op safety
                APP_STATE.demandPlan[productId][dateStr] = { value: qty, type: 'actual' };
            });

            // Preload existing FM rows if reopening later is not needed now; save and refresh
            ensureSandboxMode('plan');
            saveToLocalStorage();
            closeDailyActualsForm();
            renderApp();
            alert(`‚úÖ Daily actuals saved for ${facilityId} on ${dateStr}\n‚Ä¢ Ending inventories stored and seeded to ${nextDate} beginning inventory\n‚Ä¢ Shipments stored as actual demand for ${dateStr}`);
        }



        function cleanupLegacyPlaceholderSeeds() {
            try {
                if (!APP_STATE.inventory || typeof APP_STATE.inventory !== 'object') return;
                const actualInv = Array.isArray(APP_STATE.actuals?.inventoryEOD) ? APP_STATE.actuals.inventoryEOD : [];
                for (const [storageId, byProduct] of Object.entries(APP_STATE.inventory)) {
                    if (!byProduct || typeof byProduct !== 'object') continue;
                    for (const [productId, byDate] of Object.entries(byProduct)) {
                        if (!byDate || typeof byDate !== 'object') continue;
                        const vals = Object.values(byDate).map(v => Number(v)).filter(Number.isFinite);
                        if (!vals.length) continue;
                        const uniq = [...new Set(vals.map(v => Math.round(v * 1000) / 1000))];
                        const onlyPlaceholder = uniq.length === 1 && (uniq[0] === 7500 || uniq[0] === 5000);
                        const hasActualSupport = actualInv.some(r => String(r.storageId) === String(storageId) && String(r.productId) === String(productId));
                        if (onlyPlaceholder && !hasActualSupport) {
                            delete APP_STATE.inventory[storageId][productId];
                        }
                    }
                    if (Object.keys(APP_STATE.inventory[storageId] || {}).length === 0) delete APP_STATE.inventory[storageId];
                }
            } catch (e) { console.warn('cleanupLegacyPlaceholderSeeds failed', e); }
        }

        // ============================================
        // SAVE/LOAD
        // ============================================
        
        function saveToLocalStorage() {
            try {
                const data = snapshotCurrentPlannerData();
                // Legacy local key (kept for backward compatibility)
                localStorage.setItem('cementPlanner_' + APP_STATE.currentLocation, JSON.stringify(data));
                // New per-user sandbox local key (v1 scaffold)
                saveSandboxLocal();
            } catch (error) {
                console.error('Save error:', error);
            }
        }

        function loadFromLocalStorage() {
            try {
                // Priority: per-user sandbox (new) -> legacy local key (backward compatible)
                if (loadSandboxLocal()) {
                    console.log('Loaded sandbox from localStorage'); cleanupLegacyPlaceholderSeeds();
                    return;
                }

                const saved = localStorage.getItem('cementPlanner_' + (APP_STATE.currentLocation || 'MIA'));
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.products) {
                        APP_STATE.products = data.products;
                        const familyMap = {
                            'ck_raw': 'raw_materials',
                            'cem_raw': 'raw_materials',
                            'fuel': 'fuels',
                            'portland_cement': 'cementitious',
                            'blended_cement': 'cementitious',
                            'specialty_cement': 'cementitious'
                        };
                        Object.values(APP_STATE.products).forEach(p => {
                            if (familyMap[p.family]) p.family = familyMap[p.family];
                        });
                    }
                    applyPlannerSnapshot(data);
                    APP_STATE.scenarioContext.viewMode = 'sandbox';
                    console.log('Loaded legacy local data');
                }
            } catch (error) {
                console.error('Load error:', error);
            }
        }

        function saveFlowToLocalStorage() {
            saveToLocalStorage();
        }

        function loadFlowFromLocalStorage() {
            loadFromLocalStorage();
            if (typeof migrateEquipmentIdsIfNeeded === "function") { migrateEquipmentIdsIfNeeded(); }
        }

        function exportFlowToFile() {
            const data = {
                equipment: APP_STATE.flowDesigner.equipment,
                connections: APP_STATE.flowDesigner.connections,
                nextId: APP_STATE.flowDesigner.nextId,
                exportedAt: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flow_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importFlowFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        APP_STATE.flowDesigner.equipment = data.equipment;
                        APP_STATE.flowDesigner.connections = data.connections;
                        APP_STATE.flowDesigner.nextId = data.nextId || 1;
                        renderFlowCanvas();
                        saveToLocalStorage();
                        alert('‚úÖ Flow loaded!');
                    } catch (err) {
                        alert('‚ùå Error: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function resetAllData() {
            if (!confirm('‚ö†Ô∏è WARNING: This will DELETE ALL DATA for this plant!\n\nAre you absolutely sure?')) {
                return;
            }
            
            if (!confirm('Last chance! This cannot be undone.\n\nDelete all data?')) {
                return;
            }
            
            // Clear localStorage for current location
            const key = 'cementPlanner_' + (APP_STATE.currentLocation || 'MIA');
            localStorage.removeItem(key);
            
            // Reload page to reset everything
            window.location.reload();
        }

        // ============================================
        // EXCEL INTEGRATION - Hybrid Approach
        // ============================================
        
        // Store folder handle for persistent access
        let dataFolderHandle = null;
        
        async function setupDataFolder() {
            try {
                // Request folder permission
                const dirHandle = await window.showDirectoryPicker({
                    mode: 'readwrite'
                });
                
                // Store handle (note: handle can't be stored in localStorage directly)
                dataFolderHandle = dirHandle;
                
                // Create Excel template files
                await createExcelTemplates(dirHandle);
                
                alert('‚úÖ Data folder configured!\n\nExcel files created in selected folder.\nApp will now auto-save to these files.');
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('User cancelled folder selection');
                } else {
                    console.error('Error setting up data folder:', error);
                    alert('‚ùå Error: ' + error.message);
                }
            }
        }
        
        async function createExcelTemplates(dirHandle) {
            // Create template Excel files
            await createProductsExcel(dirHandle);
            await createEquipmentExcel(dirHandle);
            await createCampaignsExcel(dirHandle);
            await createDemandExcel(dirHandle);
            await createInventoryExcel(dirHandle);
        }
        
        function exportAllDataToExcel() {
            // Create Excel files and download as ZIP
            const files = {
                'products.xlsx': createProductsExcelBlob(),
                'equipment.xlsx': createEquipmentExcelBlob(),
                'campaigns.xlsx': createCampaignsExcelBlob(),
                'demand.xlsx': createDemandExcelBlob(),
                'inventory.xlsx': createInventoryExcelBlob()
            };
            
            // For now, download each file individually
            // (ZIP creation would require additional library)
            Object.keys(files).forEach(filename => {
                const blob = files[filename];
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            });
            
            alert('‚úÖ Excel files exported!\n\n5 files downloaded:\n- products.xlsx\n- equipment.xlsx\n- campaigns.xlsx\n- demand.xlsx\n- inventory.xlsx');
        }
        
        function createProductsExcelBlob() {
            // Convert products to CSV (simple format)
            const products = Object.values(APP_STATE.products);
            
            let csv = 'ID,Name,Family,Color,Clinker,Gypsum,Limestone,FlyAsh,Slag,Pozzolana,Additives\n';
            
            products.forEach(p => {
                const recipe = p.recipe || {};
                csv += `${p.id},${p.name},${p.family || ''},${p.color},`;
                csv += `${recipe.clinker || 0},${recipe.gypsum || 0},${recipe.limestone || 0},`;
                csv += `${recipe.fly_ash || 0},${recipe.slag || 0},${recipe.pozzolana || 0},${recipe.additives || 0}\n`;
            });
            
            return new Blob([csv], { type: 'text/csv' });
        }
        
        function createEquipmentExcelBlob() {
            const equipment = APP_STATE.flowDesigner.equipment;
            
            let csv = 'ID,Name,Type,X,Y,TPD,TPH,MaxVolume,MaterialType,BagSize,LoadoutType\n';
            
            equipment.forEach(eq => {
                const params = eq.params || {};
                csv += `${eq.id},${eq.name},${eq.type},${eq.x},${eq.y},`;
                csv += `${params.tpd || ''},${params.tph || ''},${params.max_volume || ''},`;
                csv += `${params.material_type || ''},${params.bag_size || ''},${params.loadout_type || ''}\n`;
            });
            
            return new Blob([csv], { type: 'text/csv' });
        }
        
        function createCampaignsExcelBlob() {
            const campaigns = APP_STATE.productionPlan.campaigns || [];
            
            let csv = 'ID,Type,EquipmentID,ProductID,ProductName,StartDate,EndDate,Duration,CustomRate\n';
            
            campaigns.forEach(c => {
                csv += `${c.id},${c.type},${c.equipmentId},${c.productId || ''},${c.productName || ''},`;
                csv += `${c.startDate},${c.endDate},${c.duration},${c.customRate || ''}\n`;
            });
            
            return new Blob([csv], { type: 'text/csv' });
        }
        
        function createDemandExcelBlob() {
            const demandPlan = APP_STATE.demandPlan;
            const products = Object.values(APP_STATE.products);
            
            // Get all unique dates
            const dates = new Set();
            Object.values(demandPlan).forEach(productData => {
                Object.keys(productData).forEach(date => dates.add(date));
            });
            const sortedDates = Array.from(dates).sort();
            
            // Header row
            let csv = 'Date,' + products.map(p => p.name).join(',') + '\n';
            
            // Data rows
            sortedDates.forEach(date => {
                csv += date;
                products.forEach(p => {
                    const value = demandPlan[p.id]?.[date]?.value || '';
                    csv += ',' + value;
                });
                csv += '\n';
            });
            
            return new Blob([csv], { type: 'text/csv' });
        }
        
        function createInventoryExcelBlob() {
            // Placeholder - would calculate from campaigns
            let csv = 'Date,Silo,Beginning,Production,Demand,Ending\n';
            csv += '2026-02-20,OPC Silo,1200,3600,3450,1350\n';
            
            return new Blob([csv], { type: 'text/csv' });
        }
        
        async function createProductsExcel(dirHandle) {
            const blob = createProductsExcelBlob();
            await writeFileToFolder(dirHandle, 'products.csv', blob);
        }
        
        async function createEquipmentExcel(dirHandle) {
            const blob = createEquipmentExcelBlob();
            await writeFileToFolder(dirHandle, 'equipment.csv', blob);
        }
        
        async function createCampaignsExcel(dirHandle) {
            const blob = createCampaignsExcelBlob();
            await writeFileToFolder(dirHandle, 'campaigns.csv', blob);
        }
        
        async function createDemandExcel(dirHandle) {
            const blob = createDemandExcelBlob();
            await writeFileToFolder(dirHandle, 'demand.csv', blob);
        }
        
        async function createInventoryExcel(dirHandle) {
            const blob = createInventoryExcelBlob();
            await writeFileToFolder(dirHandle, 'inventory.csv', blob);
        }
        
        async function writeFileToFolder(dirHandle, filename, blob) {
            try {
                const fileHandle = await dirHandle.getFileHandle(filename, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(blob);
                await writable.close();
            } catch (error) {
                console.error(`Error writing ${filename}:`, error);
            }
        }
        
        async function saveToExcelFolder() {
            if (!dataFolderHandle) {
                alert('‚ö†Ô∏è Data folder not configured.\n\nClick "Setup Data Folder" first.');
                return;
            }
            
            try {
                await createExcelTemplates(dataFolderHandle);
                alert('‚úÖ Data saved to Excel files!');
            } catch (error) {
                console.error('Error saving to Excel:', error);
                alert('‚ùå Error saving: ' + error.message);
            }
        }
        
        async function loadFromExcelFolder() {
            if (!dataFolderHandle) {
                alert('‚ö†Ô∏è Data folder not configured.\n\nClick "Setup Data Folder" first.');
                return;
            }
            
            try {
                // Read each file
                await loadProductsFromFolder(dataFolderHandle);
                await loadEquipmentFromFolder(dataFolderHandle);
                await loadCampaignsFromFolder(dataFolderHandle);
                await loadDemandFromFolder(dataFolderHandle);
                
                saveToLocalStorage();
                renderApp();
                
                alert('‚úÖ Data loaded from Excel files!');
            } catch (error) {
                console.error('Error loading from Excel:', error);
                alert('‚ùå Error loading: ' + error.message);
            }
        }
        
        async function loadProductsFromFolder(dirHandle) {
            try {
                const fileHandle = await dirHandle.getFileHandle('products.csv');
                const file = await fileHandle.getFile();
                const text = await file.text();
                const lines = text.split('\n').slice(1); // Skip header
                
                APP_STATE.products = {};
                
                lines.forEach(line => {
                    if (!line.trim()) return;
                    const [id, name, family, color, clinker, gypsum, limestone, flyAsh, slag, pozzolana, additives] = line.split(',');
                    
                    APP_STATE.products[id] = {
                        id: id,
                        name: name,
                        family: family,
                        color: color,
                        recipe: {
                            clinker: parseFloat(clinker) || 0,
                            gypsum: parseFloat(gypsum) || 0,
                            limestone: parseFloat(limestone) || 0,
                            fly_ash: parseFloat(flyAsh) || 0,
                            slag: parseFloat(slag) || 0,
                            pozzolana: parseFloat(pozzolana) || 0,
                            additives: parseFloat(additives) || 0
                        }
                    };
                });
            } catch (error) {
                console.log('Products file not found or error reading:', error);
            }
        }
        
        async function loadEquipmentFromFolder(dirHandle) {
            try {
                const fileHandle = await dirHandle.getFileHandle('equipment.csv');
                const file = await fileHandle.getFile();
                const text = await file.text();
                const lines = text.split('\n').slice(1); // Skip header
                
                APP_STATE.flowDesigner.equipment = [];
                
                lines.forEach(line => {
                    if (!line.trim()) return;
                    const [id, name, type, x, y, tpd, tph, maxVolume, materialType, bagSize, loadoutType] = line.split(',');
                    
                    const params = {};
                    if (tpd) params.tpd = parseFloat(tpd);
                    if (tph) params.tph = parseFloat(tph);
                    if (maxVolume) params.max_volume = parseFloat(maxVolume);
                    if (materialType) params.material_type = materialType;
                    if (bagSize) params.bag_size = parseFloat(bagSize);
                    if (loadoutType) params.loadout_type = loadoutType;
                    
                    APP_STATE.flowDesigner.equipment.push({
                        id: id,
                        name: name,
                        type: type,
                        x: parseFloat(x),
                        y: parseFloat(y),
                        params: params
                    });
                });
            } catch (error) {
                console.log('Equipment file not found or error reading:', error);
            }
        }
        
        async function loadCampaignsFromFolder(dirHandle) {
            try {
                const fileHandle = await dirHandle.getFileHandle('campaigns.csv');
                const file = await fileHandle.getFile();
                const text = await file.text();
                const lines = text.split('\n').slice(1); // Skip header
                
                APP_STATE.productionPlan.campaigns = [];
                
                lines.forEach(line => {
                    if (!line.trim()) return;
                    const [id, type, equipmentId, productId, productName, startDate, endDate, duration, customRate] = line.split(',');
                    
                    APP_STATE.productionPlan.campaigns.push({
                        id: id,
                        type: type,
                        equipmentId: equipmentId,
                        productId: productId || null,
                        productName: productName || null,
                        startDate: startDate,
                        endDate: endDate,
                        duration: parseInt(duration),
                        customRate: customRate ? parseFloat(customRate) : null
                    });
                });
            } catch (error) {
                console.log('Campaigns file not found or error reading:', error);
            }
        }
        
        async function loadDemandFromFolder(dirHandle) {
            try {
                const fileHandle = await dirHandle.getFileHandle('demand.csv');
                const file = await fileHandle.getFile();
                const text = await file.text();
                const lines = text.split('\n');
                
                if (lines.length < 2) return;
                
                // Parse header to get product IDs
                const header = lines[0].split(',').slice(1); // Skip "Date" column
                const products = Object.values(APP_STATE.products);
                
                // Initialize demand plan
                APP_STATE.demandPlan = {};
                products.forEach(p => {
                    APP_STATE.demandPlan[p.id] = {};
                });
                
                // Parse data rows
                lines.slice(1).forEach(line => {
                    if (!line.trim()) return;
                    const parts = line.split(',');
                    const date = parts[0];
                    
                    header.forEach((productName, index) => {
                        const product = products.find(p => p.name === productName);
                        if (product) {
                            const value = parseFloat(parts[index + 1]) || 0;
                            APP_STATE.demandPlan[product.id][date] = {
                                value: value,
                                type: 'actual'
                            };
                        }
                    });
                });
            } catch (error) {
                console.log('Demand file not found or error reading:', error);
            }
        }
        
        function exportAllData() {
            // Show options
            const choice = confirm('Export data as Excel files?\n\nOK = Excel files (CSV)\nCancel = JSON file');
            
            if (choice) {
                exportAllDataToExcel();
            } else {
                // Original JSON export
                const data = {
                    products: APP_STATE.products,
                    flowDesigner: APP_STATE.flowDesigner,
                    productionPlan: APP_STATE.productionPlan,
                    demandPlan: APP_STATE.demandPlan,
                    exportedAt: new Date().toISOString(),
                    version: '1.0'
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cement_planner_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                alert('‚úÖ Data exported as JSON!');
            }
        }

        function showDataManagementMenu() {
            const modal = document.createElement('div');
            modal.id = 'dataManagementModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl w-full max-w-md">
                    <div class="bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-4 rounded-t-lg">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold">üìÅ Data Management</h3>
                            <button onclick="closeDataManagementMenu()" class="text-white hover:text-gray-200">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6 space-y-3">
                        <button onclick="setupDataFolder()" 
                                class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 px-4 rounded-lg font-semibold text-left flex items-center">
                            <span class="mr-3">üìÇ</span>
                            <div>
                                <div class="font-semibold">Setup Data Folder</div>
                                <div class="text-xs opacity-90">Select folder for Excel files (one-time)</div>
                            </div>
                        </button>
                        
                        <button onclick="saveToExcelFolder()" 
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-semibold text-left flex items-center">
                            <span class="mr-3">üíæ</span>
                            <div>
                                <div class="font-semibold">Save to Excel Folder</div>
                                <div class="text-xs opacity-90">Update Excel files in configured folder</div>
                            </div>
                        </button>
                        
                        <button onclick="loadFromExcelFolder()" 
                                class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-semibold text-left flex items-center">
                            <span class="mr-3">üì•</span>
                            <div>
                                <div class="font-semibold">Load from Excel Folder</div>
                                <div class="text-xs opacity-90">Import latest data from Excel files</div>
                            </div>
                        </button>
                        
                        <hr class="my-4">
                        
                        <button onclick="exportAllDataToExcel(); closeDataManagementMenu();" 
                                class="w-full bg-teal-600 hover:bg-teal-700 text-white py-3 px-4 rounded-lg font-semibold text-left flex items-center">
                            <span class="mr-3">üìä</span>
                            <div>
                                <div class="font-semibold">Export Excel Files</div>
                                <div class="text-xs opacity-90">Download all data as CSV files</div>
                            </div>
                        </button>
                        
                        <button onclick="closeDataManagementMenu()" 
                                class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg font-semibold">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function closeDataManagementMenu() {
            const modal = document.getElementById('dataManagementModal');
            if (modal) modal.remove();
        }

        // ============================================
        // INITIALIZE
        // ============================================
        
        console.log('Loading from localStorage...');
        loadFromLocalStorage();
        if (typeof migrateEquipmentIdsIfNeeded === "function") { migrateEquipmentIdsIfNeeded(); }
        console.log('Rendering app...');
        try {
            renderApp();
            console.log('App rendered successfully');
        } catch (error) {
            console.error('Error rendering app:', error);
            document.getElementById('app').innerHTML = `
                <div style="padding: 20px; color: red; font-family: monospace;">
                    <h1>Error Loading Application</h1>
                    <pre>${error.message}\n${error.stack}</pre>
                </div>
            `;
        }
        
        console.log('=== CEMENT PLANNER INITIALIZED ===');
    </script>

<script>
// ===== FANO Phase 3: Official/Sandbox + Local Tables/Data Hub =====
(function(){
  const origRenderNavTabs = window.renderNavTabs;
  window.renderNavTabs = function() {
    const html = origRenderNavTabs();
    return html.replace('</nav>', `
      <button onclick="switchTab('datahub')"
        class="border-b-2 ${APP_STATE.currentTab === 'datahub' ? 'border-blue-600 text-blue-600 bg-blue-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'} py-3 px-4 font-semibold text-sm transition-colors rounded-t">
        6. Data & Scenarios
      </button>
    </nav>`);
  };

  const origRenderHeader = window.renderHeader;
  window.renderHeader = function(){
    let h = origRenderHeader();
    const mode = APP_STATE?.scenarioContext?.viewMode || 'sandbox';
    const dirty = APP_STATE?.scenarioContext?.sandboxMeta?.dirtyDomains || {};
    const dirtyList = Object.entries(dirty).filter(([,v])=>v).map(([k])=>k);
    const badge = `
      <div class="ml-3 flex items-center gap-2">
        <span class="px-2 py-1 rounded text-xs font-bold ${mode==='official'?'bg-gray-800 text-white':'bg-amber-100 text-amber-800 border border-amber-300'}">${mode==='official'?'OFFICIAL':'SANDBOX'}</span>
        <span class="text-xs text-gray-500">User: ${escapeHtml(APP_STATE.currentUser||'local_user')}</span>
        ${dirtyList.length?`<span class="text-xs text-amber-700">Dirty: ${dirtyList.join(', ')}</span>`:''}
      </div>`;
    h = h.replace('<div>\n                                <h1 class="text-lg font-bold text-gray-900">FANO Version - Production Planning System</h1>', `<div style="display:flex;align-items:center;flex-wrap:wrap;gap:4px;">\n                                <div><h1 class="text-lg font-bold text-gray-900">FANO Version - Production Planning System</h1>`)
         .replace('<p class="text-xs text-gray-400">Configure ‚Üí Design ‚Üí Plan ‚Üí Monitor</p>\n                            </div>', '<p class="text-xs text-gray-400">Configure ‚Üí Design ‚Üí Plan ‚Üí Monitor</p></div>'+badge+'\n                            </div>');
    return h;
  };

  const origRenderApp = window.renderApp;
  window.renderApp = function(){
    if (APP_STATE.currentTab !== 'datahub') return origRenderApp();
    const app = document.getElementById('app');
    let content = '';
    content += renderHeader();
    content += renderNavTabs();
    content += renderDataHubTab();
    app.innerHTML = content;
  };

  const coreTableList = [
    'Region','FacilityType','Facility','Product','RecipeHeader','RecipeComponent','Customer','Equipment','EquipmentProductCapability','StorageUnit','Connection','Rules','Scenario','PublishLog'
  ];


  function mapFamilyToCategory(family){
    if (family === 'raw_materials') return 'RAW_MATERIAL';
    if (family === 'fuels') return 'FUEL';
    if (family === 'intermediate') return 'INTERMEDIATE_PRODUCT';
    return 'FINISHED_PRODUCT';
  }
  function parseProductCodeFallback(p){
    return (p.code || p.id || p.name || '').toString().toUpperCase().replace(/[^A-Z0-9_\-]/g,'_').slice(0,40);
  }
  function getFacilityScopedProductVersionKey(facilityId, productIdOrCode, versionNo){
    const f = (facilityId || APP_STATE.currentLocation || 'NA').toString().trim().toUpperCase();
    const p = (productIdOrCode || 'UNKNOWN').toString().trim().toUpperCase().replace(/[^A-Z0-9_\-]/g,'_');
    const vRaw = (versionNo === undefined || versionNo === null || versionNo === '') ? 1 : versionNo;
    const vNum = Number(vRaw);
    const v = Number.isFinite(vNum) ? `v${Math.trunc(vNum)}` : `v${String(vRaw).replace(/[^A-Z0-9_\-]/gi,'_')}`;
    return `${f}|${p}|${v}`;
  }

  function sanitizeIdToken(v){
    return (v || '').toString().trim().toUpperCase().replace(/[^A-Z0-9_\-]/g,'_').replace(/_+/g,'_').replace(/^_+|_+$/g,'');
  }
  function getFacilityScopedEquipmentId(facilityId, equipmentName){
    const f = sanitizeIdToken(facilityId || APP_STATE.currentLocation || 'NA');
    const n = sanitizeIdToken(equipmentName || 'EQ');
    return `${f}_${n}`;
  }
  function ensureUniqueEquipmentId(baseId, existingIds){
    let id = baseId;
    if (!existingIds.has(id)) return id;
    let i = 2;
    while (existingIds.has(`${baseId}_${i}`)) i++;
    return `${baseId}_${i}`;
  }
  function migrateEquipmentIdsIfNeeded(){
    try{
      const loc = APP_STATE.currentLocation || 'NA';
      const eqList = (APP_STATE.flowDesigner && APP_STATE.flowDesigner.equipment) ? APP_STATE.flowDesigner.equipment : [];
      if (!Array.isArray(eqList) || eqList.length === 0) return;
      const hasLegacy = eqList.some(e => (e.id || '').startsWith('eq_'));
      if (!hasLegacy) return;
      const existing = new Set(eqList.map(e => e.id));
      const map = {};
      // Build mapping old->new
      eqList.forEach(e=>{
        const oldId = e.id;
        if (!oldId || !oldId.startsWith('eq_')) return;
        const base = getFacilityScopedEquipmentId(loc, e.name || oldId);
        const newId = ensureUniqueEquipmentId(base, existing);
        if (newId !== oldId){
          map[oldId] = newId;
          existing.add(newId);
        }
      });
      const keys = Object.keys(map);
      if (keys.length === 0) return;

      // Apply mapping to equipment list
      eqList.forEach(e=>{
        if (map[e.id]) e.id = map[e.id];
      });

      // Update connections
      const conns = (APP_STATE.flowDesigner && APP_STATE.flowDesigner.connections) ? APP_STATE.flowDesigner.connections : [];
      if (Array.isArray(conns)){
        conns.forEach(c=>{
          if (map[c.from]) c.from = map[c.from];
          if (map[c.to]) c.to = map[c.to];
        });
      }

      // Update capability rows
      if (APP_STATE.data && Array.isArray(APP_STATE.data.equipmentProductCapability)){
        APP_STATE.data.equipmentProductCapability.forEach(r=>{
          if (map[r.equipment_id]) r.equipment_id = map[r.equipment_id];
          if (map[r.equipmentId]) r.equipmentId = map[r.equipmentId];
        });
      }

      // Update selected equipment pointers
      if (APP_STATE.flowDesigner){
        if (map[APP_STATE.flowDesigner.selectedEquipment]) APP_STATE.flowDesigner.selectedEquipment = map[APP_STATE.flowDesigner.selectedEquipment];
        if (Array.isArray(APP_STATE.flowDesigner.selectedIds)){
          APP_STATE.flowDesigner.selectedIds = APP_STATE.flowDesigner.selectedIds.map(id => map[id] || id);
        }
        if (APP_STATE.flowDesigner.connecting && map[APP_STATE.flowDesigner.connecting.from]){
          APP_STATE.flowDesigner.connecting.from = map[APP_STATE.flowDesigner.connecting.from];
        }
      }
    }catch(err){
      console.warn('Equipment ID migration skipped:', err);
    }
  }
  // Expose helpers globally so legacy/global functions (e.g., addFlowEquipment) can use them
  window.sanitizeIdToken = sanitizeIdToken;
  window.getFacilityScopedEquipmentId = getFacilityScopedEquipmentId;
  window.ensureUniqueEquipmentId = ensureUniqueEquipmentId;
  window.migrateEquipmentIdsIfNeeded = migrateEquipmentIdsIfNeeded;

  function inferProductVersionNoForRecipe(p){
    return Number(p.recipeVersionNo || p.versionNo || 1) || 1;
  }
  function buildRecipeRows(){
    const headers = [];
    const lines = [];
    const facilityId = APP_STATE.currentLocation || 'NA';
    Object.values(APP_STATE.products||{}).forEach((p,idx) => {
      const family = p.family || 'cementitious';
      const hasRecipe = family === 'intermediate' || family === 'cementitious';
      const recipeObj = p.recipe || {};
      const entries = Object.entries(recipeObj).filter(([_,v]) => Number(v) > 0);
      if (!hasRecipe || !entries.length) return;
      const productId = p.id || '';
      const productCode = parseProductCodeFallback(p);
      const versionNo = inferProductVersionNoForRecipe(p);
      const facilityProductVersionKey = getFacilityScopedProductVersionKey(facilityId, productCode || productId, versionNo);
      const recipeId = `RCP|${facilityProductVersionKey}`;
      headers.push({
        recipe_id: recipeId,
        facility_product_version_key: facilityProductVersionKey,
        facility_id: facilityId,
        output_product_id: productId,
        output_product_code: productCode,
        version_no: versionNo,
        effective_start: p.recipeEffectiveStart || '',
        effective_end: p.recipeEffectiveEnd || '',
        active: p.active !== false
      });
      entries.forEach(([mat,pct], lineIdx) => {
        lines.push({
          recipe_line_id: `${recipeId}|L${lineIdx+1}`,
          recipe_id: recipeId,
          facility_product_version_key: facilityProductVersionKey,
          facility_id: facilityId,
          output_product_id: productId,
          component_material_name: mat,
          pct_of_output: Number(pct) || 0
        });
      });
    });
    return { headers, lines };
  }

  window.getDataHubTables = function(){
    const loc = APP_STATE.currentLocation;
    const scenarioMode = APP_STATE.scenarioContext.viewMode;
    const now = new Date().toISOString();
    const rows = {};
    rows.Region = (APP_STATE.orgStructure?.regions||[]).map(r => ({...r}));
    rows.FacilityType = (APP_STATE.orgStructure?.facilityTypes||[]).map(f => ({...f}));
    rows.Facility = buildFacilityRows();
    rows.Product = Object.values(APP_STATE.products||{}).map(p => ({
      product_id: p.id || '',
      product_code: p.code || p.id || '',
      product_name: p.name || '',
      product_category: mapFamilyToCategory(p.family || ''),
      family: p.family || '',
      uom_mass: p.uomMass || 'STn',
      landed_cost_usd_per_stn: p.landedCostUsdPerStn ?? '',
      calorific_power_mmbtu_per_stn: p.calorificPowerMMBTUPerStn ?? '',
      co2_factor_kgco2_per_mmbtu: p.co2FactorKgCO2PerMMBTU ?? '',
      active: p.active !== false,
      location_code: loc,
      recipe_version_no: inferProductVersionNoForRecipe(p),
      facility_product_version_key: getFacilityScopedProductVersionKey(loc, (p.code || p.id || ''), inferProductVersionNoForRecipe(p))
    }));
    const recipeRows = buildRecipeRows();
    rows.RecipeHeader = recipeRows.headers;
    rows.RecipeComponent = recipeRows.lines;
    rows.Customer = Object.values(APP_STATE.customers || {}).map(c => ({
      customer_code: c.code || c.id || '', customer_name: c.name || '', active: c.active !== false
    }));
    rows.Equipment = buildEquipmentRows();
    rows.EquipmentProductCapability = buildEquipmentProductCapabilityRows();
    rows.StorageUnit = buildStorageRows();
    rows.Connection = buildConnectionRows();
    rows.Rules = buildRulesRows();
    rows.Scenario = [{
      scenario_id: scenarioMode === 'official' ? `OFFICIAL_${loc}` : `SANDBOX_${loc}_${APP_STATE.currentUser}`,
      scenario_type: scenarioMode.toUpperCase(),
      sandbox_owner: scenarioMode === 'sandbox' ? APP_STATE.currentUser : '',
      location_code: loc,
      updated_at: now
    }];
    rows.PublishLog = (APP_STATE.publishLog||[]).map(r=>({...r}));
    return rows;
  };

  function buildFacilityRows(){
    const locs = window.CEMEX_LOCATIONS || {};
    return Object.values(locs).map(l => ({
      facility_id: l.code,
      facility_code: l.code,
      facility_name: l.name,
      facility_type_code: (l.type||'').toUpperCase(),
      region_id: 'FL',
      country_code: 'USA',
      active: true
    }));
  }
  function buildEquipmentRows(){
    return (APP_STATE.flowDesigner?.equipment||[]).map(e => ({
      equipment_id: e.id,
      equipment_code: e.id,
      equipment_name: e.name || e.type || `EQ-${e.id}`,
      equipment_type: e.type || '',
      facility_id: APP_STATE.currentLocation,
      x: e.x, y: e.y,
      active: e.active !== false
    }));
  }

  function buildEquipmentProductCapabilityRows(){
    const rows = [];
    (APP_STATE.flowDesigner?.equipment||[]).forEach(e => {
      const caps = e?.params?.products || {};
      Object.entries(caps).forEach(([productId, cap]) => {
        if (!cap || cap.enabled === false) return;
        const p = APP_STATE.products?.[productId] || {};
        const productCode = p.code || p.id || productId;
        const versionNo = inferProductVersionNoForRecipe(p);
        rows.push({
          equipment_id: e.id,
          equipment_type: e.type || '',
          facility_id: APP_STATE.currentLocation,
          product_id: productId,
          product_code: productCode,
          facility_product_version_key: getFacilityScopedProductVersionKey(APP_STATE.currentLocation, productCode, versionNo),
          product_name: p.name || productId,
          max_rate_stn_per_day: cap.tpd ?? '',
          electric_kwh_per_stn: cap.kwh_per_ton ?? '',
          thermal_mmbtu_per_stn: cap.mmbtu_per_stn ?? '',
          active: true
        });
      });
    });
    return rows;
  }
  function buildStorageRows(){
    const out = [];
    const seen = new Set();
    const eq = APP_STATE.flowDesigner?.equipment||[];
    eq.forEach(e => {
      const t = (e.type||'').toLowerCase();
      if (t.includes('silo') || t.includes('storage') || t.includes('dispatch') || t.includes('packer')) {
        const id = String(e.id);
        if (seen.has(id)) return;
        seen.add(id);
        out.push({
          storage_unit_id: id,
          storage_code: id,
          storage_name: e.name || e.type || id,
          storage_type: e.type || 'STORAGE',
          facility_id: APP_STATE.currentLocation,
          min_capacity_tons: e.params?.min_capacity ?? '',
          max_capacity_tons: e.params?.capacity ?? e.params?.max_capacity ?? '',
          active: e.active !== false
        });
      }
    });
    return out;
  }
  function buildConnectionRows(){
    const internal = (APP_STATE.flowDesigner?.connections||[]).map((c,idx) => ({
      connection_id: c.id || `FLOW_${idx+1}`,
      connection_type: 'INTERNAL',
      from_node: c.from || c.fromId || '',
      to_node: c.to || c.toId || '',
      facility_id: APP_STATE.currentLocation,
      active: c.active !== false
    }));
    const network = (APP_STATE.networkMap?.connections||[]).map((c,idx) => ({
      connection_id: c.id || `NET_${idx+1}`,
      connection_type: c.connectionType || 'INTER_FACILITY',
      from_node: c.from || c.from_node || '',
      to_node: c.to || c.to_node || '',
      facility_id: c.facility_id || '',
      active: c.active !== false
    }));
    return [...internal, ...network];
  }
  function buildRulesRows(){
    const rows = [];
    // existing simple rules
    const r = APP_STATE.rules || {};
    if (r.operational) {
      Object.entries(r.operational).forEach(([k,v]) => rows.push({ rule_key:k, rule_type:'soft', enabled:true, param_text: typeof v==='object'?JSON.stringify(v):'', param_number: typeof v==='number'?v:'', scope_country:'USA', scope_region:'FL' }));
    }
    if (r.system) {
      Object.entries(r.system).forEach(([k,v]) => rows.push({ rule_key:k, rule_type:'hard', enabled: !!v, param_text:'', param_number:'', scope_country:'USA', scope_region:'FL' }));
    }
    if (APP_STATE.rulesBook?.scopedRules?.length) {
      APP_STATE.rulesBook.scopedRules.forEach((x) => rows.push({
        rule_key:x.rule_key||x.key||'', rule_type:x.rule_type||'hard', enabled:x.enabled!==false,
        scope_country:x.country||'', scope_region:x.region||'', scope_facility:x.facility||'', scope_equipment:x.equipment||'', scope_storage:x.storage||'',
        param_text:x.param_text || x.value_text || '', param_number:x.param_number ?? x.value_number ?? ''
      }));
    }
    return rows;
  }

  window.renderDataHubTab = function(){
    const tables = getDataHubTables();
    const selected = APP_STATE.dataHub?.selectedTable || 'Region';
    APP_STATE.dataHub ||= { selectedTable:'Region' };
    const rows = tables[selected] || [];
    const keys = rows.length ? Object.keys(rows[0]) : (DATA_MODEL.tables?.[selected]?.columns||[]).map(c=>c.name);
    return `
      <div class="p-6 space-y-4 bg-gray-50 min-h-screen">
        <div class="bg-white rounded-lg border border-gray-200 p-4">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <h2 class="text-xl font-bold text-gray-900">Data & Scenarios Hub</h2>
              <p class="text-sm text-gray-500">Official on shared file later (SharePoint), Sandbox local per user (today local/localStorage + file import/export)</p>
            </div>
            <div class="flex flex-wrap gap-2">
              <button onclick="switchScenarioView('official')" class="px-3 py-2 rounded border text-sm ${APP_STATE.scenarioContext.viewMode==='official'?'bg-gray-900 text-white border-gray-900':'bg-white text-gray-700 border-gray-300'}">View Official</button>
              <button onclick="switchScenarioView('sandbox')" class="px-3 py-2 rounded border text-sm ${APP_STATE.scenarioContext.viewMode==='sandbox'?'bg-amber-500 text-white border-amber-500':'bg-white text-gray-700 border-gray-300'}">View Sandbox</button>
              <button onclick="cloneOfficialToSandbox()" class="px-3 py-2 rounded bg-blue-600 text-white text-sm">Clone Official ‚Üí Sandbox</button>
              <button onclick="openPushToOfficialModal()" class="px-3 py-2 rounded bg-green-600 text-white text-sm">Push Sandbox ‚Üí Official</button>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="lg:col-span-1 bg-white rounded-lg border border-gray-200 p-4">
            <div class="font-semibold text-gray-900 mb-3">Project Files (local for now)</div>
            <div class="space-y-2 text-sm">
              <button onclick="exportCurrentScenarioJson()" class="w-full text-left px-3 py-2 rounded bg-gray-100 hover:bg-gray-200">Export Current Scenario (.json)</button>
              <button onclick="exportOfficialJson()" class="w-full text-left px-3 py-2 rounded bg-gray-100 hover:bg-gray-200">Export Official (.json)</button>
              <button onclick="exportTablesCsvBundle()" class="w-full text-left px-3 py-2 rounded bg-gray-100 hover:bg-gray-200">Export Selected Table (.csv)</button>
              <button onclick="triggerImportProjectJson()" class="w-full text-left px-3 py-2 rounded bg-gray-100 hover:bg-gray-200">Import Project/Scenario (.json)</button>
              <button onclick="triggerImportTableCsv()" class="w-full text-left px-3 py-2 rounded bg-gray-100 hover:bg-gray-200">Import Table (.csv ‚Üí selected)</button>
              <input id="projectJsonInput" type="file" accept=".json,application/json" class="hidden" onchange="handleProjectJsonImport(event)">
              <input id="tableCsvInput" type="file" accept=".csv,text/csv" class="hidden" onchange="handleTableCsvImport(event)">
            </div>
            <div class="mt-4 pt-4 border-t text-xs text-gray-500 space-y-1">
              <div>Current user: <b>${escapeHtml(APP_STATE.currentUser||'local_user')}</b></div>
              <div>Current location: <b>${escapeHtml(APP_STATE.currentLocation||'MIA')}</b></div>
              <div>Mode: <b>${escapeHtml(APP_STATE.scenarioContext.viewMode||'sandbox').toUpperCase()}</b></div>
            </div>
          </div>

          <div class="lg:col-span-2 bg-white rounded-lg border border-gray-200 p-4">
            <div class="flex flex-wrap gap-2 mb-3">
              ${coreTableList.map(t => `
                <button onclick="selectDataHubTable('${t}')" class="px-2.5 py-1.5 rounded text-xs border ${selected===t?'bg-blue-600 text-white border-blue-600':'bg-white text-gray-700 border-gray-300'}">${t}</button>`).join('')}
            </div>
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm text-gray-600"><b>${selected}</b> ¬∑ ${rows.length} rows</div>
              <div class="flex gap-2">
                <button onclick="downloadSelectedTableCsv()" class="px-3 py-1.5 rounded bg-slate-700 text-white text-xs">Export CSV</button>
                <button onclick="downloadSelectedTableJson()" class="px-3 py-1.5 rounded bg-slate-500 text-white text-xs">Export JSON</button>
              </div>
            </div>
            <div class="overflow-auto border rounded max-h-[520px]">
              <table class="min-w-full text-xs">
                <thead class="bg-gray-100 sticky top-0 z-10">
                  <tr>${keys.map(k=>`<th class="text-left px-2 py-2 border-b whitespace-nowrap">${escapeHtml(k)}</th>`).join('')}</tr>
                </thead>
                <tbody>
                  ${rows.length ? rows.slice(0,500).map(r=>`<tr class="hover:bg-gray-50">${keys.map(k=>`<td class="px-2 py-1.5 border-b align-top whitespace-nowrap">${escapeHtml(formatCell(r[k]))}</td>`).join('')}</tr>`).join('') : `<tr><td class="px-3 py-4 text-gray-500" colspan="${Math.max(keys.length,1)}">No rows yet</td></tr>`}
                </tbody>
              </table>
            </div>
            ${rows.length>500?`<div class="mt-2 text-xs text-amber-700">Showing first 500 rows.</div>`:''}
          </div>
        </div>
      </div>`;
  };

  window.formatCell = function(v){
    if (v === null || v === undefined) return '';
    if (typeof v === 'object') return JSON.stringify(v);
    return String(v);
  };
  window.escapeHtml = window.escapeHtml || function(str){
    return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  };

  window.selectDataHubTable = function(name){ APP_STATE.dataHub ||= {}; APP_STATE.dataHub.selectedTable = name; renderApp(); };

  window.switchScenarioView = function(mode){
    if (mode === APP_STATE.scenarioContext.viewMode) return;
    if (mode === 'official') {
      if (!loadOfficialCacheToState()) {
        alert('No local Official cache yet. Clone current Sandbox to Official or import an Official file first.');
        return;
      }
      APP_STATE.scenarioContext.viewMode = 'official';
    } else {
      if (!loadSandboxLocal()) {
        // stay in current data, but mark as sandbox
        APP_STATE.scenarioContext.viewMode = 'sandbox';
      }
      APP_STATE.scenarioContext.viewMode = 'sandbox';
    }
    renderApp();
  };

  window.cloneOfficialToSandbox = function(){
    if (!loadOfficialCacheToState()) {
      if (!confirm('No local Official cache found. Use current loaded data as base and create Sandbox?')) return;
    }
    APP_STATE.scenarioContext.viewMode = 'sandbox';
    APP_STATE.scenarioContext.sandboxMeta.lastClonedFromOfficialAt = new Date().toISOString();
    APP_STATE.scenarioContext.sandboxMeta.dirtyDomains = { actuals:false, demand:false, plan:false, masters:false };
    saveSandboxLocal();
    showSandboxToast('Sandbox created/refreshed from Official baseline');
    renderApp();
  };

  window.openPushToOfficialModal = function(){
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/40 z-50 flex items-center justify-center';
    modal.id = 'pushOfficialModal';
    const today = new Date().toISOString().slice(0,10);
    modal.innerHTML = `
      <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg border">
        <div class="px-4 py-3 border-b flex items-center justify-between">
          <h3 class="font-semibold text-gray-900">Push Sandbox ‚Üí Official (v1 overwrite)</h3>
          <button class="text-gray-500" onclick="document.getElementById('pushOfficialModal').remove()">‚úï</button>
        </div>
        <div class="p-4 space-y-3 text-sm">
          <p class="text-amber-700 bg-amber-50 border border-amber-200 rounded p-2">v1 behavior: publish overwrites Official for the selected date range/domain.</p>
          <div class="grid grid-cols-3 gap-2 items-end">
            <label class="block">Domain<select id="pushDomain" class="mt-1 w-full border rounded px-2 py-1"><option value="actuals">actuals</option><option value="demand">demand</option><option value="plan" selected>plan</option><option value="masters">masters</option></select></label>
            <label class="block">From<input id="pushDateFrom" type="date" value="${today}" class="mt-1 w-full border rounded px-2 py-1"></label>
            <label class="block">To<input id="pushDateTo" type="date" value="${today}" class="mt-1 w-full border rounded px-2 py-1"></label>
          </div>
          <div class="flex justify-end gap-2 pt-2">
            <button onclick="document.getElementById('pushOfficialModal').remove()" class="px-3 py-1.5 border rounded">Cancel</button>
            <button onclick="confirmPushSandboxToOfficial()" class="px-3 py-1.5 bg-green-600 text-white rounded">Push to Official</button>
          </div>
        </div>
      </div>`;
    document.body.appendChild(modal);
  };

  window.confirmPushSandboxToOfficial = function(){
    const domain = document.getElementById('pushDomain')?.value || 'plan';
    const from = document.getElementById('pushDateFrom')?.value || '';
    const to = document.getElementById('pushDateTo')?.value || '';
    if (!confirm(`This will overwrite OFFICIAL for ${domain} from ${from} to ${to}. Continue?`)) return;
    const result = pushSandboxToOfficialDateRange(domain, from, to);
    APP_STATE.publishLog ||= [];
    APP_STATE.publishLog.unshift({ timestamp:new Date().toISOString(), user:APP_STATE.currentUser||'local_user', location:APP_STATE.currentLocation||'MIA', domain, date_from:from, date_to:to, mode:'overwrite_v1', ok: !!result?.ok });
    saveOfficialCacheFromState();
    APP_STATE.scenarioContext.sandboxMeta.dirtyDomains[domain] = false;
    document.getElementById('pushOfficialModal')?.remove();
    renderApp();
  };

  function downloadBlob(filename, type, content){
    const blob = new Blob([content], {type});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 500);
  }

  window.exportCurrentScenarioJson = function(){
    const payload = { mode: APP_STATE.scenarioContext.viewMode, user: APP_STATE.currentUser, location: APP_STATE.currentLocation, exported_at: new Date().toISOString(), snapshot: snapshotCurrentPlannerData() };
    downloadBlob(`CementPlanner_${APP_STATE.currentLocation}_${APP_STATE.scenarioContext.viewMode}_${(APP_STATE.currentUser||'user')}.json`, 'application/json', JSON.stringify(payload, null, 2));
  };
  window.exportOfficialJson = function(){
    const raw = localStorage.getItem(getOfficialCacheKey());
    if (!raw) return alert('No local Official cache found yet. Push Sandbox ‚Üí Official first or import an Official file.');
    downloadBlob(`CementPlanner_${APP_STATE.currentLocation}_OFFICIAL.json`, 'application/json', raw);
  };
  window.triggerImportProjectJson = ()=> document.getElementById('projectJsonInput')?.click();
  window.triggerImportTableCsv = ()=> document.getElementById('tableCsvInput')?.click();

  window.handleProjectJsonImport = async function(ev){
    const file = ev.target.files?.[0]; if (!file) return;
    try {
      const txt = await file.text();
      const data = JSON.parse(txt);
      const snap = data.snapshot || data;
      applyPlannerSnapshot(snap);
      if ((data.mode||'').toLowerCase() === 'official') {
        saveOfficialCacheFromState();
        APP_STATE.scenarioContext.viewMode = 'official';
      } else {
        APP_STATE.scenarioContext.viewMode = 'sandbox';
        saveSandboxLocal();
      }
      alert('‚úÖ JSON imported');
      renderApp();
    } catch(err){
      alert('Import failed: ' + err.message);
    } finally { ev.target.value=''; }
  };

  function rowsToCsv(rows){
    if (!rows.length) return '';
    const cols = Object.keys(rows[0]);
    const esc = (v) => {
      const s = v == null ? '' : (typeof v === 'object' ? JSON.stringify(v) : String(v));
      return /[",\n]/.test(s) ? '"' + s.replace(/"/g, '""') + '"' : s;
    };
    return [cols.join(','), ...rows.map(r=>cols.map(c=>esc(r[c])).join(','))].join('\n');
  }
  function csvToRows(text){
    // lightweight parser (sufficient for app-generated csv)
    const lines = text.trim().split(/\r?\n/);
    if (!lines.length) return [];
    const parseLine = (line) => {
      const out=[]; let cur=''; let q=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(q){
          if(ch==='"' && line[i+1]==='"'){ cur+='"'; i++; }
          else if(ch==='"'){ q=false; }
          else cur+=ch;
        } else {
          if(ch===','){ out.push(cur); cur=''; }
          else if(ch==='"'){ q=true; }
          else cur+=ch;
        }
      }
      out.push(cur); return out;
    };
    const headers = parseLine(lines[0]);
    return lines.slice(1).filter(Boolean).map(l => {
      const vals = parseLine(l); const o={}; headers.forEach((h,i)=>o[h]=vals[i]??''); return o;
    });
  }

  window.downloadSelectedTableCsv = function(){
    const t = APP_STATE.dataHub?.selectedTable || 'Region';
    const rows = getDataHubTables()[t] || [];
    downloadBlob(`${t}.csv`, 'text/csv', rowsToCsv(rows));
  };
  window.downloadSelectedTableJson = function(){
    const t = APP_STATE.dataHub?.selectedTable || 'Region';
    const rows = getDataHubTables()[t] || [];
    downloadBlob(`${t}.json`, 'application/json', JSON.stringify(rows,null,2));
  };
  window.exportTablesCsvBundle = window.downloadSelectedTableCsv;

  window.handleTableCsvImport = async function(ev){
    const file = ev.target.files?.[0]; if (!file) return;
    const t = APP_STATE.dataHub?.selectedTable || 'Region';
    try {
      const txt = await file.text();
      const rows = csvToRows(txt);
      importRowsIntoSelectedTable(t, rows);
      ensureSandboxMode('masters');
      saveToLocalStorage();
      alert(`‚úÖ Imported ${rows.length} rows into ${t} (sandbox)`);
      renderApp();
    } catch(err){ alert('CSV import failed: '+err.message); }
    finally { ev.target.value=''; }
  };

  function importRowsIntoSelectedTable(table, rows){
    if (!Array.isArray(rows)) return;
    if (table === 'Region') {
      APP_STATE.orgStructure ||= {}; APP_STATE.orgStructure.regions = rows.map(r=>({
        id:r.id||r.region_id||r.RegionID||r.code, code:r.code||r.region_code||r.id, name:r.name||r.region_name||'', countryCode:r.countryCode||r.country_code||'USA', active:String(r.active??'true')!=='false'
      }));
      return;
    }
    if (table === 'FacilityType') {
      APP_STATE.orgStructure ||= {}; APP_STATE.orgStructure.facilityTypes = rows.map(r=>({ id:r.id||r.facility_type_id||r.code, code:r.code||r.facility_type_code||'', name:r.name||r.facility_type_name||'', active:String(r.active??'true')!=='false' }));
      return;
    }
    if (table === 'Product') {
      const products = {};
      rows.forEach((r,i)=>{
        const id = (r.product_code||r.code||r.id||`P${i+1}`).toLowerCase().replace(/[^a-z0-9_\-]/g,'_');
        const category = (r.product_category||r.category||'').toUpperCase();
        const familyFromCategory = category==='RAW_MATERIAL' ? 'raw_materials' : category==='FUEL' ? 'fuels' : category==='INTERMEDIATE_PRODUCT' ? 'intermediate' : (r.family||'cementitious');
        products[id] = { id, code:r.product_code||r.code||id.toUpperCase(), name:r.product_name||r.name||id, family: familyFromCategory, recipe: r.recipe ? safeParseObj(r.recipe,{}) : {}, color: r.color || '#3b82f6',
          landedCostUsdPerStn: r.landed_cost_usd_per_stn===''? '' : Number(r.landed_cost_usd_per_stn ?? r.landedCostUsdPerStn ?? ''),
          calorificPowerMMBTUPerStn: r.calorific_power_mmbtu_per_stn===''? '' : Number(r.calorific_power_mmbtu_per_stn ?? ''),
          co2FactorKgCO2PerMMBTU: r.co2_factor_kgco2_per_mmbtu===''? '' : Number(r.co2_factor_kgco2_per_mmbtu ?? ''),
          uomMass: r.uom_mass || 'STn'
        };
      });
      APP_STATE.products = products;
      return;
    }
    if (table === 'Customer') {
      APP_STATE.customers ||= {};
      const out={}; rows.forEach((r,i)=>{ const id=(r.customer_code||r.code||r.id||`C${i+1}`); out[id]={ id, code:id, name:r.customer_name||r.name||id, active:String(r.active??'true')!=='false' };});
      APP_STATE.customers = out;
      return;
    }
    if (table === 'Connection') {
      // import to networkMap as unified connections for now
      APP_STATE.networkMap ||= {nodes:[],connections:[],allowedByConnection:[]};
      APP_STATE.networkMap.connections = rows.map((r,i)=>({ id:r.connection_id||`NET_${i+1}`, from:r.from_node||r.from||'', to:r.to_node||r.to||'', connectionType:r.connection_type||'INTER_FACILITY', active:String(r.active??'true')!=='false' }));
      return;
    }
    if (table === 'Rules') {
      APP_STATE.rulesBook ||= {scopedRules:[], resolutionMode:'most_specific_match'};
      APP_STATE.rulesBook.scopedRules = rows.map(r=>({ rule_key:r.rule_key||r.key||'', rule_type:r.rule_type||'hard', enabled:String(r.enabled??'true')!=='false', country:r.scope_country||'', region:r.scope_region||'', facility:r.scope_facility||'', equipment:r.scope_equipment||'', storage:r.scope_storage||'', param_text:r.param_text||'', param_number:r.param_number===''?null:Number(r.param_number) }));
      return;
    }
    // other tables intentionally view/export-first in this phase
  }
  function safeParseObj(text, fallback){ try{return JSON.parse(text);}catch{return fallback;} }

  // Lightweight hooks for editing actions -> sandbox mode (global click/input listeners)
  document.addEventListener('change', (e) => {
    const t = e.target;
    if (!(t instanceof HTMLElement)) return;
    if (APP_STATE.scenarioContext?.viewMode === 'official') {
      if (t.matches('input, select, textarea')) ensureSandboxMode(inferDomainFromElement(t));
    }
  }, true);
  document.addEventListener('input', (e) => {
    const t = e.target;
    if (!(t instanceof HTMLElement)) return;
    if (APP_STATE.scenarioContext?.viewMode === 'official' && t.matches('input, textarea')) {
      ensureSandboxMode(inferDomainFromElement(t));
    }
  }, true);
  function inferDomainFromElement(el){
    const tab = APP_STATE.currentTab;
    if (tab === 'demand') return 'demand';
    if (tab === 'plan' || tab === 'monitor') return 'plan';
    if (tab === 'products' || tab === 'flow' || tab === 'datahub') return 'masters';
    return 'plan';
  }
})();
</script>


<script>
(function(){
  function _norm(v){ return String(v||'').toLowerCase().replace(/[^a-z0-9]+/g,' ').trim(); }
  function _isFuelFamily(f){ return ['fuel','fuels'].includes(String(f||'').toLowerCase()); }
  function _isRawFamily(f){ return ['raw','raw_material','raw_materials'].includes(String(f||'').toLowerCase()); }
  function _isFinishedFamily(f){
    const x=String(f||'').toLowerCase();
    return ['cementitious','finished','finished_product','finished_products','cement','blended','portland','specialty'].includes(x);
  }
  function _findProductForSilo(silo){
    const t = silo?.params?.material_type || silo?.params?.material || silo?.productName || '';
    const nt = _norm(t);
    if(!nt) return null;
    const products = Object.values(APP_STATE.products || {});
    // exact-ish by code/name/id
    let m = products.find(p => [_norm(p.name), _norm(p.code), _norm(p.id)].includes(nt));
    if (m) return m;
    // contains match
    m = products.find(p => nt.includes(_norm(p.name)) || nt.includes(_norm(p.code)) || _norm(p.name).includes(nt));
    return m || null;
  }
  function _classifySiloGroup(silo){
    const mat = String(silo?.params?.material_type || '').toLowerCase();
    const name = String(silo?.name || '').toLowerCase();
    const p = _findProductForSilo(silo);
    const family = p?.family || '';
    const text = `${mat} ${name} ${p?.name||''} ${p?.code||''}`.toLowerCase();

    if (text.includes('clinker') || text.includes('/clk') || /\bclk\b/.test(text)) return 'clinker';
    if (_isFinishedFamily(family)) return 'cement';
    if (_isFuelFamily(family) || text.includes('fuel') || text.includes('coal') || text.includes('petcoke')) return 'fuel';
    if (_isRawFamily(family) || text.includes('raw meal') || text.includes('/rm') || text.includes('limestone') || text.includes('gypsum') || text.includes('bauxite') || text.includes('clay')) return 'raw';
    // non-clinker intermediates (e.g., raw meal) default with raw materials for readability
    if (String(family).toLowerCase() === 'intermediate') return 'raw';
    return 'raw';
  }
  function _siloGroupOrder(g){ return ({clinker:1, cement:2, raw:3, fuel:4}[g] || 99); }
  function _siloGroupLabel(g){
    return ({
      clinker:'üß± CLINKER INVENTORY',
      cement:'üèóÔ∏è CEMENT / FINISHED PRODUCTS INVENTORY',
      raw:'ü™® RAW MATERIALS INVENTORY',
      fuel:'üî• FUELS INVENTORY'
    }[g] || 'üì¶ INVENTORY');
  }
  function _equipmentOrderKey(eq){
    const rank = { kiln:1, raw_mill:2, finish_mill:3, packing:4, loadout:5 };
    return (rank[eq?.type] || 99) * 100000 + (eq?.y || 0) * 100 + (eq?.x || 0);
  }

  const _origRenderUnifiedProductionTable = window.renderUnifiedProductionTable;
  window.renderUnifiedProductionTable = function(dateHeaders){
    const equipmentAll = (APP_STATE.flowDesigner?.equipment || []);
    const kilns = equipmentAll.filter(e => e.type === 'kiln');
    const rawMills = equipmentAll.filter(e => e.type === 'raw_mill');
    const finishMills = equipmentAll.filter(e => e.type === 'finish_mill');
    const otherPlanEquip = equipmentAll.filter(e => !['kiln','raw_mill','finish_mill','storage'].includes(e.type||''));
    const allEquipment = [...kilns, ...rawMills, ...finishMills, ...otherPlanEquip].sort((a,b)=>_equipmentOrderKey(a)-_equipmentOrderKey(b));
    const silos = equipmentAll.filter(e => e.type === 'storage');

    if (allEquipment.length === 0 && silos.length === 0) {
      return `
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
          <p class="text-yellow-800">‚ö†Ô∏è No equipment configured. Please set up equipment in Process Flow (Tab 2)</p>
        </div>
      `;
    }

    const inventories = calculateInventories(dateHeaders);
    const monthGroups = {};
    dateHeaders.forEach(header => {
      const monthKey = header.date.getFullYear() + '-' + String(header.date.getMonth()).padStart(2, '0');
      if (!monthGroups[monthKey]) monthGroups[monthKey] = { monthName: header.date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }), dates: [] };
      monthGroups[monthKey].dates.push(header);
    });

    const siloGroups = {};
    silos.forEach(s => {
      const g = _classifySiloGroup(s);
      (siloGroups[g] ||= []).push(s);
    });
    Object.values(siloGroups).forEach(arr => arr.sort((a,b)=>String(a.name||'').localeCompare(String(b.name||''))));

    return `
      <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="overflow-x-auto">
          <table class="w-full border-collapse">
            <thead class="sticky top-0 z-20 bg-gray-100">
              <tr class="border-b border-gray-300">
                <th class="sticky left-0 bg-gray-100 z-30 px-3 py-2 text-left font-semibold text-gray-700 border-r border-gray-300" style="min-width: 200px;">Section</th>
                ${Object.values(monthGroups).map(month => `
                  <th colspan="${month.dates.length}" class="px-2 py-2 text-center text-sm font-semibold text-gray-700 border-l border-gray-300">
                    ${month.monthName}
                  </th>
                `).join('')}
              </tr>
              <tr class="border-b-2 border-gray-300">
                <th class="sticky left-0 bg-gray-100 z-30 px-3 py-2 border-r border-gray-300"></th>
                ${dateHeaders.map(header => {
                  const isWeekend = header.date.getDay() === 0 || header.date.getDay() === 6;
                  const isToday = header.dateStr === getDateString(new Date(APP_STATE.currentDate));
                  let bgClass = 'bg-gray-50';
                  if (isToday) bgClass = 'bg-blue-100';
                  else if (isWeekend) bgClass = 'bg-gray-200';
                  return `
                    <th class="${bgClass} px-2 py-2 text-center border-l border-gray-200" style="min-width: 60px;">
                      <div class="text-xs font-semibold text-gray-600">${header.date.toLocaleDateString('en-US', { weekday: 'short' })}</div>
                      <div class="text-sm font-bold text-gray-900">${header.date.getDate()}</div>
                    </th>
                  `;
                }).join('')}
              </tr>
            </thead>
            <tbody>
              ${allEquipment.length > 0 ? `
                <tr class="bg-gray-800">
                  <td colspan="${dateHeaders.length + 1}" class="px-4 py-2 font-bold text-white text-sm">‚öôÔ∏è EQUIPMENT CAMPAIGNS</td>
                </tr>
                ${allEquipment.map(eq => renderEquipmentDailyRow(eq, dateHeaders)).join('')}
              ` : ''}

              ${silos.length > 0 ? `
                <tr class="bg-gray-800 border-t-4 border-gray-400">
                  <td colspan="${dateHeaders.length + 1}" class="px-4 py-2 font-bold text-white text-sm">üì¶ INVENTORY LEVELS</td>
                </tr>
                ${['clinker','cement','raw','fuel'].filter(g => (siloGroups[g]||[]).length).map(g => `
                  <tr class="bg-gray-100 border-t border-gray-300">
                    <td colspan="${dateHeaders.length + 1}" class="px-4 py-2 font-semibold text-gray-800 text-xs tracking-wide">${_siloGroupLabel(g)}</td>
                  </tr>
                  ${(siloGroups[g]||[]).map(silo => renderSiloDailyRow(silo, inventories, dateHeaders)).join('')}
                `).join('')}
              ` : ''}
            </tbody>
          </table>
        </div>
      </div>
    `;
  };
})();
</script>

</body>
</html>
